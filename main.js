/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var ge=Object.defineProperty;var Ie=Object.getOwnPropertyDescriptor;var Le=Object.getOwnPropertyNames;var Ae=Object.prototype.hasOwnProperty;var De=(v,o)=>{for(var e in o)ge(v,e,{get:o[e],enumerable:!0})},$e=(v,o,e,t)=>{if(o&&typeof o=="object"||typeof o=="function")for(let n of Le(o))!Ae.call(v,n)&&n!==e&&ge(v,n,{get:()=>o[n],enumerable:!(t=Ie(o,n))||t.enumerable});return v};var Ne=v=>$e(ge({},"__esModule",{value:!0}),v);var qe={};De(qe,{default:()=>he});module.exports=Ne(qe);var b=require("obsidian");var Fe={Thing:{name:"Thing",label:"Thing",plural:"Things",description:"The most basic type of entity. All other types extend from this.",extends:[],featured:["name"],required:[],caption:["name"],properties:{name:{label:"Name",type:"name",description:"A name or title"},description:{label:"Description",type:"text"},country:{label:"Country",type:"country"},alias:{label:"Alias",type:"name"},notes:{label:"Notes",type:"text"},sourceUrl:{label:"Source URL",type:"url",matchable:!1},wikidataId:{label:"Wikidata ID",type:"identifier"},keywords:{label:"Keywords"},topics:{label:"Topics"},address:{label:"Address",type:"address"}}},Interval:{name:"Interval",label:"Interval",plural:"Intervals",description:"An object which is bounded in time.",extends:[],abstract:!0,featured:[],required:[],caption:[],properties:{startDate:{label:"Start date",type:"date"},endDate:{label:"End date",type:"date"},date:{label:"Date",type:"date"},summary:{label:"Summary",type:"text"},description:{label:"Description",type:"text"},sourceUrl:{label:"Source link",type:"url",matchable:!1},modifiedAt:{label:"Modified on",type:"date"}}},Value:{name:"Value",label:"Value",plural:"Values",description:"A monetary value with amount and currency.",extends:[],abstract:!0,featured:["amount","currency"],required:[],caption:[],properties:{amount:{label:"Amount",type:"number"},amountUsd:{label:"Amount (USD)",type:"number"},currency:{label:"Currency"}}},Analyzable:{name:"Analyzable",label:"Analyzable",plural:"Analyzables",description:"An entity suitable for being processed via named-entity recognition.",extends:[],abstract:!0,featured:[],required:[],caption:[],properties:{detectedLanguage:{label:"Detected language",type:"language",hidden:!0},detectedCountry:{label:"Detected country",type:"country",hidden:!0}}}},_e={Person:{name:"Person",label:"Person",plural:"People",description:"A natural person, alive or dead.",extends:["LegalEntity"],matchable:!0,featured:["name","nationality","birthDate","country"],required:["name"],caption:["name","firstName","lastName"],properties:{firstName:{label:"First name",type:"name"},lastName:{label:"Last name",type:"name"},fatherName:{label:"Father name",type:"name"},motherName:{label:"Mother name",type:"name"},birthDate:{label:"Birth date",type:"date"},birthPlace:{label:"Place of birth",type:"address"},deathDate:{label:"Death date",type:"date"},nationality:{label:"Nationality",type:"country"},gender:{label:"Gender"},title:{label:"Title"},religion:{label:"Religion"},ethnicity:{label:"Ethnicity"},political:{label:"Political affiliation"},position:{label:"Position"},education:{label:"Education"},passportNumber:{label:"Passport number",type:"identifier"},idNumber:{label:"ID number",type:"identifier"}},color:"#4CAF50"},LegalEntity:{name:"LegalEntity",label:"Legal entity",plural:"Legal entities",description:"Any party to legal proceedings, such as asset ownership, corporate governance or social interactions.",extends:["Thing"],matchable:!0,featured:["name","country","legalForm","status"],required:["name"],caption:["name","email","phone","registrationNumber"],properties:{email:{label:"E-Mail",type:"email"},phone:{label:"Phone",type:"phone",maxLength:32},website:{label:"Website",type:"url"},legalForm:{label:"Legal form",matchable:!1},incorporationDate:{label:"Incorporation date",type:"date"},dissolutionDate:{label:"Dissolution date",type:"date"},taxStatus:{label:"Tax status",matchable:!1},status:{label:"Status",matchable:!1},sector:{label:"Sector",matchable:!1},classification:{label:"Classification",matchable:!1},registrationNumber:{label:"Registration number",type:"identifier"},idNumber:{label:"ID Number",type:"identifier"},taxNumber:{label:"Tax Number",type:"identifier"},jurisdiction:{label:"Jurisdiction",type:"country"},mainCountry:{label:"Country of origin",type:"country"}},color:"#607D8B"},Organization:{name:"Organization",label:"Organization",plural:"Organizations",description:"Any type of incorporated entity that cannot be owned by another.",extends:["LegalEntity"],matchable:!0,featured:["name","country","legalForm","status"],required:["name"],caption:["name"],properties:{cageCode:{label:"CAGE",type:"identifier",maxLength:16},permId:{label:"PermID",type:"identifier",maxLength:16}},color:"#795548"},Company:{name:"Company",label:"Company",plural:"Companies",description:"A legal entity representing a commercial business.",extends:["Organization"],matchable:!0,featured:["name","jurisdiction","registrationNumber","incorporationDate"],required:["name"],caption:["name","registrationNumber"],properties:{voenCode:{label:"VOEN",type:"identifier"},coatoCode:{label:"COATO",type:"identifier"},irsCode:{label:"IRS Employer ID",type:"identifier"},ipoCode:{label:"IPO",type:"identifier"}},color:"#037d9e"},Event:{name:"Event",label:"Event",plural:"Events",description:"An occurrence at a specific time and place.",extends:["Interval","Thing"],matchable:!1,featured:["name","summary","date","location","add_to_timeline"],required:["name"],caption:["name","summary","date"],properties:{location:{label:"Location",type:"address"},country:{label:"Country",type:"country"},latitude:{label:"Latitude",type:"number"},longitude:{label:"Longitude",type:"number"},important:{label:"Important"},add_to_timeline:{label:"Add to Timeline",type:"boolean"}},color:"#F22416"},Address:{name:"Address",label:"Address",plural:"Addresses",description:"A location associated with an entity.",extends:["Thing"],matchable:!0,featured:["full","city","street","country","latitude","longitude"],required:[],caption:["full","summary","city"],properties:{full:{label:"Full address",type:"address"},remarks:{label:"Remarks"},postOfficeBox:{label:"PO Box"},street:{label:"Street address"},street2:{label:"Street address (ctd.)"},city:{label:"City"},postalCode:{label:"Postal code",maxLength:16},region:{label:"Region"},state:{label:"State"},latitude:{label:"Latitude",type:"number"},longitude:{label:"Longitude",type:"number"},country:{label:"Country",type:"country"}},color:"#FF5722"},Vehicle:{name:"Vehicle",label:"Vehicle",plural:"Vehicles",description:"A vehicle such as a car, truck, or motorcycle.",extends:["Thing"],matchable:!1,featured:["type","name","registrationNumber","country"],required:[],caption:["name","registrationNumber"],properties:{registrationNumber:{label:"Registration number",type:"identifier"},type:{label:"Type"},model:{label:"Model"},buildDate:{label:"Build Date",type:"date"},registrationDate:{label:"Registration Date",type:"date"}},color:"#6c5952"},BankAccount:{name:"BankAccount",label:"Bank Account",plural:"Bank Accounts",description:"A bank account held at a financial institution.",extends:["Thing"],matchable:!0,featured:["bankName","iban","accountNumber"],required:[],caption:["bankName","iban","accountNumber"],properties:{bankName:{label:"Bank name"},iban:{label:"IBAN",type:"iban"},accountNumber:{label:"Account number",type:"identifier"},bic:{label:"BIC/SWIFT",type:"identifier"},balance:{label:"Balance",type:"number"},currency:{label:"Currency"}},color:"#2E7D32"},CryptoWallet:{name:"CryptoWallet",label:"Crypto Wallet",plural:"Crypto Wallets",description:"A cryptocurrency wallet address.",extends:["Thing"],matchable:!0,featured:["publicKey","currency"],required:["publicKey"],caption:["publicKey"],properties:{publicKey:{label:"Public key/Address",type:"identifier"},currency:{label:"Currency"},balance:{label:"Balance",type:"number"}},color:"#FF9800"},UserAccount:{name:"UserAccount",label:"User Account",plural:"User Accounts",description:"A user account on a platform or service.",extends:["Thing"],matchable:!0,featured:["userName","platform","url"],required:["userName"],caption:["userName","platform"],properties:{userName:{label:"Username"},platform:{label:"Platform"},url:{label:"Profile URL",type:"url"},email:{label:"Email",type:"email"},phone:{label:"Phone",type:"phone"}},color:"#21B57D"},Document:{name:"Document",label:"Document",plural:"Documents",description:"A document or file.",extends:["Thing"],matchable:!1,featured:["title","date","mimeType"],required:[],caption:["title","fileName"],properties:{title:{label:"Title"},fileName:{label:"File name"},mimeType:{label:"MIME type"},fileSize:{label:"File size",type:"number"},date:{label:"Date",type:"date"},author:{label:"Author"}},color:"#9C27B0"},RealEstate:{name:"RealEstate",label:"Real Estate",plural:"Real Estate",description:"A piece of real estate property.",extends:["Thing"],matchable:!1,featured:["name","address","country"],required:[],caption:["name","address"],properties:{registrationNumber:{label:"Registration number",type:"identifier"},area:{label:"Area"},areaUnit:{label:"Area unit"},buildDate:{label:"Build date",type:"date"},propertyType:{label:"Property type"}},color:"#8D6E63"},Sanction:{name:"Sanction",label:"Sanction",plural:"Sanctions",description:"A sanction or restriction placed on an entity.",extends:["Interval"],matchable:!1,featured:["program","authority","reason"],required:[],caption:["program","authority"],properties:{program:{label:"Program"},authority:{label:"Authority"},reason:{label:"Reason"},listingDate:{label:"Listing date",type:"date"},provisions:{label:"Provisions"}},color:"#D32F2F"},Passport:{name:"Passport",label:"Passport",plural:"Passports",description:"A passport or travel document.",extends:["Interval","Thing"],matchable:!0,featured:["number","country","type"],required:["number"],caption:["number","country"],properties:{number:{label:"Number",type:"identifier"},type:{label:"Type"},country:{label:"Country",type:"country"},issueDate:{label:"Issue date",type:"date"},expiryDate:{label:"Expiry date",type:"date"}},color:"#1565C0"},Ownership:{name:"Ownership",label:"Ownership",plural:"Ownerships",description:"An ownership relationship between entities.",extends:["Interval"],matchable:!1,featured:["owner","asset","percentage"],required:[],caption:["owner","asset"],properties:{percentage:{label:"Percentage",type:"number"},sharesCount:{label:"Shares count",type:"number"},sharesValue:{label:"Shares value",type:"number"},sharesCurrency:{label:"Shares currency"}},color:"#546E7A"},Employment:{name:"Employment",label:"Employment",plural:"Employments",description:"An employment relationship.",extends:["Interval"],matchable:!1,featured:["employee","employer","role"],required:[],caption:["employee","employer","role"],properties:{role:{label:"Role"},title:{label:"Title"},salary:{label:"Salary",type:"number"},salaryCurrency:{label:"Salary currency"}},color:"#00897B"},Directorship:{name:"Directorship",label:"Directorship",plural:"Directorships",description:"A directorship or board membership.",extends:["Interval"],matchable:!1,featured:["director","organization","role"],required:[],caption:["director","organization","role"],properties:{role:{label:"Role"},secretary:{label:"Secretary"}},color:"#5E35B1"},Airplane:{name:"Airplane",label:"Airplane",plural:"Airplanes",description:"An airplane, helicopter or other flying vehicle.",extends:["Vehicle"],matchable:!0,featured:["type","registrationNumber","country","name"],required:[],caption:["name","registrationNumber"],properties:{serialNumber:{label:"Serial Number",type:"identifier"},icaoCode:{label:"ICAO aircraft type designator",type:"identifier",maxLength:16},manufacturer:{label:"Manufacturer"}},color:"#5C6BC0"},Vessel:{name:"Vessel",label:"Vessel",plural:"Vessels",description:"A boat or ship. Typically flying some sort of national flag.",extends:["Vehicle"],matchable:!0,featured:["name","imoNumber","type","flag"],required:["name"],caption:["name","imoNumber"],properties:{imoNumber:{label:"IMO Number",type:"identifier",maxLength:16},crsNumber:{label:"CRS Number",type:"identifier"},flag:{label:"Flag",type:"country"},registrationPort:{label:"Port of Registration"},navigationArea:{label:"Navigation Area"},tonnage:{label:"Tonnage",type:"number"},grossRegisteredTonnage:{label:"Gross Registered Tonnage",type:"number"},callSign:{label:"Call Sign",type:"identifier"},mmsi:{label:"MMSI",type:"identifier",maxLength:16}},color:"#0288D1"},PublicBody:{name:"PublicBody",label:"Public Body",plural:"Public Bodies",description:"A public body, such as a ministry, department or state company.",extends:["Organization"],matchable:!0,featured:["name","country","legalForm","status"],required:["name"],caption:["name"],properties:{},color:"#7B1FA2"},Asset:{name:"Asset",label:"Asset",plural:"Assets",description:"A piece of property which can be owned and assigned a monetary value.",extends:["Thing","Value"],matchable:!1,featured:["name","amount"],required:[],caption:["name"],properties:{},color:"#FFA000"},Security:{name:"Security",label:"Security",plural:"Securities",description:"A tradeable financial asset.",extends:["Asset"],matchable:!0,featured:["isin","name","country"],required:[],caption:["name","isin","registrationNumber"],properties:{isin:{label:"ISIN",type:"identifier",maxLength:16},registrationNumber:{label:"Registration number",type:"identifier"},ticker:{label:"Stock ticker symbol",type:"identifier"},figiCode:{label:"Financial Instrument Global Identifier",type:"identifier",maxLength:16},issueDate:{label:"Date issued",type:"date"},maturityDate:{label:"Maturity date",type:"date"},type:{label:"Type"},classification:{label:"Classification"}},color:"#00796B"},Payment:{name:"Payment",label:"Payment",plural:"Payments",description:"A monetary payment between two parties.",extends:["Interval","Value"],matchable:!1,featured:["date","amount","purpose"],required:[],caption:["amount"],properties:{sequenceNumber:{label:"Sequence number"},transactionNumber:{label:"Transaction number"},purpose:{label:"Payment purpose",type:"text"},programme:{label:"Payment programme"}},color:"#388E3C"},Folder:{name:"Folder",label:"Folder",plural:"Folders",description:"A folder or directory containing documents.",extends:["Document"],matchable:!1,generated:!0,featured:["title"],required:[],caption:["fileName","title"],properties:{},color:"#8D6E63"},PlainText:{name:"PlainText",label:"Text File",plural:"Text Files",description:"Text files, like .txt or source code.",extends:["Document"],matchable:!1,generated:!0,featured:["title","fileName","mimeType"],required:[],caption:["fileName","title"],properties:{bodyText:{label:"Text",type:"text",hidden:!0}},color:"#78909C"},HyperText:{name:"HyperText",label:"Web Page",plural:"Web Pages",description:"An HTML document or web page.",extends:["Document"],matchable:!1,generated:!0,featured:["title","fileName","mimeType"],required:[],caption:["title","fileName"],properties:{bodyHtml:{label:"HTML",type:"html",hidden:!0}},color:"#26A69A"},Email:{name:"Email",label:"E-Mail",plural:"E-Mails",description:"An internet mail message with subject, sender, and recipients.",extends:["Folder","PlainText","HyperText"],matchable:!1,generated:!0,featured:["subject","date","from"],required:[],caption:["subject","threadTopic","title","name","fileName"],properties:{subject:{label:"Subject"},threadTopic:{label:"Thread topic"},sender:{label:"Sender"},from:{label:"From"},to:{label:"To"},cc:{label:"CC"},bcc:{label:"BCC"}},color:"#2196F3"},Message:{name:"Message",label:"Message",plural:"Messages",description:"A message or communication between parties.",extends:["Interval","Folder","PlainText","HyperText"],matchable:!1,generated:!0,featured:["subject","date"],required:[],caption:["subject","title","threadTopic","fileName"],properties:{subject:{label:"Subject"},threadTopic:{label:"Thread topic"}},color:"#7E57C2"},Contract:{name:"Contract",label:"Contract",plural:"Contracts",description:"A contract or contract lot issued by an authority.",extends:["Asset"],matchable:!1,featured:["title","amount","contractDate"],required:["title"],caption:["title","name","procedureNumber"],properties:{title:{label:"Title"},type:{label:"Type"},contractDate:{label:"Contract date",type:"date"},procedureNumber:{label:"Procedure number"},procedure:{label:"Contract procedure"},status:{label:"Status"},method:{label:"Procurement method"},criteria:{label:"Contract award criteria"},classification:{label:"Classification"}},color:"#5D4037"},Project:{name:"Project",label:"Project",plural:"Projects",description:"An activity carried out by a group of participants.",extends:["Interval","Thing","Value"],matchable:!1,featured:["name","projectId","startDate"],required:[],caption:["name","projectId"],properties:{projectId:{label:"Project ID",type:"identifier"},status:{label:"Status"},phase:{label:"Phase"},goal:{label:"Project goal"}},color:"#00ACC1"},CourtCase:{name:"CourtCase",label:"Court Case",plural:"Court Cases",description:"A legal case in a court of law.",extends:["Thing"],matchable:!1,featured:["name","fileDate","caseNumber"],required:["name"],caption:["name","caseNumber"],properties:{category:{label:"Category"},type:{label:"Type"},status:{label:"Status"},caseNumber:{label:"Case number",type:"identifier"},court:{label:"Court"},fileDate:{label:"File date",type:"date"},closeDate:{label:"Close date",type:"date"}},color:"#6D4C41"},Family:{name:"Family",label:"Family",plural:"Family Members",description:"Family relationship between two people.",extends:["Interval"],matchable:!1,featured:["relationship"],required:[],caption:["relationship"],properties:{relationship:{label:"Relationship"}},color:"#E91E63"},Membership:{name:"Membership",label:"Membership",plural:"Memberships",description:"A membership in an organization.",extends:["Interval"],matchable:!1,featured:["role"],required:[],caption:["role"],properties:{role:{label:"Role"},status:{label:"Status"}},color:"#9C27B0"},Associate:{name:"Associate",label:"Associate",plural:"Associates",description:"An association between two entities.",extends:["Interval"],matchable:!1,featured:["relationship"],required:[],caption:["relationship"],properties:{relationship:{label:"Relationship"}},color:"#673AB7"},Representation:{name:"Representation",label:"Representation",plural:"Representations",description:"A legal or formal representation relationship.",extends:["Interval"],matchable:!1,featured:["role"],required:[],caption:["role"],properties:{role:{label:"Role"}},color:"#3F51B5"},Identification:{name:"Identification",label:"Identification",plural:"Identifications",description:"An identification document or number.",extends:["Interval","Thing"],matchable:!0,featured:["number","type","country"],required:["number"],caption:["number","type"],properties:{number:{label:"Number",type:"identifier"},type:{label:"Type"},country:{label:"Country",type:"country"},issueDate:{label:"Issue date",type:"date"},expiryDate:{label:"Expiry date",type:"date"}},color:"#1976D2"},License:{name:"License",label:"License",plural:"Licenses",description:"A license or permit.",extends:["Interval","Thing"],matchable:!1,featured:["number","type","authority"],required:[],caption:["number","type"],properties:{number:{label:"Number",type:"identifier"},type:{label:"Type"},authority:{label:"Authority"},issueDate:{label:"Issue date",type:"date"},expiryDate:{label:"Expiry date",type:"date"}},color:"#0097A7"},Debt:{name:"Debt",label:"Debt",plural:"Debts",description:"A debt or liability.",extends:["Interval","Value"],matchable:!1,featured:["amount","currency","date"],required:[],caption:["amount"],properties:{status:{label:"Status"},type:{label:"Type"}},color:"#C62828"},Interest:{name:"Interest",label:"Interest",plural:"Interests",description:"An interest or stake in an entity.",extends:["Interval"],matchable:!1,featured:["percentage","type"],required:[],caption:["percentage","type"],properties:{percentage:{label:"Percentage",type:"number"},type:{label:"Type"},status:{label:"Status"}},color:"#AD1457"},Occupancy:{name:"Occupancy",label:"Occupancy",plural:"Occupancies",description:"An occupancy of a position or role.",extends:["Interval"],matchable:!1,featured:["role","status"],required:[],caption:["role"],properties:{role:{label:"Role"},status:{label:"Status"}},color:"#6A1B9A"},Position:{name:"Position",label:"Position",plural:"Positions",description:"A position or role in an organization.",extends:["Thing"],matchable:!1,featured:["name","country"],required:["name"],caption:["name"],properties:{subnationalArea:{label:"Subnational area"}},color:"#4527A0"},Trip:{name:"Trip",label:"Trip",plural:"Trips",description:"A journey or trip.",extends:["Interval","Thing"],matchable:!1,featured:["name","startDate","endDate"],required:[],caption:["name"],properties:{origin:{label:"Origin"},destination:{label:"Destination"},purpose:{label:"Purpose"}},color:"#00838F"},Call:{name:"Call",label:"Call",plural:"Calls",description:"A phone call or communication.",extends:["Interval"],matchable:!1,featured:["date","duration"],required:[],caption:["date"],properties:{duration:{label:"Duration"},type:{label:"Type"}},color:"#00695C"},Image:{name:"Image",label:"Image",plural:"Images",description:"An image file.",extends:["Document"],matchable:!1,generated:!0,featured:["title","fileName"],required:[],caption:["title","fileName"],properties:{width:{label:"Width",type:"number"},height:{label:"Height",type:"number"}},color:"#F4511E"},Video:{name:"Video",label:"Video",plural:"Videos",description:"A video file.",extends:["Document"],matchable:!1,generated:!0,featured:["title","fileName"],required:[],caption:["title","fileName"],properties:{duration:{label:"Duration"}},color:"#D81B60"},Audio:{name:"Audio",label:"Audio",plural:"Audio Files",description:"An audio file.",extends:["Document"],matchable:!1,generated:!0,featured:["title","fileName"],required:[],caption:["title","fileName"],properties:{duration:{label:"Duration"}},color:"#8E24AA"},Article:{name:"Article",label:"Article",plural:"Articles",description:"A news article or publication.",extends:["Document"],matchable:!1,featured:["title","date","author"],required:[],caption:["title"],properties:{author:{label:"Author"},publisher:{label:"Publisher"},publishedAt:{label:"Published at",type:"date"}},color:"#5E35B1"},Note:{name:"Note",label:"Note",plural:"Notes",description:"A note or annotation.",extends:["PlainText"],matchable:!1,featured:["title","date"],required:[],caption:["title"],properties:{},color:"#FDD835"},Post:{name:"Post",label:"Post",plural:"Posts",description:"A social media post or message.",extends:["Document"],matchable:!1,featured:["title","date"],required:[],caption:["title"],properties:{platform:{label:"Platform"},url:{label:"URL",type:"url"}},color:"#1E88E5"},Mention:{name:"Mention",label:"Mention",plural:"Mentions",description:"A mention of an entity in a document.",extends:["Interval"],matchable:!1,featured:["name"],required:[],caption:["name"],properties:{name:{label:"Name"},detectedLanguage:{label:"Detected language"}},color:"#43A047"},Assessment:{name:"Assessment",label:"Assessment",plural:"Assessments",description:"An assessment or evaluation.",extends:["Interval","Thing"],matchable:!1,featured:["name","date"],required:[],caption:["name"],properties:{type:{label:"Type"},status:{label:"Status"},result:{label:"Result"}},color:"#FB8C00"},TaxRoll:{name:"TaxRoll",label:"Tax Roll",plural:"Tax Rolls",description:"A tax roll or tax record.",extends:["Interval","Value"],matchable:!1,featured:["amount","date"],required:[],caption:["amount"],properties:{type:{label:"Type"},status:{label:"Status"}},color:"#7CB342"},Succession:{name:"Succession",label:"Succession",plural:"Successions",description:"A succession or inheritance relationship.",extends:["Interval"],matchable:!1,featured:["date"],required:[],caption:["date"],properties:{type:{label:"Type"}},color:"#8D6E63"},Similar:{name:"Similar",label:"Similar",plural:"Similarities",description:"A similarity relationship between entities.",extends:["Interval"],matchable:!1,featured:["score"],required:[],caption:["score"],properties:{score:{label:"Score",type:"number"}},color:"#78909C"},UnknownLink:{name:"UnknownLink",label:"Unknown Link",plural:"Unknown Links",description:"An unknown or unclassified relationship.",extends:["Interval"],matchable:!1,featured:["description"],required:[],caption:["description"],properties:{description:{label:"Description"}},color:"#90A4AE"},Table:{name:"Table",label:"Table",plural:"Tables",description:"A data table.",extends:["Document"],matchable:!1,generated:!0,featured:["title"],required:[],caption:["title","fileName"],properties:{},color:"#26A69A"},Workbook:{name:"Workbook",label:"Workbook",plural:"Workbooks",description:"A spreadsheet workbook.",extends:["Document"],matchable:!1,generated:!0,featured:["title"],required:[],caption:["title","fileName"],properties:{},color:"#66BB6A"},Package:{name:"Package",label:"Package",plural:"Packages",description:"A package or archive file.",extends:["Document"],matchable:!1,generated:!0,featured:["title"],required:[],caption:["title","fileName"],properties:{},color:"#8D6E63"},Page:{name:"Page",label:"Page",plural:"Pages",description:"A page in a document.",extends:["Document"],matchable:!1,generated:!0,featured:["title","index"],required:[],caption:["title","index"],properties:{index:{label:"Page number",type:"number"}},color:"#BDBDBD"},Pages:{name:"Pages",label:"Pages",plural:"Pages",description:"A collection of pages.",extends:["Document"],matchable:!1,generated:!0,featured:["title"],required:[],caption:["title","fileName"],properties:{},color:"#9E9E9E"},EconomicActivity:{name:"EconomicActivity",label:"Economic Activity",plural:"Economic Activities",description:"An economic activity or business sector.",extends:["Thing"],matchable:!1,featured:["name","code"],required:[],caption:["name","code"],properties:{code:{label:"Code",type:"identifier"},classification:{label:"Classification"}},color:"#558B2F"},CallForTenders:{name:"CallForTenders",label:"Call for Tenders",plural:"Calls for Tenders",description:"A call for tenders or procurement notice.",extends:["Asset"],matchable:!1,featured:["title","amount","date"],required:[],caption:["title"],properties:{title:{label:"Title"},deadline:{label:"Deadline",type:"date"},status:{label:"Status"}},color:"#0277BD"},ContractAward:{name:"ContractAward",label:"Contract Award",plural:"Contract Awards",description:"An award of a contract to a supplier.",extends:["Interval","Value"],matchable:!1,featured:["amount","date"],required:[],caption:["amount"],properties:{lotNumber:{label:"Lot number"}},color:"#00897B"},CourtCaseParty:{name:"CourtCaseParty",label:"Court Case Party",plural:"Court Case Parties",description:"A party to a court case.",extends:["Interval"],matchable:!1,featured:["role"],required:[],caption:["role"],properties:{role:{label:"Role"}},color:"#5D4037"},ProjectParticipant:{name:"ProjectParticipant",label:"Project Participant",plural:"Project Participants",description:"A participant in a project.",extends:["Interval"],matchable:!1,featured:["role"],required:[],caption:["role"],properties:{role:{label:"Role"}},color:"#0288D1"}},Ce={...Fe,..._e},ye=class{constructor(){this.resolvedSchemas=new Map;this.initialized=!1}initialize(){if(!this.initialized){for(let o of Object.keys(Ce))this.resolveSchema(o);this.initialized=!0}}resolveSchema(o){if(this.resolvedSchemas.has(o))return this.resolvedSchemas.get(o);let e=Ce[o];if(!e)return console.warn(`[FTMSchemaService] Schema not found: ${o}`),null;let t={};if(e.extends&&e.extends.length>0)for(let l of e.extends){let c=this.resolveSchema(l);c&&(t={...t,...c.allProperties})}e.properties&&(t={...t,...e.properties});let n=e.required||[],i=e.featured||[],r=[...new Set([...n,...i])],a=Object.keys(t).filter(l=>!r.includes(l)&&!t[l].hidden),s={name:o,label:e.label||o,plural:e.plural||o+"s",description:e.description||"",extends:e.extends||[],abstract:e.abstract,matchable:e.matchable,generated:e.generated,featured:i,required:n,caption:e.caption||[],properties:e.properties||{},allProperties:t,defaultProperties:r,optionalProperties:a,color:e.color};return this.resolvedSchemas.set(o,s),s}getSchema(o){return this.initialize(),this.resolvedSchemas.get(o)||null}getEntitySchemas(){return this.initialize(),Array.from(this.resolvedSchemas.values()).filter(o=>!o.abstract)}getIntervalSchemas(){return this.initialize(),Array.from(this.resolvedSchemas.values()).filter(o=>!o.abstract&&this.extendsInterval(o))}extendsInterval(o){if(o.name==="Interval")return!1;if(o.extends.includes("Interval"))return!0;for(let e of o.extends){let t=this.getSchema(e);if(t&&this.extendsInterval(t))return!0}return!1}getSchemaNames(){return this.initialize(),Array.from(this.resolvedSchemas.keys())}getEntitySchemaNames(){return this.getEntitySchemas().map(o=>o.name)}hasSchema(o){return this.initialize(),this.resolvedSchemas.has(o)}getLabelField(o){let e=this.getSchema(o);if(!e)return"name";for(let t of e.caption)if(e.allProperties[t])return t;return"name"}getColor(o){return this.getSchema(o)?.color||"#607D8B"}getProperty(o,e){let t=this.getSchema(o);return t&&t.allProperties[e]||null}getEntityLabel(o,e){let t=this.getLabelField(o);return e[t]?String(e[t]):e.name?String(e.name):o}},B=new ye;var F=(p=>(p.Person="Person",p.Event="Event",p.Location="Location",p.Company="Company",p.Email="Email",p.Phone="Phone",p.Username="Username",p.Vehicle="Vehicle",p.Website="Website",p.Evidence="Evidence",p.Image="Image",p.Text="Text",p))(F||{});function H(v){let o=B.getSchema(v);return o?{color:o.color||"#607D8B",label:o.label,plural:o.plural,description:o.description,labelField:B.getLabelField(v),requiredProperties:o.required,featuredProperties:o.featured,optionalProperties:o.optionalProperties,propertyDefinitions:o.allProperties}:null}function Te(){return B.getEntitySchemas().map(v=>({name:v.name,label:v.label,description:v.description,color:v.color||"#607D8B"}))}function Me(){return B.getIntervalSchemas().map(v=>({name:v.name,label:v.label,description:v.description,color:v.color||"#607D8B"}))}var D={Person:{color:"#4CAF50",properties:["full_name","age","height","nationality","occupation"],labelField:"full_name",description:"A person representing an individual"},Event:{color:"#F22416",properties:["name","description","start_date","end_date","add_to_timeline"],labelField:"name",description:"An event with date and time"},Location:{color:"#FF5722",properties:["address","city","state","country","postal_code","latitude","longitude","location_type"],labelField:"address",description:"A physical location or address"},Company:{color:"#037d9e",properties:["name","description"],labelField:"name",description:"A company or organization"},Email:{color:"#2196F3",properties:["address","domain"],labelField:"address",description:"An email address"},Phone:{color:"#b82549",properties:["number","phone_type","country_code"],labelField:"number",description:"A phone number"},Username:{color:"#21B57D",properties:["username","platform","link"],labelField:"username",description:"A username on a platform"},Vehicle:{color:"#6c5952",properties:["model","color","year","vin"],labelField:"model",description:"A vehicle"},Website:{color:"#9C27B0",properties:["url","domain","title","description","ip_address","status","technologies"],labelField:"title",description:"A website or web domain"},Evidence:{color:"#02bfd4",properties:["name","description","tampered"],labelField:"name",description:"Evidence in an investigation"},Image:{color:"#E9B96E",properties:["title","url","description"],labelField:"title",description:"An image"},Text:{color:"#D0BD1D",properties:["text"],labelField:"text",description:"A text note"}},J=["notes","source","image"];function ee(v,o){if(B.hasSchema(v))return B.getEntityLabel(v,o);let e=D[v];return e&&o[e.labelField]?String(o[e.labelField]):v}function U(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(v){let o=Math.random()*16|0;return(v==="x"?o:o&3|8).toString(16)})}function Q(v){return v.replace(/[\\/:*?"<>|]/g,"-").replace(/\s+/g," ").trim().substring(0,100)}var T=require("obsidian");var ke=require("obsidian");var A=class extends Error{constructor(e,t){super(t);this.type=e;this.name="GeocodingError"}},$=class ${constructor(){this.lastRequestTime=0}async geocodeAddressWithRetry(o,e,t,n,i){let r=null;for(let a=0;a<$.MAX_RETRIES;a++)try{return await this.geocodeAddressWithFallback(o,e,t,n)}catch(s){if(s instanceof A?r=s:r=new A("UNKNOWN",s instanceof Error?s.message:String(s)),r.type==="INVALID_INPUT"||r.type==="NOT_FOUND"&&a>0)throw r;if(a===$.MAX_RETRIES-1)break;let l=$.INITIAL_RETRY_DELAY*Math.pow(2,a),c=Math.round(l/1e3);console.log(`[GeocodingService] Retry attempt ${a+1}/${$.MAX_RETRIES} after ${c}s`),i&&i(a+1,$.MAX_RETRIES,c),await new Promise(d=>setTimeout(d,l))}throw new A("NETWORK_ERROR",`Failed to geocode after ${$.MAX_RETRIES} attempts. Please check your internet connection.`)}async geocodeAddressWithFallback(o,e,t,n){let i=[];if(o&&e&&n){i.push({components:[o,e,t,n].filter(l=>!!l),description:"full address"});let a=o.replace(/,?\s*nr\.?\s*\d+[\/\d]*/gi,"").trim();a!==o&&i.push({components:[a,e,t,n].filter(l=>!!l),description:"address without building number"});let s=o.replace(/^str\.?\s*/i,"").replace(/,?\s*nr\.?\s*\d+[\/\d]*/gi,"").trim();s!==o&&i.push({components:[s,e,t,n].filter(l=>!!l),description:"street name and city"})}e&&n&&i.push({components:[e,t,n].filter(a=>!!a),description:"city and country"}),e&&i.push({components:[e],description:"city only"}),i.length===0&&i.push({components:[o,e,t,n].filter(a=>!!a),description:"original query"});let r=null;for(let a of i)try{console.log(`[GeocodingService] Trying ${a.description}: ${a.components.join(", ")}`);let s=await this.geocodeAddress(a.components[0],a.components[1],a.components[2],a.components[3]);return a.description!=="full address"&&a.description!=="original query"&&console.log(`[GeocodingService] \u2713 Geocoded using ${a.description} fallback`),s}catch(s){if(s instanceof A){if(r=s,s.type==="NETWORK_ERROR"||s.type==="RATE_LIMITED")throw s;console.log(`[GeocodingService] ${a.description} not found, trying next fallback...`)}else throw s}throw r||new A("NOT_FOUND","Address not found. Please check the address or enter coordinates manually.")}async geocodeAddress(o,e,t,n){let i=[o,e,t,n].filter(Boolean);if(i.length===0)throw new A("INVALID_INPUT","Please provide at least an address, city, or country");await this.enforceRateLimit();let r=i.join(", ");console.log("[GeocodingService] Geocoding address:",r);try{let a=`${$.NOMINATIM_URL}?`+new URLSearchParams({q:r,format:"json",limit:"1",addressdetails:"1"}).toString(),s=await(0,ke.requestUrl)({url:a,method:"GET",headers:{"User-Agent":$.USER_AGENT,Accept:"application/json"},throw:!1});if(this.lastRequestTime=Date.now(),s.status===429)throw new A("RATE_LIMITED","Too many requests. Please wait a moment and try again.");if(s.status!==200)throw new A("NETWORK_ERROR",`Geocoding request failed with status ${s.status}`);let l=s.json;if(!l||l.length===0)throw new A("NOT_FOUND","Address not found. Please check the address or enter coordinates manually.");let c=l[0];console.log("[GeocodingService] Geocoding result:",c);let d="medium";c.importance>.7?d="high":c.importance<.3&&(d="low");let p=c.address?.city||c.address?.town||c.address?.village||c.address?.municipality;return{latitude:parseFloat(c.lat),longitude:parseFloat(c.lon),displayName:c.display_name,city:p,state:c.address?.state,country:c.address?.country,postalCode:c.address?.postcode,confidence:d}}catch(a){throw a instanceof A?a:(console.error("[GeocodingService] Geocoding error:",a),new A("NETWORK_ERROR","Failed to connect to geocoding service. Please check your internet connection."))}}async enforceRateLimit(){let e=Date.now()-this.lastRequestTime;if(e<$.MIN_REQUEST_INTERVAL){let t=$.MIN_REQUEST_INTERVAL-e;console.log(`[GeocodingService] Rate limiting: waiting ${t}ms`),await new Promise(n=>setTimeout(n,t))}}static validateCoordinates(o,e){return o>=-90&&o<=90&&e>=-180&&e<=180}static formatCoordinates(o,e,t=6){return`${o.toFixed(t)}, ${e.toFixed(t)}`}};$.NOMINATIM_URL="https://nominatim.openstreetmap.org/search",$.USER_AGENT="OSINTCopilot-Obsidian-Plugin/1.0 (https://github.com/Probe-Point-Analytics-LLC/OSINT-Copilot-plugin)",$.REQUEST_TIMEOUT=1e4,$.MIN_REQUEST_INTERVAL=1100,$.MAX_RETRIES=5,$.INITIAL_RETRY_DELAY=1e3;var O=$,fe=new O;var te=class{constructor(o,e="OSINTCopilot"){this.entities=new Map;this.connections=new Map;this.app=o,this.basePath=e}setBasePath(o){this.basePath=o}async initialize(){await this.ensureFolderExists(this.basePath);for(let o of Object.values(F))await this.ensureFolderExists(`${this.basePath}/${o}`);await this.ensureFolderExists(`${this.basePath}/Connections`),await this.loadEntitiesFromNotes()}async ensureFolderExists(o){let e=(0,T.normalizePath)(o);if(!this.app.vault.getAbstractFileByPath(e))try{await this.app.vault.createFolder(e)}catch(n){if(n instanceof Error&&!n.message.includes("Folder already exists"))throw console.error(`Failed to create folder ${e}:`,n),n}}async loadEntitiesFromNotes(){this.entities.clear(),this.connections.clear();for(let o of Object.values(F)){let e=(0,T.normalizePath)(`${this.basePath}/${o}`),t=this.app.vault.getAbstractFileByPath(e);if(t instanceof T.TFolder){for(let n of t.children)if(n instanceof T.TFile&&n.extension==="md"){let i=await this.parseEntityFromNote(n);i&&this.entities.set(i.id,i)}}}await this.loadConnectionsFromNotes(),await this.parseConnectionsFromNotes()}async parseEntityFromNote(o){try{let e=await this.app.vault.read(o),t=this.parseFrontmatter(e);if(!t||!t.type||!t.id)return null;let n=t.type;if(!Object.values(F).includes(n))return null;let i={},a=[...D[n].properties,...J];for(let s of a)t[s]!==void 0&&(i[s]=t[s]);return{id:t.id,type:n,label:t.label||ee(n,i),properties:i,filePath:o.path}}catch(e){return console.error(`Error parsing entity from ${o.path}:`,e),null}}parseFrontmatter(o){let e=o.match(/^---\n([\s\S]*?)\n---/);if(!e)return null;let t=e[1],n={},i=t.split(`
`);for(let r of i){let a=r.indexOf(":");if(a>0){let s=r.substring(0,a).trim(),l=r.substring(a+1).trim();(l.startsWith('"')&&l.endsWith('"')||l.startsWith("'")&&l.endsWith("'"))&&(l=l.slice(1,-1)),l==="true"?n[s]=!0:l==="false"?n[s]=!1:!isNaN(Number(l))&&l!==""?n[s]=Number(l):n[s]=l}}return n}async loadConnectionsFromNotes(){let o=(0,T.normalizePath)(`${this.basePath}/Connections`),e=this.app.vault.getAbstractFileByPath(o);if(e instanceof T.TFolder){for(let t of e.children)if(t instanceof T.TFile&&t.extension==="md"){let n=await this.parseConnectionFromNote(t);n&&this.connections.set(n.id,n)}}}async parseConnectionFromNote(o){try{let e=await this.app.vault.read(o),t=this.parseFrontmatter(e);if(!t||t.type!=="connection"||!t.id)return null;let n={},i=["id","type","relationship","fromEntityId","toEntityId","fromEntity","toEntity","ftmSchema","label"];for(let[r,a]of Object.entries(t))!i.includes(r)&&a!==void 0&&a!==null&&(n[r]=a);return{id:t.id,fromEntityId:t.fromEntityId,toEntityId:t.toEntityId,relationship:t.relationship,label:t.label,properties:Object.keys(n).length>0?n:void 0,ftmSchema:t.ftmSchema,filePath:o.path}}catch(e){return console.error(`Error parsing connection from ${o.path}:`,e),null}}async parseConnectionsFromNotes(){for(let o of this.entities.values()){if(!o.filePath)continue;let e=this.app.vault.getAbstractFileByPath(o.filePath);if(!(e instanceof T.TFile))continue;let t=await this.app.vault.read(e),n=this.parseRelationshipsFromContent(t,o.id);for(let i of n)this.connections.set(i.id,i)}}parseRelationshipsFromContent(o,e){let t=[],n=/\[\[([^\]]+)\]\]\s+([A-Z_]+)\s+\[\[([^\]]+)\]\]/g,i=/-\s+\[\[([^\]]+)\]\]\s+([A-Z_]+)/g,r;for(;(r=n.exec(o))!==null;){let a=r[3],s=r[2],l=this.findEntityByLabel(a);l&&t.push({id:U(),fromEntityId:e,toEntityId:l.id,relationship:s})}for(;(r=i.exec(o))!==null;){let a=r[1],s=r[2],l=this.findEntityByLabel(a);l&&l.id!==e&&t.push({id:U(),fromEntityId:e,toEntityId:l.id,relationship:s})}return t}findEntityByLabel(o){if(!o||typeof o!="string")return;let e=o.toLowerCase();for(let t of this.entities.values())if((t.label!=null?String(t.label):"").toLowerCase()===e)return t}async createEntity(o,e){let t=U();o==="Location"&&(e=await this.geocodeLocationIfNeeded(e));let n=ee(o,e),i={id:t,type:o,label:n,properties:e},r=await this.saveEntityAsNote(i);return i.filePath=r,this.entities.set(t,i),i}async createFTMEntity(o,e){let t=U();if(!H(o))throw new Error(`Unknown FTM schema: ${o}`);o==="Address"&&(e=await this.geocodeAddressIfNeeded(e));let i=B.getEntityLabel(o,e),r={id:t,type:o,label:i,properties:e,ftmSchema:o},a=await this.saveFTMEntityAsNote(r,o);return r.filePath=a,this.entities.set(t,r),r}async geocodeAddressIfNeeded(o){let e=o.latitude!==void 0&&o.latitude!==null&&o.latitude!=="",t=o.longitude!==void 0&&o.longitude!==null&&o.longitude!=="";if(e&&t)return o;let n=o.full||o.street,i=o.city,r=o.state||o.region,a=o.country;if(!n&&!i&&!r&&!a)return o;try{let s=await fe.geocodeAddressWithRetry(n,i,r,a);return{...o,latitude:s.latitude,longitude:s.longitude,city:o.city||s.city,state:o.state||s.state,country:o.country||s.country,postalCode:o.postalCode||s.postalCode}}catch(s){return console.warn("[EntityManager] FTM Address geocoding failed:",s),o}}async saveFTMEntityAsNote(o,e){let t=Q(o.label),n=(0,T.normalizePath)(`${this.basePath}/${e}`);await this.ensureFolderExists(n);let i=(0,T.normalizePath)(`${n}/${t}.md`),a=`---
${this.buildFTMFrontmatter(o,e)}
---

# ${o.label}

## Properties

${this.buildFTMPropertiesSection(o,e)}

## Relationships

<!-- Add relationships using wikilinks: [[Entity Name]] RELATIONSHIP_TYPE [[Target Entity]] -->

## Notes

${o.properties.notes||""}
`,s=this.app.vault.getAbstractFileByPath(i);return s instanceof T.TFile?await this.app.vault.modify(s,a):await this.app.vault.create(i,a),i}buildFTMFrontmatter(o,e){let t=[`id: "${o.id}"`,`type: ${o.type}`,`ftmSchema: ${e}`,`label: "${o.label}"`];if(!H(e))return t.join(`
`);for(let[i,r]of Object.entries(o.properties))r!=null&&r!==""&&(typeof r=="string"?t.push(`${i}: "${r.replace(/"/g,'\\"')}"`):typeof r=="boolean"?t.push(`${i}: ${r}`):t.push(`${i}: ${r}`));return t.join(`
`)}buildFTMPropertiesSection(o,e){let t=[],n=H(e);if(!n)return"_No properties set_";let i=[...n.requiredProperties,...n.featuredProperties],r=new Set;for(let a of i){if(r.has(a))continue;r.add(a);let s=o.properties[a],c=n.propertyDefinitions[a]?.label||a;s!=null&&s!==""&&t.push(`- **${c}**: ${s}`)}for(let[a,s]of Object.entries(o.properties)){if(r.has(a)||s==null||s===""||a==="notes")continue;let c=n.propertyDefinitions[a]?.label||a;t.push(`- **${c}**: ${s}`)}return t.length>0?t.join(`
`):"_No properties set_"}async geocodeLocationIfNeeded(o){let e=o.latitude!==void 0&&o.latitude!==null&&o.latitude!=="",t=o.longitude!==void 0&&o.longitude!==null&&o.longitude!=="";if(e&&t)return console.log("[EntityManager] Location already has coordinates:",o.latitude,o.longitude),o;let n=o.address,i=o.city,r=o.state,a=o.country;if(!n&&!i&&!r&&!a)return console.log("[EntityManager] No address fields available for geocoding"),o;try{console.log("[EntityManager] Attempting to geocode location:",{address:n,city:i,state:r,country:a});let s=await fe.geocodeAddressWithRetry(n,i,r,a),l={...o,latitude:s.latitude,longitude:s.longitude};return!i&&s.city&&(l.city=s.city),!r&&s.state&&(l.state=s.state),!a&&s.country&&(l.country=s.country),!o.postal_code&&s.postalCode&&(l.postal_code=s.postalCode),console.log("[EntityManager] Geocoding successful:",s.latitude,s.longitude,`(${s.confidence} confidence)`),new T.Notice(`\u{1F4CD} Location geocoded: ${s.displayName.substring(0,50)}...`),l}catch(s){return s instanceof A?(console.warn("[EntityManager] Geocoding failed:",s.type,s.message),s.type==="NOT_FOUND"?new T.Notice("\u26A0\uFE0F Could not find coordinates for location. You can add them manually."):s.type==="RATE_LIMITED"?new T.Notice("\u26A0\uFE0F Geocoding rate limited. Coordinates can be added manually."):new T.Notice(`\u26A0\uFE0F Geocoding failed: ${s.message}`)):(console.error("[EntityManager] Unexpected geocoding error:",s),new T.Notice("\u26A0\uFE0F Could not geocode location. You can add coordinates manually.")),o}}async retryGeocoding(o){let e=this.entities.get(o);if(!e)return console.warn("[EntityManager] Entity not found for geocoding retry:",o),!1;if(e.type!=="Location")return console.warn("[EntityManager] Cannot geocode non-Location entity:",e.type),!1;if(e.properties.latitude&&e.properties.longitude)return console.log("[EntityManager] Entity already has coordinates"),new T.Notice("\u{1F4CD} Location already has coordinates."),!0;try{let n=await this.geocodeLocationIfNeeded(e.properties);return n.latitude&&n.longitude?(e.properties=n,await this.saveEntityAsNote(e),console.log("[EntityManager] Geocoding retry successful for:",e.label),!0):(console.log("[EntityManager] Geocoding retry did not find coordinates"),!1)}catch(n){return console.error("[EntityManager] Geocoding retry failed:",n),!1}}getUnlocatedEntities(){return Array.from(this.entities.values()).filter(o=>{if(o.type!=="Location")return!1;let e=o.properties.latitude!==void 0&&o.properties.latitude!==null&&o.properties.latitude!=="",t=o.properties.longitude!==void 0&&o.properties.longitude!==null&&o.properties.longitude!=="";return!e||!t})}async geocodeAllUnlocated(){let o=this.getUnlocatedEntities(),e=0,t=0;new T.Notice(`\u{1F30D} Geocoding ${o.length} locations...`);for(let n of o)await this.retryGeocoding(n.id)?e++:t++;return new T.Notice(`\u{1F4CD} Geocoding complete: ${e} succeeded, ${t} failed`),{success:e,failed:t}}async saveEntityAsNote(o){let e=Q(o.label),t=(0,T.normalizePath)(`${this.basePath}/${o.type}`);await this.ensureFolderExists(t);let n=(0,T.normalizePath)(`${t}/${e}.md`),r=`---
${this.buildFrontmatter(o)}
---

# ${o.label}

## Properties

${this.buildPropertiesSection(o)}

## Relationships

<!-- Add relationships using wikilinks: [[Entity Name]] RELATIONSHIP_TYPE [[Target Entity]] -->

## Notes

${o.properties.notes||""}
`,a=this.app.vault.getAbstractFileByPath(n);return a instanceof T.TFile?await this.app.vault.modify(a,r):await this.app.vault.create(n,r),n}buildFrontmatter(o){let e=[`id: "${o.id}"`,`type: ${o.type}`,`label: "${o.label}"`],n=[...D[o.type].properties,...J];for(let i of n){let r=o.properties[i];r!=null&&r!==""&&(typeof r=="string"?e.push(`${i}: "${r.replace(/"/g,'\\"')}"`):typeof r=="boolean"?e.push(`${i}: ${r}`):e.push(`${i}: ${r}`))}return e.join(`
`)}buildPropertiesSection(o){let e=[],t=D[o.type];for(let n of t.properties){let i=o.properties[n];i!=null&&i!==""&&e.push(`- **${n}**: ${i}`)}return e.length>0?e.join(`
`):"_No properties set_"}async updateEntity(o,e){let t=this.entities.get(o);return t?(t.properties={...t.properties,...e},t.label=ee(t.type,t.properties),await this.saveEntityAsNote(t),t):null}async deleteEntity(o){let e=this.entities.get(o);if(!e)return!1;if(e.filePath){let t=this.app.vault.getAbstractFileByPath(e.filePath);t instanceof T.TFile&&await this.app.vault.delete(t)}this.entities.delete(o);for(let[t,n]of this.connections)(n.fromEntityId===o||n.toEntityId===o)&&this.connections.delete(t);return!0}deleteEntityInMemory(o){if(!this.entities.get(o))return!1;this.entities.delete(o);for(let[t,n]of this.connections)(n.fromEntityId===o||n.toEntityId===o)&&this.connections.delete(t);return!0}async restoreEntity(o){try{let e=`${this.basePath}/${o.type}`;await this.ensureFolderExists(e);let t=this.generateNoteContent(o),n=o.filePath||`${e}/${Q(o.label)}.md`,i=this.app.vault.getAbstractFileByPath(n);i?i instanceof T.TFile&&await this.app.vault.modify(i,t):await this.app.vault.create(n,t);let r={...o,filePath:n};return this.entities.set(o.id,r),!0}catch(e){return console.error("[EntityManager] Failed to restore entity:",e),!1}}async updateEntityForHistory(o){try{if(this.entities.set(o.id,o),o.filePath){let e=this.app.vault.getAbstractFileByPath(o.filePath);if(e instanceof T.TFile){let t=this.generateNoteContent(o);await this.app.vault.modify(e,t)}}return!0}catch(e){return console.error("[EntityManager] Failed to update entity:",e),!1}}generateNoteContent(o){let e=[],t=new Date().toISOString();e.push("---"),e.push(`id: ${o.id}`),e.push(`type: ${o.type}`),e.push(`label: "${o.label.replace(/"/g,'\\"')}"`),e.push(`created: ${t}`),e.push(`modified: ${t}`);for(let[n,i]of Object.entries(o.properties))if(i!=null&&i!==""){let r=typeof i=="string"?`"${i.replace(/"/g,'\\"')}"`:i;e.push(`${n}: ${r}`)}if(e.push("---"),e.push(""),e.push(`# ${o.label}`),e.push(""),e.push(`**Type:** ${o.type}`),e.push(""),Object.keys(o.properties).length>0){e.push("## Properties"),e.push("");for(let[n,i]of Object.entries(o.properties))i!=null&&i!==""&&e.push(`- **${n}:** ${i}`);e.push("")}return e.push("## Relationships"),e.push(""),e.join(`
`)}async deleteEntities(o){let e=0,t=[],n=new Set;for(let i of o)try{let r=this.entities.get(i);if(!r){t.push(i);continue}if(r.filePath){let a=this.app.vault.getAbstractFileByPath(r.filePath);a instanceof T.TFile&&await this.app.vault.delete(a)}this.entities.delete(i);for(let[a,s]of this.connections)(s.fromEntityId===i||s.toEntityId===i)&&n.add(a);e++}catch(r){console.error(`[EntityManager] Failed to delete entity ${i}:`,r),t.push(i)}for(let i of n)this.connections.delete(i);return{deleted:e,failed:t}}async createConnection(o,e,t,n){let i=this.entities.get(o),r=this.entities.get(e);if(!i||!r)return null;let a=U(),s=`${i.label} \u2192 ${t} \u2192 ${r.label}`,l={id:a,fromEntityId:o,toEntityId:e,relationship:t,label:s,properties:n||{},ftmSchema:t},c=await this.saveConnectionAsNote(l,i,r);return l.filePath=c,this.connections.set(l.id,l),await this.addRelationshipToNote(i,r,t),l}async updateConnection(o,e){let t=this.connections.get(o);if(!t)return null;let n=this.entities.get(t.fromEntityId),i=this.entities.get(t.toEntityId);if(!n||!i)return null;if(t.properties={...t.properties,...e},t.filePath){let r=this.app.vault.getAbstractFileByPath(t.filePath);if(r instanceof T.TFile){let a=this.generateConnectionNoteContent(t,n,i);await this.app.vault.modify(r,a)}}else{let r=await this.saveConnectionAsNote(t,n,i);t.filePath=r}return t}async updateConnectionForHistory(o){try{this.connections.set(o.id,o);let e=this.entities.get(o.fromEntityId),t=this.entities.get(o.toEntityId);if(!e||!t)return console.error("[EntityManager] Cannot update connection: entities not found"),!1;if(o.filePath){let n=this.app.vault.getAbstractFileByPath(o.filePath);if(n instanceof T.TFile){let i=this.generateConnectionNoteContent(o,e,t);await this.app.vault.modify(n,i)}}return!0}catch(e){return console.error("[EntityManager] Failed to update connection:",e),!1}}generateConnectionNoteContent(o,e,t){return`---
${this.buildConnectionFrontmatter(o,e,t)}
---

# ${o.label||o.relationship}

## Connection Details

- **From**: [[${e.label}]]
- **To**: [[${t.label}]]
- **Type**: ${o.relationship}

## Properties

${this.buildConnectionPropertiesSection(o)}

## Notes

<!-- Add additional notes about this connection here -->
`}async addRelationshipToNote(o,e,t){if(!o.filePath)return;let n=this.app.vault.getAbstractFileByPath(o.filePath);if(!(n instanceof T.TFile))return;let i=await this.app.vault.read(n),r=`- [[${o.label}]] ${t.toUpperCase()} [[${e.label}]]`,a=i.match(/(## Relationships\n)([\s\S]*?)((?=\n## )|$)/);if(a){let s=i.substring(0,a.index+a[1].length),l=a[2],c=i.substring(a.index+a[0].length);if(!l.includes(r)){let d=s+l.trimEnd()+`
`+r+`
`+c;await this.app.vault.modify(n,d)}}}async addIncomingRelationshipToNote(o,e,t){if(!o.filePath)return;let n=this.app.vault.getAbstractFileByPath(o.filePath);if(!(n instanceof T.TFile))return;let i=await this.app.vault.read(n),r=`- [[${e.label}]] ${t.toUpperCase()} [[${o.label}]]`,a=i.match(/(## Relationships\n)([\s\S]*?)((?=\n## )|$)/);if(a){let s=i.substring(0,a.index+a[1].length),l=a[2],c=i.substring(a.index+a[0].length);if(!l.includes(r)){let d=s+l.trimEnd()+`
`+r+`
`+c;await this.app.vault.modify(n,d)}}}async saveConnectionAsNote(o,e,t){let n=Q(`${e.label} - ${o.relationship} - ${t.label}`),i=(0,T.normalizePath)(`${this.basePath}/Connections`),r=(0,T.normalizePath)(`${i}/${n}.md`);await this.ensureFolderExists(i);let s=`---
${this.buildConnectionFrontmatter(o,e,t)}
---

# ${o.label||o.relationship}

## Connection Details

- **From**: [[${e.label}]]
- **To**: [[${t.label}]]
- **Type**: ${o.relationship}

## Properties

${this.buildConnectionPropertiesSection(o)}

## Notes

<!-- Add additional notes about this connection here -->
`,l=this.app.vault.getAbstractFileByPath(r);return l instanceof T.TFile?await this.app.vault.modify(l,s):await this.app.vault.create(r,s),r}buildConnectionFrontmatter(o,e,t){let n=[`id: "${o.id}"`,"type: connection",`relationship: "${o.relationship}"`,`fromEntityId: "${o.fromEntityId}"`,`toEntityId: "${o.toEntityId}"`,`fromEntity: "[[${e.label}]]"`,`toEntity: "[[${t.label}]]"`];if(o.ftmSchema&&n.push(`ftmSchema: "${o.ftmSchema}"`),o.label&&n.push(`label: "${o.label.replace(/"/g,'\\"')}"`),o.properties)for(let[i,r]of Object.entries(o.properties))r!=null&&r!==""&&(typeof r=="string"?n.push(`${i}: "${r.replace(/"/g,'\\"')}"`):typeof r=="boolean"?n.push(`${i}: ${r}`):n.push(`${i}: ${r}`));return n.join(`
`)}buildConnectionPropertiesSection(o){if(!o.properties||Object.keys(o.properties).length===0)return"_No additional properties_";let e=[];for(let[t,n]of Object.entries(o.properties))if(n!=null&&n!==""){let i=t.replace(/([A-Z])/g," $1").replace(/^./,r=>r.toUpperCase());e.push(`- **${i}**: ${n}`)}return e.length>0?e.join(`
`):"_No additional properties_"}getConnection(o){return this.connections.get(o)}async deleteConnectionWithNote(o){let e=this.connections.get(o);if(!e)return!1;let t=this.entities.get(e.fromEntityId);if(t&&t.filePath){let n=this.app.vault.getAbstractFileByPath(t.filePath);if(n instanceof T.TFile)try{let i=await this.app.vault.read(n),r=this.entities.get(e.toEntityId);if(r){let a=`- [[${r.label}]] (${e.relationship})`,s=`- [[${r.filePath?.replace(".md","")}]] (${e.relationship})`;i=i.replace(new RegExp(`^${this.escapeRegex(a)}\\n?`,"gm"),""),i=i.replace(new RegExp(`^${this.escapeRegex(s)}\\n?`,"gm"),""),await this.app.vault.modify(n,i)}}catch(i){console.error("[EntityManager] Failed to update note for connection deletion:",i)}}return this.connections.delete(o)}escapeRegex(o){return o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}deleteConnection(o){return this.connections.delete(o)}async restoreConnection(o){this.connections.set(o.id,o);let e=this.entities.get(o.fromEntityId),t=this.entities.get(o.toEntityId);return e&&t&&await this.addRelationshipToNote(e,t,o.relationship),!0}getAllEntities(){return Array.from(this.entities.values())}getEntitiesByType(o){let e=Array.from(this.entities.values()).filter(t=>t.type===o);return console.log(`[EntityManager] getEntitiesByType(${o}): found ${e.length} entities`),o==="Location"&&e.forEach(t=>{console.log(`[EntityManager] Location entity: ${t.label}, lat: ${t.properties.latitude}, lng: ${t.properties.longitude}`)}),e}getEntity(o){return this.entities.get(o)}getAllConnections(){return Array.from(this.connections.values())}getConnectionsForEntity(o){return Array.from(this.connections.values()).filter(e=>e.fromEntityId===o||e.toEntityId===o)}getGraphData(){return{entities:this.getAllEntities(),connections:this.getAllConnections()}}async openEntityNote(o){let e=this.entities.get(o);if(!e||!e.filePath)return;let t=this.app.vault.getAbstractFileByPath(e.filePath);t instanceof T.TFile&&await this.app.workspace.getLeaf().openFile(t)}};var He={maxRetries:7,baseDelayMs:1e3,maxDelayMs:32e3,baseTimeoutMs:45e3,maxTimeoutMs:12e4,timeoutMultiplierOnTimeout:1.5},ne=class{constructor(o="https://api.osint-copilot.com",e=""){this.isOnline=!1;this.baseUrl=o,this.apiKey=e,this.retryConfig={...He}}setRetryConfig(o){this.retryConfig={...this.retryConfig,...o}}getRetryConfig(){return{...this.retryConfig}}setBaseUrl(o){this.baseUrl=o}setApiKey(o){this.apiKey=o}getHeaders(){let o={"Content-Type":"application/json"};return this.apiKey&&(o.Authorization=`Bearer ${this.apiKey}`),o}async checkHealth(){try{let o=await fetch(`${this.baseUrl}/health`,{method:"GET",headers:this.getHeaders(),mode:"cors",credentials:"omit"});if(o.ok)return this.isOnline=!0,await o.json();let e=await fetch(`${this.baseUrl}/`,{method:"GET",headers:this.getHeaders(),mode:"cors",credentials:"omit"});return e.ok?(this.isOnline=!0,await e.json()):(this.isOnline=!1,null)}catch{return this.isOnline=!1,console.log("[GraphApiService] AI API unavailable - entity generation from text will not work"),null}}getOnlineStatus(){return this.isOnline}async fetchWithTimeout(o,e,t=3e4){let n=new AbortController,i=setTimeout(()=>n.abort(),t);try{return await fetch(o,{...e,signal:n.signal})}finally{clearTimeout(i)}}isTimeoutError(o){return o instanceof DOMException&&o.name==="AbortError"}isNetworkError(o){if(o instanceof TypeError){let e=String(o).toLowerCase();return e.includes("failed to fetch")||e.includes("network")||e.includes("connection")}return!1}isRetryableError(o,e){return!!(this.isTimeoutError(o)||this.isNetworkError(o)||o instanceof TypeError||e&&e>=500&&e<600||e===429||e===503||e===504)}getErrorReason(o,e){return this.isTimeoutError(o)?"timeout":this.isNetworkError(o)?"network":e===429?"rate-limited":e&&e>=500?`server-error-${e}`:"unknown"}getErrorMessage(o,e){return this.isTimeoutError(o)?"Request timed out. The server may be busy or your connection is slow.":this.isNetworkError(o)?"Network connection failed. Please check your internet connection.":o instanceof TypeError?"Network error occurred. Please check your connection and try again.":e&&e>=500?e===503?"Service temporarily unavailable. The server is overloaded or under maintenance.":e===504?"Gateway timeout. The server took too long to respond.":`Server error (${e}). The service is temporarily unavailable.`:e===429?"Too many requests. Please wait a moment before trying again.":o instanceof Error?o.message:String(o)}calculateBackoffDelay(o){let e=this.retryConfig.baseDelayMs*Math.pow(2,o-1),t=e*.25*(Math.random()*2-1);return Math.min(e+t,this.retryConfig.maxDelayMs)}calculateTimeout(o,e){if(e){let t=o*this.retryConfig.timeoutMultiplierOnTimeout;return Math.min(t,this.retryConfig.maxTimeoutMs)}return o}async processText(o,e,t,n){if(this.isOnline||await this.checkHealth(),!this.isOnline)return{success:!1,error:`AI API is offline. Entity generation from text is not available.

You can still:
\u2022 Create entities manually using the Graph View
\u2022 Edit existing entities
\u2022 Create connections between entities
\u2022 View entities on the map`};console.log("[GraphApiService] Processing text with AI:",o.substring(0,100)+"...");let{maxRetries:i,baseTimeoutMs:r}=this.retryConfig,a=r,s=null,l,c=!1;for(let u=1;u<=i;u++)try{c&&(a=this.calculateTimeout(a,!0),console.log(`[GraphApiService] Increased timeout to ${a}ms after timeout error`)),console.log(`[GraphApiService] Attempt ${u}/${i} with ${a}ms timeout`);let g=await this.fetchWithTimeout(`${this.baseUrl}/api/process-text`,{method:"POST",headers:this.getHeaders(),mode:"cors",credentials:"omit",body:JSON.stringify({text:o,existing_entities:e?.map(y=>({id:y.id,type:y.type,label:y.label,properties:y.properties})),reference_time:t})},a);if(g.ok){let y=await g.json();return console.log("[GraphApiService] AI processing successful:",y),y}else{let y=await g.text();if(console.error(`[GraphApiService] API error (attempt ${u}/${i}):`,g.status,y),l=g.status,g.status>=400&&g.status<500&&g.status!==429)return g.status===401||g.status===403?{success:!1,error:"Authentication required. Please configure your API key in Settings \u2192 OSINT Copilot \u2192 API Key"}:g.status===404?{success:!1,error:"API endpoint not found. Please check that the API server is running and the URL is correct."}:{success:!1,error:`API error (${g.status}): ${y}`};if(s=new Error(`HTTP ${g.status}: ${y}`),u<i){let h=this.calculateBackoffDelay(u),m=this.getErrorReason(s,g.status);console.log(`[GraphApiService] Retrying in ${Math.round(h)}ms (reason: ${m})...`),n&&n(u,i,m,h),await new Promise(f=>setTimeout(f,h));continue}}}catch(g){if(console.error(`[GraphApiService] Process text failed (attempt ${u}/${i}):`,g),s=g,this.isTimeoutError(g)&&(c=!0),this.isRetryableError(g)&&u<i){let y=this.calculateBackoffDelay(u),h=this.getErrorReason(g,l);console.log(`[GraphApiService] ${h} error, retrying in ${Math.round(y)}ms...`),n&&n(u,i,h,y),await new Promise(m=>setTimeout(m,y));continue}this.isRetryableError(g)||(this.isOnline=!1)}let d=this.getErrorMessage(s,l);console.error("[GraphApiService] All retries exhausted:",d);let p="\u{1F4A1} This may be a temporary network issue. Please try again in a moment.";return this.isTimeoutError(s)?p="\u{1F4A1} The request timed out. Try again when your connection is more stable, or the server may be under heavy load.":this.isNetworkError(s)?p="\u{1F4A1} Network connection failed. Please check your internet connection and try again.":l&&l>=500&&(p="\u{1F4A1} The server is experiencing issues. Please try again later."),{success:!1,error:`Entity extraction failed after ${i} attempts: ${d}

${p}`,originalText:o}}};var W=require("obsidian"),ie=class{constructor(o,e){this.conversationList=[];this.currentConversationId=null;this.saveInProgress=!1;this.pendingSave=!1;this.app=o,this.basePath=e}setBasePath(o){this.basePath=o}setCurrentConversationId(o){this.currentConversationId=o}async initialize(){await this.ensureFolderExists(this.basePath),await this.loadConversationList()}async ensureFolderExists(o){let e=(0,W.normalizePath)(o);if(this.app.vault.getAbstractFileByPath(e))return;let n=e.split("/"),i="";for(let r of n)if(i=i?`${i}/${r}`:r,!this.app.vault.getAbstractFileByPath(i))try{await this.app.vault.createFolder(i)}catch(s){if(!s?.message?.includes("Folder already exists"))throw s}}async loadConversationList(){this.conversationList=[];let o=(0,W.normalizePath)(this.basePath);if(!await this.app.vault.adapter.exists(o))return[];try{let t=await this.app.vault.adapter.list(o);for(let n of t.files)if(n.endsWith(".md")){let i=await this.parseConversationMetadataFromPath(n);i&&this.conversationList.push(i)}}catch(t){return console.error("Failed to list conversation files:",t),[]}return this.conversationList.sort((t,n)=>n.updatedAt-t.updatedAt),this.conversationList}getConversationList(){return this.conversationList}async parseConversationMetadataFromPath(o){try{let e=await this.app.vault.adapter.read(o);return this.parseMetadataFromContent(e,o)}catch(e){return console.error("Failed to parse conversation metadata from path:",o,e),null}}async parseConversationMetadata(o){try{let e=await this.app.vault.read(o);return this.parseMetadataFromContent(e,o.path)}catch(e){return console.error("Failed to parse conversation metadata:",e),null}}parseMetadataFromContent(o,e){let t=o.match(/^---\n([\s\S]*?)\n---/);if(!t)return null;let n=t[1],i=e.split("/").pop()?.replace(".md","")||"unknown",r=this.extractYamlValue(n,"id")||i,a=this.extractYamlValue(n,"title")||"Untitled",s=parseInt(this.extractYamlValue(n,"createdAt")||"0"),l=parseInt(this.extractYamlValue(n,"updatedAt")||"0"),c=parseInt(this.extractYamlValue(n,"messageCount")||"0"),d=this.extractYamlValue(n,"darkWebMode")==="true",p=this.extractYamlValue(n,"entityGenerationMode")==="true",u=this.extractYamlValue(n,"reportGenerationMode")==="true",g=this.extractYamlValue(n,"lookupMode"),y=g===null?!d&&!u:g==="true",h=this.extractYamlValue(n,"reportConversationId");return{id:r,title:a,createdAt:s,updatedAt:l,messageCount:c,lookupMode:y,darkWebMode:d,entityGenerationMode:p,reportGenerationMode:u,reportConversationId:h||void 0}}extractYamlValue(o,e){let t=o.match(new RegExp(`^${e}:\\s*(.*)$`,"m"));return t?t[1].trim():null}async loadConversation(o){let e=(0,W.normalizePath)(`${this.basePath}/${o}.md`);if(!await this.app.vault.adapter.exists(e))return null;try{let n=await this.app.vault.adapter.read(e),i=this.parseMetadataFromContent(n,e);if(!i)return null;let r=n.match(/```json:messages\n([\s\S]*?)\n```/),a=[];if(r)try{a=JSON.parse(r[1])}catch(s){console.error("Failed to parse messages JSON:",s)}return{...i,messages:a}}catch(n){return console.error("Failed to load conversation:",n),null}}generateId(){return`conv-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateTitle(o){if(!o)return"New Conversation";let e=o.substring(0,50);return e.length<o.length?e+"...":e}async createConversation(o,e=!1,t=!1,n=!1){let i=this.generateId(),r=Date.now(),a=!e&&!n,s={id:i,title:this.generateTitle(o),createdAt:r,updatedAt:r,messageCount:0,lookupMode:a,darkWebMode:e,entityGenerationMode:t,reportGenerationMode:n,messages:[]};return await this.saveConversation(s),this.currentConversationId=i,s}async saveConversation(o){if(this.saveInProgress){this.pendingSave=!0;return}this.saveInProgress=!0;try{for(await this.doSaveConversation(o);this.pendingSave;)this.pendingSave=!1,await this.doSaveConversation(o)}finally{this.saveInProgress=!1}}async doSaveConversation(o){await this.ensureFolderExists(this.basePath);let e=(0,W.normalizePath)(`${this.basePath}/${o.id}.md`);o.updatedAt=Date.now(),o.messageCount=o.messages.length;let t=this.serializeConversation(o);if(await this.app.vault.adapter.exists(e))await this.app.vault.adapter.write(e,t);else try{await this.app.vault.create(e,t)}catch(i){let r=String(i?.message||i||"").toLowerCase();if(r.includes("already exists")||r.includes("file exists"))await this.app.vault.adapter.write(e,t);else throw i}await this.loadConversationList()}serializeConversation(o){let e=["---",`id: ${o.id}`,`title: ${o.title}`,`createdAt: ${o.createdAt}`,`updatedAt: ${o.updatedAt}`,`messageCount: ${o.messageCount}`,`lookupMode: ${o.lookupMode}`,`darkWebMode: ${o.darkWebMode}`,`entityGenerationMode: ${o.entityGenerationMode||!1}`,`reportGenerationMode: ${o.reportGenerationMode||!1}`];o.reportConversationId&&e.push(`reportConversationId: ${o.reportConversationId}`),e.push("---","");let t=e.join(`
`),n=["```json:messages",JSON.stringify(o.messages,null,2),"```"].join(`
`);return t+n}async deleteConversation(o){let e=(0,W.normalizePath)(`${this.basePath}/${o}.md`);try{return await this.app.vault.adapter.exists(e)?(await this.app.vault.adapter.remove(e),this.currentConversationId===o&&(this.currentConversationId=null),this.conversationList=this.conversationList.filter(n=>n.id!==o),!0):(console.warn(`ConversationService: File not found for deletion: ${e}`),this.conversationList=this.conversationList.filter(n=>n.id!==o),!1)}catch(t){return console.error(`ConversationService: Failed to delete conversation ${o}:`,t),!1}}async renameConversation(o,e){let t=await this.loadConversation(o);return t?(t.title=e,await this.saveConversation(t),!0):!1}async getMostRecentConversation(){return await this.loadConversationList(),this.conversationList.length===0?null:this.loadConversation(this.conversationList[0].id)}};var w=require("obsidian");var E=require("obsidian");var Oe=["WORKS_AT","ATTENDED","LOCATED_AT","KNOWS","OWNS","MEMBER_OF","RELATED_TO","CONTACTED","VISITED","EMPLOYED_BY","LIVES_AT","ASSOCIATED_WITH","PARENT_OF","CHILD_OF","SIBLING_OF","SPOUSE_OF","FRIEND_OF","COLLEAGUE_OF"],j=class extends E.Modal{constructor(e,t,n,i){super(e);this.properties={};this.geocodeStatusEl=null;this.geocodeBtn=null;this.entityManager=t,this.entityType=n,this.onEntityCreated=i||null,this.geocodingService=new O}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("graph_copilot-entity-modal");let t=D[this.entityType];e.createEl("h2",{text:`Create ${this.entityType}`}),e.createEl("p",{text:t.description,cls:"graph_copilot-entity-modal-description"});let n=e.createDiv({cls:"graph_copilot-entity-form"}),i=["address","city","state","country","postal_code"],r=["latitude","longitude"];for(let d of t.properties)this.entityType==="Location"&&r.includes(d)||this.createPropertyField(n,d,d===t.labelField);if(this.entityType==="Location"){this.createGeocodeSection(n);for(let d of r)this.createPropertyField(n,d,!1)}e.createEl("h4",{text:"Additional Properties"});let a=e.createDiv({cls:"graph_copilot-entity-form"});for(let d of J)d!=="image"&&this.createPropertyField(a,d,!1);let s=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),l=s.createEl("button",{text:"Create Entity",cls:"mod-cta"});l.onclick=()=>this.handleCreate();let c=s.createEl("button",{text:"Cancel"});c.onclick=()=>this.close()}createGeocodeSection(e){let t=e.createDiv({cls:"graph_copilot-geocode-section"});this.geocodeBtn=t.createEl("button",{text:"\u{1F4CD} Geocode Address",cls:"graph_copilot-geocode-btn"}),this.geocodeStatusEl=t.createEl("span",{cls:"graph_copilot-geocode-status"}),t.createEl("small",{text:"Convert address to coordinates using OpenStreetMap",cls:"graph_copilot-geocode-help"}),this.geocodeBtn.onclick=async()=>{await this.handleGeocode()}}async handleGeocode(){if(!this.geocodeBtn||!this.geocodeStatusEl)return;let e=this.properties.address||"",t=this.properties.city||"",n=this.properties.state||"",i=this.properties.country||"";if(!e&&!t&&!i){this.setGeocodeStatus("error","Please enter an address, city, or country first");return}this.geocodeBtn.disabled=!0,this.geocodeBtn.textContent="\u23F3 Geocoding...",this.setGeocodeStatus("loading","Looking up coordinates...");try{let r=await this.geocodingService.geocodeAddressWithRetry(e,t,n,i,(d,p,u)=>{this.setGeocodeStatus("loading",`Network error, retrying in ${u}s... (attempt ${d}/${p})`)});this.properties.latitude=r.latitude,this.properties.longitude=r.longitude;let a=document.getElementById("entity-latitude"),s=document.getElementById("entity-longitude");a&&(a.value=r.latitude.toString()),s&&(s.value=r.longitude.toString());let c=`\u2713 Found: ${O.formatCoordinates(r.latitude,r.longitude)}`;if(r.confidence==="low"&&(c+=" (low confidence - please verify)"),this.setGeocodeStatus("success",c),!this.properties.city&&r.city){this.properties.city=r.city;let d=document.getElementById("entity-city");d&&(d.value=r.city)}if(!this.properties.state&&r.state){this.properties.state=r.state;let d=document.getElementById("entity-state");d&&(d.value=r.state)}if(!this.properties.country&&r.country){this.properties.country=r.country;let d=document.getElementById("entity-country");d&&(d.value=r.country)}if(!this.properties.postal_code&&r.postalCode){this.properties.postal_code=r.postalCode;let d=document.getElementById("entity-postal_code");d&&(d.value=r.postalCode)}}catch(r){if(console.error("[EntityModal] Geocoding error:",r),r instanceof A)switch(r.type){case"NOT_FOUND":this.setGeocodeStatus("error","\u2717 Address not found. Please check the address or enter coordinates manually.");break;case"RATE_LIMITED":this.setGeocodeStatus("error","\u2717 Too many requests. Please wait a moment and try again.");break;case"NETWORK_ERROR":this.setGeocodeStatus("error","\u2717 Network error. Please check your internet connection.");break;case"INVALID_INPUT":this.setGeocodeStatus("error","\u2717 "+r.message);break;default:this.setGeocodeStatus("error","\u2717 Geocoding failed. Please enter coordinates manually.")}else this.setGeocodeStatus("error","\u2717 Geocoding failed. Please enter coordinates manually.")}finally{this.geocodeBtn&&(this.geocodeBtn.disabled=!1,this.geocodeBtn.textContent="\u{1F4CD} Geocode Address")}}setGeocodeStatus(e,t){this.geocodeStatusEl&&(this.geocodeStatusEl.textContent=t,this.geocodeStatusEl.removeClass("graph_copilot-geocode-status-success"),this.geocodeStatusEl.removeClass("graph_copilot-geocode-status-error"),this.geocodeStatusEl.removeClass("graph_copilot-geocode-status-loading"),this.geocodeStatusEl.addClass(`graph_copilot-geocode-status-${e}`))}createPropertyField(e,t,n){let i=e.createDiv({cls:"graph_copilot-entity-field"});i.createEl("label",{text:this.formatPropertyName(t)+(n?" *":"")}).setAttribute("for",`entity-${t}`);let a;if(t==="notes"||t==="description"||t==="text")a=i.createEl("textarea",{placeholder:`Enter ${this.formatPropertyName(t).toLowerCase()}...`}),a.rows=3;else if(t==="start_date"||t==="end_date")a=i.createEl("input",{type:"datetime-local"});else if(t==="latitude"||t==="longitude")a=i.createEl("input",{type:"number",placeholder:t==="latitude"?"-90 to 90":"-180 to 180"}),a.step="any";else if(t==="add_to_timeline"||t==="tampered"){let s=i.createDiv({cls:"graph_copilot-toggle-container"});s.style.cssText="display: flex; align-items: center; gap: 12px; margin-top: 4px;",a=s.createEl("input",{type:"checkbox"}),a.id=`entity-${t}`,a.style.display="none";let l=s.createEl("button",{cls:"graph_copilot-toggle-btn"});l.type="button",l.style.cssText=`
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 10px 20px;
                font-size: 14px;
                font-weight: 500;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s ease;
                border: 2px solid var(--background-modifier-border);
                background: var(--background-secondary);
                color: var(--text-muted);
            `;let c=l.createSpan({cls:"toggle-icon"});c.textContent="\u{1F4C5}",c.style.fontSize="16px";let d=l.createSpan({cls:"toggle-text"});d.textContent="Add to Timeline";let p=u=>{u?(l.style.background="var(--interactive-accent)",l.style.borderColor="var(--interactive-accent)",l.style.color="white",d.textContent="On Timeline \u2713"):(l.style.background="var(--background-secondary)",l.style.borderColor="var(--background-modifier-border)",l.style.color="var(--text-muted)",d.textContent="Add to Timeline")};p(!1),l.addEventListener("click",()=>{let u=!a.checked;a.checked=u,this.properties[t]=u,p(u)}),l.addEventListener("mouseenter",()=>{a.checked||(l.style.borderColor="var(--interactive-accent)",l.style.color="var(--text-normal)")}),l.addEventListener("mouseleave",()=>{p(a.checked)});return}else a=i.createEl("input",{type:"text",placeholder:`Enter ${this.formatPropertyName(t).toLowerCase()}...`});a.id=`entity-${t}`,a.addClass("graph_copilot-entity-input"),a.addEventListener("input",()=>{if(a.type==="datetime-local"){let s=a.value;s&&(this.properties[t]=s.replace("T"," "))}else if(a.type==="number"){let s=parseFloat(a.value);isNaN(s)||(this.properties[t]=s)}else this.properties[t]=a.value}),a.addEventListener("change",()=>{if(a.type==="datetime-local"){let s=a.value;s&&(this.properties[t]=s.replace("T"," "))}})}formatPropertyName(e){return e.split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}async handleCreate(){let t=D[this.entityType].labelField;if(!this.properties[t]||this.properties[t].trim()===""){new E.Notice(`Please enter a ${this.formatPropertyName(t)}`);return}this.entityType==="Location"&&await this.autoGeocodeIfNeeded();try{let n=await this.entityManager.createEntity(this.entityType,this.properties);new E.Notice(`Created ${this.entityType}: ${n.label}`),this.onEntityCreated&&this.onEntityCreated(n.id),this.close()}catch(n){new E.Notice(`Failed to create entity: ${n}`),console.error("Entity creation error:",n)}}async autoGeocodeIfNeeded(){let e=this.properties.latitude&&this.properties.longitude,t=this.properties.address||this.properties.city||this.properties.country;if(!(e||!t)){console.log("[EntityCreationModal] Auto-geocoding location..."),this.setGeocodeStatus("loading","Auto-geocoding address...");try{let n=await this.geocodingService.geocodeAddressWithRetry(this.properties.address,this.properties.city,this.properties.state,this.properties.country,(s,l,c)=>{this.setGeocodeStatus("loading",`Network error, retrying in ${c}s... (attempt ${s}/${l})`)});this.properties.latitude=n.latitude,this.properties.longitude=n.longitude;let i=document.getElementById("entity-latitude"),r=document.getElementById("entity-longitude");if(i&&(i.value=n.latitude.toString()),r&&(r.value=n.longitude.toString()),!this.properties.city&&n.city){this.properties.city=n.city;let s=document.getElementById("entity-city");s&&(s.value=n.city)}if(!this.properties.state&&n.state){this.properties.state=n.state;let s=document.getElementById("entity-state");s&&(s.value=n.state)}if(!this.properties.country&&n.country){this.properties.country=n.country;let s=document.getElementById("entity-country");s&&(s.value=n.country)}let a=O.formatCoordinates(n.latitude,n.longitude);this.setGeocodeStatus("success",`\u2713 Auto-geocoded: ${a}`),console.log("[EntityCreationModal] Auto-geocoded successfully:",a)}catch(n){console.warn("[EntityCreationModal] Auto-geocoding failed:",n),this.setGeocodeStatus("error","\u26A0 Auto-geocoding failed - entity will be created without coordinates")}}}onClose(){let{contentEl:e}=this;e.empty()}};var oe=class extends E.Modal{constructor(e,t,n,i,r){super(e);this.sourceEntityId=null;this.targetEntityId=null;this.relationship="";this.entities=[];this.entityManager=t,this.onConnectionCreated=n||null,this.sourceEntityId=i||null,this.targetEntityId=r||null}onOpen(){let{contentEl:e}=this;if(e.empty(),e.addClass("graph_copilot-connection-modal"),this.entities=this.entityManager.getAllEntities(),e.createEl("h2",{text:"Create Connection"}),e.createEl("p",{text:"Create a relationship between two entities",cls:"graph_copilot-entity-modal-description"}),this.entities.length<2){e.createEl("p",{text:"You need at least 2 entities to create a connection.",cls:"graph_copilot-connection-warning"});let s=e.createEl("button",{text:"Close"});s.onclick=()=>this.close();return}let t=e.createDiv({cls:"graph_copilot-entity-form"});this.createEntityDropdown(t,"Source Entity","source");let n=t.createDiv({cls:"graph_copilot-connection-arrow"});n.textContent="\u2193",this.createEntityDropdown(t,"Target Entity","target"),this.createRelationshipInput(t);let i=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),r=i.createEl("button",{text:"Create Connection",cls:"mod-cta"});r.onclick=()=>this.handleCreate();let a=i.createEl("button",{text:"Cancel"});a.onclick=()=>this.close()}createEntityDropdown(e,t,n){let i=e.createDiv({cls:"graph_copilot-entity-field"});i.createEl("label",{text:t+" *"});let r=i.createEl("select",{cls:"graph_copilot-entity-input"}),a=r.createEl("option",{text:`Select ${t.toLowerCase()}...`,value:""});a.disabled=!0;let s=n==="source"?this.sourceEntityId:this.targetEntityId;a.selected=!s;for(let l of this.entities){let c=r.createEl("option",{text:`${l.label} (${l.type})`,value:l.id});s&&l.id===s&&(c.selected=!0)}r.onchange=()=>{n==="source"?this.sourceEntityId=r.value||null:this.targetEntityId=r.value||null}}createRelationshipInput(e){let t=e.createDiv({cls:"graph_copilot-entity-field"});t.createEl("label",{text:"Relationship Type *"});let n=t.createEl("input",{type:"text",placeholder:"e.g., WORKS_AT, KNOWS, LOCATED_AT...",cls:"graph_copilot-entity-input"});n.oninput=()=>{this.relationship=n.value.toUpperCase().replace(/\s+/g,"_"),n.value=this.relationship};let i=t.createDiv({cls:"graph_copilot-relationship-suggestions"});i.createEl("small",{text:"Suggestions: "});let r=i.createSpan();Oe.slice(0,6).forEach(a=>{let s=r.createEl("span",{text:a,cls:"graph_copilot-relationship-chip"});s.onclick=()=>{this.relationship=a,n.value=a}})}async handleCreate(){if(!this.sourceEntityId){new E.Notice("Please select a source entity");return}if(!this.targetEntityId){new E.Notice("Please select a target entity");return}if(this.sourceEntityId===this.targetEntityId){new E.Notice("Source and target entities must be different");return}if(!this.relationship.trim()){new E.Notice("Please enter a relationship type");return}try{let e=await this.entityManager.createConnection(this.sourceEntityId,this.targetEntityId,this.relationship);if(e){let t=this.entityManager.getEntity(this.sourceEntityId),n=this.entityManager.getEntity(this.targetEntityId);new E.Notice(`Created: ${t?.label} \u2192 ${this.relationship} \u2192 ${n?.label}`),this.onConnectionCreated&&this.onConnectionCreated(e.id),this.close()}else new E.Notice("Failed to create connection")}catch(e){new E.Notice(`Failed to create connection: ${e}`),console.error("Connection creation error:",e)}}onClose(){let{contentEl:e}=this;e.empty()}},re=class extends E.Modal{constructor(e,t,n,i,r,a,s){super(e);this.relationship="";this.properties={};this.propertiesContainer=null;this.entityManager=t,this.sourceEntityId=n,this.targetEntityId=i,this.sourceLabel=r,this.targetLabel=a,this.onConnectionCreated=s||null}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("graph_copilot-connection-modal"),e.createEl("h2",{text:"Create Connection"});let t=e.createDiv({cls:"graph_copilot-connection-entities"}),n=t.createDiv({cls:"graph_copilot-connection-entity"});n.createEl("span",{text:"From:",cls:"graph_copilot-connection-label"}),n.createEl("strong",{text:this.sourceLabel});let i=t.createDiv({cls:"graph_copilot-connection-arrow-horizontal"});i.textContent="\u2192";let r=t.createDiv({cls:"graph_copilot-connection-entity"});r.createEl("span",{text:"To:",cls:"graph_copilot-connection-label"}),r.createEl("strong",{text:this.targetLabel});let s=e.createDiv({cls:"graph_copilot-entity-form"}).createDiv({cls:"graph_copilot-entity-field"});s.createEl("label",{text:"Relationship Type *"});let l=s.createEl("select",{cls:"graph_copilot-entity-input"}),c=l.createEl("option",{text:"Select relationship type...",value:""});c.disabled=!0,c.selected=!0;let d=Me();d.sort((y,h)=>y.label.localeCompare(h.label));for(let y of d){let h=l.createEl("option",{text:`${y.label} - ${y.description}`,value:y.name})}l.onchange=()=>{this.relationship=l.value,this.renderPropertyFields(this.relationship)},l.focus(),this.propertiesContainer=e.createDiv({cls:"graph_copilot-entity-form"}),this.propertiesContainer.style.marginTop="16px";let p=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),u=p.createEl("button",{text:"Create Connection",cls:"mod-cta"});u.onclick=()=>this.handleCreate();let g=p.createEl("button",{text:"Cancel"});g.onclick=()=>this.close()}renderPropertyFields(e){if(!this.propertiesContainer||(this.propertiesContainer.empty(),this.properties={},!e))return;let t=H(e);if(!t)return;let n=[...t.featuredProperties,...t.optionalProperties].filter(i=>{let r=t.propertyDefinitions[i];return r&&r.type!=="entity"&&!r.hidden});if(n.length!==0){this.propertiesContainer.createEl("h4",{text:"Connection Properties"});for(let i of n){let r=t.propertyDefinitions[i];if(!r)continue;let a=t.requiredProperties.includes(i);this.createPropertyField(i,r,a)}}}createPropertyField(e,t,n){if(!this.propertiesContainer)return;let i=this.propertiesContainer.createDiv({cls:"graph_copilot-entity-field"});i.createEl("label",{text:t.label+(n?" *":"")}).setAttribute("for",`conn-${e}`);let a;t.type==="text"||e==="description"||e==="summary"?(a=i.createEl("textarea",{placeholder:`Enter ${t.label.toLowerCase()}...`}),a.rows=3):t.type==="date"||e.includes("Date")?a=i.createEl("input",{type:"date"}):t.type==="number"||e.includes("percentage")||e.includes("Count")||e.includes("Value")||e.includes("amount")?(a=i.createEl("input",{type:"number",placeholder:`Enter ${t.label.toLowerCase()}...`}),a.step="any"):a=i.createEl("input",{type:"text",placeholder:`Enter ${t.label.toLowerCase()}...`}),a.id=`conn-${e}`,a.addClass("graph_copilot-entity-input"),a.addEventListener("input",()=>{if(a.type==="number"){let s=parseFloat(a.value);isNaN(s)?delete this.properties[e]:this.properties[e]=s}else{let s=a.value.trim();s?this.properties[e]=s:delete this.properties[e]}})}async handleCreate(){if(!this.relationship.trim()){new E.Notice("Please select a relationship type");return}let e=H(this.relationship);if(e)for(let t of e.requiredProperties){let n=e.propertyDefinitions[t];if(n&&n.type!=="entity"&&(!this.properties[t]||this.properties[t].toString().trim()==="")){new E.Notice(`Please enter ${n.label}`);return}}try{let t=await this.entityManager.createConnection(this.sourceEntityId,this.targetEntityId,this.relationship,this.properties);t?(new E.Notice(`Created: ${this.sourceLabel} \u2192 ${this.relationship} \u2192 ${this.targetLabel}`),this.onConnectionCreated&&this.onConnectionCreated(t.id),this.close()):new E.Notice("Failed to create connection")}catch(t){new E.Notice(`Failed to create connection: ${t}`),console.error("Connection creation error:",t)}}onClose(){let{contentEl:e}=this;e.empty()}};var me=class extends E.Modal{constructor(e,t,n,i){super(e);this.properties={};this.optionalSectionExpanded=!1;this.entityManager=t,this.schemaName=n,this.onEntityCreated=i||null}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("graph_copilot-entity-modal"),e.addClass("graph_copilot-ftm-modal");let t=H(this.schemaName);if(!t){e.createEl("p",{text:`Unknown schema: ${this.schemaName}`});return}e.createEl("h2",{text:`Create ${t.label}`}),e.createEl("p",{text:t.description,cls:"graph_copilot-entity-modal-description"});let n=e.createDiv({cls:"graph_copilot-entity-form"});if(t.requiredProperties.length>0){n.createEl("h4",{text:"Required Properties",cls:"graph_copilot-section-header"});for(let l of t.requiredProperties){let c=t.propertyDefinitions[l];c&&this.createFTMPropertyField(n,l,c,!0)}}let i=t.featuredProperties.filter(l=>!t.requiredProperties.includes(l));if(i.length>0){n.createEl("h4",{text:"Key Properties",cls:"graph_copilot-section-header"});for(let l of i){let c=t.propertyDefinitions[l];c&&this.createFTMPropertyField(n,l,c,!1)}}if(t.optionalProperties.length>0){let l=e.createDiv({cls:"graph_copilot-optional-section"}),c=l.createDiv({cls:"graph_copilot-optional-header"}),d=c.createSpan({cls:"graph_copilot-toggle-icon",text:"\u25B6"});c.createSpan({text:` Additional Properties (${t.optionalProperties.length})`});let p=l.createDiv({cls:"graph_copilot-optional-content"});p.style.display="none",c.onclick=()=>{this.optionalSectionExpanded=!this.optionalSectionExpanded,d.textContent=this.optionalSectionExpanded?"\u25BC":"\u25B6",p.style.display=this.optionalSectionExpanded?"block":"none"};for(let u of t.optionalProperties){let g=t.propertyDefinitions[u];g&&!g.hidden&&this.createFTMPropertyField(p,u,g,!1)}}let r=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),a=r.createEl("button",{text:"Create Entity",cls:"mod-cta"});a.onclick=()=>this.handleCreate();let s=r.createEl("button",{text:"Cancel"});s.onclick=()=>this.close()}createFTMPropertyField(e,t,n,i){let r=e.createDiv({cls:"graph_copilot-entity-field"});r.createEl("label",{text:n.label+(i?" *":"")}).setAttribute("for",`entity-${t}`);let s,l=n.type||"string";l==="text"||t==="description"||t==="notes"||t==="summary"?(s=r.createEl("textarea",{placeholder:`Enter ${n.label.toLowerCase()}...`}),s.rows=3):l==="date"?s=r.createEl("input",{type:"date"}):l==="number"?(s=r.createEl("input",{type:"number",placeholder:`Enter ${n.label.toLowerCase()}...`}),s.step="any"):l==="url"?s=r.createEl("input",{type:"url",placeholder:"https://..."}):l==="email"?s=r.createEl("input",{type:"email",placeholder:"email@example.com"}):l==="phone"?s=r.createEl("input",{type:"tel",placeholder:"+1 234 567 8900"}):l==="country"?s=r.createEl("input",{type:"text",placeholder:"Country code (e.g., US, GB, DE)"}):s=r.createEl("input",{type:"text",placeholder:`Enter ${n.label.toLowerCase()}...`}),s.id=`entity-${t}`,s.addClass("graph_copilot-entity-input"),s.addEventListener("input",()=>{if(s.type==="number"){let c=parseFloat(s.value);isNaN(c)||(this.properties[t]=c)}else this.properties[t]=s.value})}async handleCreate(){let e=H(this.schemaName);if(e){for(let t of e.requiredProperties)if(!this.properties[t]||String(this.properties[t]).trim()===""){let n=e.propertyDefinitions[t];new E.Notice(`Please enter ${n?.label||t}`);return}try{let t=await this.entityManager.createFTMEntity(this.schemaName,this.properties);new E.Notice(`Created ${e.label}: ${t.label}`),this.onEntityCreated&&this.onEntityCreated(t.id),this.close()}catch(t){new E.Notice(`Failed to create entity: ${t}`),console.error("FTM Entity creation error:",t)}}}onClose(){let{contentEl:e}=this;e.empty()}},se=class extends E.Modal{constructor(e,t,n){super(e);this.searchInput=null;this.gridContainer=null;this.entityTypes=[];this.entityManager=t,this.onEntityCreated=n||null}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("graph_copilot-entity-selector-modal"),e.createEl("h2",{text:"Create New Entity"}),e.createEl("p",{text:"Select the type of entity to create:"});let t=e.createDiv({cls:"graph_copilot-entity-search-container"});t.style.cssText="margin-bottom: 12px;",this.searchInput=t.createEl("input",{type:"text",placeholder:"Search entity types...",cls:"graph_copilot-entity-search-input"}),this.searchInput.style.cssText=`
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--background-modifier-border);
            border-radius: 6px;
            background: var(--background-primary);
            color: var(--text-normal);
            font-size: 14px;
        `,this.searchInput.addEventListener("input",()=>this.filterEntityTypes());let n=e.createDiv({cls:"graph_copilot-entity-scroll-container"});n.style.cssText=`
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        `,this.gridContainer=n.createDiv({cls:"graph_copilot-entity-type-grid"}),this.entityTypes=Te(),this.entityTypes.sort((r,a)=>r.label.localeCompare(a.label)),this.renderEntityTypes(this.entityTypes);let i=e.createEl("button",{text:"Cancel",cls:"graph_copilot-entity-cancel-btn"});i.onclick=()=>this.close(),setTimeout(()=>this.searchInput?.focus(),50)}filterEntityTypes(){let e=this.searchInput?.value.toLowerCase()||"",t=this.entityTypes.filter(n=>n.label.toLowerCase().includes(e)||n.description.toLowerCase().includes(e)||n.name.toLowerCase().includes(e));this.renderEntityTypes(t)}renderEntityTypes(e){if(this.gridContainer){if(this.gridContainer.empty(),e.length===0){let t=this.gridContainer.createDiv({cls:"graph_copilot-no-results"});t.style.cssText=`
                text-align: center;
                padding: 20px;
                color: var(--text-muted);
            `,t.textContent="No entity types match your search.";return}for(let t of e){let n=this.gridContainer.createDiv({cls:"graph_copilot-entity-type-btn"});n.style.borderLeftColor=t.color;let i=n.createDiv({cls:"graph_copilot-entity-type-icon"});i.style.backgroundColor=t.color,i.textContent=t.label.charAt(0);let r=n.createDiv({cls:"graph_copilot-entity-type-info"});r.createEl("strong",{text:t.label}),r.createEl("small",{text:t.description}),n.onclick=()=>{this.close(),new me(this.app,this.entityManager,t.name,this.onEntityCreated||void 0).open()}}}}onClose(){let{contentEl:e}=this;e.empty()}},ae=class extends E.Modal{constructor(e,t,n,i){super(e);this.properties={};this.optionalSectionExpanded=!1;this.geocodeStatusEl=null;this.entityManager=t,this.entity=n,this.schemaName=n.ftmSchema||String(n.type),this.properties={...n.properties},this.onEntityUpdated=i||null,this.geocodingService=new O}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("graph_copilot-entity-modal"),e.addClass("graph_copilot-ftm-modal");let t=H(this.schemaName);if(!t){this.renderNonFTMEntityEditor(e);return}e.createEl("h2",{text:`Edit ${t.label}`}),e.createEl("p",{text:`Editing: ${this.entity.label}`,cls:"graph_copilot-entity-modal-description"});let n=e.createDiv({cls:"graph_copilot-entity-form"});if(t.requiredProperties.length>0){n.createEl("h4",{text:"Required Properties",cls:"graph_copilot-section-header"});for(let l of t.requiredProperties){let c=t.propertyDefinitions[l];c&&this.createFTMPropertyField(n,l,c,!0)}}let i=t.featuredProperties.filter(l=>!t.requiredProperties.includes(l));if(i.length>0){n.createEl("h4",{text:"Key Properties",cls:"graph_copilot-section-header"});for(let l of i){let c=t.propertyDefinitions[l];c&&this.createFTMPropertyField(n,l,c,!1)}}if(t.optionalProperties.length>0){let l=e.createDiv({cls:"graph_copilot-optional-section"}),c=l.createDiv({cls:"graph_copilot-optional-header"}),d=c.createSpan({cls:"graph_copilot-toggle-icon",text:"\u25B6"});c.createSpan({text:` Additional Properties (${t.optionalProperties.length})`});let p=l.createDiv({cls:"graph_copilot-optional-content"});p.style.display="none",c.onclick=()=>{this.optionalSectionExpanded=!this.optionalSectionExpanded,d.textContent=this.optionalSectionExpanded?"\u25BC":"\u25B6",p.style.display=this.optionalSectionExpanded?"block":"none"};for(let u of t.optionalProperties){let g=t.propertyDefinitions[u];g&&!g.hidden&&this.createFTMPropertyField(p,u,g,!1)}}(this.schemaName==="Location"||this.schemaName==="Address")&&(!this.properties.latitude||!this.properties.longitude)&&this.createGeocodingSection(e);let r=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),a=r.createEl("button",{text:"Save Changes",cls:"mod-cta"});a.onclick=()=>this.handleSave();let s=r.createEl("button",{text:"Cancel"});s.onclick=()=>this.close()}createFTMPropertyField(e,t,n,i){let r=e.createDiv({cls:"graph_copilot-entity-field"});r.createEl("label",{text:n.label+(i?" *":"")}).setAttribute("for",`entity-${t}`);let s,l=this.properties[t],c=n.type||"string";if(c==="boolean"){let d=r.createDiv({cls:"graph_copilot-toggle-container"});d.style.cssText="display: flex; align-items: center; gap: 12px; margin-top: 4px;",s=d.createEl("input",{type:"checkbox"}),s.id=`entity-${t}`,s.style.display="none",l&&(s.checked=!0);let p=d.createEl("button",{cls:"graph_copilot-toggle-btn"});p.type="button",p.style.cssText=`
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 10px 20px;
                font-size: 14px;
                font-weight: 500;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s ease;
                border: 2px solid var(--background-modifier-border);
                background: var(--background-secondary);
                color: var(--text-muted);
            `;let u=p.createSpan({cls:"toggle-icon"});u.textContent="\u{1F4C5}",u.style.fontSize="16px";let g=p.createSpan({cls:"toggle-text"}),y=h=>{h?(p.style.background="var(--interactive-accent)",p.style.borderColor="var(--interactive-accent)",p.style.color="white",g.textContent="On Timeline \u2713"):(p.style.background="var(--background-secondary)",p.style.borderColor="var(--background-modifier-border)",p.style.color="var(--text-muted)",g.textContent="Add to Timeline")};y(!!l),p.addEventListener("click",()=>{let h=!s.checked;s.checked=h,this.properties[t]=h,y(h)}),p.addEventListener("mouseenter",()=>{s.checked||(p.style.borderColor="var(--interactive-accent)",p.style.color="var(--text-normal)")}),p.addEventListener("mouseleave",()=>{y(s.checked)});return}else c==="text"||t==="description"||t==="notes"||t==="summary"?(s=r.createEl("textarea",{placeholder:`Enter ${n.label.toLowerCase()}...`}),s.rows=3,l&&(s.value=l)):c==="date"?(s=r.createEl("input",{type:"date"}),l&&(s.value=l)):c==="number"?(s=r.createEl("input",{type:"number",placeholder:`Enter ${n.label.toLowerCase()}...`}),s.step="any",l!=null&&(s.value=l.toString())):c==="url"?(s=r.createEl("input",{type:"url",placeholder:"https://..."}),l&&(s.value=l)):c==="email"?(s=r.createEl("input",{type:"email",placeholder:"email@example.com"}),l&&(s.value=l)):c==="phone"?(s=r.createEl("input",{type:"tel",placeholder:"+1 234 567 8900"}),l&&(s.value=l)):c==="country"?(s=r.createEl("input",{type:"text",placeholder:"Country code (e.g., US, GB, DE)"}),l&&(s.value=l)):(s=r.createEl("input",{type:"text",placeholder:`Enter ${n.label.toLowerCase()}...`}),l&&(s.value=l));s.id=`entity-${t}`,s.addClass("graph_copilot-entity-input"),s.addEventListener("input",()=>{if(s.type==="number"){let d=parseFloat(s.value);isNaN(d)||(this.properties[t]=d)}else this.properties[t]=s.value})}createGeocodingSection(e){let t=e.createDiv({cls:"graph_copilot-geocoding-section"});t.style.cssText=`
            margin-top: 20px;
            padding: 15px;
            background: var(--background-secondary);
            border-radius: 6px;
            border-left: 3px solid var(--interactive-accent);
        `;let n=t.createEl("h4",{text:"\u{1F4CD} Geocoding"});n.style.cssText="margin-top: 0; margin-bottom: 10px;";let i=t.createEl("p",{text:"This entity is missing coordinates. Click the button below to automatically geocode the address.",cls:"text-muted"});i.style.cssText="font-size: 12px; margin-bottom: 12px;",this.geocodeStatusEl=t.createDiv({cls:"graph_copilot-geocode-status"}),this.geocodeStatusEl.style.cssText="margin-bottom: 10px; font-size: 12px;";let r=t.createEl("button",{text:"\u{1F4CD} Geolocate Address"});r.style.cssText=`
            padding: 8px 16px;
            background: var(--interactive-accent);
            color: var(--text-on-accent);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        `,r.onclick=async()=>{await this.handleGeocode(r)}}async handleGeocode(e){let t,n,i,r;if(this.schemaName==="Location"?(t=this.properties.address,n=this.properties.city,r=this.properties.country):this.schemaName==="Address"&&(t=this.properties.street||this.properties.full,n=this.properties.city,i=this.properties.state,r=this.properties.country),!t&&!n&&!r){this.updateGeocodeStatus("\u26A0\uFE0F No address information found. Please fill in address fields first.","error");return}try{e.disabled=!0,e.textContent="Geocoding...",this.updateGeocodeStatus("\u{1F504} Geocoding address...","info");let a=await this.geocodingService.geocodeAddressWithRetry(t,n,i,r,(s,l,c)=>{this.updateGeocodeStatus(`\u26A0\uFE0F Network error, retrying in ${c}s... (attempt ${s}/${l})`,"warning")});this.properties.latitude=a.latitude,this.properties.longitude=a.longitude,a.city&&!n&&(this.properties.city=a.city),a.state&&!i&&this.schemaName==="Address"&&(this.properties.state=a.state),a.country&&!r&&(this.properties.country=a.country),a.postalCode&&this.schemaName==="Address"&&!this.properties.postalCode&&(this.properties.postalCode=a.postalCode),this.updateGeocodeStatus(`\u2713 Geocoded: ${a.displayName}
Lat: ${a.latitude.toFixed(6)}, Lng: ${a.longitude.toFixed(6)}
Confidence: ${a.confidence}`,"success"),e.disabled=!1,e.textContent="\u2713 Geocoded Successfully",e.style.background="var(--text-success)",new E.Notice("Geocoding successful! Don't forget to save your changes.")}catch(a){e.disabled=!1,e.textContent="\u{1F4CD} Geolocate Address",a instanceof A?(this.updateGeocodeStatus(`\u2717 ${a.message}`,"error"),new E.Notice(`Geocoding failed: ${a.message}`)):(console.error("[FTMEntityEditModal] Geocoding error:",a),this.updateGeocodeStatus("\u2717 Failed to geocode address. Please try again.","error"),new E.Notice("Failed to geocode address. Please try again."))}}updateGeocodeStatus(e,t){if(!this.geocodeStatusEl)return;this.geocodeStatusEl.textContent=e;let n="var(--text-muted)";t==="success"?n="var(--text-success)":t==="warning"?n="var(--text-warning)":t==="error"&&(n="var(--text-error)"),this.geocodeStatusEl.style.color=n,this.geocodeStatusEl.style.whiteSpace="pre-line"}async handleSave(){let e=H(this.schemaName);if(e){for(let t of e.requiredProperties)if(!this.properties[t]||String(this.properties[t]).trim()===""){let n=e.propertyDefinitions[t];new E.Notice(`Please enter ${n?.label||t}`);return}try{let t=await this.entityManager.updateEntity(this.entity.id,this.properties);t?(new E.Notice(`Updated ${e.label}: ${t.label}`),this.onEntityUpdated&&this.onEntityUpdated(this.entity.id),this.close()):new E.Notice("Failed to update entity: Entity not found")}catch(t){new E.Notice(`Failed to update entity: ${t}`),console.error("FTM Entity update error:",t)}}}renderNonFTMEntityEditor(e){e.createEl("h2",{text:`Edit ${this.schemaName}`}),e.createEl("p",{text:`Editing: ${this.entity.label}`,cls:"graph_copilot-entity-modal-description"});let t=e.createDiv({cls:"graph_copilot-info-message"});t.style.cssText=`
            padding: 12px;
            margin-bottom: 20px;
            background: var(--background-secondary);
            border-left: 3px solid var(--interactive-accent);
            border-radius: 4px;
        `,t.createEl("p",{text:"This is a non-standard entity type. You can edit its properties below.",cls:"text-muted"});let n=e.createDiv({cls:"graph_copilot-entity-form"}),i=Object.keys(this.properties);if(i.length>0){n.createEl("h4",{text:"Properties",cls:"graph_copilot-section-header"});for(let h of i)this.createGenericPropertyField(n,h)}let r=e.createDiv({cls:"graph_copilot-add-property-section"});r.style.cssText="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--background-modifier-border);",r.createEl("h4",{text:"Add New Property",cls:"graph_copilot-section-header"});let a=r.createDiv({cls:"graph_copilot-add-property-container"});a.style.cssText="display: flex; gap: 10px; align-items: flex-end;";let s=a.createDiv({cls:"graph_copilot-entity-field"});s.style.flex="1",s.createEl("label",{text:"Property Name"});let l=s.createEl("input",{type:"text",placeholder:"e.g., address, phone, email"});l.addClass("graph_copilot-entity-input");let c=a.createDiv({cls:"graph_copilot-entity-field"});c.style.flex="2",c.createEl("label",{text:"Property Value"});let d=c.createEl("input",{type:"text",placeholder:"Enter value..."});d.addClass("graph_copilot-entity-input");let p=a.createEl("button",{text:"+ Add"});p.style.cssText="padding: 8px 16px; margin-bottom: 2px;",p.onclick=()=>{let h=l.value.trim(),m=d.value.trim();if(!h){new E.Notice("Please enter a property name");return}if(!m){new E.Notice("Please enter a property value");return}this.properties[h]=m,e.empty(),this.renderNonFTMEntityEditor(e),new E.Notice(`Added property: ${h}`)},this.schemaName==="Location"&&(!this.properties.latitude||!this.properties.longitude)&&this.createGeocodingSection(e);let u=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),g=u.createEl("button",{text:"Save Changes",cls:"mod-cta"});g.onclick=()=>this.handleNonFTMSave();let y=u.createEl("button",{text:"Cancel"});y.onclick=()=>this.close()}createGenericPropertyField(e,t){let n=e.createDiv({cls:"graph_copilot-entity-field"});n.style.cssText="display: flex; gap: 10px; align-items: flex-start;";let i=n.createDiv();i.style.flex="1",i.createEl("label",{text:t}).setAttribute("for",`entity-${t}`);let a=this.properties[t],s=i.createEl("input",{type:"text",value:String(a||"")});s.id=`entity-${t}`,s.addClass("graph_copilot-entity-input"),s.addEventListener("input",()=>{this.properties[t]=s.value});let l=n.createEl("button",{text:"\u{1F5D1}"});l.style.cssText="padding: 8px 12px; margin-top: 24px;",l.title="Delete property",l.onclick=()=>{delete this.properties[t],n.remove(),new E.Notice(`Deleted property: ${t}`)}}async handleNonFTMSave(){try{let e=await this.entityManager.updateEntity(this.entity.id,this.properties);e?(new E.Notice(`Updated ${this.schemaName}: ${e.label}`),this.onEntityUpdated&&this.onEntityUpdated(this.entity.id),this.close()):new E.Notice("Failed to update entity: Entity not found")}catch(e){new E.Notice(`Failed to update entity: ${e}`),console.error("Non-FTM Entity update error:",e)}}onClose(){let{contentEl:e}=this;e.empty()}};var le=class extends E.Modal{constructor(e,t,n,i){super(e);this.properties={};this.entityManager=t,this.connection=n,this.properties=n.properties?{...n.properties}:{},this.onConnectionUpdated=i||null}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("graph_copilot-entity-modal"),e.addClass("graph_copilot-ftm-modal");let t=this.connection.ftmSchema||this.connection.relationship,n=H(t);if(!n){this.renderNonFTMConnectionEditor(e,t);return}let i=this.entityManager.getEntity(this.connection.fromEntityId),r=this.entityManager.getEntity(this.connection.toEntityId);if(!i||!r){e.createEl("p",{text:"Error: Source or target entity not found"});let u=e.createEl("button",{text:"Close"});u.onclick=()=>this.close();return}e.createEl("h2",{text:`Edit ${n.label}`}),e.createEl("p",{text:`${i.label} \u2192 ${this.connection.relationship} \u2192 ${r.label}`,cls:"graph_copilot-entity-modal-description"});let a=e.createDiv({cls:"graph_copilot-connection-details"});a.style.cssText=`
            background: var(--background-secondary);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        `,a.createEl("div",{text:`From: ${i.label}`}),a.createEl("div",{text:`To: ${r.label}`}),a.createEl("div",{text:`Type: ${this.connection.relationship}`});let s=e.createDiv({cls:"graph_copilot-entity-form"}),l=[...n.featuredProperties,...n.optionalProperties].filter(u=>{let g=n.propertyDefinitions[u];return g&&g.type!=="entity"&&!g.hidden});if(l.length===0)s.createEl("p",{text:"This connection type has no editable properties.",cls:"graph_copilot-entity-modal-description"});else{s.createEl("h4",{text:"Connection Properties",cls:"graph_copilot-section-header"});for(let u of l){let g=n.propertyDefinitions[u];if(!g)continue;let y=n.requiredProperties.includes(u);this.createPropertyField(s,u,g,y)}}let c=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),d=c.createEl("button",{text:"Save Changes",cls:"mod-cta"});d.onclick=()=>this.handleSave();let p=c.createEl("button",{text:"Cancel"});p.onclick=()=>this.close()}createPropertyField(e,t,n,i){let r=e.createDiv({cls:"graph_copilot-entity-field"});r.createEl("label",{text:n.label+(i?" *":"")}).setAttribute("for",`conn-edit-${t}`);let s,l=this.properties[t]||"";n.type==="text"||t==="description"||t==="summary"?(s=r.createEl("textarea",{placeholder:`Enter ${n.label.toLowerCase()}...`}),s.rows=3,s.value=l):n.type==="date"||t.includes("Date")?(s=r.createEl("input",{type:"date"}),s.value=l):n.type==="number"||t.includes("percentage")||t.includes("Count")||t.includes("Value")||t.includes("amount")?(s=r.createEl("input",{type:"number",placeholder:`Enter ${n.label.toLowerCase()}...`}),s.step="any",s.value=l):(s=r.createEl("input",{type:"text",placeholder:`Enter ${n.label.toLowerCase()}...`}),s.value=l),s.id=`conn-edit-${t}`,s.addClass("graph_copilot-entity-input"),s.addEventListener("input",()=>{if(s.type==="number"){let c=parseFloat(s.value);isNaN(c)?delete this.properties[t]:this.properties[t]=c}else{let c=s.value.trim();c?this.properties[t]=c:delete this.properties[t]}})}async handleSave(){let e=this.connection.ftmSchema||this.connection.relationship,t=H(e);if(t)for(let n of t.requiredProperties){let i=t.propertyDefinitions[n];if(i&&i.type!=="entity"&&(!this.properties[n]||this.properties[n].toString().trim()==="")){new E.Notice(`Please enter ${i.label}`);return}}try{await this.entityManager.updateConnection(this.connection.id,this.properties),new E.Notice("Connection updated successfully"),this.onConnectionUpdated&&this.onConnectionUpdated(this.connection.id),this.close()}catch(n){new E.Notice(`Failed to update connection: ${n}`),console.error("Connection update error:",n)}}renderNonFTMConnectionEditor(e,t){let n=this.entityManager.getEntity(this.connection.fromEntityId),i=this.entityManager.getEntity(this.connection.toEntityId);if(!n||!i){e.createEl("p",{text:"Error: Source or target entity not found"});let x=e.createEl("button",{text:"Close"});x.onclick=()=>this.close();return}e.createEl("h2",{text:"Edit Connection"}),e.createEl("p",{text:`${n.label} \u2192 ${this.connection.relationship} \u2192 ${i.label}`,cls:"graph_copilot-entity-modal-description"});let r=e.createDiv({cls:"graph_copilot-info-message"});r.style.cssText=`
            padding: 12px;
            margin-bottom: 20px;
            background: var(--background-secondary);
            border-left: 3px solid var(--interactive-accent);
            border-radius: 4px;
        `,r.createEl("p",{text:"This is a non-standard relationship type. You can edit its properties below.",cls:"text-muted"});let a=e.createDiv({cls:"graph_copilot-entity-form"}),s=Object.keys(this.properties);if(s.length>0){a.createEl("h4",{text:"Properties",cls:"graph_copilot-section-header"});for(let x of s)this.createGenericConnectionPropertyField(a,x)}let l=e.createDiv({cls:"graph_copilot-add-property-section"});l.style.cssText="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--background-modifier-border);",l.createEl("h4",{text:"Add New Property",cls:"graph_copilot-section-header"});let c=l.createDiv({cls:"graph_copilot-add-property-container"});c.style.cssText="display: flex; gap: 10px; align-items: flex-end;";let d=c.createDiv({cls:"graph_copilot-entity-field"});d.style.flex="1",d.createEl("label",{text:"Property Name"});let p=d.createEl("input",{type:"text",placeholder:"e.g., date, location, notes"});p.addClass("graph_copilot-entity-input");let u=c.createDiv({cls:"graph_copilot-entity-field"});u.style.flex="2",u.createEl("label",{text:"Property Value"});let g=u.createEl("input",{type:"text",placeholder:"Enter value..."});g.addClass("graph_copilot-entity-input");let y=c.createEl("button",{text:"+ Add"});y.style.cssText="padding: 8px 16px; margin-bottom: 2px;",y.onclick=()=>{let x=p.value.trim(),C=g.value.trim();if(!x){new E.Notice("Please enter a property name");return}if(!C){new E.Notice("Please enter a property value");return}this.properties[x]=C,e.empty(),this.renderNonFTMConnectionEditor(e,t),new E.Notice(`Added property: ${x}`)};let h=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),m=h.createEl("button",{text:"Save Changes",cls:"mod-cta"});m.onclick=()=>this.handleNonFTMConnectionSave();let f=h.createEl("button",{text:"Cancel"});f.onclick=()=>this.close()}createGenericConnectionPropertyField(e,t){let n=e.createDiv({cls:"graph_copilot-entity-field"});n.style.cssText="display: flex; gap: 10px; align-items: flex-start;";let i=n.createDiv();i.style.flex="1",i.createEl("label",{text:t}).setAttribute("for",`connection-${t}`);let a=this.properties[t],s=i.createEl("input",{type:"text",value:String(a||"")});s.id=`connection-${t}`,s.addClass("graph_copilot-entity-input"),s.addEventListener("input",()=>{this.properties[t]=s.value});let l=n.createEl("button",{text:"\u{1F5D1}"});l.style.cssText="padding: 8px 12px; margin-top: 24px;",l.title="Delete property",l.onclick=()=>{delete this.properties[t],n.remove(),new E.Notice(`Deleted property: ${t}`)}}async handleNonFTMConnectionSave(){try{await this.entityManager.updateConnection(this.connection.id,this.properties),new E.Notice("Connection updated successfully"),this.onConnectionUpdated&&this.onConnectionUpdated(this.connection.id),this.close()}catch(e){new E.Notice(`Failed to update connection: ${e}`),console.error("Non-FTM Connection update error:",e)}}onClose(){let{contentEl:e}=this;e.empty()}};var ce=class{constructor(o=100){this.undoStack=[];this.redoStack=[];this.maxHistorySize=100;this.callbacks=null;this.listeners=new Set;this.maxHistorySize=o}setCallbacks(o){this.callbacks=o}addListener(o){this.listeners.add(o)}removeListener(o){this.listeners.delete(o)}notifyListeners(){this.listeners.forEach(o=>o())}generateId(){return`hist_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}recordEntityCreate(o){let e={id:this.generateId(),type:"entity_create",timestamp:new Date,description:`Created entity: ${o.label}`,entityData:{...o}};this.pushToUndoStack(e)}recordEntityDelete(o){let e={id:this.generateId(),type:"entity_delete",timestamp:new Date,description:`Deleted entity: ${o.label}`,entityData:{...o}};this.pushToUndoStack(e)}recordEntityEdit(o,e){let t={id:this.generateId(),type:"entity_edit",timestamp:new Date,description:`Edited entity: ${e.label}`,entityData:{...e},previousEntityData:{...o}};this.pushToUndoStack(t)}recordRelationshipEdit(o,e){let t={id:this.generateId(),type:"relationship_edit",timestamp:new Date,description:`Edited relationship: ${e.relationship}`,connectionData:{...e},previousConnectionData:{...o}};this.pushToUndoStack(t)}recordRelationshipCreate(o){let e={id:this.generateId(),type:"relationship_create",timestamp:new Date,description:`Created relationship: ${o.relationship}`,connectionData:{...o}};this.pushToUndoStack(e)}recordRelationshipDelete(o){let e={id:this.generateId(),type:"relationship_delete",timestamp:new Date,description:`Deleted relationship: ${o.relationship}`,connectionData:{...o}};this.pushToUndoStack(e)}recordNodePositionChange(o,e){let t={id:this.generateId(),type:"node_position_change",timestamp:new Date,description:`Moved ${e.size} node(s)`,nodePositions:new Map(e),previousNodePositions:new Map(o)};this.pushToUndoStack(t)}pushToUndoStack(o){for(this.undoStack.push(o),this.redoStack=[];this.undoStack.length>this.maxHistorySize;)this.undoStack.shift();this.notifyListeners()}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}getUndoStack(){return[...this.undoStack]}getRedoStack(){return[...this.redoStack]}getCurrentPosition(){return this.undoStack.length}getTotalHistorySize(){return this.undoStack.length+this.redoStack.length}async undo(){if(!this.canUndo()||!this.callbacks)return!1;let o=this.undoStack.pop();try{return await this.executeUndo(o),this.redoStack.push(o),this.notifyListeners(),!0}catch(e){return console.error("[GraphHistoryManager] Undo failed:",e),this.undoStack.push(o),!1}}async redo(){if(!this.canRedo()||!this.callbacks)return!1;let o=this.redoStack.pop();try{return await this.executeRedo(o),this.undoStack.push(o),this.notifyListeners(),!0}catch(e){return console.error("[GraphHistoryManager] Redo failed:",e),this.redoStack.push(o),!1}}async undoToEntry(o){let e=this.undoStack.findIndex(n=>n.id===o);if(e===-1)return!1;let t=this.undoStack.length-e;for(let n=0;n<t;n++)if(!await this.undo())return!1;return!0}async redoToEntry(o){let e=this.redoStack.findIndex(n=>n.id===o);if(e===-1)return!1;let t=this.redoStack.length-e;for(let n=0;n<t;n++)if(!await this.redo())return!1;return!0}async executeUndo(o){if(this.callbacks)switch(o.type){case"entity_create":o.entityData&&await this.callbacks.onEntityDelete(o.entityData.id);break;case"entity_delete":o.entityData&&await this.callbacks.onEntityRestore(o.entityData);break;case"entity_edit":o.previousEntityData&&await this.callbacks.onEntityUpdate(o.previousEntityData);break;case"relationship_create":o.connectionData&&await this.callbacks.onConnectionDelete(o.connectionData.id);break;case"relationship_delete":o.connectionData&&await this.callbacks.onConnectionRestore(o.connectionData);break;case"relationship_edit":o.previousConnectionData&&await this.callbacks.onConnectionUpdate(o.previousConnectionData);break;case"node_position_change":o.previousNodePositions&&this.callbacks.onNodePositionChange(o.previousNodePositions);break;case"batch_operation":if(o.subOperations)for(let e=o.subOperations.length-1;e>=0;e--)await this.executeUndo(o.subOperations[e]);break}}async executeRedo(o){if(this.callbacks)switch(o.type){case"entity_create":o.entityData&&await this.callbacks.onEntityRestore(o.entityData);break;case"entity_delete":o.entityData&&await this.callbacks.onEntityDelete(o.entityData.id);break;case"entity_edit":o.entityData&&await this.callbacks.onEntityUpdate(o.entityData);break;case"relationship_create":o.connectionData&&await this.callbacks.onConnectionRestore(o.connectionData);break;case"relationship_delete":o.connectionData&&await this.callbacks.onConnectionDelete(o.connectionData.id);break;case"relationship_edit":o.connectionData&&await this.callbacks.onConnectionUpdate(o.connectionData);break;case"node_position_change":o.nodePositions&&this.callbacks.onNodePositionChange(o.nodePositions);break;case"batch_operation":if(o.subOperations)for(let e of o.subOperations)await this.executeRedo(e);break}}clear(){this.undoStack=[],this.redoStack=[],this.notifyListeners()}getLastUndoDescription(){return this.undoStack.length===0?null:this.undoStack[this.undoStack.length-1].description}getLastRedoDescription(){return this.redoStack.length===0?null:this.redoStack[this.redoStack.length-1].description}};var V="graph_copilot-graph-view",z=".osint-copilot/graph-positions.json",de=class extends w.ItemView{constructor(e,t,n,i){super(e);this.cy=null;this.container=null;this.onEntityClick=null;this.onShowOnMap=null;this.connectionMode=!1;this.sourceNodeId=null;this.sourceNodeLabel=null;this.connectBtn=null;this.statusIndicator=null;this.selectedNodes=new Set;this.selectedEdges=new Set;this.selectionCountEl=null;this.deleteSelectedBtn=null;this.clearSelectionBtn=null;this.boxSelectMode=!1;this.boxSelectBtn=null;this.historyPanel=null;this.historyPanelVisible=!1;this.undoBtn=null;this.redoBtn=null;this.nodePositionsCache=new Map;this.savePositionsDebounced=this.debounce(()=>this.savePositions(),1e3);this.entityManager=t,this.onEntityClick=n||null,this.onShowOnMap=i||null,this.geocodingService=new O,this.historyManager=new ce,this.setupHistoryCallbacks()}setupHistoryCallbacks(){this.historyManager.setCallbacks({onEntityCreate:async e=>{},onEntityDelete:async e=>{this.cy&&this.cy.getElementById(e).remove(),this.entityManager.deleteEntityInMemory(e)},onEntityRestore:async e=>{await this.entityManager.restoreEntity(e),this.addEntityToGraphPreserveLayout(e)},onEntityUpdate:async e=>{await this.entityManager.updateEntityForHistory(e),this.updateEntityInGraph(e)},onConnectionCreate:async e=>{},onConnectionDelete:async e=>{this.cy&&this.cy.getElementById(e).remove(),this.entityManager.deleteConnection(e)},onConnectionRestore:async e=>{await this.entityManager.restoreConnection(e),this.addConnectionToGraph(e)},onConnectionUpdate:async e=>{await this.entityManager.updateConnectionForHistory(e),this.updateConnectionInGraph(e)},onNodePositionChange:e=>{this.cy&&e.forEach((t,n)=>{let i=this.cy.getElementById(n);i.length>0&&i.position(t)})}}),this.historyManager.addListener(()=>this.updateHistoryUI())}getViewType(){return V}getDisplayText(){return"OSINTCopilot Graph"}getIcon(){return"git-fork"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("graph_copilot-graph-container"),this.container=e.createDiv({cls:"graph_copilot-graph-canvas"}),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="absolute",this.container.style.top="0",this.container.style.left="0";let t=e.createDiv({cls:"graph_copilot-graph-toolbar"});this.createToolbar(t);try{if(console.log("[GraphView] Loading Cytoscape.js..."),await this.loadCytoscape(),console.log("[GraphView] Cytoscape.js loaded successfully"),typeof cytoscape>"u")throw new Error("Cytoscape failed to load - typeof cytoscape is undefined");this.initializeGraph(),console.log("[GraphView] Graph initialized"),await this.loadSavedPositions(),await this.refreshWithSavedPositions(),console.log("[GraphView] Graph refreshed with entities")}catch(n){console.error("[GraphView] Failed to initialize graph:",n);let i=e.createDiv({cls:"graph_copilot-error"});i.style.cssText=`
                padding: 20px;
                text-align: center;
                color: var(--text-error);
            `;let r=i.createEl("h3",{text:"Failed to Load Graph"});r.style.cssText="color: var(--text-error); margin-bottom: 10px;";let a=i.createEl("p",{text:n instanceof Error?n.message:String(n)});a.style.cssText="margin-bottom: 15px;";let s=i.createDiv();s.style.cssText="text-align: left; max-width: 600px; margin: 0 auto;",s.innerHTML=`
                <p><strong>Possible causes:</strong></p>
                <ul>
                    <li><strong>CDN blocked:</strong> Cytoscape.js cannot be loaded from unpkg.com CDN. Check:
                        <ul>
                            <li>Browser extensions (ad blockers, privacy tools)</li>
                            <li>Corporate firewall or network restrictions</li>
                            <li>Content Security Policy (CSP) settings</li>
                        </ul>
                    </li>
                    <li><strong>Network issues:</strong> Check your internet connection</li>
                    <li><strong>Entity Manager:</strong> Check console for EntityManager initialization errors</li>
                </ul>
                <p><strong>To debug:</strong></p>
                <ol>
                    <li>Open Developer Tools (Ctrl+Shift+I)</li>
                    <li>Check Console tab for errors</li>
                    <li>Check Network tab for failed requests to unpkg.com</li>
                    <li>Verify plugin settings: enableGraphFeatures should be enabled</li>
                </ol>
            `,new w.Notice("Graph failed to load. Check console for details.",1e4)}}async onClose(){this._keyHandler&&document.removeEventListener("keydown",this._keyHandler),this.cy&&(this.cy.destroy(),this.cy=null)}async loadCytoscape(){if(typeof cytoscape<"u"){console.log("[GraphView] Cytoscape.js already loaded");return}return new Promise((e,t)=>{let n=document.createElement("script");n.src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js";let i=setTimeout(()=>{t(new Error("Cytoscape.js load timeout - CDN request took too long. Check network connection or firewall settings."))},3e4);n.onload=()=>{clearTimeout(i),typeof cytoscape>"u"?t(new Error("Cytoscape script loaded but cytoscape object is undefined. Possible CSP or script execution issue.")):(console.log("[GraphView] Cytoscape.js loaded from CDN"),e())},n.onerror=r=>{clearTimeout(i),console.error("[GraphView] Failed to load Cytoscape.js from CDN:",r),t(new Error("Failed to load Cytoscape.js from CDN. Possible causes: network issue, firewall blocking unpkg.com, or Content Security Policy restrictions."))},document.head.appendChild(n)})}createToolbar(e){e.style.cssText=`
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            display: flex;
            gap: 5px;
            background: var(--background-secondary);
            padding: 5px;
            border-radius: 5px;
            flex-wrap: wrap;
            align-items: center;
        `;let t=e.createEl("button",{text:"+ Add Entity"});t.addClass("graph_copilot-add-entity-btn"),t.onclick=()=>this.openEntityCreator(),this.connectBtn=e.createEl("button",{text:"\u{1F517} Connect"}),this.connectBtn.addClass("graph_copilot-connect-btn"),this.connectBtn.onclick=()=>this.toggleConnectionMode(),e.createDiv({cls:"graph_copilot-toolbar-separator"}),this.boxSelectBtn=e.createEl("button",{text:"\u2B1A Box Select"}),this.boxSelectBtn.title="Enter box selection mode to select multiple items by dragging",this.boxSelectBtn.onclick=()=>this.toggleBoxSelectMode(),this.clearSelectionBtn=e.createEl("button",{text:"\u2715 Clear Selection"}),this.clearSelectionBtn.addClass("graph_copilot-clear-selection-btn"),this.clearSelectionBtn.style.display="none",this.clearSelectionBtn.onclick=()=>this.clearSelection(),this.deleteSelectedBtn=e.createEl("button",{text:"\u{1F5D1} Delete Selected"}),this.deleteSelectedBtn.addClass("graph_copilot-delete-selected-btn"),this.deleteSelectedBtn.style.display="none",this.deleteSelectedBtn.onclick=()=>this.showDeleteConfirmation(),this.selectionCountEl=e.createDiv({cls:"graph_copilot-selection-count"}),this.selectionCountEl.style.cssText=`
            padding: 4px 8px;
            font-size: 12px;
            color: var(--text-muted);
            display: none;
        `,e.createDiv({cls:"graph_copilot-toolbar-separator"}),this.undoBtn=e.createEl("button",{text:"\u21B6 Undo"}),this.undoBtn.addClass("graph_copilot-undo-btn"),this.undoBtn.disabled=!0,this.undoBtn.onclick=()=>this.performUndo(),this.redoBtn=e.createEl("button",{text:"\u21B7 Redo"}),this.redoBtn.addClass("graph_copilot-redo-btn"),this.redoBtn.disabled=!0,this.redoBtn.onclick=()=>this.performRedo();let n=e.createEl("button",{text:"\u{1F4DC} History"});n.addClass("graph_copilot-history-btn"),n.onclick=()=>this.toggleHistoryPanel(),e.createDiv({cls:"graph_copilot-toolbar-separator"});let i=e.createEl("button",{text:"\u{1F504} Rearrange"});i.title="Rearrange all entities using automatic layout (resets current positions)",i.onclick=async()=>{await this.showRearrangeConfirmation()&&(i.disabled=!0,i.textContent="\u{1F504} Rearranging...",await this.rearrangeGraph(),i.disabled=!1,i.textContent="\u{1F504} Rearrange")};let r=e.createEl("button",{text:"\u21BB Refresh"});r.title="Refresh graph (reload entities while preserving zoom and positions)",r.addClass("graph_copilot-refresh-btn"),r.onclick=async()=>{r.disabled=!0;let s=r.textContent;r.textContent="\u21BB Refreshing...";try{await this.refreshWithSavedPositions(),new w.Notice("Graph refreshed successfully"),r.style.backgroundColor="var(--interactive-success)",setTimeout(()=>{r.style.backgroundColor=""},300)}catch(l){console.error("[GraphView] Manual refresh failed:",l),new w.Notice("Failed to refresh graph. Check console for details."),r.style.backgroundColor="var(--interactive-error)",setTimeout(()=>{r.style.backgroundColor=""},300)}finally{r.disabled=!1,r.textContent=s}};let a=e.createEl("button",{text:"\u22A1 Fit"});a.title="Fit all entities in view",a.onclick=()=>this.cy?.fit(),this.statusIndicator=e.createDiv({cls:"graph_copilot-connection-status"}),this.statusIndicator.style.display="none"}toggleConnectionMode(){this.connectionMode?this.exitConnectionMode():this.enterConnectionMode()}enterConnectionMode(){this.connectionMode=!0,this.sourceNodeId=null,this.sourceNodeLabel=null,this.connectBtn&&(this.connectBtn.addClass("graph_copilot-connect-btn-active"),this.connectBtn.textContent="\u2715 Cancel"),this.statusIndicator&&(this.statusIndicator.style.display="block",this.statusIndicator.textContent="Click source node...",this.statusIndicator.addClass("graph_copilot-connection-status-active")),this.container&&this.container.addClass("graph_copilot-connection-mode"),new w.Notice("Connection mode: Click the source node")}exitConnectionMode(){this.connectionMode=!1,this.sourceNodeId=null,this.sourceNodeLabel=null,this.connectBtn&&(this.connectBtn.removeClass("graph_copilot-connect-btn-active"),this.connectBtn.textContent="\u{1F517} Connect"),this.statusIndicator&&(this.statusIndicator.style.display="none",this.statusIndicator.removeClass("graph_copilot-connection-status-active")),this.container&&this.container.removeClass("graph_copilot-connection-mode"),this.cy&&this.cy.nodes().removeClass("connection-source")}toggleBoxSelectMode(){this.boxSelectMode?this.exitBoxSelectMode():this.enterBoxSelectMode()}enterBoxSelectMode(){this.connectionMode&&this.exitConnectionMode(),this.boxSelectMode=!0,this.boxSelectBtn&&(this.boxSelectBtn.addClass("graph_copilot-box-select-active"),this.boxSelectBtn.textContent="\u2B1A Exit Box Select"),this.cy&&(this.cy.boxSelectionEnabled(!0),this.cy.userPanningEnabled(!1)),this.container&&this.container.addClass("graph_copilot-box-select-mode"),new w.Notice("Box select mode: Drag to select multiple items")}exitBoxSelectMode(){this.boxSelectMode=!1,this.boxSelectBtn&&(this.boxSelectBtn.removeClass("graph_copilot-box-select-active"),this.boxSelectBtn.textContent="\u2B1A Box Select"),this.cy&&(this.cy.boxSelectionEnabled(!1),this.cy.userPanningEnabled(!0)),this.container&&this.container.removeClass("graph_copilot-box-select-mode")}handleConnectionModeClick(e,t){if(!this.sourceNodeId)this.sourceNodeId=e,this.sourceNodeLabel=t,this.cy&&this.cy.getElementById(e).addClass("connection-source"),this.statusIndicator&&(this.statusIndicator.textContent=`Source: ${t} \u2192 Click target...`),new w.Notice(`Source selected: ${t}. Now click the target node.`);else{if(e===this.sourceNodeId){new w.Notice("Cannot connect a node to itself. Click a different node.");return}new re(this.app,this.entityManager,this.sourceNodeId,e,this.sourceNodeLabel||"",t,i=>{if(i){let r=this.entityManager.getConnection(i);r&&(this.historyManager.recordRelationshipCreate(r),this.addConnectionToGraph(r))}}).open(),this.exitConnectionMode()}}openConnectionModal(){new oe(this.app,this.entityManager,t=>{if(t){let n=this.entityManager.getConnection(t);n&&(this.historyManager.recordRelationshipCreate(n),this.addConnectionToGraph(n))}}).open()}openEntityCreator(){new se(this.app,this.entityManager,t=>{let n=this.entityManager.getEntity(t);n&&(this.historyManager.recordEntityCreate(n),this.addEntityToGraphPreserveLayout(n))}).open()}initializeGraph(){if(!this.container){console.error("[GraphView] Cannot initialize: container is null");return}if(typeof cytoscape>"u")throw console.error("[GraphView] Cannot initialize: cytoscape is undefined"),new Error("Cytoscape is not available. Graph cannot be initialized.");this.cy=cytoscape({container:this.container,style:this.getGraphStyle(),layout:{name:"preset"},minZoom:.1,maxZoom:3,boxSelectionEnabled:!0,selectionType:"additive"}),this.cy.on("tap","node",e=>{let t=e.target,n=t.id(),i=t.data("fullLabel")||t.data("label"),r=e.originalEvent;if(this.connectionMode){this.handleConnectionModeClick(n,i);return}if(r&&(r.ctrlKey||r.metaKey)){this.toggleNodeSelection(n);return}this.clearSelection(),this.selectedNodes.add(n),t.addClass("multi-selected"),this.updateSelectionUI()}),this.cy.on("dbltap","node",e=>{let n=e.target.id();this.connectionMode||(this.onEntityClick?this.onEntityClick(n):this.entityManager.openEntityNote(n))}),this.cy.on("tap","edge",e=>{let t=e.target,n=t.id(),i=e.originalEvent;if(i&&(i.ctrlKey||i.metaKey)){this.toggleEdgeSelection(n);return}this.clearSelection(),this.selectedEdges.add(n),t.addClass("multi-selected"),this.updateSelectionUI()}),this.cy.on("cxttap","node",e=>{let t=e.target,n=t.id(),i=t.data("type"),r=t.data("fullLabel")||t.data("label");this.showNodeContextMenu(e.originalEvent,n,i,r)}),this.cy.on("cxttap","edge",e=>{let t=e.target,n=t.id(),i=t.data("label"),r=t.data("source"),a=t.data("target");this.showEdgeContextMenu(e.originalEvent,n,i,r,a)}),this.cy.on("dragfree","node",e=>{let t=e.target,n=t.id(),i=t.position(),r=this.nodePositionsCache.get(n);if(r&&(r.x!==i.x||r.y!==i.y)){let a=new Map;a.set(n,{...r});let s=new Map;s.set(n,{x:i.x,y:i.y}),this.historyManager.recordNodePositionChange(a,s)}this.nodePositionsCache.set(n,{x:i.x,y:i.y}),this.savePositionsDebounced()}),this.cy.on("mouseover","node",e=>{let t=e.target,n=t.data("type");t.style("border-width",4),n==="Location"&&this.showLocationTooltip(t)}),this.cy.on("mouseout","node",e=>{e.target.style("border-width",2),this.hideLocationTooltip()}),this.cy.on("tap",e=>{e.target===this.cy&&(this.connectionMode?(this.exitConnectionMode(),new w.Notice("Connection mode cancelled")):!this.boxSelectMode&&(this.selectedNodes.size>0||this.selectedEdges.size>0)&&this.clearSelection())}),this.cy.on("boxselect","node",e=>{if(!this.boxSelectMode)return;let t=e.target,n=t.id();this.selectedNodes.has(n)||(this.selectedNodes.add(n),t.addClass("multi-selected"))}),this.cy.on("boxselect","edge",e=>{if(!this.boxSelectMode)return;let t=e.target,n=t.id();this.selectedEdges.has(n)||(this.selectedEdges.add(n),t.addClass("multi-selected"))}),this.cy.on("boxend",e=>{this.boxSelectMode&&(this.cy.elements().unselect(),setTimeout(()=>{this.updateSelectionUI()},0))}),this.registerKeyboardShortcuts()}registerKeyboardShortcuts(){let e=t=>{if(!this.container?.isConnected)return;let n=document.activeElement,i=n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement||n?.hasAttribute("contenteditable"),r=document.querySelector(".modal-container")!==null;if(i||r){t.key==="Escape"&&!r&&(this.boxSelectMode?this.exitBoxSelectMode():this.connectionMode&&this.exitConnectionMode());return}t.key==="Delete"||t.key==="Backspace"?(this.selectedNodes.size>0||this.selectedEdges.size>0)&&(t.preventDefault(),this.showDeleteConfirmation()):t.key==="Escape"?this.boxSelectMode?(t.preventDefault(),this.exitBoxSelectMode()):this.connectionMode?(t.preventDefault(),this.exitConnectionMode()):(this.selectedNodes.size>0||this.selectedEdges.size>0)&&(t.preventDefault(),this.clearSelection()):t.key==="a"&&(t.ctrlKey||t.metaKey)?(t.preventDefault(),this.selectAll()):t.key==="z"&&(t.ctrlKey||t.metaKey)?(t.preventDefault(),t.shiftKey?this.performRedo():this.performUndo()):t.key==="y"&&(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.performRedo())};document.addEventListener("keydown",e),this._keyHandler=e}toggleNodeSelection(e){if(!this.cy)return;let t=this.cy.getElementById(e);t.length!==0&&(this.selectedNodes.has(e)?(this.selectedNodes.delete(e),t.removeClass("multi-selected")):(this.selectedNodes.add(e),t.addClass("multi-selected")),this.updateSelectionUI())}toggleEdgeSelection(e){if(!this.cy)return;let t=this.cy.getElementById(e);t.length!==0&&(this.selectedEdges.has(e)?(this.selectedEdges.delete(e),t.removeClass("multi-selected")):(this.selectedEdges.add(e),t.addClass("multi-selected")),this.updateSelectionUI())}selectAll(){if(!this.cy)return;this.cy.nodes().forEach(t=>{let n=t.id();this.selectedNodes.add(n),t.addClass("multi-selected")}),this.cy.edges().forEach(t=>{let n=t.id();this.selectedEdges.add(n),t.addClass("multi-selected")}),this.updateSelectionUI();let e=this.selectedNodes.size+this.selectedEdges.size;new w.Notice(`Selected ${this.selectedNodes.size} entities and ${this.selectedEdges.size} relationships`)}clearSelection(){this.cy&&(this.cy.nodes().removeClass("multi-selected"),this.cy.edges().removeClass("multi-selected"),this.selectedNodes.clear(),this.selectedEdges.clear(),this.updateSelectionUI())}updateSelectionUI(){let e=this.selectedNodes.size,t=this.selectedEdges.size,n=e+t;if(this.selectionCountEl)if(n>0){let i=[];e>0&&i.push(`${e} ${e===1?"entity":"entities"}`),t>0&&i.push(`${t} ${t===1?"relationship":"relationships"}`),this.selectionCountEl.textContent=i.join(", "),this.selectionCountEl.style.display="block"}else this.selectionCountEl.style.display="none";this.deleteSelectedBtn&&(n>0?(this.deleteSelectedBtn.textContent=`\u{1F5D1} Delete Selected (${n})`,this.deleteSelectedBtn.style.display="block"):(this.deleteSelectedBtn.textContent="\u{1F5D1} Delete Selected",this.deleteSelectedBtn.style.display="none")),this.clearSelectionBtn&&(this.clearSelectionBtn.style.display=n>0?"block":"none")}showDeleteConfirmation(){let e=this.selectedNodes.size,t=this.selectedEdges.size;if(e===0&&t===0)return;let n=[];this.selectedNodes.forEach(y=>{let h=this.entityManager.getEntity(y);if(h){let m=h.label!=null?String(h.label):y;n.push(`\u{1F4E6} ${m}`)}});let i=[];this.selectedEdges.forEach(y=>{let h=this.entityManager.getConnection(y);if(h){let m=this.entityManager.getEntity(h.fromEntityId),f=this.entityManager.getEntity(h.toEntityId),x=m?.label!=null?String(m.label):h.fromEntityId,C=f?.label!=null?String(f.label):h.toEntityId;i.push(`\u{1F517} ${x} \u2192 ${h.relationship} \u2192 ${C}`)}});let r=document.createElement("div");r.className="graph_copilot-delete-modal",r.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;let a=document.createElement("div");a.style.cssText=`
            background: var(--background-primary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        `;let s=[];e>0&&s.push(`${e} ${e===1?"Entity":"Entities"}`),t>0&&s.push(`${t} ${t===1?"Relationship":"Relationships"}`);let l=document.createElement("h3");l.textContent=`Delete ${s.join(" and ")}?`,l.style.cssText="margin: 0 0 15px 0; color: var(--text-normal);",a.appendChild(l);let c=document.createElement("p");e>0?c.textContent="\u26A0\uFE0F Entity deletions cannot be undone. Entity markdown files will be permanently deleted.":c.textContent="\u26A0\uFE0F The following items will be deleted:",c.style.cssText="margin: 0 0 15px 0; color: var(--text-warning);",a.appendChild(c);let d=document.createElement("ul");d.style.cssText=`
            margin: 0 0 20px 0;
            padding-left: 20px;
            max-height: 200px;
            overflow-y: auto;
            color: var(--text-muted);
        `,n.forEach(y=>{let h=document.createElement("li");h.textContent=y,d.appendChild(h)}),i.forEach(y=>{let h=document.createElement("li");h.textContent=y,h.style.fontSize="0.9em",d.appendChild(h)}),a.appendChild(d);let p=document.createElement("div");p.style.cssText="display: flex; gap: 10px; justify-content: flex-end;";let u=document.createElement("button");u.textContent="Cancel",u.style.cssText="padding: 8px 16px;",u.onclick=()=>r.remove(),p.appendChild(u);let g=document.createElement("button");g.textContent=`Delete ${s.join(" and ")}`,g.style.cssText=`
            padding: 8px 16px;
            background: var(--text-error);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        `,g.onclick=async()=>{r.remove(),await this.deleteSelectedItems()},p.appendChild(g),a.appendChild(p),r.appendChild(a),r.onclick=y=>{y.target===r&&r.remove()},document.body.appendChild(r)}async deleteSelectedItems(){let e=0,t=0,n=0,i=0,r=Array.from(this.selectedEdges);for(let p of r){let u=this.entityManager.getConnection(p);if(u)try{await this.entityManager.deleteConnectionWithNote(p),this.historyManager.recordRelationshipDelete(u),this.cy&&this.cy.getElementById(p).remove(),t++}catch(g){console.error(`Failed to delete relationship ${p}:`,g),i++}}let a=Array.from(this.selectedNodes),s=[];for(let p of a){let u=this.entityManager.getEntity(p);u&&s.push({...u})}let l=await this.entityManager.deleteEntities(a);for(let p of s)l.failed.includes(p.id)?n++:(this.historyManager.recordEntityDelete(p),e++);if(this.cy)for(let p of a)l.failed.includes(p)||this.cy.getElementById(p).remove();this.selectedNodes.clear(),this.selectedEdges.clear(),this.updateSelectionUI();let c=[],d=[];e>0&&c.push(`${e} ${e===1?"entity":"entities"}`),t>0&&c.push(`${t} ${t===1?"relationship":"relationships"}`),n>0&&d.push(`${n} ${n===1?"entity":"entities"}`),i>0&&d.push(`${i} ${i===1?"relationship":"relationships"}`),d.length===0?new w.Notice(`Successfully deleted ${c.join(" and ")}`):new w.Notice(`Deleted ${c.join(" and ")}. Failed: ${d.join(" and ")}`)}showSingleDeleteConfirmation(e,t){let n=document.createElement("div");n.className="graph_copilot-delete-modal",n.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;let i=document.createElement("div");i.style.cssText=`
            background: var(--background-primary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 8px;
            padding: 20px;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        `;let r=document.createElement("h3");r.textContent="Delete Entity?",r.style.cssText="margin: 0 0 15px 0; color: var(--text-normal);",i.appendChild(r);let a=document.createElement("p");a.innerHTML=`\u26A0\uFE0F This action cannot be undone. The entity <strong>"${t}"</strong> and its markdown file will be permanently deleted.`,a.style.cssText="margin: 0 0 20px 0; color: var(--text-warning);",i.appendChild(a);let s=document.createElement("div");s.style.cssText="display: flex; gap: 10px; justify-content: flex-end;";let l=document.createElement("button");l.textContent="Cancel",l.style.cssText="padding: 8px 16px;",l.onclick=()=>n.remove(),s.appendChild(l);let c=document.createElement("button");c.textContent="Delete",c.style.cssText=`
            padding: 8px 16px;
            background: var(--text-error);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        `,c.onclick=async()=>{n.remove();try{let d=this.entityManager.getEntity(e);await this.entityManager.deleteEntity(e)?(d&&this.historyManager.recordEntityDelete(d),this.cy&&this.cy.getElementById(e).remove(),this.selectedNodes.delete(e),this.updateSelectionUI(),new w.Notice(`Deleted entity: ${t}`)):new w.Notice(`Failed to delete entity: ${t}`)}catch(d){console.error(`Failed to delete entity ${e}:`,d),new w.Notice(`Error deleting entity: ${t}`)}},s.appendChild(c),i.appendChild(s),n.appendChild(i),n.onclick=d=>{d.target===n&&n.remove()},document.body.appendChild(n)}showNodeContextMenu(e,t,n,i){let r=document.querySelector(".graph_copilot-context-menu");r&&r.remove();let a=document.createElement("div");a.className="graph_copilot-context-menu",a.style.cssText=`
            position: fixed;
            left: ${e.clientX}px;
            top: ${e.clientY}px;
            background: var(--background-primary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 6px;
            padding: 4px 0;
            min-width: 150px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        `;let s=this.createMenuItem("\u{1F4C4} Open Note",()=>{this.entityManager.openEntityNote(t),a.remove()});a.appendChild(s);let l=this.createMenuItem("\u270F\uFE0F Edit Entity",()=>{let h=this.entityManager.getEntity(t);if(h){let m={...h,properties:{...h.properties}};new ae(this.app,this.entityManager,h,()=>{let x=this.entityManager.getEntity(t);x&&(this.historyManager.recordEntityEdit(m,x),this.updateEntityInGraph(x))}).open()}else new w.Notice("Entity not found");a.remove()});if(a.appendChild(l),n==="Location"){let h=this.entityManager.getEntity(t);if(h&&h.properties.latitude&&h.properties.longitude){let m=this.createMenuItem("\u{1F5FA}\uFE0F Show on Map",()=>{this.onShowOnMap?this.onShowOnMap(t):new w.Notice("Map view not available"),a.remove()});a.appendChild(m)}}if(n==="Location"||n==="Address"){let h=this.entityManager.getEntity(t);if(h&&!h.properties.latitude&&!h.properties.longitude){let m=this.createMenuItem("\u{1F4CD} Geolocate Address",async()=>{a.remove(),await this.geolocateEntity(t)});a.appendChild(m)}}if(n==="Event"){let h=this.entityManager.getEntity(t);if(h&&h.properties.start_date){let m=h.properties.add_to_timeline===!0,f=m?"\u{1F4C5} Remove from Timeline":"\u{1F4C5} Add to Timeline",x=this.createMenuItem(f,async()=>{try{await this.entityManager.updateEntity(t,{add_to_timeline:!m}),new w.Notice(m?"Removed from Timeline":"Added to Timeline");let C=this.entityManager.getEntity(t);C&&this.updateEntityInGraph(C)}catch(C){console.error("[GraphView] Failed to toggle timeline status:",C),new w.Notice("Failed to update timeline status")}a.remove()});a.appendChild(x)}}let c=document.createElement("div");c.style.cssText="height: 1px; background: var(--background-modifier-border); margin: 4px 0;",a.appendChild(c);let d=this.createMenuItem("\u{1F517} Connect to...",()=>{this.enterConnectionMode(),this.handleConnectionModeClick(t,i),a.remove()});a.appendChild(d);let p=document.createElement("div");p.style.cssText="height: 1px; background: var(--background-modifier-border); margin: 4px 0;",a.appendChild(p);let u=this.selectedNodes.size+this.selectedEdges.size;if(u>1&&this.selectedNodes.has(t)){let h=this.createMenuItem(`\u{1F5D1} Delete Selected (${u})`,()=>{a.remove(),this.showDeleteConfirmation()});h.style.color="var(--text-error)",a.appendChild(h)}let g=this.createMenuItem("\u{1F5D1} Delete Entity",()=>{a.remove(),this.showSingleDeleteConfirmation(t,i)});g.style.color="var(--text-error)",a.appendChild(g),document.body.appendChild(a);let y=h=>{a.contains(h.target)||(a.remove(),document.removeEventListener("click",y))};setTimeout(()=>document.addEventListener("click",y),0)}createMenuItem(e,t){let n=document.createElement("div");return n.textContent=e,n.style.cssText=`
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
        `,n.onmouseenter=()=>n.style.background="var(--background-modifier-hover)",n.onmouseleave=()=>n.style.background="transparent",n.onclick=t,n}showEdgeContextMenu(e,t,n,i,r){let a=document.querySelector(".graph_copilot-context-menu");a&&a.remove();let s=this.entityManager.getEntity(i),l=this.entityManager.getEntity(r),c=s?.label||i,d=l?.label||r,p=document.createElement("div");p.className="graph_copilot-context-menu",p.style.cssText=`
            position: fixed;
            left: ${e.clientX}px;
            top: ${e.clientY}px;
            background: var(--background-primary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 6px;
            padding: 4px 0;
            min-width: 180px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        `;let u=document.createElement("div");u.style.cssText=`
            padding: 6px 12px;
            font-size: 11px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--background-modifier-border);
            margin-bottom: 4px;
        `,u.innerHTML=`<strong>${c}</strong> \u2192 <strong>${d}</strong><br><em>${n}</em>`,p.appendChild(u);let g=this.createMenuItem("\u270F\uFE0F Edit Connection",()=>{let f=this.entityManager.getConnection(t);if(f){let x={...f,properties:{...f.properties}};new le(this.app,this.entityManager,f,()=>{let S=this.entityManager.getConnection(t);S&&(this.historyManager.recordRelationshipEdit(x,S),this.updateConnectionInGraph(S))}).open()}else new w.Notice("Connection not found");p.remove()});p.appendChild(g);let y=this.selectedNodes.size+this.selectedEdges.size;if(y>1&&this.selectedEdges.has(t)){let f=this.createMenuItem(`\u{1F5D1} Delete Selected (${y})`,()=>{p.remove(),this.showDeleteConfirmation()});f.style.color="var(--text-error)",p.appendChild(f)}let h=this.createMenuItem("\u{1F5D1} Delete Relationship",async()=>{p.remove(),await this.deleteRelationship(t,n,c,d)});h.style.color="var(--text-error)",p.appendChild(h),document.body.appendChild(p);let m=f=>{p.contains(f.target)||(p.remove(),document.removeEventListener("click",m))};setTimeout(()=>document.addEventListener("click",m),0)}async deleteRelationship(e,t,n,i){let r=this.entityManager.getConnection(e);if(!r){new w.Notice("Relationship not found");return}confirm(`Delete relationship "${t}" between "${n}" and "${i}"?`)&&(this.historyManager.recordRelationshipDelete(r),await this.entityManager.deleteConnectionWithNote(e),this.cy&&this.cy.getElementById(e).remove(),new w.Notice(`Deleted relationship: ${t}`))}showLocationTooltip(e){let t=e.id(),n=this.entityManager.getEntity(t);if(!n||!n.properties.latitude||!n.properties.longitude)return;this.hideLocationTooltip();let i=document.createElement("div");i.id="graph_copilot-location-tooltip",i.className="graph_copilot-location-tooltip";let r=parseFloat(n.properties.latitude),a=parseFloat(n.properties.longitude);i.innerHTML=`
            <div style="font-weight: bold; margin-bottom: 4px;">\u{1F4CD} ${n.label}</div>
            <div style="font-size: 11px; color: var(--text-muted);">
                ${n.properties.address||""}<br>
                Lat: ${r.toFixed(4)}, Lng: ${a.toFixed(4)}
            </div>
            <div style="font-size: 10px; color: var(--text-accent); margin-top: 4px;">
                Right-click \u2192 Show on Map
            </div>
        `,i.style.cssText=`
            position: fixed;
            background: var(--background-primary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 6px;
            padding: 8px 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 250px;
            pointer-events: none;
        `;let s=e.renderedPosition(),l=this.container?.getBoundingClientRect();l&&(i.style.left=`${l.left+s.x+30}px`,i.style.top=`${l.top+s.y-20}px`),document.body.appendChild(i)}hideLocationTooltip(){let e=document.getElementById("graph_copilot-location-tooltip");e&&e.remove()}getGraphStyle(){return[{selector:"node",style:{"background-color":"data(color)",label:"data(label)","text-valign":"bottom","text-halign":"center","text-margin-y":5,"font-size":"12px",color:"#ffffff","text-outline-color":"#000000","text-outline-width":1,width:50,height:50,"border-width":2,"border-color":"#ffffff"}},{selector:'node[type = "Location"]',style:{shape:"diamond",width:45,height:55,"border-width":3,"border-color":"#ffffff"}},{selector:'node[type = "Location"].has-coordinates',style:{"border-style":"double","border-width":4}},{selector:"node:selected",style:{"border-width":4,"border-color":"#ffff00"}},{selector:"node.connection-source",style:{"border-width":5,"border-color":"#00ff00","border-style":"dashed"}},{selector:"node.multi-selected",style:{"border-width":4,"border-color":"#ff6b6b","border-style":"solid","overlay-color":"#ff6b6b","overlay-padding":6,"overlay-opacity":.2}},{selector:"edge",style:{width:2,"line-color":"#888888","target-arrow-color":"#888888","target-arrow-shape":"triangle","curve-style":"bezier",label:"data(label)","font-size":"10px",color:"#cccccc","text-rotation":"autorotate","text-margin-y":-10}},{selector:"edge:selected",style:{width:4,"line-color":"#ffff00"}},{selector:"edge.multi-selected",style:{width:4,"line-color":"#ff6b6b","target-arrow-color":"#ff6b6b","line-style":"solid"}}]}async refresh(){if(!this.cy)return;try{await this.entityManager.loadEntitiesFromNotes()}catch(r){console.error("[GraphView] Failed to reload entities from notes:",r)}let{entities:e,connections:t}=this.entityManager.getGraphData();this.cy.elements().remove();let n=e.map((r,a)=>{let s=r.type==="Location"&&r.properties.latitude&&r.properties.longitude,l=r.label!=null?String(r.label):"";return{data:{id:r.id,label:this.truncateLabel(l),fullLabel:l,type:r.type,color:D[r.type]?.color||"#607D8B",hasCoordinates:s},position:this.getNodePosition(a,e.length),classes:s?"has-coordinates":""}}),i=t.map(r=>({data:{id:r.id,source:r.fromEntityId,target:r.toEntityId,label:r.relationship}}));this.cy.add([...n,...i]),this.runLayout()}async refreshWithSavedPositions(){if(!this.cy)return;console.log(`[GraphView] refreshWithSavedPositions called, cache has ${this.nodePositionsCache.size} positions`);try{await this.entityManager.loadEntitiesFromNotes()}catch(s){console.error("[GraphView] Failed to reload entities from notes:",s)}let{entities:e,connections:t}=this.entityManager.getGraphData();console.log(`[GraphView] Found ${e.length} entities and ${t.length} connections`),this.cy.elements().remove();let n=[],i=[],r=e.map((s,l)=>{let c=s.type==="Location"&&s.properties.latitude&&s.properties.longitude,d=s.label!=null?String(s.label):"",p=this.nodePositionsCache.get(s.id),u;return p?(u=p,i.push(s.id)):(u=this.getNodePosition(l,e.length),n.push(s.id)),{data:{id:s.id,label:this.truncateLabel(d),fullLabel:d,type:s.type,color:D[s.type]?.color||"#607D8B",hasCoordinates:c},position:u,classes:c?"has-coordinates":""}});console.log(`[GraphView] Nodes with saved positions: ${i.length}, nodes needing layout: ${n.length}`),n.length>0&&n.length<=5&&console.log("[GraphView] Nodes needing layout:",n),i.length>0&&i.length<=5&&console.log("[GraphView] Nodes with saved positions:",i);let a=t.map(s=>({data:{id:s.id,source:s.fromEntityId,target:s.toEntityId,label:s.relationship}}));if(this.cy.add([...r,...a]),this.cy.nodes().forEach(s=>{let l=s.position();this.nodePositionsCache.set(s.id(),{x:l.x,y:l.y})}),n.length>0&&n.length<e.length){let s=this.cy.nodes().filter(l=>n.includes(l.id()));s.length>0&&(s.layout({name:"cose",animate:!0,animationDuration:300,fit:!1,nodeRepulsion:()=>8e3,idealEdgeLength:()=>100}).run(),setTimeout(()=>{s.forEach(l=>{let c=l.position();this.nodePositionsCache.set(l.id(),{x:c.x,y:c.y})}),this.savePositionsDebounced()},400))}else n.length===e.length&&e.length>0&&(this.runLayout(),setTimeout(()=>{this.cy.nodes().forEach(s=>{let l=s.position();this.nodePositionsCache.set(s.id(),{x:l.x,y:l.y})}),this.savePositionsDebounced()},600));this.cy.fit()}async rearrangeGraph(){this.cy&&(this.nodePositionsCache.clear(),this.runLayout(),setTimeout(()=>{this.cy.nodes().forEach(e=>{let t=e.position();this.nodePositionsCache.set(e.id(),{x:t.x,y:t.y})}),this.savePositions(),new w.Notice("Graph rearranged")},600))}showRearrangeConfirmation(){return new Promise(e=>{let t=document.createElement("div");t.className="modal-container",t.style.cssText=`
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;let n=document.createElement("div");n.className="modal",n.style.cssText=`
                background: var(--background-primary);
                border-radius: 8px;
                padding: 20px;
                max-width: 400px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            `;let i=document.createElement("h3");i.textContent="Rearrange Graph?",i.style.marginTop="0",n.appendChild(i);let r=document.createElement("p");r.textContent="Are you sure you want to rearrange all entities? This will reset their current positions.",n.appendChild(r);let a=document.createElement("div");a.style.cssText="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;";let s=document.createElement("button");s.textContent="Cancel",s.onclick=()=>{t.remove(),e(!1)},a.appendChild(s);let l=document.createElement("button");l.textContent="Rearrange",l.className="mod-cta",l.style.cssText="background: var(--interactive-accent); color: var(--text-on-accent);",l.onclick=()=>{t.remove(),e(!0)},a.appendChild(l),n.appendChild(a),t.appendChild(n),document.body.appendChild(t),t.addEventListener("click",c=>{c.target===t&&(t.remove(),e(!1))})})}truncateLabel(e,t=20){let n=e!=null?String(e):"";return n.length<=t?n:n.substring(0,t-3)+"..."}getNodePosition(e,t){let n=Math.max(200,t*30),i=2*Math.PI*e/t;return{x:n*Math.cos(i)+400,y:n*Math.sin(i)+300}}async loadSavedPositions(){try{console.log(`[GraphView] Looking for positions file at: ${z}`);let e=this.app.vault.getAbstractFileByPath(z);if(e instanceof w.TFile){let t=await this.app.vault.read(e),n=JSON.parse(t);this.nodePositionsCache.clear();for(let[i,r]of Object.entries(n))this.nodePositionsCache.set(i,r);console.log(`[GraphView] Loaded ${this.nodePositionsCache.size} saved node positions:`,Array.from(this.nodePositionsCache.entries()).slice(0,3))}else console.log("[GraphView] Positions file not found")}catch(e){console.log("[GraphView] No saved positions found, starting fresh:",e)}}async savePositions(){try{let e={};for(let[r,a]of this.nodePositionsCache.entries())e[r]=a;let t=JSON.stringify(e,null,2);console.log(`[GraphView] Saving ${Object.keys(e).length} positions to ${z}`);let n=z.substring(0,z.lastIndexOf("/"));try{this.app.vault.getAbstractFileByPath(n)||await this.app.vault.createFolder(n)}catch{}let i=this.app.vault.getAbstractFileByPath(z);if(i instanceof w.TFile)await this.app.vault.modify(i,t),console.log("[GraphView] Positions saved successfully (modified existing file)");else try{await this.app.vault.create(z,t),console.log("[GraphView] Positions saved successfully (created new file)")}catch(r){if(r.message?.includes("already exists")){let a=this.app.vault.getAbstractFileByPath(z);a instanceof w.TFile&&(await this.app.vault.modify(a,t),console.log("[GraphView] Positions saved successfully (modified after race condition)"))}else throw r}}catch(e){console.error("[GraphView] Failed to save positions:",e)}}debounce(e,t){let n=null;return(...i)=>{n&&clearTimeout(n),n=setTimeout(()=>e(...i),t)}}runLayout(){this.cy&&this.cy.layout({name:"cose",animate:!0,animationDuration:500,nodeRepulsion:()=>8e3,idealEdgeLength:()=>100,edgeElasticity:()=>100,nestingFactor:1.2,gravity:.25,numIter:1e3,initialTemp:200,coolingFactor:.95,minTemp:1}).run()}addEntity(e){if(!this.cy||this.cy.getElementById(e.id).length>0)return;let n=e.label!=null?String(e.label):"";this.cy.add({data:{id:e.id,label:this.truncateLabel(n),fullLabel:n,type:e.type,color:D[e.type]?.color||"#607D8B"},position:{x:400,y:300}}),this.runLayout()}addConnection(e){!this.cy||this.cy.getElementById(e.id).length>0||this.cy.add({data:{id:e.id,source:e.fromEntityId,target:e.toEntityId,label:e.relationship}})}removeEntity(e){this.cy&&this.cy.getElementById(e).remove()}highlightEntity(e){if(!this.cy)return;this.cy.elements().unselect();let t=this.cy.getElementById(e);t.length>0&&(t.select(),this.cy.animate({center:{eles:t},zoom:1.5},{duration:300}))}async performUndo(){if(!this.historyManager.canUndo()){new w.Notice("Nothing to undo");return}let e=this.historyManager.getLastUndoDescription();await this.historyManager.undo()?new w.Notice(`Undo: ${e}`):new w.Notice("Undo failed")}async performRedo(){if(!this.historyManager.canRedo()){new w.Notice("Nothing to redo");return}let e=this.historyManager.getLastRedoDescription();await this.historyManager.redo()?new w.Notice(`Redo: ${e}`):new w.Notice("Redo failed")}updateHistoryUI(){if(this.undoBtn){this.undoBtn.disabled=!this.historyManager.canUndo();let e=this.historyManager.getLastUndoDescription();this.undoBtn.title=e?`Undo: ${e}`:"Nothing to undo"}if(this.redoBtn){this.redoBtn.disabled=!this.historyManager.canRedo();let e=this.historyManager.getLastRedoDescription();this.redoBtn.title=e?`Redo: ${e}`:"Nothing to redo"}this.historyPanelVisible&&this.historyPanel&&this.renderHistoryPanelContent()}toggleHistoryPanel(){this.historyPanelVisible?this.hideHistoryPanel():this.showHistoryPanel()}showHistoryPanel(){this.historyPanel&&this.historyPanel.remove(),this.historyPanel=document.createElement("div"),this.historyPanel.className="graph_copilot-history-panel",this.historyPanel.style.cssText=`
            position: absolute;
            top: 60px;
            right: 10px;
            width: 280px;
            max-height: 400px;
            background: var(--background-primary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 99;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        `;let e=document.createElement("div");e.style.cssText=`
            padding: 10px 12px;
            font-weight: bold;
            border-bottom: 1px solid var(--background-modifier-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        `,e.innerHTML="<span>\u{1F4DC} Edit History</span>";let t=document.createElement("button");t.textContent="\u2715",t.style.cssText=`
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-muted);
        `,t.onclick=()=>this.hideHistoryPanel(),e.appendChild(t),this.historyPanel.appendChild(e);let n=document.createElement("div");n.className="graph_copilot-history-content",n.style.cssText=`
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        `,this.historyPanel.appendChild(n),this.container?.parentElement?.appendChild(this.historyPanel),this.historyPanelVisible=!0,this.renderHistoryPanelContent()}hideHistoryPanel(){this.historyPanel&&(this.historyPanel.remove(),this.historyPanel=null),this.historyPanelVisible=!1}renderHistoryPanelContent(){if(!this.historyPanel)return;let e=this.historyPanel.querySelector(".graph_copilot-history-content");if(!e)return;e.innerHTML="";let t=this.historyManager.getUndoStack(),n=this.historyManager.getRedoStack();if(t.length===0&&n.length===0){let r=document.createElement("div");r.style.cssText=`
                text-align: center;
                color: var(--text-muted);
                padding: 20px;
                font-size: 13px;
            `,r.textContent="No history yet",e.appendChild(r);return}if(n.length>0){let r=document.createElement("div");r.style.cssText=`
                font-size: 11px;
                color: var(--text-muted);
                padding: 4px 8px;
                text-transform: uppercase;
            `,r.textContent="Redo Stack",e.appendChild(r),[...n].reverse().forEach((a,s)=>{let l=this.createHistoryItem(a,"redo",s);e.appendChild(l)})}let i=document.createElement("div");if(i.style.cssText=`
            padding: 6px 8px;
            background: var(--interactive-accent);
            color: var(--text-on-accent);
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            margin: 4px 0;
        `,i.textContent="\u25B6 Current State",e.appendChild(i),t.length>0){let r=document.createElement("div");r.style.cssText=`
                font-size: 11px;
                color: var(--text-muted);
                padding: 4px 8px;
                text-transform: uppercase;
            `,r.textContent="Undo Stack",e.appendChild(r),[...t].reverse().forEach((a,s)=>{let l=this.createHistoryItem(a,"undo",s);e.appendChild(l)})}}createHistoryItem(e,t,n){let i=document.createElement("div");i.style.cssText=`
            padding: 8px;
            margin: 2px 0;
            background: var(--background-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            opacity: ${t==="redo"?"0.6":"1"};
        `;let r=this.getHistoryIcon(e.type),a=this.formatTime(e.timestamp);return i.innerHTML=`
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>${r} ${e.description}</span>
                <span style="font-size: 10px; color: var(--text-muted);">${a}</span>
            </div>
        `,i.onmouseenter=()=>i.style.background="var(--background-modifier-hover)",i.onmouseleave=()=>i.style.background="var(--background-secondary)",i.onclick=async()=>{t==="undo"?await this.historyManager.undoToEntry(e.id):await this.historyManager.redoToEntry(e.id)},i}getHistoryIcon(e){switch(e){case"entity_create":return"\u2795";case"entity_delete":return"\u{1F5D1}";case"entity_edit":return"\u270F\uFE0F";case"relationship_create":return"\u{1F517}";case"relationship_delete":return"\u2702\uFE0F";case"node_position_change":return"\u2194\uFE0F";case"batch_operation":return"\u{1F4E6}";default:return"\u2022"}}formatTime(e){let n=new Date().getTime()-e.getTime();return n<6e4?"just now":n<36e5?`${Math.floor(n/6e4)}m ago`:n<864e5?`${Math.floor(n/36e5)}h ago`:e.toLocaleDateString()}addEntityToGraphPreserveLayout(e){if(!this.cy||this.cy.getElementById(e.id).length>0)return;let n=D[e.type]||D.Person,i=e.label!=null?String(e.label):"",r=this.truncateLabel(i,15),s=this.nodePositionsCache.get(e.id)||{x:Math.random()*400+100,y:Math.random()*400+100};this.cy.add({data:{id:e.id,label:r,fullLabel:i,type:e.type,color:n.color},position:s}),this.nodePositionsCache.set(e.id,s)}updateEntityInGraph(e){if(!this.cy)return;let t=this.cy.getElementById(e.id);if(t.length===0)return;let n=D[e.type]||D.Person,i=e.label!=null?String(e.label):"",r=this.truncateLabel(i,15);t.data("label",r),t.data("fullLabel",i),t.data("type",e.type),t.data("color",n.color)}updateConnectionInGraph(e){if(!this.cy)return;let t=this.cy.getElementById(e.id);t.length!==0&&t.data("label",e.relationship)}addConnectionToGraph(e){!this.cy||this.cy.getElementById(e.id).length>0||this.cy.add({data:{id:e.id,source:e.fromEntityId,target:e.toEntityId,label:e.relationship}})}async geolocateEntity(e){let t=this.entityManager.getEntity(e);if(!t){new w.Notice("Entity not found");return}let n,i,r,a;if(t.type==="Location"?(n=t.properties.address,i=t.properties.city,a=t.properties.country):t.type==="Address"&&(n=t.properties.street||t.properties.full,i=t.properties.city,r=t.properties.state,a=t.properties.country),!n&&!i&&!a){new w.Notice("No address information found. Please add address details to the entity first.");return}try{new w.Notice("Geocoding address...");let s=await this.geocodingService.geocodeAddressWithRetry(n,i,r,a,(d,p,u)=>{new w.Notice(`Network error, retrying in ${u}s... (attempt ${d}/${p})`)}),l={latitude:s.latitude,longitude:s.longitude};s.city&&!i&&(l.city=s.city),s.state&&!r&&t.type==="Address"&&(l.state=s.state),s.country&&!a&&(l.country=s.country),s.postalCode&&t.type==="Address"&&!t.properties.postalCode&&(l.postalCode=s.postalCode),await this.entityManager.updateEntity(e,l);let c=this.entityManager.getEntity(e);c&&this.updateEntityInGraph(c),new w.Notice(`\u2713 Geocoded: ${s.displayName}
Lat: ${s.latitude.toFixed(4)}, Lng: ${s.longitude.toFixed(4)}
Confidence: ${s.confidence}`)}catch(s){s instanceof A?new w.Notice(`Geocoding failed: ${s.message}`):(console.error("[GraphView] Geocoding error:",s),new w.Notice("Failed to geocode address. Please try again."))}}};var Pe=require("obsidian");var Y="graph_copilot-timeline-view",pe=class extends Pe.ItemView{constructor(e,t,n){super(e);this.container=null;this.timelineContainer=null;this.events=[];this.onEventClick=null;this.entityManager=t,this.onEventClick=n||null}getViewType(){return Y}getDisplayText(){return"OSINTCopilot Timeline"}getIcon(){return"calendar-clock"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("graph_copilot-timeline-container");let t=e.createDiv({cls:"graph_copilot-timeline-toolbar"});this.createToolbar(t),this.timelineContainer=e.createDiv({cls:"graph_copilot-timeline-canvas"}),this.applyStyles(),await this.refresh()}async onClose(){this.events=[]}applyStyles(){this.timelineContainer&&(this.timelineContainer.style.cssText=`
            width: 100%;
            height: calc(100% - 50px);
            overflow-x: auto;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        `)}createToolbar(e){e.style.cssText=`
            display: flex;
            gap: 10px;
            padding: 10px;
            background: var(--background-secondary);
            border-bottom: 1px solid var(--background-modifier-border);
        `;let t=e.createEl("button",{text:"+ Add Event"});t.addClass("graph_copilot-add-entity-btn"),t.onclick=()=>this.openEventCreator(),e.createDiv({cls:"graph_copilot-toolbar-separator"});let n=e.createEl("button",{text:"\u21BB Refresh"});n.onclick=async()=>{n.disabled=!0,n.textContent="\u21BB Loading...",await this.refresh(),n.disabled=!1,n.textContent="\u21BB Refresh"},e.createEl("span",{text:'Shows events with "Add to Timeline" enabled',cls:"graph_copilot-timeline-info"}).style.cssText="margin-left: auto; color: var(--text-muted); font-size: 12px;"}openEventCreator(){new j(this.app,this.entityManager,"Event",t=>{this.refresh()}).open()}async refresh(){if(!this.timelineContainer)return;try{await this.entityManager.loadEntitiesFromNotes()}catch(t){console.error("[TimelineView] Failed to reload entities from notes:",t)}let e=this.entityManager.getEntitiesByType("Event");this.events=this.parseEvents(e),this.renderTimeline()}parseEvents(e){let t=[];for(let n of e){if(!n.properties.add_to_timeline)continue;let i=this.parseDate(n.properties.start_date);if(!i)continue;let r=this.parseDate(n.properties.end_date);t.push({id:n.id,label:n.label,start:i,end:r||void 0,color:D.Event.color})}return t.sort((n,i)=>n.start.getTime()-i.start.getTime()),t}parseDate(e){if(!e)return null;try{let t=e.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})/);if(t)return new Date(parseInt(t[1]),parseInt(t[2])-1,parseInt(t[3]),parseInt(t[4]),parseInt(t[5]));let n=new Date(e);if(!isNaN(n.getTime()))return n}catch{console.error("Failed to parse date:",e)}return null}renderTimeline(){if(!this.timelineContainer)return;if(this.timelineContainer.empty(),this.events.length===0){let n=this.timelineContainer.createDiv({cls:"graph_copilot-timeline-empty"});n.style.cssText="text-align: center; padding: 40px; color: var(--text-muted);",n.createEl("p",{text:"No events added to the timeline yet."}).style.marginBottom="10px",n.createEl("p",{text:'To add events: Create an Event entity with a start date, then check the "Add to Timeline" checkbox.'}).style.fontSize="12px";return}let e=this.timelineContainer.createDiv({cls:"graph_copilot-timeline-wrapper"});e.style.cssText=`
            position: relative;
            min-height: 100%;
            padding-left: 200px;
        `;let t=e.createDiv({cls:"graph_copilot-timeline-line"});t.style.cssText=`
            position: absolute;
            left: 180px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--interactive-accent);
            border-radius: 2px;
        `,this.events.forEach((n,i)=>{this.renderEvent(e,n,i)})}renderEvent(e,t,n){let i=e.createDiv({cls:"graph_copilot-timeline-event"});i.style.cssText=`
            position: relative;
            margin-bottom: 30px;
            padding-left: 40px;
        `;let r=i.createDiv({cls:"graph_copilot-timeline-dot"});r.style.cssText=`
            position: absolute;
            left: -12px;
            top: 5px;
            width: 20px;
            height: 20px;
            background: ${t.color};
            border-radius: 50%;
            border: 3px solid var(--background-primary);
            box-shadow: 0 0 0 2px ${t.color};
        `;let a=i.createDiv({cls:"graph_copilot-timeline-date"});a.style.cssText=`
            position: absolute;
            left: -180px;
            top: 0;
            width: 150px;
            text-align: right;
            font-size: 12px;
            color: var(--text-muted);
        `,a.textContent=this.formatDate(t.start);let s=i.createDiv({cls:"graph_copilot-timeline-card"});s.style.cssText=`
            background: var(--background-secondary);
            border-left: 4px solid ${t.color};
            padding: 15px;
            border-radius: 0 8px 8px 0;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        `;let l=s.createDiv({cls:"graph_copilot-timeline-card-header"});l.style.cssText=`
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        `;let c=l.createEl("h4",{text:t.label});c.style.cssText=`
            margin: 0;
            color: var(--text-normal);
            flex: 1;
        `;let d=l.createEl("button",{text:"\u2715 Remove",cls:"graph_copilot-timeline-remove-btn"});d.style.cssText=`
            background: transparent;
            border: 1px solid var(--text-muted);
            color: var(--text-muted);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        `,d.title="Remove from Timeline",d.onmouseenter=()=>{d.style.background="var(--background-modifier-error)",d.style.borderColor="var(--background-modifier-error)",d.style.color="white"},d.onmouseleave=()=>{d.style.background="transparent",d.style.borderColor="var(--text-muted)",d.style.color="var(--text-muted)"},d.onclick=async g=>{g.stopPropagation(),await this.toggleEventTimeline(t.id,!1)};let p=s.createDiv({cls:"graph_copilot-timeline-time"});p.style.cssText=`
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 5px;
        `;let u=this.formatTime(t.start);t.end&&(u+=` \u2192 ${this.formatTime(t.end)}`),p.textContent=u,s.onmouseenter=()=>{s.style.transform="translateX(5px)",s.style.boxShadow="0 4px 12px rgba(0,0,0,0.2)"},s.onmouseleave=()=>{s.style.transform="translateX(0)",s.style.boxShadow="none"},s.onclick=g=>{g.target.closest(".graph_copilot-timeline-remove-btn")||(this.onEventClick?this.onEventClick(t.id):this.entityManager.openEntityNote(t.id))}}async toggleEventTimeline(e,t){try{await this.entityManager.updateEntity(e,{add_to_timeline:t}),await this.refresh()}catch(n){console.error("[TimelineView] Failed to toggle event timeline status:",n)}}formatDate(e){let t={year:"numeric",month:"short",day:"numeric"};return e.toLocaleDateString(void 0,t)}formatTime(e){let t={hour:"2-digit",minute:"2-digit"};return e.toLocaleTimeString(void 0,t)}addEvent(e){e.type==="Event"&&this.refresh()}removeEvent(e){this.events=this.events.filter(t=>t.id!==e),this.renderTimeline()}};var G=require("obsidian");var q="graph_copilot-map-view",Ge=`
/* Leaflet CSS v1.9.4 - Inlined for CSP compliance */
.leaflet-pane,.leaflet-tile,.leaflet-marker-icon,.leaflet-marker-shadow,.leaflet-tile-container,.leaflet-pane>svg,.leaflet-pane>canvas,.leaflet-zoom-box,.leaflet-image-layer,.leaflet-layer{position:absolute;left:0;top:0}
.leaflet-container{overflow:hidden}
.leaflet-tile,.leaflet-marker-icon,.leaflet-marker-shadow{-webkit-user-select:none;-moz-user-select:none;user-select:none;-webkit-user-drag:none}
.leaflet-tile::selection{background:transparent}
.leaflet-safari .leaflet-tile{image-rendering:-webkit-optimize-contrast}
.leaflet-safari .leaflet-tile-container{width:1600px;height:1600px;-webkit-transform-origin:0 0}
.leaflet-marker-icon,.leaflet-marker-shadow{display:block}
.leaflet-container .leaflet-overlay-pane svg{max-width:none!important;max-height:none!important}
.leaflet-container .leaflet-marker-pane img,.leaflet-container .leaflet-shadow-pane img,.leaflet-container .leaflet-tile-pane img,.leaflet-container img.leaflet-image-layer,.leaflet-container .leaflet-tile{max-width:none!important;max-height:none!important;width:auto;padding:0}
.leaflet-container img.leaflet-tile{mix-blend-mode:plus-lighter}
.leaflet-container.leaflet-touch-zoom{-ms-touch-action:pan-x pan-y;touch-action:pan-x pan-y}
.leaflet-container.leaflet-touch-drag{-ms-touch-action:pinch-zoom;touch-action:none;touch-action:pinch-zoom}
.leaflet-container.leaflet-touch-drag.leaflet-touch-zoom{-ms-touch-action:none;touch-action:none}
.leaflet-container{-webkit-tap-highlight-color:transparent}
.leaflet-container a{-webkit-tap-highlight-color:rgba(51,181,229,.4)}
.leaflet-tile{filter:inherit;visibility:hidden}
.leaflet-tile-loaded{visibility:inherit}
.leaflet-zoom-box{width:0;height:0;-moz-box-sizing:border-box;box-sizing:border-box;z-index:800}
.leaflet-overlay-pane svg{-moz-user-select:none}
.leaflet-pane{z-index:400}
.leaflet-tile-pane{z-index:200}
.leaflet-overlay-pane{z-index:400}
.leaflet-shadow-pane{z-index:500}
.leaflet-marker-pane{z-index:600}
.leaflet-tooltip-pane{z-index:650}
.leaflet-popup-pane{z-index:700}
.leaflet-map-pane canvas{z-index:100}
.leaflet-map-pane svg{z-index:200}
.leaflet-vml-shape{width:1px;height:1px}
.lvml{behavior:url(#default#VML);display:inline-block;position:absolute}
.leaflet-control{position:relative;z-index:800;pointer-events:visiblePainted;pointer-events:auto}
.leaflet-top,.leaflet-bottom{position:absolute;z-index:1000;pointer-events:none}
.leaflet-top{top:0}
.leaflet-right{right:0}
.leaflet-bottom{bottom:0}
.leaflet-left{left:0}
.leaflet-control{float:left;clear:both}
.leaflet-right .leaflet-control{float:right}
.leaflet-top .leaflet-control{margin-top:10px}
.leaflet-bottom .leaflet-control{margin-bottom:10px}
.leaflet-left .leaflet-control{margin-left:10px}
.leaflet-right .leaflet-control{margin-right:10px}
.leaflet-fade-anim .leaflet-popup{opacity:0;-webkit-transition:opacity .2s linear;-moz-transition:opacity .2s linear;transition:opacity .2s linear}
.leaflet-fade-anim .leaflet-map-pane .leaflet-popup{opacity:1}
.leaflet-zoom-animated{-webkit-transform-origin:0 0;-ms-transform-origin:0 0;transform-origin:0 0}
svg.leaflet-zoom-animated{will-change:transform}
.leaflet-zoom-anim .leaflet-zoom-animated{-webkit-transition:-webkit-transform .25s cubic-bezier(0,0,.25,1);-moz-transition:-moz-transform .25s cubic-bezier(0,0,.25,1);transition:transform .25s cubic-bezier(0,0,.25,1)}
.leaflet-zoom-anim .leaflet-tile,.leaflet-pan-anim .leaflet-tile{-webkit-transition:none;-moz-transition:none;transition:none}
.leaflet-zoom-anim .leaflet-zoom-hide{visibility:hidden}
.leaflet-interactive{cursor:pointer}
.leaflet-grab{cursor:-webkit-grab;cursor:-moz-grab;cursor:grab}
.leaflet-crosshair,.leaflet-crosshair .leaflet-interactive{cursor:crosshair}
.leaflet-popup-pane,.leaflet-control{cursor:auto}
.leaflet-dragging .leaflet-grab,.leaflet-dragging .leaflet-grab .leaflet-interactive,.leaflet-dragging .leaflet-marker-draggable{cursor:move;cursor:-webkit-grabbing;cursor:-moz-grabbing;cursor:grabbing}
.leaflet-marker-icon,.leaflet-marker-shadow,.leaflet-image-layer,.leaflet-pane>svg path,.leaflet-tile-container{pointer-events:none}
.leaflet-marker-icon.leaflet-interactive,.leaflet-image-layer.leaflet-interactive,.leaflet-pane>svg path.leaflet-interactive,svg.leaflet-image-layer.leaflet-interactive path{pointer-events:visiblePainted;pointer-events:auto}
.leaflet-container{background:#ddd;outline-offset:1px}
.leaflet-container a{color:#0078A8}
.leaflet-zoom-box{border:2px dotted #38f;background:rgba(255,255,255,.5)}
.leaflet-container{font-family:"Helvetica Neue",Arial,Helvetica,sans-serif;font-size:12px;font-size:.75rem;line-height:1.5}
.leaflet-bar{box-shadow:0 1px 5px rgba(0,0,0,.65);border-radius:4px}
.leaflet-bar a{background-color:#fff;border-bottom:1px solid #ccc;width:26px;height:26px;line-height:26px;display:block;text-align:center;text-decoration:none;color:#000}
.leaflet-bar a,.leaflet-control-layers-toggle{background-position:50% 50%;background-repeat:no-repeat;display:block}
.leaflet-bar a:hover,.leaflet-bar a:focus{background-color:#f4f4f4}
.leaflet-bar a:first-child{border-top-left-radius:4px;border-top-right-radius:4px}
.leaflet-bar a:last-child{border-bottom-left-radius:4px;border-bottom-right-radius:4px;border-bottom:none}
.leaflet-bar a.leaflet-disabled{cursor:default;background-color:#f4f4f4;color:#bbb}
.leaflet-touch .leaflet-bar a{width:30px;height:30px;line-height:30px}
.leaflet-touch .leaflet-bar a:first-child{border-top-left-radius:2px;border-top-right-radius:2px}
.leaflet-touch .leaflet-bar a:last-child{border-bottom-left-radius:2px;border-bottom-right-radius:2px}
.leaflet-control-zoom-in,.leaflet-control-zoom-out{font:bold 18px 'Lucida Console',Monaco,monospace;text-indent:1px}
.leaflet-touch .leaflet-control-zoom-in,.leaflet-touch .leaflet-control-zoom-out{font-size:22px}
.leaflet-control-layers{box-shadow:0 1px 5px rgba(0,0,0,.4);background:#fff;border-radius:5px}
.leaflet-control-layers-toggle{width:36px;height:36px}
.leaflet-touch .leaflet-control-layers-toggle{width:44px;height:44px}
.leaflet-control-layers .leaflet-control-layers-list,.leaflet-control-layers-expanded .leaflet-control-layers-toggle{display:none}
.leaflet-control-layers-expanded .leaflet-control-layers-list{display:block;position:relative}
.leaflet-control-layers-expanded{padding:6px 10px 6px 6px;color:#333;background:#fff}
.leaflet-control-layers-scrollbar{overflow-y:scroll;overflow-x:hidden;padding-right:5px}
.leaflet-control-layers-selector{margin-top:2px;position:relative;top:1px}
.leaflet-control-layers label{display:block;font-size:13px;font-size:1.08333em}
.leaflet-control-layers-separator{height:0;border-top:1px solid #ddd;margin:5px -10px 5px -6px}
.leaflet-container .leaflet-control-attribution{background:#fff;background:rgba(255,255,255,.8);margin:0}
.leaflet-control-attribution,.leaflet-control-scale-line{padding:0 5px;color:#333;line-height:1.4}
.leaflet-control-attribution a{text-decoration:none}
.leaflet-control-attribution a:hover,.leaflet-control-attribution a:focus{text-decoration:underline}
.leaflet-attribution-flag{display:inline!important;vertical-align:baseline!important;width:1em;height:.6669em}
.leaflet-left .leaflet-control-scale{margin-left:5px}
.leaflet-bottom .leaflet-control-scale{margin-bottom:5px}
.leaflet-control-scale-line{border:2px solid #777;border-top:none;line-height:1.1;padding:2px 5px 1px;white-space:nowrap;-moz-box-sizing:border-box;box-sizing:border-box;background:rgba(255,255,255,.8);text-shadow:1px 1px #fff}
.leaflet-control-scale-line:not(:first-child){border-top:2px solid #777;border-bottom:none;margin-top:-2px}
.leaflet-control-scale-line:not(:first-child):not(:last-child){border-bottom:2px solid #777}
.leaflet-touch .leaflet-control-attribution,.leaflet-touch .leaflet-control-layers,.leaflet-touch .leaflet-bar{box-shadow:none}
.leaflet-touch .leaflet-control-layers,.leaflet-touch .leaflet-bar{border:2px solid rgba(0,0,0,.2);background-clip:padding-box}
.leaflet-popup{position:absolute;text-align:center;margin-bottom:20px}
.leaflet-popup-content-wrapper{padding:1px;text-align:left;border-radius:12px}
.leaflet-popup-content{margin:13px 24px 13px 20px;line-height:1.3;font-size:13px;font-size:1.08333em;min-height:1px}
.leaflet-popup-content p{margin:17px 0;margin:1.3em 0}
.leaflet-popup-tip-container{width:40px;height:20px;position:absolute;left:50%;margin-top:-1px;margin-left:-20px;overflow:hidden;pointer-events:none}
.leaflet-popup-tip{width:17px;height:17px;padding:1px;margin:-10px auto 0;pointer-events:auto;-webkit-transform:rotate(45deg);-moz-transform:rotate(45deg);-ms-transform:rotate(45deg);transform:rotate(45deg)}
.leaflet-popup-content-wrapper,.leaflet-popup-tip{background:#fff;color:#333;box-shadow:0 3px 14px rgba(0,0,0,.4)}
.leaflet-container a.leaflet-popup-close-button{position:absolute;top:0;right:0;border:none;text-align:center;width:24px;height:24px;font:16px/24px Tahoma,Verdana,sans-serif;color:#757575;text-decoration:none;background:transparent}
.leaflet-container a.leaflet-popup-close-button:hover,.leaflet-container a.leaflet-popup-close-button:focus{color:#585858}
.leaflet-popup-scrolled{overflow:auto}
.leaflet-oldie .leaflet-popup-content-wrapper{-ms-zoom:1}
.leaflet-oldie .leaflet-popup-tip{width:24px;margin:0 auto;-ms-filter:"progid:DXImageTransform.Microsoft.Matrix(M11=0.70710678, M12=0.70710678, M21=-0.70710678, M22=0.70710678)";filter:progid:DXImageTransform.Microsoft.Matrix(M11=0.70710678,M12=0.70710678,M21=-0.70710678,M22=0.70710678)}
.leaflet-oldie .leaflet-control-zoom,.leaflet-oldie .leaflet-control-layers,.leaflet-oldie .leaflet-popup-content-wrapper,.leaflet-oldie .leaflet-popup-tip{border:1px solid #999}
.leaflet-div-icon{background:#fff;border:1px solid #666}
.leaflet-tooltip{position:absolute;padding:6px;background-color:#fff;border:1px solid #fff;border-radius:3px;color:#222;white-space:nowrap;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;pointer-events:none;box-shadow:0 1px 3px rgba(0,0,0,.4)}
.leaflet-tooltip.leaflet-interactive{cursor:pointer;pointer-events:auto}
.leaflet-tooltip-top:before,.leaflet-tooltip-bottom:before,.leaflet-tooltip-left:before,.leaflet-tooltip-right:before{position:absolute;pointer-events:none;border:6px solid transparent;background:transparent;content:""}
.leaflet-tooltip-bottom{margin-top:6px}
.leaflet-tooltip-top{margin-top:-6px}
.leaflet-tooltip-bottom:before,.leaflet-tooltip-top:before{left:50%;margin-left:-6px}
.leaflet-tooltip-top:before{bottom:0;margin-bottom:-12px;border-top-color:#fff}
.leaflet-tooltip-bottom:before{top:0;margin-top:-12px;margin-left:-6px;border-bottom-color:#fff}
.leaflet-tooltip-left{margin-left:-6px}
.leaflet-tooltip-right{margin-left:6px}
.leaflet-tooltip-left:before,.leaflet-tooltip-right:before{top:50%;margin-top:-6px}
.leaflet-tooltip-left:before{right:0;margin-right:-12px;border-left-color:#fff}
.leaflet-tooltip-right:before{left:0;margin-left:-12px;border-right-color:#fff}
@media print{.leaflet-control{-webkit-print-color-adjust:exact;print-color-adjust:exact}}
`,ue=class extends G.ItemView{constructor(e,t,n){super(e);this.map=null;this.markers=new Map;this.container=null;this.onLocationClick=null;this.entityManager=t,this.onLocationClick=n||null,this.geocodingService=new O}getViewType(){return q}getDisplayText(){return"OSINTCopilot Map"}getIcon(){return"map-pin"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("graph_copilot-map-container");let t=e.createDiv({cls:"graph_copilot-map-toolbar"});this.createToolbar(t),this.container=e.createDiv({cls:"graph_copilot-map-canvas"}),this.container.id="graph_copilot-map-"+Date.now(),this.container.style.cssText=`
            width: 100%;
            height: calc(100% - 50px);
        `,await this.loadLeaflet(),this.initializeMap(),setTimeout(async()=>{await this.refresh()},200)}async onClose(){this.map&&(this.map.remove(),this.map=null),this.markers.clear()}async loadLeaflet(){if(!(typeof L<"u")){if(!document.getElementById("leaflet-inline-css")){let e=document.createElement("style");e.id="leaflet-inline-css",e.textContent=Ge,document.head.appendChild(e)}return new Promise((e,t)=>{let n=document.createElement("script");n.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",n.onload=()=>e(),n.onerror=()=>t(new Error("Failed to load Leaflet")),document.head.appendChild(n)})}}createToolbar(e){e.style.cssText=`
            display: flex;
            gap: 10px;
            padding: 10px;
            background: var(--background-secondary);
            border-bottom: 1px solid var(--background-modifier-border);
        `;let t=e.createEl("button",{text:"+ Add Location"});t.addClass("graph_copilot-add-entity-btn"),t.onclick=()=>this.openLocationCreator(),e.createDiv({cls:"graph_copilot-toolbar-separator"});let n=e.createEl("button",{text:"\u21BB Refresh"});n.onclick=async()=>await this.refresh();let i=e.createEl("button",{text:"\u22A1 Fit All"});i.onclick=()=>this.fitAllMarkers();let r=e.createEl("button",{text:"\u{1F4CD} Geolocate Missing"});r.onclick=()=>this.showGeolocateMissingDialog(),e.createEl("span",{text:"Map shows all Location entities with coordinates",cls:"graph_copilot-map-info"}).style.cssText="margin-left: auto; color: var(--text-muted); font-size: 12px;"}openLocationCreator(){new j(this.app,this.entityManager,"Location",t=>{this.refresh()}).open()}initializeMap(){if(!this.container||typeof L>"u")return;this.map=L.map(this.container.id,{center:[20,0],zoom:2,zoomControl:!0});let e=L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'\xA9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19,crossOrigin:"anonymous"}),t=L.tileLayer("https://tile.openstreetmap.de/{z}/{x}/{y}.png",{attribution:'\xA9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19,crossOrigin:"anonymous"}),n=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:'\xA9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors \xA9 <a href="https://carto.com/attributions">CARTO</a>',subdomains:"abcd",maxZoom:20,crossOrigin:"anonymous"});e.on("tileerror",()=>{console.log("OSM tiles failed, trying fallback..."),this.map.hasLayer(n)||(e.remove(),n.addTo(this.map))}),e.addTo(this.map);let i={OpenStreetMap:e,"OpenStreetMap DE":t,"Carto Light":n};L.control.layers(i).addTo(this.map),setTimeout(()=>{this.map?.invalidateSize()},100)}async refresh(){if(console.log("[MapView] refresh() called, map exists:",!!this.map),!this.map)return;try{await this.entityManager.loadEntitiesFromNotes(),console.log("[MapView] Entities reloaded from notes")}catch(r){console.error("[MapView] Failed to reload entities:",r)}this.markers.forEach(r=>r.remove()),this.markers.clear();let e=this.entityManager.getEntitiesByType("Location"),t=this.entityManager.getAllEntities().filter(r=>r.type==="Address"),n=[...e,...t];console.log("[MapView] Found Location and Address entities:",n.length,n);let i=this.parseLocations(n);console.log("[MapView] Parsed locations with coordinates:",i.length,i),i.forEach(r=>{console.log("[MapView] Adding marker for:",r.label,"at",r.lat,r.lng),this.addMarker(r)}),console.log("[MapView] Total markers added:",this.markers.size),i.length>0&&this.fitAllMarkers()}parseLocations(e){let t=[];for(let n of e){console.log("[MapView] Parsing entity:",n.label,"properties:",n.properties);let i=this.parseCoordinate(n.properties.latitude),r=this.parseCoordinate(n.properties.longitude);if(console.log("[MapView] Parsed coordinates - lat:",i,"lng:",r),i!==null&&r!==null){let a=n.type==="Address"?n.properties.street||n.properties.full:n.properties.address;t.push({id:n.id,label:n.label,lat:i,lng:r,address:a,city:n.properties.city,country:n.properties.country})}else console.log("[MapView] Skipping entity - missing coordinates")}return t}parseCoordinate(e){if(e==null||e==="")return console.log("[MapView] parseCoordinate: value is empty/undefined:",e),null;let t=typeof e=="number"?e:parseFloat(e);return isNaN(t)?(console.log("[MapView] parseCoordinate: value is NaN:",e),null):t}addMarker(e){if(!this.map||typeof L>"u")return;let t=D.Location.color,n=L.divIcon({className:"graph_copilot-map-marker",html:`<div style="
                background: ${t};
                width: 24px;
                height: 24px;
                border-radius: 50% 50% 50% 0;
                transform: rotate(-45deg);
                border: 2px solid white;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            "></div>`,iconSize:[24,24],iconAnchor:[12,24],popupAnchor:[0,-24]}),i=L.marker([e.lat,e.lng],{icon:n}).addTo(this.map),r=this.createPopupContent(e);i.bindPopup(r),i.on("click",()=>{this.onLocationClick&&this.onLocationClick(e.id)}),i.on("dblclick",()=>{this.entityManager.openEntityNote(e.id)}),this.markers.set(e.id,i)}createPopupContent(e){let t='<div style="min-width: 150px;">';if(t+=`<strong>${e.label}</strong>`,e.address&&(t+=`<br><small>${e.address}</small>`),e.city||e.country){let n=[e.city,e.country].filter(Boolean);t+=`<br><small>${n.join(", ")}</small>`}return t+=`<br><small style="color: #888;">
            ${e.lat.toFixed(6)}, ${e.lng.toFixed(6)}
        </small>`,t+=`<br><a href="#" onclick="return false;" style="font-size: 11px;">
            Double-click to open note
        </a>`,t+="</div>",t}fitAllMarkers(){if(!this.map||this.markers.size===0)return;let e=L.latLngBounds([]);this.markers.forEach(t=>{e.extend(t.getLatLng())}),this.map.fitBounds(e,{padding:[50,50]})}addLocation(e){if(e.type!=="Location")return;let t=this.parseCoordinate(e.properties.latitude),n=this.parseCoordinate(e.properties.longitude);t!==null&&n!==null&&this.addMarker({id:e.id,label:e.label,lat:t,lng:n,address:e.properties.address,city:e.properties.city,country:e.properties.country})}removeLocation(e){let t=this.markers.get(e);t&&(t.remove(),this.markers.delete(e))}focusLocation(e){console.log("[MapView] focusLocation called for:",e),console.log("[MapView] Available markers:",Array.from(this.markers.keys()));let t=this.markers.get(e);t&&this.map?(console.log("[MapView] Found marker, focusing..."),this.map.setView(t.getLatLng(),15),t.openPopup()):console.log("[MapView] Marker not found for entity:",e)}async showGeolocateMissingDialog(){let t=this.entityManager.getAllEntities().filter(i=>{let r=i.type==="Location"||i.type==="Address",a=!i.properties.latitude||!i.properties.longitude,s=i.properties.address||i.properties.street||i.properties.full||i.properties.city||i.properties.country;return r&&a&&s});if(t.length===0){new G.Notice("No locations found that need geocoding");return}new be(this.app,t,this.geocodingService,this.entityManager,async()=>{await this.refresh()}).open()}},be=class extends G.Modal{constructor(o,e,t,n,i){super(o),this.locations=e,this.geocodingService=t,this.entityManager=n,this.onComplete=i}onOpen(){let{contentEl:o}=this;o.empty(),o.createEl("h2",{text:"Geolocate Locations"}),o.createEl("p",{text:`Found ${this.locations.length} location(s) without coordinates that can be geocoded.`});let e=o.createDiv({cls:"geolocate-list"});e.style.cssText=`
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        `,this.locations.forEach(r=>{let a=e.createDiv({cls:"geolocate-item"});a.style.cssText=`
                padding: 10px;
                margin: 5px 0;
                border: 1px solid var(--background-modifier-border);
                border-radius: 4px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            `;let s=a.createDiv();s.createEl("strong",{text:r.label}),s.createEl("br");let l=r.properties.address||r.properties.street||r.properties.full||r.properties.city||r.properties.country;s.createEl("small",{text:String(l),cls:"text-muted"});let c=a.createEl("button",{text:"\u{1F4CD} Geolocate"});c.onclick=async()=>{c.disabled=!0,c.textContent="Geocoding...",await this.geolocateEntity(r,c,a)}});let t=o.createDiv({cls:"modal-button-container"});t.style.cssText="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;";let n=t.createEl("button",{text:"Geolocate All"});n.onclick=async()=>{n.disabled=!0,await this.geolocateAll(),n.disabled=!1};let i=t.createEl("button",{text:"Close"});i.onclick=()=>this.close()}async geolocateEntity(o,e,t){try{let n,i,r,a;o.type==="Location"?(n=o.properties.address,i=o.properties.city,a=o.properties.country):o.type==="Address"&&(n=o.properties.street||o.properties.full,i=o.properties.city,r=o.properties.state,a=o.properties.country);let s=await this.geocodingService.geocodeAddressWithRetry(n,i,r,a,(c,d,p)=>{new G.Notice(`Network error, retrying in ${p}s... (attempt ${c}/${d})`)}),l={latitude:s.latitude,longitude:s.longitude};s.city&&!i&&(l.city=s.city),s.state&&!r&&o.type==="Address"&&(l.state=s.state),s.country&&!a&&(l.country=s.country),s.postalCode&&o.type==="Address"&&!o.properties.postalCode&&(l.postalCode=s.postalCode),await this.entityManager.updateEntity(o.id,l),e.textContent="\u2713 Done",e.style.color="var(--text-success)",t.style.borderColor="var(--text-success)"}catch(n){e.textContent="\u2717 Failed",e.style.color="var(--text-error)",n instanceof A?new G.Notice(`Failed to geocode ${o.label}: ${n.message}`):new G.Notice(`Failed to geocode ${o.label}`),e.disabled=!1}}async geolocateAll(){let o=0,e=0;for(let t of this.locations)try{let n,i,r,a;t.type==="Location"?(n=t.properties.address,i=t.properties.city,a=t.properties.country):t.type==="Address"&&(n=t.properties.street||t.properties.full,i=t.properties.city,r=t.properties.state,a=t.properties.country);let s=await this.geocodingService.geocodeAddressWithRetry(n,i,r,a,(c,d,p)=>{new G.Notice(`Network error, retrying in ${p}s... (attempt ${c}/${d})`)}),l={latitude:s.latitude,longitude:s.longitude};s.city&&!i&&(l.city=s.city),s.state&&!r&&t.type==="Address"&&(l.state=s.state),s.country&&!a&&(l.country=s.country),s.postalCode&&t.type==="Address"&&!t.properties.postalCode&&(l.postalCode=s.postalCode),await this.entityManager.updateEntity(t.id,l),o++}catch(n){console.error(`Failed to geocode ${t.label}:`,n),e++}new G.Notice(`Geocoded ${o} location(s). ${e} failed.`),await this.onComplete(),this.close()}onClose(){let{contentEl:o}=this;o.empty()}};var Se="gpt-4o-mini",Be="gpt-4o-mini",ze="gpt-5-mini",Ve={systemPrompt:"You are a vault assistant. Answer questions clearly and concisely based on the provided notes. Cite note paths in-line where useful.",maxNotes:15,reportApiKey:"",reportOutputDir:"Reports",graphApiUrl:"https://api.osint-copilot.com",entityBasePath:"OSINTCopilot",enableGraphFeatures:!0,autoRefreshGraph:!0,autoOpenGraphOnEntityCreation:!1,conversationFolder:".osint-copilot/conversations"},K="https://api.osint-copilot.com",X="vault-ai-chat-view",he=class extends b.Plugin{constructor(){super(...arguments);this.index=new Map}async onload(){await this.loadSettings(),this.settings.reportApiKey||new b.Notice("OSINT Copilot: License key required for AI features. Visualization features (Graph, Timeline, Map) are free. Configure in settings."),this.entityManager=new te(this.app,this.settings.entityBasePath),this.graphApiService=new ne(this.settings.graphApiUrl,this.settings.reportApiKey),this.conversationService=new ie(this.app,this.settings.conversationFolder);try{await this.conversationService.initialize(),console.log("OSINTCopilot: Conversation service initialized")}catch(e){console.warn("OSINTCopilot: Conversation service initialization had issues:",e)}if(this.settings.enableGraphFeatures){try{await this.entityManager.initialize(),console.log("OSINTCopilot: Local entity storage initialized")}catch(e){console.warn("OSINTCopilot: Entity storage initialization had issues:",e)}this.graphApiService.checkHealth().then(e=>{e?console.log("OSINTCopilot: Graph API connected",e):console.log("OSINTCopilot: Graph API unavailable - running in local-only mode")}).catch(e=>{console.log("OSINTCopilot: Graph API unavailable - running in local-only mode")})}this.registerView(X,e=>new xe(e,this)),this.registerView(V,e=>(console.log("[VaultAIPlugin] Creating GraphView instance"),this.settings.enableGraphFeatures||console.warn("[VaultAIPlugin] Graph features are disabled in settings"),new de(e,this.entityManager,t=>this.onEntityClick(t),t=>this.showEntityOnMap(t)))),this.registerView(Y,e=>new pe(e,this.entityManager,t=>this.onEntityClick(t))),this.registerView(q,e=>new ue(e,this.entityManager,t=>this.onEntityClick(t))),this.addRibbonIcon("message-square","OSINT Copilot Chat",async()=>{await this.openChatView()}),this.settings.enableGraphFeatures&&(this.addRibbonIcon("git-fork","Entity Graph",async()=>{await this.openGraphView()}),this.addRibbonIcon("calendar","Timeline",async()=>{await this.openTimelineView()}),this.addRibbonIcon("map-pin","Location Map",async()=>{await this.openMapView()})),await this.buildIndex(),this.registerEvent(this.app.vault.on("modify",e=>{e instanceof b.TFile&&this.indexFile(e)})),this.registerEvent(this.app.vault.on("create",e=>{e instanceof b.TFile&&this.indexFile(e)})),this.registerEvent(this.app.vault.on("delete",e=>{e instanceof b.TFile&&this.index.delete(e.path)})),this.addCommand({id:"open-chat-view",name:"Open Chat",callback:async()=>await this.openChatView()}),this.addCommand({id:"open-graph-view",name:"Open Entity Graph",callback:async()=>await this.openGraphView()}),this.addCommand({id:"open-timeline-view",name:"Open Timeline",callback:async()=>await this.openTimelineView()}),this.addCommand({id:"open-map-view",name:"Open Location Map",callback:async()=>await this.openMapView()}),this.addCommand({id:"ask-vault",name:"Ask (remote)",callback:()=>this.openAskModal()}),this.addCommand({id:"reindex-vault",name:"Reindex vault",callback:async()=>{await this.buildIndex(),new b.Notice("Vault reindexed successfully.")}}),this.addCommand({id:"reload-entities",name:"Reload Entities from Notes",callback:async()=>{await this.entityManager.loadEntitiesFromNotes(),new b.Notice("Entities reloaded from notes.")}}),this.addSettingTab(new we(this.app,this))}async onunload(){this.app.workspace.detachLeavesOfType(X),this.app.workspace.detachLeavesOfType(V),this.app.workspace.detachLeavesOfType(Y),this.app.workspace.detachLeavesOfType(q)}async loadSettings(){this.settings=Object.assign({},Ve,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.graphApiService&&(this.graphApiService.setBaseUrl(this.settings.graphApiUrl),this.graphApiService.setApiKey(this.settings.reportApiKey)),this.entityManager&&this.entityManager.setBasePath(this.settings.entityBasePath)}isAuthenticated(){return!!this.settings.reportApiKey}async openGraphView(){if(!this.settings.enableGraphFeatures){new b.Notice("Graph features are disabled. Enable them in Settings \u2192 OSINT Copilot \u2192 Enable Graph Features",5e3),console.warn("[VaultAIPlugin] Attempted to open graph view but graph features are disabled");return}console.log("[VaultAIPlugin] Opening graph view");let e=this.app.workspace.getLeavesOfType(V);if(e.length>0)return this.app.workspace.revealLeaf(e[0]),e[0];let t=this.app.workspace.getRightLeaf(!1);return t?(await t.setViewState({type:V,active:!0}),this.app.workspace.revealLeaf(t),t):null}async openGraphViewWithEntity(e){let t=await this.openGraphView();t&&setTimeout(()=>{let n=t.view;n&&typeof n.highlightEntity=="function"&&n.highlightEntity(e)},300)}async refreshGraphView(){let e=this.app.workspace.getLeavesOfType(V);if(e.length>0){let t=e[0].view;t&&typeof t.refreshWithSavedPositions=="function"&&(console.log("[OSINT Copilot] Refreshing graph view with new entities..."),await t.refreshWithSavedPositions(),new b.Notice("Graph view updated with new entities"))}}async refreshOrOpenGraphView(){if(!this.settings.enableGraphFeatures)return;this.app.workspace.getLeavesOfType(V).length>0?this.settings.autoRefreshGraph&&await this.refreshGraphView():this.settings.autoOpenGraphOnEntityCreation&&(console.log("[OSINT Copilot] Auto-opening graph view with new entities..."),await this.openGraphView(),new b.Notice("Graph view opened with new entities"))}async openTimelineView(){let e=this.app.workspace.getLeavesOfType(Y);if(e.length>0){this.app.workspace.revealLeaf(e[0]);return}let t=this.app.workspace.getRightLeaf(!1);t&&(await t.setViewState({type:Y,active:!0}),this.app.workspace.revealLeaf(t))}async openMapView(){let e=this.app.workspace.getLeavesOfType(q);if(e.length>0){this.app.workspace.revealLeaf(e[0]);return}let t=this.app.workspace.getRightLeaf(!1);t&&(await t.setViewState({type:q,active:!0}),this.app.workspace.revealLeaf(t))}onEntityClick(e){this.entityManager.openEntityNote(e)}async showEntityOnMap(e){let t=this.entityManager.getEntity(e);if(!t){new b.Notice("Entity not found");return}if(t.type!=="Location"){new b.Notice("Only Location entities can be shown on the map");return}if(!t.properties.latitude||!t.properties.longitude){new b.Notice("Location has no coordinates. Please add latitude and longitude.");return}await this.openMapView(),setTimeout(()=>{let n=this.app.workspace.getLeavesOfType(q);if(n.length>0){let i=n[0].view;i&&typeof i.focusLocation=="function"&&(i.refresh(),setTimeout(()=>{i.focusLocation(e)},200))}},300)}async buildIndex(){this.index.clear();let e=this.app.vault.getMarkdownFiles();for(let t of e)await this.indexFile(t)}async indexFile(e){try{let t=await this.app.vault.read(e),n=this.app.metadataCache.getFileCache(e),i=this.extractTags(n),r=this.extractLinks(n),a=n?.frontmatter||void 0;this.index.set(e.path,{path:e.path,content:t,tags:i,links:r,frontmatter:a,updated:e.stat.mtime})}catch(t){console.error(`Failed to index file ${e.path}:`,t)}}extractTags(e){if(!e)return[];let t=[];if(e.tags&&e.tags.forEach(n=>t.push(n.tag)),e.frontmatter?.tags){let n=e.frontmatter.tags;Array.isArray(n)?t.push(...n.map(i=>i.startsWith("#")?i:`#${i}`)):typeof n=="string"&&t.push(n.startsWith("#")?n:`#${n}`)}return t}extractLinks(e){return!e||!e.links?[]:e.links.map(t=>t.link)}retrieveNotes(e){let t=e.toLowerCase(),n=this.tokenizeEnglish(t),i=[];for(let r of this.index.values()){let a=0,s=r.content.toLowerCase();(s.includes(t)||this.fuzzyMatchText(s,n))&&(a+=2),r.tags.some(c=>{let d=c.toLowerCase();return d.includes(t)||this.fuzzyMatchText(d,n)})&&(a+=1);let l=r.path.toLowerCase();(l.includes(t)||this.fuzzyMatchText(l,n))&&(a+=1),a>0&&i.push({note:r,score:a})}return i.sort((r,a)=>a.score-r.score),i.slice(0,this.settings.maxNotes).map(r=>r.note)}tokenizeEnglish(e){return(e.match(/\b[a-z0-9]{3,}\b/gi)||[]).map(t=>t.toLowerCase())}fuzzyMatchText(e,t){if(t.length===0||t.length>3)return!1;let n=this.tokenizeEnglish(e);if(n.length===0)return!1;let r=n.slice(0,800);for(let a of t)if(!(a.length<3)){for(let s of r)if(!(Math.abs(s.length-a.length)>2)&&this.levenshteinDistance(a,s)<=1)return!0}return!1}levenshteinDistance(e,t){let n=e.length,i=t.length;if(n===0)return i;if(i===0)return n;let r=new Array(i+1);for(let a=0;a<=i;a++)r[a]=a;for(let a=1;a<=n;a++){let s=r[0];r[0]=a;for(let l=1;l<=i;l++){let c=r[l];e[a-1]===t[l-1]?r[l]=s:r[l]=Math.min(s+1,r[l]+1,r[l-1]+1),s=c}}return r[i]}async callRemoteModel(e,t=!1,n){if(!this.settings.reportApiKey)throw new Error("License key is required. Please configure it in settings.");let i=`${K}/api/chat/completion`;try{let a={model:n||Se,messages:e,stream:t},s=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.settings.reportApiKey}`},body:JSON.stringify(a),mode:"cors",credentials:"omit"});if(!s.ok){let u=await s.text().catch(()=>"");throw console.error("[callRemoteModel] API error:",s.status,u),new Error(`API request failed (${s.status}): ${u.substring(0,200)}`)}if(!t){let u=await s.json();return u.choices?.[0]?.message?.content||u.choices?.[0]?.text||u.content||""||"No answer received."}if(!s.body)throw new Error("Response body is null");let l=s.body.getReader(),c=new TextDecoder,d="",p="";for(;;){let{done:u,value:g}=await l.read();if(u)break;let y=c.decode(g,{stream:!0});p+=y;let h=p.split(`
`);p=h.pop()??"";for(let m of h){let f=m.trim();if(!f.startsWith("data:"))continue;let x=f.slice(5).trim();if(x!=="[DONE]")try{let C=JSON.parse(x),S=C.choices?.[0]?.delta?.content,k=C.choices?.[0]?.message?.content,I=S??k??"";I&&(d+=I)}catch(C){console.warn("Failed to parse SSE chunk:",C,f)}}}return d||(d="No answer received."),d}catch(r){throw r instanceof Error?new Error(`Model call failed: ${r.message}`):r}}isTransientNetworkError(e){let t=e.message.toLowerCase();return["network","fetch","failed to fetch","net::err_","err_network_changed","network_changed","connection","timeout","timed out","econnreset","econnrefused","enotfound","socket","dns","abort","aborted"].some(i=>t.includes(i))}sleep(e){return new Promise(t=>setTimeout(t,e))}async executeStreamingFetch(e,t,n){let i=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.settings.reportApiKey}`},body:JSON.stringify({model:Se,messages:t,stream:!0}),mode:"cors",credentials:"omit"});if(!i.ok){let c=await this.callRemoteModel(t);return n&&n(c),c}if(!i.body||!("getReader"in i.body)){let c=await this.callRemoteModel(t);return n&&n(c),c}let r=i.body.getReader(),a=new TextDecoder("utf-8"),s="",l="";for(;;){let{value:c,done:d}=await r.read();if(d)break;l+=a.decode(c,{stream:!0});let p=l.split(`
`);l=p.pop()??"";for(let u of p){let g=u.trim();if(!g.startsWith("data:"))continue;let y=g.slice(5).trim();if(y==="[DONE]")return s;try{let m=JSON.parse(y)?.choices?.[0]?.delta?.content??"";m&&(s+=m,n?.(m))}catch{}}}return s}async callRemoteModelStream(e,t,n){if(!this.settings.reportApiKey)throw new Error("License key is required. Please configure it in settings.");let i=`${K}/api/chat`,r=3,a=l=>[500,1e3,2e3][l-1]||2e3,s=null;for(let l=1;l<=r;l++)try{return await this.executeStreamingFetch(i,e,t)}catch(c){if(s=c instanceof Error?c:new Error(String(c)),!this.isTransientNetworkError(s))break;if(l<r){let d=a(l);console.log(`[OSINT Copilot] Network error, retrying in ${d}ms (attempt ${l}/${r})`),n&&n(l,r),await this.sleep(d)}}if(s){let l=s.message.toLowerCase();throw this.isTransientNetworkError(s)?new Error("Network connection error. Please check your internet connection and try again."):l.includes("abort")?new Error("Request was cancelled."):new Error(`API request failed: ${s.message}`)}throw new Error("An unexpected error occurred. Please try again.")}async askVault(e){if(!this.isAuthenticated())throw new Error("License key required for AI features. Please configure your license key in settings.");let t=this.retrieveNotes(e);if(t.length===0)return{answer:"No relevant notes found for your query.",notes:[]};let n=`User query: "${e}"

Here are relevant notes:

`;for(let a of t){n+=`--- Note: ${a.path} ---
`,a.tags.length>0&&(n+=`Tags: ${a.tags.join(", ")}
`),a.frontmatter&&(n+=`Frontmatter: ${JSON.stringify(a.frontmatter)}
`);let s=a.content.length>1500?a.content.substring(0,1500)+"...":a.content;n+=`Content:
${s}

`}let i=[{role:"system",content:this.settings.systemPrompt},{role:"user",content:n}];return{answer:await this.callRemoteModel(i),notes:t}}async askVaultStream(e,t,n,i){if(!this.isAuthenticated())throw new Error("License key required for AI features. Please configure your license key in settings.");let r=n??this.retrieveNotes(e);if(r.length===0){let c="No relevant notes found for your query.";return t?.(c),{fullAnswer:c,notes:[]}}let a=`User query: "${e}"

Here are relevant notes:

`;for(let c of r){a+=`--- Note: ${c.path} ---
`,c.tags.length>0&&(a+=`Tags: ${c.tags.join(", ")}
`),c.frontmatter&&(a+=`Frontmatter: ${JSON.stringify(c.frontmatter)}
`);let d=c.content.length>1500?c.content.substring(0,1500)+"...":c.content;a+=`Content:
${d}

`}let s=[{role:"system",content:this.settings.systemPrompt},{role:"user",content:a}];return{fullAnswer:await this.callRemoteModelStream(s,t,i),notes:r}}async generateReport(e,t,n){let i=this.settings.reportApiKey;if(!i)throw new Error("License key required. Please configure it in settings.");let r=K;try{n?.("Requesting report generation...");let a="",s=3,l=t?.reportConversationId||null;for(let k=1;k<=s;k++)try{let I={description:e,vault_context:""};l?(I.conversation_id=l,console.log("[OSINT Copilot] Sending request with existing conversation_id:",l)):console.log("[OSINT Copilot] Sending first request (no conversation_id)");let M=await fetch(`${r}/api/generate-report`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(I),mode:"cors",credentials:"omit"});if(!M.ok){let R=await M.text();if(M.status===403){let P=R.toLowerCase();if(P.includes("quota")||P.includes("exhausted"))throw new Error("Report quota exhausted. Please upgrade your plan or wait for quota renewal. Visit https://osint-copilot.com/dashboard/ to manage your subscription.");if(P.includes("expired"))throw new Error("Your license key or trial has expired. Please renew your subscription at https://osint-copilot.com/dashboard/");if(P.includes("inactive"))throw new Error("Your license key is inactive. Please check your account status at https://osint-copilot.com/dashboard/")}throw new Error(`Report generation request failed (${M.status}): ${R.substring(0,200)}`)}let _=await M.json();if(a=_.job_id,!a)throw new Error("No job_id received from server");_.conversation_id&&t&&(t.reportConversationId=_.conversation_id,console.log("[OSINT Copilot] Updated conversation with reportConversationId:",_.conversation_id));break}catch(I){if(I instanceof Error&&this.isTransientNetworkError(I)&&k<s)console.log(`[OSINT Copilot] Report init network error, retrying (${k}/${s}):`,I),n?.(`Network interrupted, retrying... (attempt ${k}/${s})`),await this.sleep(1e3*k);else throw I}n?.(`Report generation started (Job ID: ${a}). Processing...`);let c=0,d=5*60*1e3,p=0,u="processing",g="",y=0,h=5,m=k=>k<15e3?2e3:k<45e3?3e3:5e3;for(;p<d&&u==="processing";){let k=m(p);await new Promise(M=>setTimeout(M,k)),p+=k,c++;let I=Math.round(p/1e3);n?.(`Checking report status... (${I}s elapsed)`);try{let M=new AbortController,_=setTimeout(()=>M.abort(),3e4),R;try{if(R=await fetch(`${r}/api/report-status/${a}`,{method:"GET",headers:{Authorization:`Bearer ${i}`},mode:"cors",credentials:"omit",signal:M.signal}),clearTimeout(_),!R.ok)throw new Error(`Failed to check job status: ${R.status}`)}catch(N){throw clearTimeout(_),N}let P=await R.json();if(u=P.status,y=0,P.progress?n?.(P.status,{message:P.progress.message||"Processing...",percent:P.progress.percent||0},P.intermediate_results):n?.(P.status,void 0,P.intermediate_results),P.response_ready){n?.("Response ready, retrieving from conversation...");let N=t?.reportConversationId||P.conversation_id;if(!N)throw new Error("Response ready but no conversation_id available");let Z=P.content||P.response_content||P.message||P.response;if(!Z)try{Z=await this.getConversationResponse(N,r,i)}catch{throw new Error(`Response is ready but content not found. Backend must return 'content' or 'response_content' in statusData when response_ready = true. Conversation ID: ${N}`)}if(!Z)throw new Error("Response is ready but no content found. Backend must return 'content' or 'response_content' in statusData when response_ready = true.");return t&&!t.reportConversationId&&(t.reportConversationId=N),{content:this.sanitizeMarkdownContent(Z),filename:`response_${a}.md`,conversationId:N}}if(u==="completed"){g=P.filename;break}else if(u==="failed"){let N=P.error||"Unknown error";throw N.toLowerCase().includes("ssl")||N.toLowerCase().includes("certificate")||N.toLowerCase().includes("n8n")?new Error("Backend service temporarily unavailable. Please try again in a few minutes."):new Error(`Report generation failed: ${N}`)}}catch(M){if(M instanceof Error&&this.isTransientNetworkError(M)){y++;let R=M instanceof Error?M.name:"Unknown",P=M instanceof Error?M.message:String(M);if(console.log(`[OSINT Copilot] Report status poll network error (${y}/${h}):`,`Type: ${R}, Message: ${P}`),y>=h)throw new Error("Network connection lost after multiple retries. Please check your internet connection and try again.");let N=`Network interrupted (${R}), retrying... (${Math.round(p/1e3)}s elapsed, attempt ${y}/${h})`;n?.(N),console.log(`[OSINT Copilot] ${N}`)}else throw console.error("[OSINT Copilot] Non-retryable error during status polling:",M),M}}if(u!=="completed")throw new Error("Report generation timed out. Please try again.");n?.("Downloading report...");let f="",x=3;for(let k=1;k<=x;k++)try{let I=await fetch(`${r}/api/download-report/${a}`,{method:"GET",headers:{Authorization:`Bearer ${i}`},mode:"cors",credentials:"omit"});if(!I.ok){let _=await I.text();throw new Error(`Failed to download report: ${I.status} - ${_}`)}let M=await I.text();f=this.extractMarkdownFromResponse(M);break}catch(I){if(I instanceof Error&&this.isTransientNetworkError(I)&&k<x)console.log(`[OSINT Copilot] Report download network error, retrying (${k}/${x}):`,I),n?.(`Download interrupted, retrying... (attempt ${k}/${x})`),await this.sleep(1e3*k);else throw I}let C=g||`report_${a}.md`;if(!f)throw new Error("No content received from server");return n?.("Report downloaded successfully!"),{content:this.sanitizeMarkdownContent(f),filename:C}}catch(a){throw a instanceof Error?new Error(`Report generation failed: ${a.message}`):a}}async getConversationResponse(e,t,n){let i=[`/api/conversation/${e}/messages`,`/api/conversations/${e}/messages`,`/api/chat/conversation/${e}`,`/api/conversation/${e}`];for(let r of i)try{let a=await fetch(`${t}${r}`,{method:"GET",headers:{Authorization:`Bearer ${n}`},mode:"cors",credentials:"omit"});if(a.ok){let s=await a.json(),l=[];Array.isArray(s)?l=s:s.messages&&Array.isArray(s.messages)?l=s.messages:s.conversation&&Array.isArray(s.conversation.messages)&&(l=s.conversation.messages);let c=l.filter(d=>d.role==="assistant"||d.role==="AI").pop();if(c&&c.content)return c.content}else if(a.status!==404)continue}catch{continue}throw new Error("No API endpoint found to retrieve conversation messages. Backend must return 'content' or 'response_content' in statusData when response_ready = true.")}async extractEntityFromQuery(e){let n=[{role:"system",content:`Extract the main entity mentioned in the user's query and classify it as one of: person | company | asset | event | location. Respond ONLY in JSON: {"name":"<entity name or null>","type":"person|company|asset|event|location|unknown"}. Use English only.`},{role:"user",content:e}];try{let r=(await this.callRemoteModel(n,!1,Be)).trim(),a=null;try{a=JSON.parse(r)}catch{let u=r.match(/\{[\s\S]*\}/);if(u)try{a=JSON.parse(u[0])}catch{}}if(!a)return{name:null,type:"unknown"};let s=["person","company","asset","event","location","unknown"],l=(a?.type||"unknown").toLowerCase(),c=s.includes(l)?l:"unknown",d=typeof a?.name=="string"&&a.name.trim().length>0?a.name.trim():null;return console.log("[extractEntityFromQuery] Extracted:",{name:d,type:c}),{name:d,type:c}}catch(i){return console.error("[extractEntityFromQuery] Error:",i),{name:null,type:"unknown"}}}sanitizeMarkdownContent(e){return e=e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,""),e=e.replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,""),e=e.replace(/<(object|embed)\b[^<]*(?:(?!<\/\1>)<[^<]*)*<\/\1>/gi,""),e=e.replace(/\[([^\]]+)\]\(javascript:[^\)]*\)/gi,"[$1](#)"),e=e.replace(/\[([^\]]+)\]\(data:(?!image)[^\)]*\)/gi,"[$1](#)"),e}extractMarkdownFromResponse(e){let t=e.trim();if(t.startsWith("{")||t.startsWith("["))try{let n=JSON.parse(t),i=Array.isArray(n)?n[0]:n;if(i&&typeof i=="object"){let r=["content","markdown","report","text","data","body","result","output"];for(let s of r)if(i[s]&&typeof i[s]=="string")return console.log(`[OSINT Copilot] Extracted markdown from JSON field: ${s}`),i[s];if(i.report&&typeof i.report=="object"){for(let s of r)if(i.report[s]&&typeof i.report[s]=="string")return console.log(`[OSINT Copilot] Extracted markdown from JSON field: report.${s}`),i.report[s]}let a=Object.entries(i).filter(([s,l])=>typeof l=="string"&&l.length>100);if(a.length===1)return console.log(`[OSINT Copilot] Extracted markdown from single string field: ${a[0][0]}`),a[0][1];console.warn("[OSINT Copilot] Could not find markdown content in JSON response. Fields:",Object.keys(i))}}catch{console.log("[OSINT Copilot] Response is not valid JSON, treating as plain markdown")}return e}getVaultContext(){let e=Array.from(this.index.values()),t=`Vault contains ${e.length} notes.

`,n=e.slice(0,20);t+=`Sample notes:
`;for(let i of n)t+=`- ${i.path}
`;return t}async saveReportToVault(e,t,n){let i=new Date().toISOString().split("T")[0],r=t,a=[/(?:tell me about|report on|who is|what is|investigate|research|find|look up|search for)\s+(.+)/i,/(.+?)(?:\s+report|\s+investigation|\s+research)?$/i];for(let y of a){let h=t.match(y);if(h&&h[1]){r=h[1].trim();break}}let s=r.substring(0,50).replace(/[^a-zA-Z0-9\s-]/g,"").trim().replace(/\s+/g,"_"),l=s?`${s}_Report`:"Report",c=`${this.settings.reportOutputDir}/${l}_${i}.md`;this.app.vault.getAbstractFileByPath(this.settings.reportOutputDir)||await this.app.vault.createFolder(this.settings.reportOutputDir);let p=`---
`;p+=`report_description: "${t.replace(/"/g,'\\"')}"
`,p+=`generated: ${new Date().toISOString()}
`,p+=`source: OpenDossier API
`,p+=`---

`,p+=e;let u=c,g=1;for(;this.app.vault.getAbstractFileByPath(u);)u=`${this.settings.reportOutputDir}/${l}_${i}-${g}.md`,g++;return await this.app.vault.create(u,p),u}async saveDarkWebReportToVault(e,t,n){let i=new Date().toISOString().split("T")[0],r=t.substring(0,50).replace(/[^a-zA-Z0-9\s-]/g,"").trim().replace(/\s+/g,"_"),a=r?`DarkWeb_${r}`:"DarkWeb_Investigation",s=`${this.settings.reportOutputDir}/${a}_${i}.md`;this.app.vault.getAbstractFileByPath(this.settings.reportOutputDir)||await this.app.vault.createFolder(this.settings.reportOutputDir);let c=`---
`;c+=`investigation_query: "${t.replace(/"/g,'\\"')}"
`,c+=`job_id: "${n}"
`,c+=`generated: ${new Date().toISOString()}
`,c+=`source: Dark Web Investigation
`,c+=`---

`,c+=e;let d=s,p=1;for(;this.app.vault.getAbstractFileByPath(d);)d=`${this.settings.reportOutputDir}/${a}_${i}-${p}.md`,p++;return await this.app.vault.create(d,c),d}openAskModal(){if(!this.isAuthenticated()){new b.Notice("License key required for AI features. Please configure your license key in settings.");return}new ve(this.app,this).open()}async openChatView(){if(!this.settings.reportApiKey){new b.Notice("A valid license key is required to use the Chat feature. Please purchase a license key to enable this functionality.",8e3);let n=this.app.setting;n&&(n.open(),n.openTabById(this.manifest.id));return}let e=this.app.workspace.getLeavesOfType(X);if(e.length>0){this.app.workspace.revealLeaf(e[0]);return}let t=this.app.workspace.getRightLeaf(!1);t&&(await t.setViewState({type:X,active:!0}),this.app.workspace.revealLeaf(t))}},ve=class extends b.Modal{constructor(o,e){super(o),this.plugin=e}onOpen(){let{contentEl:o}=this;o.addClass("vault-ai-modal"),o.createEl("h2",{text:"Ask Your Vault"}),o.createEl("label",{text:"Your question:"}),this.queryInput=o.createEl("textarea",{placeholder:"What would you like to know?"});let e=o.createDiv();e.createEl("button",{text:"Ask"}).addEventListener("click",()=>this.handleAsk()),e.createEl("button",{text:"Close"}).addEventListener("click",()=>this.close()),this.answerContainer=o.createDiv("vault-ai-answer"),this.answerContainer.style.display="none",this.notesContainer=o.createDiv("vault-ai-notes-list"),this.notesContainer.style.display="none"}async handleAsk(){let o=this.queryInput.value.trim();if(!o){new b.Notice("Please enter a question.");return}this.answerContainer.innerHTML="<p>Thinking...</p>",this.answerContainer.style.display="block";try{let e=await this.plugin.askVault(o);this.answerContainer.innerHTML="";let t=this.answerContainer.createEl("pre");if(t.textContent=e.answer,this.answerContainer.createEl("button",{text:"Copy Answer"}).addEventListener("click",()=>{navigator.clipboard.writeText(e.answer),new b.Notice("Answer copied to clipboard.")}),e.notes.length>0){this.notesContainer.innerHTML="",this.notesContainer.createEl("h3",{text:"Matching Notes:"});for(let i of e.notes){let r=this.notesContainer.createDiv("vault-ai-note-item");r.textContent=i.path,r.addEventListener("click",async()=>{let a=this.app.vault.getAbstractFileByPath(i.path);a instanceof b.TFile&&(await this.app.workspace.getLeaf().openFile(a),this.close())})}this.notesContainer.style.display="block"}}catch(e){this.answerContainer.innerHTML=`<p style="color: var(--text-error);">Error: ${e instanceof Error?e.message:String(e)}</p>`}}onClose(){let{contentEl:o}=this;o.empty()}},Ee=class extends b.Modal{constructor(o,e,t){super(o),this.currentTitle=e,this.onSubmit=t}onOpen(){let{contentEl:o}=this;o.addClass("vault-ai-modal"),o.createEl("h3",{text:"Rename Conversation"});let e=o.createDiv({cls:"vault-ai-rename-input-container"});e.createEl("label",{text:"New title:"}),this.inputEl=e.createEl("input",{type:"text",value:this.currentTitle,cls:"vault-ai-rename-input"}),this.inputEl.style.width="100%",this.inputEl.style.marginTop="8px",this.inputEl.style.padding="8px",this.inputEl.addEventListener("keydown",r=>{r.key==="Enter"?(r.preventDefault(),this.submit()):r.key==="Escape"&&this.close()});let t=o.createDiv({cls:"vault-ai-rename-buttons"});t.style.marginTop="16px",t.style.display="flex",t.style.justifyContent="flex-end",t.style.gap="8px",t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),t.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",()=>this.submit()),setTimeout(()=>{this.inputEl.focus(),this.inputEl.select()},10)}submit(){let o=this.inputEl.value.trim();o&&o!==this.currentTitle&&this.onSubmit(o),this.close()}onClose(){let{contentEl:o}=this;o.empty()}},xe=class extends b.ItemView{constructor(e,t){super(e);this.chatHistory=[];this.lookupMode=!0;this.darkWebMode=!1;this.reportGenerationMode=!1;this.entityGenerationMode=!1;this.pollingIntervals=new Map;this.currentConversation=null;this.sidebarVisible=!0;this.plugin=t}getViewType(){return X}getDisplayText(){return"OSINT Copilot"}getIcon(){return"message-square"}async onOpen(){await this.loadMostRecentConversation(),this.render()}async loadMostRecentConversation(){let e=await this.plugin.conversationService.getMostRecentConversation();e&&(this.currentConversation=e,this.chatHistory=this.conversationMessagesToHistory(e.messages),this.darkWebMode=e.darkWebMode||!1,this.entityGenerationMode=e.entityGenerationMode||!1,this.reportGenerationMode=e.reportGenerationMode||!1,this.lookupMode=!this.darkWebMode&&!this.reportGenerationMode)}conversationMessagesToHistory(e){return e.map(t=>({role:t.role,content:t.content,notes:t.notes,jobId:t.jobId,status:t.status,progress:t.progress,reportFilePath:t.reportFilePath}))}historyToConversationMessages(){return this.chatHistory.map(e=>({role:e.role,content:e.content,timestamp:Date.now(),notes:e.notes,jobId:e.jobId,status:e.status,progress:e.progress,reportFilePath:e.reportFilePath}))}async saveCurrentConversation(){this.currentConversation||(this.currentConversation=await this.plugin.conversationService.createConversation(this.chatHistory.length>0?this.chatHistory[0].content:void 0,this.darkWebMode,this.entityGenerationMode,this.reportGenerationMode)),this.currentConversation.messages=this.historyToConversationMessages(),this.currentConversation.lookupMode=this.lookupMode,this.currentConversation.darkWebMode=this.darkWebMode,this.currentConversation.entityGenerationMode=this.entityGenerationMode,this.currentConversation.reportGenerationMode=this.reportGenerationMode,await this.plugin.conversationService.saveConversation(this.currentConversation),this.renderConversationList()}render(){let e=this.containerEl.children[1];e.empty(),e.addClass("vault-ai-chat-view"),e.addClass("vault-ai-chat-with-sidebar");let t=e.createDiv("vault-ai-chat-layout");this.sidebarContainer=t.createDiv("vault-ai-chat-sidebar"),this.sidebarVisible||this.sidebarContainer.addClass("hidden"),this.renderSidebar();let n=t.createDiv("vault-ai-chat-area"),i=n.createDiv("vault-ai-chat-header"),r=i.createEl("button",{cls:"vault-ai-sidebar-toggle"});r.innerHTML="\u2630",r.title="Toggle conversation history",r.addEventListener("click",()=>{this.sidebarVisible=!this.sidebarVisible,this.sidebarVisible?this.sidebarContainer.removeClass("hidden"):this.sidebarContainer.addClass("hidden")}),i.createEl("h3",{text:"OSINT Copilot"});let a=i.createDiv("vault-ai-chat-header-buttons");a.createEl("button",{text:"New Chat",cls:"vault-ai-new-chat-btn"}).addEventListener("click",async()=>{await this.startNewConversation()});let l=a.createDiv("vault-ai-main-mode-group");l.setAttribute("title","Select one mode, or deselect all for Entity-Only Mode");let c=l.createDiv("vault-ai-lookup-toggle");c.addClass("vault-ai-toggle-container"),this.lookupModeToggle=c.createEl("input",{type:"checkbox",cls:"vault-ai-mode-checkbox"}),this.lookupModeToggle.id="lookup-mode-toggle",this.lookupModeToggle.checked=this.lookupMode,this.lookupModeToggle.addEventListener("change",()=>{this.lookupModeToggle.checked?(this.lookupMode=!0,this.darkWebMode=!1,this.reportGenerationMode=!1,this.darkWebToggle.checked=!1,this.reportGenerationToggle.checked=!1,new b.Notice("Lookup Mode enabled")):(this.lookupMode=!1,this.checkEntityOnlyMode()),this.updateAllModeLabels(),this.updateInputPlaceholder()});let d=c.createEl("label",{text:this.lookupMode?"\u{1F50D} Lookup (ON)":"\u{1F50D} Lookup",cls:this.lookupMode?"vault-ai-mode-label active":"vault-ai-mode-label"});d.htmlFor="lookup-mode-toggle";let p=l.createDiv("vault-ai-dark-web-toggle");p.addClass("vault-ai-toggle-container"),this.darkWebToggle=p.createEl("input",{type:"checkbox",cls:"vault-ai-mode-checkbox"}),this.darkWebToggle.id="dark-web-mode-toggle",this.darkWebToggle.checked=this.darkWebMode,this.darkWebToggle.addEventListener("change",()=>{this.darkWebToggle.checked?(this.darkWebMode=!0,this.lookupMode=!1,this.reportGenerationMode=!1,this.lookupModeToggle.checked=!1,this.reportGenerationToggle.checked=!1,new b.Notice("Dark Web Mode enabled")):(this.darkWebMode=!1,this.checkEntityOnlyMode()),this.updateAllModeLabels(),this.updateInputPlaceholder()});let u=p.createEl("label",{text:this.darkWebMode?"\u{1F575}\uFE0F Dark Web (ON)":"\u{1F575}\uFE0F Dark Web",cls:this.darkWebMode?"vault-ai-mode-label active":"vault-ai-mode-label"});u.htmlFor="dark-web-mode-toggle";let g=l.createDiv("vault-ai-report-gen-toggle");g.addClass("vault-ai-toggle-container"),this.reportGenerationToggle=g.createEl("input",{type:"checkbox",cls:"vault-ai-mode-checkbox"}),this.reportGenerationToggle.id="report-gen-mode-toggle",this.reportGenerationToggle.checked=this.reportGenerationMode,this.reportGenerationToggle.addEventListener("change",()=>{this.reportGenerationToggle.checked?(this.reportGenerationMode=!0,this.lookupMode=!1,this.darkWebMode=!1,this.lookupModeToggle.checked=!1,this.darkWebToggle.checked=!1,new b.Notice("Report Generation Mode enabled")):(this.reportGenerationMode=!1,this.checkEntityOnlyMode()),this.updateAllModeLabels(),this.updateInputPlaceholder()});let y=g.createEl("label",{text:this.reportGenerationMode?"\u{1F4C4} Report (ON)":"\u{1F4C4} Report",cls:this.reportGenerationMode?"vault-ai-mode-label active":"vault-ai-mode-label"});y.htmlFor="report-gen-mode-toggle";let h=a.createDiv("vault-ai-entity-gen-toggle");h.addClass("vault-ai-toggle-container"),h.setAttribute("title","Extract entities (works with any mode, or alone for Entity-Only Mode)"),this.entityGenerationToggle=h.createEl("input",{type:"checkbox",cls:"vault-ai-entity-gen-checkbox"}),this.entityGenerationToggle.id="entity-gen-mode-toggle",this.entityGenerationToggle.checked=this.entityGenerationMode,this.entityGenerationToggle.addEventListener("change",()=>{this.entityGenerationMode=this.entityGenerationToggle.checked,this.updateEntityGenerationLabel(),this.updateInputPlaceholder(),this.isEntityOnlyMode()?new b.Notice("Entity-Only Mode enabled - extract entities from your text"):this.entityGenerationMode?new b.Notice("Entity Generation enabled"):new b.Notice("Entity Generation disabled")});let m=h.createEl("label",{text:this.getEntityGenLabelText(),cls:this.entityGenerationMode?"vault-ai-entity-gen-label active":"vault-ai-entity-gen-label"});m.htmlFor="entity-gen-mode-toggle",this.messagesContainer=n.createDiv("vault-ai-chat-messages"),this.renderMessages();let f=n.createDiv("vault-ai-chat-input");this.inputEl=f.createEl("textarea",{placeholder:this.getInputPlaceholder()}),this.inputEl.rows=3,f.createEl("button",{text:"Send"}).addEventListener("click",()=>this.handleSend()),this.inputEl.addEventListener("keydown",C=>{C.key==="Enter"&&!C.shiftKey&&(C.preventDefault(),this.handleSend())})}isEntityOnlyMode(){return this.entityGenerationMode&&!this.lookupMode&&!this.darkWebMode&&!this.reportGenerationMode}checkEntityOnlyMode(){this.isEntityOnlyMode()&&new b.Notice("Entity-Only Mode - enter text to extract entities")}getInputPlaceholder(){return this.isEntityOnlyMode()?"Enter text to extract entities...":this.darkWebMode?"Enter dark web investigation query...":this.reportGenerationMode?"Describe the report you want to generate...":"Ask a question about your vault..."}updateInputPlaceholder(){this.inputEl&&(this.inputEl.placeholder=this.getInputPlaceholder())}getEntityGenLabelText(){return this.isEntityOnlyMode()?"\u{1F3F7}\uFE0F Entity-Only (ON)":this.entityGenerationMode?"\u{1F3F7}\uFE0F Entities (ON)":"\u{1F3F7}\uFE0F Entities"}updateEntityGenerationLabel(){let e=this.containerEl.querySelector(".vault-ai-entity-gen-toggle");if(e){let t=e.querySelector("label");t&&(t.textContent=this.getEntityGenLabelText(),t.className=this.entityGenerationMode?"vault-ai-entity-gen-label active":"vault-ai-entity-gen-label",this.isEntityOnlyMode()?e.addClass("entity-only-mode"):e.removeClass("entity-only-mode"))}}updateAllModeLabels(){let e=this.containerEl.querySelector(".vault-ai-lookup-toggle");if(e){let i=e.querySelector("label");i&&(i.textContent=this.lookupMode?"\u{1F50D} Lookup (ON)":"\u{1F50D} Lookup",i.className=this.lookupMode?"vault-ai-mode-label active":"vault-ai-mode-label");let r=e.querySelector("input");r&&(r.checked=this.lookupMode)}let t=this.containerEl.querySelector(".vault-ai-dark-web-toggle");if(t){let i=t.querySelector("label");i&&(i.textContent=this.darkWebMode?"\u{1F575}\uFE0F Dark Web (ON)":"\u{1F575}\uFE0F Dark Web",i.className=this.darkWebMode?"vault-ai-mode-label active":"vault-ai-mode-label");let r=t.querySelector("input");r&&(r.checked=this.darkWebMode)}let n=this.containerEl.querySelector(".vault-ai-report-gen-toggle");if(n){let i=n.querySelector("label");i&&(i.textContent=this.reportGenerationMode?"\u{1F4C4} Report (ON)":"\u{1F4C4} Report",i.className=this.reportGenerationMode?"vault-ai-mode-label active":"vault-ai-mode-label");let r=n.querySelector("input");r&&(r.checked=this.reportGenerationMode)}this.updateEntityGenerationLabel()}renderSidebar(){this.sidebarContainer.empty(),this.sidebarContainer.createDiv("vault-ai-sidebar-header").createEl("h4",{text:"Conversations"}),this.conversationListEl=this.sidebarContainer.createDiv("vault-ai-conversation-list"),this.renderConversationList()}renderConversationList(){this.conversationListEl.empty();let e=this.plugin.conversationService.getConversationList();if(e.length===0){this.conversationListEl.createEl("p",{text:"No conversations yet",cls:"vault-ai-no-conversations"});return}for(let t of e){let n=this.conversationListEl.createDiv("vault-ai-conversation-item");this.currentConversation&&this.currentConversation.id===t.id&&n.addClass("active");let i=n.createDiv("vault-ai-conversation-content");i.createEl("div",{text:t.title,cls:"vault-ai-conversation-title"});let r=i.createDiv("vault-ai-conversation-meta"),a=new Date(t.updatedAt);r.createEl("span",{text:this.formatDate(a),cls:"vault-ai-conversation-date"}),t.entityGenerationMode&&!t.lookupMode&&!t.darkWebMode&&!t.reportGenerationMode?r.createEl("span",{text:"\u{1F3F7}\uFE0F",cls:"vault-ai-conversation-entityonly",title:"Entity-Only Mode"}):t.darkWebMode?(r.createEl("span",{text:"\u{1F575}\uFE0F",cls:"vault-ai-conversation-darkweb",title:"Dark Web Mode"}),t.entityGenerationMode&&r.createEl("span",{text:"\u{1F3F7}\uFE0F",cls:"vault-ai-conversation-entitygen",title:"Entity Generation"})):t.reportGenerationMode?(r.createEl("span",{text:"\u{1F4C4}",cls:"vault-ai-conversation-report",title:"Report Generation Mode"}),t.entityGenerationMode&&r.createEl("span",{text:"\u{1F3F7}\uFE0F",cls:"vault-ai-conversation-entitygen",title:"Entity Generation"})):(r.createEl("span",{text:"\u{1F50D}",cls:"vault-ai-conversation-lookup",title:"Lookup Mode"}),t.entityGenerationMode&&r.createEl("span",{text:"\u{1F3F7}\uFE0F",cls:"vault-ai-conversation-entitygen",title:"Entity Generation"})),i.addEventListener("click",async()=>{await this.loadConversation(t.id)});let l=n.createDiv("vault-ai-conversation-actions"),c=l.createEl("button",{cls:"vault-ai-conv-action-btn"});c.innerHTML="\u270F\uFE0F",c.title="Rename",c.addEventListener("click",async p=>{p.stopPropagation(),await this.renameConversation(t.id,t.title)});let d=l.createEl("button",{cls:"vault-ai-conv-action-btn"});d.innerHTML="\u{1F5D1}\uFE0F",d.title="Delete",d.addEventListener("click",async p=>{p.stopPropagation(),await this.deleteConversation(t.id)})}}formatDate(e){let n=new Date().getTime()-e.getTime(),i=Math.floor(n/(1e3*60*60*24));return i===0?e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):i===1?"Yesterday":i<7?e.toLocaleDateString([],{weekday:"short"}):e.toLocaleDateString([],{month:"short",day:"numeric"})}async loadConversation(e){if(this.currentConversation&&this.currentConversation.id===e)return;let t=await this.plugin.conversationService.loadConversation(e);t?(this.currentConversation=t,this.chatHistory=this.conversationMessagesToHistory(t.messages),this.darkWebMode=t.darkWebMode||!1,this.entityGenerationMode=t.entityGenerationMode||!1,this.reportGenerationMode=t.reportGenerationMode||!1,this.lookupMode=t.lookupMode!==void 0?t.lookupMode:!this.darkWebMode&&!this.reportGenerationMode,this.plugin.conversationService.setCurrentConversationId(e),this.render()):new b.Notice("Failed to load conversation")}async startNewConversation(){this.currentConversation&&this.chatHistory.length>0&&await this.saveCurrentConversation(),this.currentConversation=null,this.chatHistory=[],this.lookupMode=!0,this.darkWebMode=!1,this.entityGenerationMode=!1,this.reportGenerationMode=!1,this.plugin.conversationService.setCurrentConversationId(null),this.render(),new b.Notice("Started new conversation")}async deleteConversation(e){if(!confirm("Are you sure you want to delete this conversation?"))return;let n=await this.plugin.conversationService.deleteConversation(e);this.currentConversation&&this.currentConversation.id===e&&(this.currentConversation=null,this.chatHistory=[]),this.renderConversationList(),this.renderMessages(),n?new b.Notice("Conversation deleted"):new b.Notice("Failed to delete conversation")}async renameConversation(e,t){new Ee(this.app,t,async n=>{await this.plugin.conversationService.renameConversation(e,n)&&(this.currentConversation&&this.currentConversation.id===e&&(this.currentConversation.title=n),await this.plugin.conversationService.loadConversationList(),this.renderConversationList(),new b.Notice("Conversation renamed"))}).open()}async renderMessages(){if(this.messagesContainer.empty(),this.chatHistory.length===0){this.messagesContainer.createEl("p",{text:"Start a conversation by asking a question about your vault.",cls:"vault-ai-chat-empty"});return}for(let e=0;e<this.chatHistory.length;e++){let t=this.chatHistory[e],n=this.messagesContainer.createDiv(`vault-ai-chat-message vault-ai-chat-${t.role}`);n.setAttribute("data-message-index",e.toString()),t.jobId&&(n.addClass("vault-ai-darkweb-message"),t.status==="processing"?n.addClass("vault-ai-darkweb-processing"):t.status==="completed"?n.addClass("vault-ai-darkweb-completed"):t.status==="failed"&&n.addClass("vault-ai-darkweb-failed"));let i=n.createEl("strong",{text:t.role==="user"?"You: ":"AI: "}),r=n.createDiv("vault-ai-chat-content");if(await b.MarkdownRenderer.render(this.app,t.content,r,"",this),t.role==="assistant"&&t.progress&&typeof t.progress=="object"&&"percent"in t.progress){let a=n.createDiv("vault-ai-progress-container"),s=a.createDiv("vault-ai-progress-bar");s.style.width=`${t.progress.percent}%`;let l=a.createEl("span",{cls:"vault-ai-progress-text",text:`${t.progress.message||"Processing..."} (${t.progress.percent}%)`})}if(t.role==="assistant"&&t.intermediateResults&&t.intermediateResults.length>0){let a=n.createDiv("vault-ai-intermediate-results-container");a.createEl("strong",{text:"Intermediate results:"});let s=a.createEl("ul",{cls:"vault-ai-intermediate-results"});t.intermediateResults.forEach(l=>{s.createEl("li",{text:l})})}if(t.role==="assistant"&&t.notes&&t.notes.length>0){let a=n.createDiv("vault-ai-chat-notes");a.createEl("small",{text:"Referenced notes:"});for(let s of t.notes)a.createEl("a",{text:s.path,cls:"vault-ai-note-link"}).addEventListener("click",async c=>{c.preventDefault();let d=this.app.vault.getAbstractFileByPath(s.path);d instanceof b.TFile&&await this.app.workspace.getLeaf().openFile(d)})}if(t.role==="assistant"&&t.createdEntities&&t.createdEntities.length>0){let a=n.createDiv("vault-ai-created-entities");a.style.cssText=`
          margin-top: 10px;
          padding: 10px;
          background: var(--background-secondary);
          border-radius: 6px;
          border-left: 3px solid var(--interactive-accent);
        `;for(let l of t.createdEntities){let c=a.createDiv("vault-ai-entity-row");c.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            flex-wrap: wrap;
          `;let d=c.createEl("span",{text:l.type,cls:"vault-ai-entity-type-badge"});d.style.cssText=`
            background: var(--interactive-accent);
            color: var(--text-on-accent);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
          `;let p=c.createEl("span",{text:l.label,cls:"vault-ai-entity-label"});p.style.cssText=`
            font-weight: 500;
            flex: 1;
            min-width: 100px;
          `;let u=c.createEl("button",{text:"\u{1F4C4} Note",cls:"vault-ai-entity-note-btn"});u.style.cssText=`
            padding: 3px 8px;
            font-size: 11px;
            background: var(--background-modifier-border);
            border: none;
            border-radius: 4px;
            cursor: pointer;
          `,u.title="Open entity note",u.addEventListener("click",async y=>{y.preventDefault();let h=this.app.vault.getAbstractFileByPath(l.filePath);h instanceof b.TFile&&await this.app.workspace.getLeaf().openFile(h)});let g=c.createEl("button",{text:"\u{1F517} Graph",cls:"vault-ai-entity-graph-btn"});g.style.cssText=`
            padding: 3px 8px;
            font-size: 11px;
            background: var(--interactive-accent);
            color: var(--text-on-accent);
            border: none;
            border-radius: 4px;
            cursor: pointer;
          `,g.title="View in Graph",g.addEventListener("click",async y=>{y.preventDefault(),await this.plugin.openGraphViewWithEntity(l.id)})}let s=a.createEl("small",{text:"Click 'Graph' to view entity in the graph, or 'Note' to open its file.",cls:"vault-ai-entity-hint"});s.style.cssText=`
          display: block;
          margin-top: 8px;
          color: var(--text-muted);
          font-style: italic;
        `}if(t.role==="assistant"&&t.reportFilePath){let a=n.createDiv("vault-ai-report-button-container");a.style.cssText=`
          margin-top: 12px;
          padding: 10px;
          background: var(--background-secondary);
          border-radius: 6px;
          border-left: 3px solid var(--interactive-accent);
        `;let s=a.createEl("button",{text:"\u{1F4C4} Open Report",cls:"vault-ai-open-report-btn"});s.style.cssText=`
          padding: 8px 16px;
          font-size: 13px;
          font-weight: 500;
          background: var(--interactive-accent);
          color: var(--text-on-accent);
          border: none;
          border-radius: 4px;
          cursor: pointer;
          transition: opacity 0.2s;
        `,s.title=`Open report: ${t.reportFilePath}`,s.addEventListener("mouseenter",()=>{s.style.opacity="0.8"}),s.addEventListener("mouseleave",()=>{s.style.opacity="1"}),s.addEventListener("click",async c=>{c.preventDefault();let d=this.app.vault.getAbstractFileByPath(t.reportFilePath);d instanceof b.TFile?(await this.app.workspace.getLeaf().openFile(d),new b.Notice(`Opened report: ${t.reportFilePath}`)):new b.Notice(`Report file not found: ${t.reportFilePath}`)});let l=a.createEl("small",{text:`File: ${t.reportFilePath}`,cls:"vault-ai-report-path-label"});l.style.cssText=`
          display: block;
          margin-top: 6px;
          color: var(--text-muted);
          font-style: italic;
          font-size: 11px;
        `}}this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}updateProgressBar(e,t,n){let i=this.messagesContainer.querySelector(`.vault-ai-chat-message[data-message-index="${e}"]`);if(!i)return;let r=t||(e<this.chatHistory.length&&this.chatHistory[e].progress&&typeof this.chatHistory[e].progress=="object"&&"percent"in this.chatHistory[e].progress?this.chatHistory[e].progress:void 0),a=i.querySelector(".vault-ai-progress-container");if(r){if(a)a.empty();else{let p=i.querySelector(".vault-ai-chat-content");p?(a=document.createElement("div"),a.className="vault-ai-progress-container",p.insertAdjacentElement("afterend",a)):a=i.createDiv("vault-ai-progress-container")}let c=a.createDiv("vault-ai-progress-bar");c.style.width=`${r.percent}%`;let d=a.createEl("span",{cls:"vault-ai-progress-text",text:`${r.message||"Processing..."} (${r.percent}%)`})}if(e<this.chatHistory.length){let c=i.querySelector(".vault-ai-chat-content");if(c){let d=this.chatHistory[e].content;c.textContent!==d&&(c.textContent=d)}}let s=n||(e<this.chatHistory.length&&this.chatHistory[e].intermediateResults&&this.chatHistory[e].intermediateResults.length>0?this.chatHistory[e].intermediateResults:void 0),l=i.querySelector(".vault-ai-intermediate-results-container");if(s&&s.length>0){l?l.empty():l=i.createDiv("vault-ai-intermediate-results-container"),l.createEl("strong",{text:"Intermediate results:"});let c=l.createEl("ul",{cls:"vault-ai-intermediate-results"});s.forEach(d=>{c.createEl("li",{text:d})})}this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}async handleSend(){let e=this.inputEl.value.trim();if(!e){new b.Notice("Please enter a question.");return}if(!this.plugin.isAuthenticated()){new b.Notice("License key required for AI features. Please configure your license key in settings.");return}this.chatHistory.push({role:"user",content:e}),this.inputEl.value="",await this.saveCurrentConversation(),this.isEntityOnlyMode()?await this.handleEntityOnlyMode(e):this.darkWebMode?await this.handleDarkWebInvestigation(e):this.reportGenerationMode?await this.handleReportGeneration(e):await this.handleNormalChat(e),await this.saveCurrentConversation()}async handleEntityOnlyMode(e){let t=this.chatHistory.length;this.chatHistory.push({role:"assistant",content:"\u{1F3F7}\uFE0F Extracting entities from your text...",progress:{message:"Analyzing text...",percent:10}}),this.renderMessages();let n=(i,r)=>{this.chatHistory[t].progress={message:i,percent:r},this.chatHistory[t].content=`\u{1F3F7}\uFE0F ${i}`,this.updateProgressBar(t,{message:i,percent:r})};try{let i=this.plugin.entityManager.getAllEntities();n("Checking existing entities...",20);let r=(u,g,y,h)=>{let m=Math.round(h/1e3),f="Network interrupted";y==="timeout"?f="Request timed out":y==="network"?f="Network connection lost":y.startsWith("server-error")?f="Server temporarily unavailable":y==="rate-limited"&&(f="Rate limited"),n(`\u26A0\uFE0F ${f}. Retrying in ${m}s... (${u+1}/${g})`,25)};n("Sending text to AI for entity extraction...",30);let a=await this.plugin.graphApiService.processText(e,i,void 0,r);if(n("Processing API response...",50),!a.success){this.chatHistory[t].progress=void 0,this.chatHistory[t].content=`\u{1F3F7}\uFE0F **Entity Extraction Failed**

**Input:** ${e.substring(0,100)}${e.length>100?"...":""}

**Error:** ${a.error||"Unknown error"}`,this.renderMessages();return}if(!a.operations||a.operations.length===0){this.chatHistory[t].progress=void 0,this.chatHistory[t].content=`\u{1F3F7}\uFE0F **Entity Extraction Complete**

**Input:** ${e.substring(0,200)}${e.length>200?"...":""}

No entities detected in the provided text.`,this.renderMessages();return}let s=0;for(let u of a.operations)u.action==="create"&&u.entities&&(s+=u.entities.length);n(`Found ${s} entities to create...`,55);let l=[],c=0,d=0;console.log("[EntityOnlyMode] Processing operations:",JSON.stringify(a.operations,null,2));for(let u of a.operations){console.log("[EntityOnlyMode] Processing operation:",{action:u.action,hasEntities:!!u.entities,entitiesCount:u.entities?.length||0,hasConnections:!!u.connections,connectionsCount:u.connections?.length||0});let g=[];if(u.action==="create"&&u.entities){for(let y of u.entities){d++;let h=55+Math.round(d/s*35);n(`Creating entity ${d}/${s}...`,h),console.log("[EntityOnlyMode] Processing entity:",{type:y.type,properties:y.properties});try{let m=y.type;if(!Object.values(F).includes(m)){console.warn(`[EntityOnlyMode] Unknown entity type: ${y.type}. Valid types:`,Object.values(F)),g.push(null);continue}console.log("[EntityOnlyMode] Creating entity with type:",m);let f=await this.plugin.entityManager.createEntity(m,y.properties);console.log("[EntityOnlyMode] Entity created successfully:",{id:f.id,type:f.type,label:f.label,filePath:f.filePath}),g.push(f),l.push({id:f.id,type:f.type,label:f.label,filePath:f.filePath||""})}catch(m){console.error("[EntityOnlyMode] Failed to create entity:",m),g.push(null)}}if(u.connections&&u.connections.length>0){n("Creating relationships...",92);for(let y of u.connections)try{let h=g[y.from],m=g[y.to];h&&m&&(await this.plugin.entityManager.addRelationshipToNote(h,m,y.relationship),c++)}catch(h){console.error("[EntityOnlyMode] Failed to create connection:",h)}}}}n("Finalizing...",98);let p=`\u{1F3F7}\uFE0F **Entity Extraction Complete**

`;if(p+=`**Input:** ${e.substring(0,200)}${e.length>200?"...":""}

`,l.length>0?(this.chatHistory[t].createdEntities=l,this.chatHistory[t].connectionsCreated=c,p+=`**Entities Created (${l.length}):**`,c>0&&(p+=`
**Relationships Created:** ${c}`)):p+="No new entities were created (may already exist or types not recognized).",this.chatHistory[t].progress=void 0,this.chatHistory[t].content=p,this.renderMessages(),l.length>0){let u=c>0?`Created ${l.length} entities and ${c} relationships`:`Created ${l.length} entities`;new b.Notice(u)}}catch(i){let r=i instanceof Error?i.message:String(i);this.chatHistory[t].progress=void 0,this.chatHistory[t].content=`\u{1F3F7}\uFE0F **Entity Extraction Failed**

**Input:** ${e.substring(0,100)}${e.length>100?"...":""}

**Error:** ${r}`,this.renderMessages(),new b.Notice(`Entity extraction failed: ${r}`)}}async handleNormalChat(e){this.chatHistory.push({role:"assistant",content:"Analyzing query...",progress:{message:"Analyzing query...",percent:10}});let t=this.chatHistory.length-1;this.renderMessages();let n=(a,s)=>{this.chatHistory[t].progress={message:a,percent:s},this.updateProgressBar(t,{message:a,percent:s})},i=()=>{let a=this.messagesContainer.querySelectorAll(".vault-ai-chat-message.vault-ai-chat-assistant .vault-ai-chat-content");return a.length===0?null:a[a.length-1]},r="";try{n("Extracting entity from query...",15);let a=await this.plugin.extractEntityFromQuery(e),s=a.type==="unknown"?"Entity defined. Starting lookup.":a.name?`Entity defined (${a.type}: ${a.name}). Starting lookup.`:`Entity defined (${a.type}). Starting lookup.`;this.chatHistory[t].content=s,n("Entity extracted, searching vault...",30);let l=a.name&&a.name.length>0?a.name:e,c=this.plugin.retrieveNotes(l);if(c.length===0){this.chatHistory[t].progress=void 0,this.chatHistory[t].content=s+`

No relevant notes found.`,this.chatHistory[t].notes=[],this.renderMessages();return}n(`Found ${c.length} notes, preparing context...`,45),r=s+`

Found ${c.length} relevant notes. Selecting key excerpts...
Drafting the answer...

`,this.chatHistory[t].content=r,this.chatHistory[t].notes=c,this.renderMessages(),n("Generating response...",55);let d=i(),p="",u=55,g=(f,x)=>{n(`Network interrupted. Retrying... (${f}/${x})`,u),this.chatHistory[t].content=r+`\u26A0\uFE0F Network interrupted. Retrying... (${f}/${x})`,this.renderMessages(),p=""},{fullAnswer:y,notes:h}=await this.plugin.askVaultStream(l,f=>{p+=f,u=Math.min(90,55+Math.round(p.length/2e3*35)),n("Generating response...",u),d?(d.textContent=r+p,this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight):(this.chatHistory[t].content=r+p,this.renderMessages())},c,g);n("Finalizing response...",95);let m=r+y;this.chatHistory[t].content=m,this.chatHistory[t].notes=h,this.chatHistory[t].progress=void 0,this.renderMessages(),this.entityGenerationMode&&await this.processEntityGeneration(t,y,e,m)}catch(a){let s=a instanceof Error?a.message:String(a);this.chatHistory[t].progress=void 0,this.chatHistory[t].content=`Error: ${s}

\u{1F4A1} Tip: Your message was saved. You can try sending it again.`,this.renderMessages(),this.inputEl.value=e}}async processEntityGeneration(e,t,n,i){let r=(a,s)=>{this.chatHistory[e].progress={message:a,percent:s},this.updateProgressBar(e,{message:a,percent:s})};try{r("Extracting entities from response...",10);let a=i+`

\u{1F3F7}\uFE0F Extracting entities...`;this.chatHistory[e].content=a,this.renderMessages();let s=`Extract all entities (people, companies, locations, events) and their relationships from the following content. Create entities for each person, company, location, and event mentioned. Return JSON operations to create entities, do NOT provide analysis or summary.

Original Query: ${n}

Content to extract entities from:
${t}`,l=this.plugin.entityManager.getAllEntities(),c=(h,m,f,x)=>{let C=Math.round(x/1e3),S="Network interrupted";f==="timeout"?S="Request timed out":f==="network"?S="Network connection lost":f.startsWith("server-error")?S="Server temporarily unavailable":f==="rate-limited"&&(S="Rate limited");let k=`

\u26A0\uFE0F ${S}. Retrying in ${C}s... (attempt ${h+1}/${m})`;this.chatHistory[e].content=i+k,this.renderMessages()};r("Sending to AI for entity extraction...",25);let d=await this.plugin.graphApiService.processText(s,l,void 0,c);if(r("Processing extraction results...",40),!d.success){this.chatHistory[e].progress=void 0,this.chatHistory[e].content=i+`

\u26A0\uFE0F Entity extraction failed: ${d.error||"Unknown error"}`,this.renderMessages();return}if(!d.operations||d.operations.length===0){this.chatHistory[e].progress=void 0,this.chatHistory[e].content=i+`

\u{1F3F7}\uFE0F No new entities detected in the response.`,this.renderMessages();return}r("Creating entities...",50);let p=[],u=0,g=0;for(let h of d.operations)h.action==="create"&&h.entities&&(g+=h.entities.length);let y=0;console.log("[EntityGeneration] Processing operations:",JSON.stringify(d.operations,null,2));for(let h of d.operations){console.log("[EntityGeneration] Processing operation:",{action:h.action,hasEntities:!!h.entities,entitiesCount:h.entities?.length||0,hasConnections:!!h.connections,connectionsCount:h.connections?.length||0});let m=[];if(h.action==="create"&&h.entities){for(let f of h.entities){y++;let x=50+Math.round(y/Math.max(g,1)*35);r(`Creating entity ${y}/${g}...`,x),console.log("[EntityGeneration] Processing entity:",{type:f.type,properties:f.properties});try{let C=f.type;if(!Object.values(F).includes(C)){console.warn(`[EntityGeneration] Unknown entity type: ${f.type}. Valid types:`,Object.values(F)),m.push(null);continue}console.log("[EntityGeneration] Creating entity with type:",C);let S=await this.plugin.entityManager.createEntity(C,f.properties);console.log("[EntityGeneration] Entity created successfully:",{id:S.id,type:S.type,label:S.label,filePath:S.filePath}),m.push(S),p.push({id:S.id,type:S.type,label:S.label,filePath:S.filePath||""})}catch(C){console.error("[EntityGeneration] Failed to create entity:",C),m.push(null)}}if(h.connections&&h.connections.length>0){r("Creating relationships...",88);for(let f of h.connections)try{let x=m[f.from],C=m[f.to];x&&C&&(await this.plugin.entityManager.addRelationshipToNote(x,C,f.relationship),u++)}catch(x){console.error("[EntityGeneration] Failed to create connection:",x)}}}}if(r("Finalizing...",95),p.length>0){this.chatHistory[e].createdEntities=p,this.chatHistory[e].connectionsCreated=u;let h=`

\u{1F3F7}\uFE0F **Entities Created (${p.length}):**`;u>0&&(h+=`
**Relationships Created:** ${u}`),this.chatHistory[e].progress=void 0,this.chatHistory[e].content=i+h,await this.plugin.refreshOrOpenGraphView()}else this.chatHistory[e].progress=void 0,this.chatHistory[e].content=i+`

\u{1F3F7}\uFE0F No new entities were created (entities may already exist).`;this.renderMessages()}catch(a){console.error("[EntityGeneration] Error during entity generation:",a);let s=a instanceof Error?a.message:String(a);this.chatHistory[e].progress=void 0,this.chatHistory[e].content=i+`

\u26A0\uFE0F Entity generation error: ${s}`,this.renderMessages()}}async handleReportGeneration(e){let t=this.chatHistory.length;this.chatHistory.push({role:"assistant",content:"\u{1F4C4} Starting report generation..."}),this.renderMessages();try{let n=await this.plugin.generateReport(e,this.currentConversation,(s,l,c)=>{let d=`\u{1F4C4} ${s}`;l&&(d=`\u{1F4C4} ${l.message}`),this.chatHistory[t].content=d,l&&(this.chatHistory[t].progress=l),c&&c.length>0&&(this.chatHistory[t].intermediateResults=c),this.updateProgressBar(t,l,c)}),i=await this.plugin.saveReportToVault(n.content,e,n.filename);this.currentConversation&&await this.saveCurrentConversation();let r=`\u{1F4C4} **Report Generated Successfully!**

**Request:** ${e}

**Saved to:** \`${i}\`

---

`+n.content;this.chatHistory[t].content=r,this.chatHistory[t].reportFilePath=i,this.renderMessages(),this.entityGenerationMode&&await this.processEntityGeneration(t,n.content,e,r);let a=this.app.vault.getAbstractFileByPath(i);a instanceof b.TFile&&await this.app.workspace.getLeaf().openFile(a),new b.Notice(`Report saved to ${i}`)}catch(n){let i=n instanceof Error?n.message:String(n),r=i,a="";i.toLowerCase().includes("ssl")||i.toLowerCase().includes("certificate")?(r="Backend service temporarily unavailable (SSL/certificate issue)",a=`

\u{1F4A1} **Suggestion:** This is a temporary server-side issue. Please try again in a few minutes.`):i.toLowerCase().includes("timeout")?(r="Report generation timed out",a=`

\u{1F4A1} **Suggestion:** The server may be busy. Please try again with a simpler query.`):i.toLowerCase().includes("quota")?a=`

\u{1F4A1} **Suggestion:** Visit https://osint-copilot.com/dashboard/ to check your quota.`:i.toLowerCase().includes("network")||i.toLowerCase().includes("fetch")?(r="Network connection error",a=`

\u{1F4A1} **Suggestion:** Check your internet connection and try again.`):(i.toLowerCase().includes("n8n")||i.toLowerCase().includes("workflow"))&&(r="Backend workflow error",a=`

\u{1F4A1} **Suggestion:** This is a temporary server-side issue. Please try again in a few minutes.`),this.chatHistory[t].content=`\u{1F4C4} **Report Generation Failed**

**Request:** ${e}

**Error:** ${r}${a}`,this.renderMessages(),new b.Notice(`Report generation failed: ${r}`)}}async handleDarkWebInvestigation(e){let t=this.chatHistory.length;this.chatHistory.push({role:"assistant",content:"\u{1F575}\uFE0F Starting dark web investigation...",status:"starting",progress:{message:"Initializing investigation...",percent:5}}),this.renderMessages();let n=(c,d)=>{this.chatHistory[t].progress={message:c,percent:d},this.updateProgressBar(t,{message:c,percent:d})},i=3,r=1e3,a=null;for(let c=1;c<=i;c++)try{n("Connecting to dark web API...",10);let d=`${K}/api/darkweb/investigate`,p=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.plugin.settings.reportApiKey}`},body:JSON.stringify({query:e,model:ze,threads:8}),mode:"cors",credentials:"omit"});if(!p.ok){let y=await p.text().catch(()=>"");if(p.status===403){let h=y.toLowerCase();if(h.includes("quota")||h.includes("exceeded"))throw new Error("Investigation quota exhausted. Please upgrade your plan or wait for quota renewal. Visit https://osint-copilot.com/dashboard/ to manage your subscription.");if(h.includes("expired"))throw new Error("Your license key or trial has expired. Please renew your subscription at https://osint-copilot.com/dashboard/");if(h.includes("inactive"))throw new Error("Your license key is inactive. Please check your account status at https://osint-copilot.com/dashboard/")}throw new Error(`DarkWeb API request failed (${p.status}): ${y.substring(0,200)}`)}n("Processing API response...",15);let g=(await p.json()).job_id;if(!g)throw new Error("No job ID returned from DarkWeb API");n("Investigation started, searching dark web engines...",20),console.log(`[OSINT Copilot] Dark web investigation started with Job ID: ${g}`),this.chatHistory[t]={role:"assistant",content:`\u{1F575}\uFE0F Dark web investigation started

**Query:** ${e}
**Status:** Processing
**Estimated time:** 2-3 minutes

Searching 15+ dark web engines...`,jobId:g,status:"processing",query:e,progress:{message:"Searching dark web engines...",percent:20}},this.renderMessages(),this.pollDarkWebStatus(g,t,e);return}catch(d){if(a=d instanceof Error?d:new Error(String(d)),!this.plugin.isTransientNetworkError(a))break;if(c<i){let p=r*Math.pow(2,c-1);console.log(`[OSINT Copilot] DarkWeb API network error, retrying in ${p}ms (attempt ${c}/${i})`),n(`Network error. Retrying... (${c}/${i})`,8),this.chatHistory[t]={role:"assistant",content:`\u{1F575}\uFE0F Starting dark web investigation...

\u26A0\uFE0F Network interrupted. Retrying... (${c}/${i})`,status:"starting"},this.renderMessages(),await this.plugin.sleep(p)}}let s=a?a.message:"Unknown error",l=a&&this.plugin.isTransientNetworkError(a);this.chatHistory[t]={role:"assistant",content:`\u274C Error starting dark web investigation: ${l?"Network connection error. Please check your internet connection and try again.":s}

\u{1F4A1} Tip: Your query was saved. You can try sending it again.`,status:"failed"},this.renderMessages(),this.inputEl.value=e}pollDarkWebStatus(e,t,n){let i=this.pollingIntervals.get(e);i&&window.clearTimeout(i);let r=0,a=0,s=5,l=10*60*1e3,c=g=>g<2e4?3e3:g<6e4?5e3:8e3,d=async()=>{if(r>=l){this.pollingIntervals.delete(e),console.warn(`[OSINT Copilot] Dark web investigation timed out after ${Math.round(l/1e3)}s`),this.chatHistory[t]={role:"assistant",content:`\u23F1\uFE0F Dark web investigation timed out

**Job ID:** ${e}

The investigation is taking longer than expected (${Math.round(l/6e4)} minutes).

The job may still be processing on the server. You can try checking the status later or contact support.`,jobId:e,status:"timeout",progress:void 0},this.renderMessages();return}try{let g=`${K}/api/darkweb/status/${e}`,y=new AbortController,h=setTimeout(()=>y.abort(),3e4),m;try{if(m=await fetch(g,{method:"GET",headers:{Authorization:`Bearer ${this.plugin.settings.reportApiKey}`},mode:"cors",credentials:"omit",signal:y.signal}),clearTimeout(h),!m.ok)throw new Error(`Status check failed (${m.status})`)}catch(C){throw clearTimeout(h),C}let f=await m.json(),x=f.status;if(a=0,x==="processing (up to 5 mins)"){let C=f.progress||{},S=C.percent_complete||0,k=C.current_step||"Processing...",I=C.engines_searched||0,M=C.results_found||0,_=20+Math.round(S*.7),R=`${k} (${I} engines, ${M} results)`;this.chatHistory[t]={role:"assistant",content:`\u{1F575}\uFE0F Dark web investigation in progress

**Status:** ${k}
**Progress:** ${S}%
**Engines searched:** ${I}
**Results found:** ${M}

Please wait...`,jobId:e,status:"processing",progress:{message:R,percent:_},query:n},this.updateProgressBar(t,{message:R,percent:_});let P=c(r);r+=P;let N=window.setTimeout(d,P);this.pollingIntervals.set(e,N)}else x==="completed"?(this.pollingIntervals.delete(e),this.chatHistory[t].progress={message:"Fetching results...",percent:92},this.updateProgressBar(t,{message:"Fetching results...",percent:92}),await this.fetchDarkWebResults(e,t,n)):x==="failed"&&(this.pollingIntervals.delete(e),console.error(`[OSINT Copilot] Dark web investigation failed. Job ID: ${e}, Error: ${f.error||"Unknown error"}`),this.chatHistory[t]={role:"assistant",content:`\u274C Dark web investigation failed

**Error:** ${f.error||"Unknown error"}

Please try again or contact support if the issue persists.`,jobId:e,status:"failed",progress:void 0},this.renderMessages())}catch(g){a++;let y=g instanceof Error?g.name:"Unknown",h=g instanceof Error?g.message:String(g);if(console.error(`[OSINT Copilot] Dark web status poll error (${a}/${s}):`,`Type: ${y}, Message: ${h}`),a<s){let m=c(r);r+=m;let f=Math.round(r/1e3),x=`Network interrupted (${y}), retrying... (${f}s elapsed, attempt ${a}/${s})`;console.log(`[OSINT Copilot] ${x}`);let C=window.setTimeout(d,m);this.pollingIntervals.set(e,C)}else this.pollingIntervals.delete(e),console.error("[OSINT Copilot] Dark web status polling failed after max retries"),this.chatHistory[t]={role:"assistant",content:`\u274C Dark web investigation status check failed

**Error:** Network connection lost after ${s} attempts (${y}).

Please check your connection and try again.`,jobId:e,status:"failed",progress:void 0},this.renderMessages()}},p=c(0);r=p;let u=window.setTimeout(d,p);this.pollingIntervals.set(e,u)}async fetchDarkWebResults(e,t,n){try{let i=`${K}/api/darkweb/summary/${e}`,r=await fetch(i,{method:"GET",headers:{Authorization:`Bearer ${this.plugin.settings.reportApiKey}`},mode:"cors",credentials:"omit"});if(!r.ok)throw new Error(`Failed to fetch results (${r.status})`);let a=await r.json();console.log(`[OSINT Copilot] Dark web investigation completed. Job ID: ${e}`);let s=`# Dark Web Investigation: ${n}

`;a.summary&&(s+=`## Summary

${a.summary}

`),a.findings&&a.findings.length>0&&(s+=`## Key Findings (${a.findings.length})

`,a.findings.forEach((d,p)=>{s+=`### ${p+1}. ${d.title||"Finding"}

`,d.url&&(s+=`**URL:** ${d.url}

`),d.snippet&&(s+=`${d.snippet}

`)}));let l="";try{l=await this.plugin.saveDarkWebReportToVault(s,n,e),new b.Notice(`Dark web report saved to ${l}`)}catch(d){console.error("Error saving dark web report to vault:",d)}let c=`\u2705 Dark web investigation completed

`;if(c+=`**Query:** ${n}
`,l&&(c+=`**Saved to:** \`${l}\`
`),c+=`
---

`,c+=s,this.chatHistory[t]={role:"assistant",content:c,jobId:e,status:"completed",query:n,progress:void 0,reportFilePath:l||void 0},this.renderMessages(),this.entityGenerationMode&&await this.processEntityGeneration(t,s,n,c),l){let d=this.app.vault.getAbstractFileByPath(l);d instanceof b.TFile&&await this.app.workspace.getLeaf().openFile(d)}new b.Notice("Dark web investigation completed!")}catch(i){console.error(`[OSINT Copilot] Failed to fetch dark web results. Job ID: ${e}, Error:`,i),this.chatHistory[t]={role:"assistant",content:`\u26A0\uFE0F Investigation completed but failed to fetch results

**Query:** ${n}
**Error:** ${i instanceof Error?i.message:String(i)}

Please try again or contact support if the issue persists.`,jobId:e,status:"completed",query:n},this.renderMessages()}}async onClose(){for(let e of this.pollingIntervals.values())window.clearTimeout(e);this.pollingIntervals.clear()}},we=class extends b.PluginSettingTab{constructor(o,e){super(o,e),this.plugin=e}display(){let{containerEl:o}=this;o.empty(),o.createEl("h2",{text:"OSINT Copilot Settings"}),new b.Setting(o).setName("Max Notes").setDesc("Maximum number of notes to include in context").addText(t=>t.setPlaceholder("15").setValue(String(this.plugin.settings.maxNotes)).onChange(async n=>{let i=parseInt(n);!isNaN(i)&&i>0&&(this.plugin.settings.maxNotes=i,await this.plugin.saveSettings())})),new b.Setting(o).setName("System Prompt").setDesc("Default system prompt for Q&A").addTextArea(t=>{t.setPlaceholder("You are a vault assistant...").setValue(this.plugin.settings.systemPrompt).onChange(async n=>{this.plugin.settings.systemPrompt=n,await this.plugin.saveSettings()}),t.inputEl.rows=4,t.inputEl.style.width="100%"}),o.createEl("h3",{text:"Backend API Settings"});let e=new b.Setting(o).setName("Account Dashboard").setDesc("View your API usage, quota, and manage your subscription");if(e.controlEl.createEl("a",{text:"Open Dashboard \u2192",href:"https://osint-copilot.com/dashboard/",cls:"external-link"}).style.cssText="color: var(--interactive-accent); text-decoration: none; font-weight: 500;",new b.Setting(o).setName("License Key").setDesc("License key for all operations (chat, reports, and investigations)").addText(t=>{t.setPlaceholder("Enter your license key").setValue(this.plugin.settings.reportApiKey).onChange(async n=>{this.plugin.settings.reportApiKey=n,await this.plugin.saveSettings(),this.refreshApiInfo()}),t.inputEl.type="password"}),this.plugin.settings.reportApiKey){let t=o.createDiv("api-info-container");t.style.cssText="margin: 10px 0; padding: 15px; background: var(--background-secondary); border-radius: 5px;";let n=t.createEl("p",{text:"Loading license key information...",cls:"setting-item-description"});this.fetchApiKeyInfo().then(i=>{if(n.remove(),i){let r=t.createDiv();r.style.cssText="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;";let a=r.createDiv();a.createEl("strong",{text:"Plan: "}),a.createSpan({text:i.plan||"No Plan"});let s=r.createDiv();s.createEl("strong",{text:"Remaining Quota: "});let l=s.createSpan({text:`${i.remaining_quota} reports`});i.remaining_quota<=0?(l.style.color="var(--text-error)",l.style.fontWeight="bold"):i.remaining_quota<=5&&(l.style.color="var(--text-warning)");let c=r.createDiv();c.createEl("strong",{text:"Status: "});let d=c.createSpan({text:i.active?"Active":"Inactive"});d.style.color=i.active?"var(--text-success)":"var(--text-error)";let p=r.createDiv();p.createEl("strong",{text:"Expires: "});let u=new Date(i.expires_at);if(p.createSpan({text:u.toLocaleDateString()}),i.is_trial){let g=t.createEl("p",{text:"\u{1F381} Trial Account",cls:"setting-item-description"});g.style.cssText="margin-top: 10px; color: var(--text-warning); font-weight: 500;"}if(i.remaining_quota<=0){let g=t.createDiv();g.style.cssText="margin-top: 15px; padding: 12px; background: var(--background-modifier-error); border-radius: 5px; border-left: 4px solid var(--text-error);",g.createEl("p",{text:"\u26A0\uFE0F Quota Exhausted"}).style.cssText="margin: 0 0 8px 0; font-weight: bold; color: var(--text-error);",g.createEl("p",{text:"You have no remaining report credits. Dark web investigations and report generation are unavailable until you upgrade or your quota renews."}).style.cssText="margin: 0 0 10px 0; font-size: 0.9em;";let y=g.createEl("a",{text:"Upgrade your plan \u2192",href:"https://osint-copilot.com/dashboard/"});y.style.cssText="color: var(--interactive-accent); font-weight: 500; text-decoration: none;"}else if(i.remaining_quota<=5){let g=t.createDiv();g.style.cssText="margin-top: 15px; padding: 10px; background: var(--background-modifier-warning); border-radius: 5px;",g.createEl("p",{text:`\u26A0\uFE0F Low quota: Only ${i.remaining_quota} report credits remaining.`}).style.cssText="margin: 0; font-size: 0.9em; color: var(--text-warning);"}}else t.createEl("p",{text:"\u26A0\uFE0F Could not load license key information. Please check your license key.",cls:"setting-item-description"}).style.color="var(--text-error)"}).catch(()=>{n.remove(),t.createEl("p",{text:"\u26A0\uFE0F Failed to connect to API. Please check your internet connection.",cls:"setting-item-description"}).style.color="var(--text-error)"})}new b.Setting(o).setName("Report Output Directory").setDesc("Directory where generated reports will be saved").addText(t=>t.setPlaceholder("Reports").setValue(this.plugin.settings.reportOutputDir).onChange(async n=>{this.plugin.settings.reportOutputDir=n,await this.plugin.saveSettings()})),new b.Setting(o).setName("Conversation History Folder").setDesc("Directory where chat conversations will be saved").addText(t=>t.setPlaceholder(".osint-copilot/conversations").setValue(this.plugin.settings.conversationFolder).onChange(async n=>{this.plugin.settings.conversationFolder=n,this.plugin.conversationService.setBasePath(n),await this.plugin.saveSettings(),await this.plugin.conversationService.initialize()})),o.createEl("p",{text:"\u2139\uFE0F Note: AI entity generation requires an active API connection. All other features (manual entity creation, editing, connections, map view) work locally without the API.",cls:"setting-item-description"}).style.color="var(--text-muted)",o.createEl("h3",{text:"Graph View Settings"}),new b.Setting(o).setName("Auto-refresh Graph View").setDesc("Automatically refresh the graph view when new entities are created through AI generation").addToggle(t=>t.setValue(this.plugin.settings.autoRefreshGraph).onChange(async n=>{this.plugin.settings.autoRefreshGraph=n,await this.plugin.saveSettings()})),new b.Setting(o).setName("Auto-open Graph View").setDesc("Automatically open the graph view when entities are created (if not already open)").addToggle(t=>t.setValue(this.plugin.settings.autoOpenGraphOnEntityCreation).onChange(async n=>{this.plugin.settings.autoOpenGraphOnEntityCreation=n,await this.plugin.saveSettings()})),o.createEl("h3",{text:"General Settings"})}async fetchApiKeyInfo(){if(!this.plugin.settings.reportApiKey)return null;try{let o=await fetch("https://api.osint-copilot.com/api/key/info",{method:"GET",headers:{Authorization:`Bearer ${this.plugin.settings.reportApiKey}`,"Content-Type":"application/json"}});return o.ok?await o.json():null}catch(o){return console.error("Failed to fetch license key info:",o),null}}async refreshApiInfo(){this.display()}};
