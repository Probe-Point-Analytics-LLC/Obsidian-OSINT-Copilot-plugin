/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var Ie=Object.defineProperty;var je=Object.getOwnPropertyDescriptor;var Ke=Object.getOwnPropertyNames;var Ye=Object.prototype.hasOwnProperty;var Je=(k,r)=>{for(var e in r)Ie(k,e,{get:r[e],enumerable:!0})},Qe=(k,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of Ke(r))!Ye.call(k,n)&&n!==e&&Ie(k,n,{get:()=>r[n],enumerable:!(t=je(r,n))||t.enumerable});return k};var Ze=k=>Qe(Ie({},"__esModule",{value:!0}),k);var lt={};Je(lt,{CHAT_VIEW_TYPE:()=>ee,ChatView:()=>he,default:()=>ke});module.exports=Ze(lt);var b=require("obsidian");var Xe={Thing:{name:"Thing",label:"Thing",plural:"Things",description:"The most basic type of entity. All other types extend from this.",extends:[],featured:["name"],required:[],caption:["name"],properties:{name:{label:"Name",type:"name",description:"A name or title"},description:{label:"Description",type:"text"},country:{label:"Country",type:"country"},alias:{label:"Alias",type:"name"},notes:{label:"Notes",type:"text"},sourceUrl:{label:"Source URL",type:"url",matchable:!1},wikidataId:{label:"Wikidata ID",type:"identifier"},keywords:{label:"Keywords"},topics:{label:"Topics"},address:{label:"Address",type:"address"}}},Interval:{name:"Interval",label:"Interval",plural:"Intervals",description:"An object which is bounded in time.",extends:[],abstract:!0,featured:[],required:[],caption:[],properties:{startDate:{label:"Start date",type:"date"},endDate:{label:"End date",type:"date"},date:{label:"Date",type:"date"},summary:{label:"Summary",type:"text"},description:{label:"Description",type:"text"},sourceUrl:{label:"Source link",type:"url",matchable:!1},modifiedAt:{label:"Modified on",type:"date"}}},Value:{name:"Value",label:"Value",plural:"Values",description:"A monetary value with amount and currency.",extends:[],abstract:!0,featured:["amount","currency"],required:[],caption:[],properties:{amount:{label:"Amount",type:"number"},amountUsd:{label:"Amount (USD)",type:"number"},currency:{label:"Currency"}}},Analyzable:{name:"Analyzable",label:"Analyzable",plural:"Analyzables",description:"An entity suitable for being processed via named-entity recognition.",extends:[],abstract:!0,featured:[],required:[],caption:[],properties:{detectedLanguage:{label:"Detected language",type:"language",hidden:!0},detectedCountry:{label:"Detected country",type:"country",hidden:!0}}}},et={Person:{name:"Person",label:"Person",plural:"People",description:"A natural person, alive or dead.",extends:["LegalEntity"],matchable:!0,featured:["name","nationality","birthDate","country"],required:["name"],caption:["name","firstName","lastName"],properties:{firstName:{label:"First name",type:"name"},lastName:{label:"Last name",type:"name"},fatherName:{label:"Father name",type:"name"},motherName:{label:"Mother name",type:"name"},birthDate:{label:"Birth date",type:"date"},birthPlace:{label:"Place of birth",type:"address"},deathDate:{label:"Death date",type:"date"},nationality:{label:"Nationality",type:"country"},gender:{label:"Gender"},title:{label:"Title"},religion:{label:"Religion"},ethnicity:{label:"Ethnicity"},political:{label:"Political affiliation"},position:{label:"Position"},education:{label:"Education"},passportNumber:{label:"Passport number",type:"identifier"},idNumber:{label:"ID number",type:"identifier"}},color:"#4CAF50"},LegalEntity:{name:"LegalEntity",label:"Legal entity",plural:"Legal entities",description:"Any party to legal proceedings, such as asset ownership, corporate governance or social interactions.",extends:["Thing"],matchable:!0,featured:["name","country","legalForm","status"],required:["name"],caption:["name","email","phone","registrationNumber"],properties:{email:{label:"E-Mail",type:"email"},phone:{label:"Phone",type:"phone",maxLength:32},website:{label:"Website",type:"url"},legalForm:{label:"Legal form",matchable:!1},incorporationDate:{label:"Incorporation date",type:"date"},dissolutionDate:{label:"Dissolution date",type:"date"},taxStatus:{label:"Tax status",matchable:!1},status:{label:"Status",matchable:!1},sector:{label:"Sector",matchable:!1},classification:{label:"Classification",matchable:!1},registrationNumber:{label:"Registration number",type:"identifier"},idNumber:{label:"ID Number",type:"identifier"},taxNumber:{label:"Tax Number",type:"identifier"},jurisdiction:{label:"Jurisdiction",type:"country"},mainCountry:{label:"Country of origin",type:"country"}},color:"#607D8B"},Organization:{name:"Organization",label:"Organization",plural:"Organizations",description:"Any type of incorporated entity that cannot be owned by another.",extends:["LegalEntity"],matchable:!0,featured:["name","country","legalForm","status"],required:["name"],caption:["name"],properties:{cageCode:{label:"CAGE",type:"identifier",maxLength:16},permId:{label:"PermID",type:"identifier",maxLength:16}},color:"#795548"},Company:{name:"Company",label:"Company",plural:"Companies",description:"A legal entity representing a commercial business.",extends:["Organization"],matchable:!0,featured:["name","jurisdiction","registrationNumber","incorporationDate"],required:["name"],caption:["name","registrationNumber"],properties:{voenCode:{label:"VOEN",type:"identifier"},coatoCode:{label:"COATO",type:"identifier"},irsCode:{label:"IRS Employer ID",type:"identifier"},ipoCode:{label:"IPO",type:"identifier"}},color:"#037d9e"},Event:{name:"Event",label:"Event",plural:"Events",description:"An occurrence at a specific time and place.",extends:["Interval","Thing"],matchable:!1,featured:["name","summary","date","location","add_to_timeline"],required:["name"],caption:["name","summary","date"],properties:{location:{label:"Location",type:"address"},country:{label:"Country",type:"country"},latitude:{label:"Latitude",type:"number"},longitude:{label:"Longitude",type:"number"},important:{label:"Important"},add_to_timeline:{label:"Add to Timeline",type:"boolean"}},color:"#F22416"},Address:{name:"Address",label:"Address",plural:"Addresses",description:"A location associated with an entity.",extends:["Thing"],matchable:!0,featured:["full","city","street","country","latitude","longitude"],required:[],caption:["full","summary","city"],properties:{full:{label:"Full address",type:"address"},remarks:{label:"Remarks"},postOfficeBox:{label:"PO Box"},street:{label:"Street address"},street2:{label:"Street address (ctd.)"},city:{label:"City"},postalCode:{label:"Postal code",maxLength:16},region:{label:"Region"},state:{label:"State"},latitude:{label:"Latitude",type:"number"},longitude:{label:"Longitude",type:"number"},country:{label:"Country",type:"country"}},color:"#FF5722"},Vehicle:{name:"Vehicle",label:"Vehicle",plural:"Vehicles",description:"A vehicle such as a car, truck, or motorcycle.",extends:["Thing"],matchable:!1,featured:["type","name","registrationNumber","country"],required:[],caption:["name","registrationNumber"],properties:{registrationNumber:{label:"Registration number",type:"identifier"},type:{label:"Type"},model:{label:"Model"},buildDate:{label:"Build Date",type:"date"},registrationDate:{label:"Registration Date",type:"date"}},color:"#6c5952"},BankAccount:{name:"BankAccount",label:"Bank Account",plural:"Bank Accounts",description:"A bank account held at a financial institution.",extends:["Thing"],matchable:!0,featured:["bankName","iban","accountNumber"],required:[],caption:["bankName","iban","accountNumber"],properties:{bankName:{label:"Bank name"},iban:{label:"IBAN",type:"iban"},accountNumber:{label:"Account number",type:"identifier"},bic:{label:"BIC/SWIFT",type:"identifier"},balance:{label:"Balance",type:"number"},currency:{label:"Currency"}},color:"#2E7D32"},CryptoWallet:{name:"CryptoWallet",label:"Crypto Wallet",plural:"Crypto Wallets",description:"A cryptocurrency wallet address.",extends:["Thing"],matchable:!0,featured:["publicKey","currency"],required:["publicKey"],caption:["publicKey"],properties:{publicKey:{label:"Public key/Address",type:"identifier"},currency:{label:"Currency"},balance:{label:"Balance",type:"number"}},color:"#FF9800"},UserAccount:{name:"UserAccount",label:"User Account",plural:"User Accounts",description:"A user account on a platform or service.",extends:["Thing"],matchable:!0,featured:["userName","platform","url"],required:["userName"],caption:["userName","platform"],properties:{userName:{label:"Username"},platform:{label:"Platform"},url:{label:"Profile URL",type:"url"},email:{label:"Email",type:"email"},phone:{label:"Phone",type:"phone"}},color:"#21B57D"},Document:{name:"Document",label:"Document",plural:"Documents",description:"A document or file.",extends:["Thing"],matchable:!1,featured:["title","date","mimeType"],required:[],caption:["title","fileName"],properties:{title:{label:"Title"},fileName:{label:"File name"},mimeType:{label:"MIME type"},fileSize:{label:"File size",type:"number"},date:{label:"Date",type:"date"},author:{label:"Author"}},color:"#9C27B0"},RealEstate:{name:"RealEstate",label:"Real Estate",plural:"Real Estate",description:"A piece of real estate property.",extends:["Thing"],matchable:!1,featured:["name","address","country"],required:[],caption:["name","address"],properties:{registrationNumber:{label:"Registration number",type:"identifier"},area:{label:"Area"},areaUnit:{label:"Area unit"},buildDate:{label:"Build date",type:"date"},propertyType:{label:"Property type"}},color:"#8D6E63"},Sanction:{name:"Sanction",label:"Sanction",plural:"Sanctions",description:"A sanction or restriction placed on an entity.",extends:["Interval"],matchable:!1,featured:["program","authority","reason"],required:[],caption:["program","authority"],properties:{program:{label:"Program"},authority:{label:"Authority"},reason:{label:"Reason"},listingDate:{label:"Listing date",type:"date"},provisions:{label:"Provisions"}},color:"#D32F2F"},Passport:{name:"Passport",label:"Passport",plural:"Passports",description:"A passport or travel document.",extends:["Interval","Thing"],matchable:!0,featured:["number","country","type"],required:["number"],caption:["number","country"],properties:{number:{label:"Number",type:"identifier"},type:{label:"Type"},country:{label:"Country",type:"country"},issueDate:{label:"Issue date",type:"date"},expiryDate:{label:"Expiry date",type:"date"}},color:"#1565C0"},Ownership:{name:"Ownership",label:"Ownership",plural:"Ownerships",description:"An ownership relationship between entities.",extends:["Interval"],matchable:!1,featured:["owner","asset","percentage"],required:[],caption:["owner","asset"],properties:{percentage:{label:"Percentage",type:"number"},sharesCount:{label:"Shares count",type:"number"},sharesValue:{label:"Shares value",type:"number"},sharesCurrency:{label:"Shares currency"}},color:"#546E7A"},Employment:{name:"Employment",label:"Employment",plural:"Employments",description:"An employment relationship.",extends:["Interval"],matchable:!1,featured:["employee","employer","role"],required:[],caption:["employee","employer","role"],properties:{role:{label:"Role"},title:{label:"Title"},salary:{label:"Salary",type:"number"},salaryCurrency:{label:"Salary currency"}},color:"#00897B"},Directorship:{name:"Directorship",label:"Directorship",plural:"Directorships",description:"A directorship or board membership.",extends:["Interval"],matchable:!1,featured:["director","organization","role"],required:[],caption:["director","organization","role"],properties:{role:{label:"Role"},secretary:{label:"Secretary"}},color:"#5E35B1"},Airplane:{name:"Airplane",label:"Airplane",plural:"Airplanes",description:"An airplane, helicopter or other flying vehicle.",extends:["Vehicle"],matchable:!0,featured:["type","registrationNumber","country","name"],required:[],caption:["name","registrationNumber"],properties:{serialNumber:{label:"Serial Number",type:"identifier"},icaoCode:{label:"ICAO aircraft type designator",type:"identifier",maxLength:16},manufacturer:{label:"Manufacturer"}},color:"#5C6BC0"},Vessel:{name:"Vessel",label:"Vessel",plural:"Vessels",description:"A boat or ship. Typically flying some sort of national flag.",extends:["Vehicle"],matchable:!0,featured:["name","imoNumber","type","flag"],required:["name"],caption:["name","imoNumber"],properties:{imoNumber:{label:"IMO Number",type:"identifier",maxLength:16},crsNumber:{label:"CRS Number",type:"identifier"},flag:{label:"Flag",type:"country"},registrationPort:{label:"Port of Registration"},navigationArea:{label:"Navigation Area"},tonnage:{label:"Tonnage",type:"number"},grossRegisteredTonnage:{label:"Gross Registered Tonnage",type:"number"},callSign:{label:"Call Sign",type:"identifier"},mmsi:{label:"MMSI",type:"identifier",maxLength:16}},color:"#0288D1"},PublicBody:{name:"PublicBody",label:"Public Body",plural:"Public Bodies",description:"A public body, such as a ministry, department or state company.",extends:["Organization"],matchable:!0,featured:["name","country","legalForm","status"],required:["name"],caption:["name"],properties:{},color:"#7B1FA2"},Asset:{name:"Asset",label:"Asset",plural:"Assets",description:"A piece of property which can be owned and assigned a monetary value.",extends:["Thing","Value"],matchable:!1,featured:["name","amount"],required:[],caption:["name"],properties:{},color:"#FFA000"},Security:{name:"Security",label:"Security",plural:"Securities",description:"A tradeable financial asset.",extends:["Asset"],matchable:!0,featured:["isin","name","country"],required:[],caption:["name","isin","registrationNumber"],properties:{isin:{label:"ISIN",type:"identifier",maxLength:16},registrationNumber:{label:"Registration number",type:"identifier"},ticker:{label:"Stock ticker symbol",type:"identifier"},figiCode:{label:"Financial Instrument Global Identifier",type:"identifier",maxLength:16},issueDate:{label:"Date issued",type:"date"},maturityDate:{label:"Maturity date",type:"date"},type:{label:"Type"},classification:{label:"Classification"}},color:"#00796B"},Payment:{name:"Payment",label:"Payment",plural:"Payments",description:"A monetary payment between two parties.",extends:["Interval","Value"],matchable:!1,featured:["date","amount","purpose"],required:[],caption:["amount"],properties:{sequenceNumber:{label:"Sequence number"},transactionNumber:{label:"Transaction number"},purpose:{label:"Payment purpose",type:"text"},programme:{label:"Payment programme"}},color:"#388E3C"},Folder:{name:"Folder",label:"Folder",plural:"Folders",description:"A folder or directory containing documents.",extends:["Document"],matchable:!1,generated:!0,featured:["title"],required:[],caption:["fileName","title"],properties:{},color:"#8D6E63"},PlainText:{name:"PlainText",label:"Text File",plural:"Text Files",description:"Text files, like .txt or source code.",extends:["Document"],matchable:!1,generated:!0,featured:["title","fileName","mimeType"],required:[],caption:["fileName","title"],properties:{bodyText:{label:"Text",type:"text",hidden:!0}},color:"#78909C"},HyperText:{name:"HyperText",label:"Web Page",plural:"Web Pages",description:"An HTML document or web page.",extends:["Document"],matchable:!1,generated:!0,featured:["title","fileName","mimeType"],required:[],caption:["title","fileName"],properties:{bodyHtml:{label:"HTML",type:"html",hidden:!0}},color:"#26A69A"},Email:{name:"Email",label:"E-Mail",plural:"E-Mails",description:"An internet mail message with subject, sender, and recipients.",extends:["Folder","PlainText","HyperText"],matchable:!1,generated:!0,featured:["subject","date","from"],required:[],caption:["subject","threadTopic","title","name","fileName"],properties:{subject:{label:"Subject"},threadTopic:{label:"Thread topic"},sender:{label:"Sender"},from:{label:"From"},to:{label:"To"},cc:{label:"CC"},bcc:{label:"BCC"}},color:"#2196F3"},Message:{name:"Message",label:"Message",plural:"Messages",description:"A message or communication between parties.",extends:["Interval","Folder","PlainText","HyperText"],matchable:!1,generated:!0,featured:["subject","date"],required:[],caption:["subject","title","threadTopic","fileName"],properties:{subject:{label:"Subject"},threadTopic:{label:"Thread topic"}},color:"#7E57C2"},IP:{name:"IP",label:"IP Address",plural:"IP Addresses",description:"An Internet Protocol address (IPv4 or IPv6).",extends:["Thing"],featured:["ip","version","isp"],required:["ip"],caption:["ip"],properties:{ip:{label:"IP Address"},version:{label:"Version",options:["IPv4","IPv6"]},asn:{label:"ASN"},isp:{label:"ISP"},hostname:{label:"Hostname"}},color:"#00BCD4"},Malware:{name:"Malware",label:"Malware",plural:"Malware",description:"Malicious software, virus, or exploit.",extends:["Thing"],featured:["name","type","platform"],required:["name"],caption:["name"],properties:{name:{label:"Name"},type:{label:"Type"},platform:{label:"Platform"},hash_md5:{label:"MD5"},hash_sha256:{label:"SHA256"},cve:{label:"CVE"}},color:"#D32F2F"},Group:{name:"Group",label:"Group",plural:"Groups",description:"A group of people, organization, or cluster of entities.",extends:["Organization"],featured:["name","purpose"],required:["name"],caption:["name"],properties:{purpose:{label:"Purpose"},area_of_operation:{label:"Area of Operation"},ideology:{label:"Ideology"}},color:"#FF9800"},Domain:{name:"Domain",label:"Domain",plural:"Domains",description:"An internet domain name.",extends:["Thing"],featured:["domain","registrar","creation_date"],required:["domain"],caption:["domain"],properties:{domain:{label:"Domain Name"},registrar:{label:"Registrar"},creation_date:{label:"Creation Date",type:"date"},expiration_date:{label:"Expiration Date",type:"date"},nameservers:{label:"Nameservers"}},color:"#3F51B5"},Contract:{name:"Contract",label:"Contract",plural:"Contracts",description:"A contract or contract lot issued by an authority.",extends:["Asset"],matchable:!1,featured:["title","amount","contractDate"],required:["title"],caption:["title","name","procedureNumber"],properties:{title:{label:"Title"},type:{label:"Type"},contractDate:{label:"Contract date",type:"date"},procedureNumber:{label:"Procedure number"},procedure:{label:"Contract procedure"},status:{label:"Status"},method:{label:"Procurement method"},criteria:{label:"Contract award criteria"},classification:{label:"Classification"}},color:"#5D4037"},Project:{name:"Project",label:"Project",plural:"Projects",description:"An activity carried out by a group of participants.",extends:["Interval","Thing","Value"],matchable:!1,featured:["name","projectId","startDate"],required:[],caption:["name","projectId"],properties:{projectId:{label:"Project ID",type:"identifier"},status:{label:"Status"},phase:{label:"Phase"},goal:{label:"Project goal"}},color:"#00ACC1"},CourtCase:{name:"CourtCase",label:"Court Case",plural:"Court Cases",description:"A legal case in a court of law.",extends:["Thing"],matchable:!1,featured:["name","fileDate","caseNumber"],required:["name"],caption:["name","caseNumber"],properties:{category:{label:"Category"},type:{label:"Type"},status:{label:"Status"},caseNumber:{label:"Case number",type:"identifier"},court:{label:"Court"},fileDate:{label:"File date",type:"date"},closeDate:{label:"Close date",type:"date"}},color:"#6D4C41"},Family:{name:"Family",label:"Family",plural:"Family Members",description:"Family relationship between two people.",extends:["Interval"],matchable:!1,featured:["relationship"],required:[],caption:["relationship"],properties:{relationship:{label:"Relationship"}},color:"#E91E63"},Membership:{name:"Membership",label:"Membership",plural:"Memberships",description:"A membership in an organization.",extends:["Interval"],matchable:!1,featured:["role"],required:[],caption:["role"],properties:{role:{label:"Role"},status:{label:"Status"}},color:"#9C27B0"},Associate:{name:"Associate",label:"Associate",plural:"Associates",description:"An association between two entities.",extends:["Interval"],matchable:!1,featured:["relationship"],required:[],caption:["relationship"],properties:{relationship:{label:"Relationship"}},color:"#673AB7"},Representation:{name:"Representation",label:"Representation",plural:"Representations",description:"A legal or formal representation relationship.",extends:["Interval"],matchable:!1,featured:["role"],required:[],caption:["role"],properties:{role:{label:"Role"}},color:"#3F51B5"},Identification:{name:"Identification",label:"Identification",plural:"Identifications",description:"An identification document or number.",extends:["Interval","Thing"],matchable:!0,featured:["number","type","country"],required:["number"],caption:["number","type"],properties:{number:{label:"Number",type:"identifier"},type:{label:"Type"},country:{label:"Country",type:"country"},issueDate:{label:"Issue date",type:"date"},expiryDate:{label:"Expiry date",type:"date"}},color:"#1976D2"},License:{name:"License",label:"License",plural:"Licenses",description:"A license or permit.",extends:["Interval","Thing"],matchable:!1,featured:["number","type","authority"],required:[],caption:["number","type"],properties:{number:{label:"Number",type:"identifier"},type:{label:"Type"},authority:{label:"Authority"},issueDate:{label:"Issue date",type:"date"},expiryDate:{label:"Expiry date",type:"date"}},color:"#0097A7"},Debt:{name:"Debt",label:"Debt",plural:"Debts",description:"A debt or liability.",extends:["Interval","Value"],matchable:!1,featured:["amount","currency","date"],required:[],caption:["amount"],properties:{status:{label:"Status"},type:{label:"Type"}},color:"#C62828"},Interest:{name:"Interest",label:"Interest",plural:"Interests",description:"An interest or stake in an entity.",extends:["Interval"],matchable:!1,featured:["percentage","type"],required:[],caption:["percentage","type"],properties:{percentage:{label:"Percentage",type:"number"},type:{label:"Type"},status:{label:"Status"}},color:"#AD1457"},Occupancy:{name:"Occupancy",label:"Occupancy",plural:"Occupancies",description:"An occupancy of a position or role.",extends:["Interval"],matchable:!1,featured:["role","status"],required:[],caption:["role"],properties:{role:{label:"Role"},status:{label:"Status"}},color:"#6A1B9A"},Position:{name:"Position",label:"Position",plural:"Positions",description:"A position or role in an organization.",extends:["Thing"],matchable:!1,featured:["name","country"],required:["name"],caption:["name"],properties:{subnationalArea:{label:"Subnational area"}},color:"#4527A0"},Trip:{name:"Trip",label:"Trip",plural:"Trips",description:"A journey or trip.",extends:["Interval","Thing"],matchable:!1,featured:["name","startDate","endDate"],required:[],caption:["name"],properties:{origin:{label:"Origin"},destination:{label:"Destination"},purpose:{label:"Purpose"}},color:"#00838F"},Call:{name:"Call",label:"Call",plural:"Calls",description:"A phone call or communication.",extends:["Interval"],matchable:!1,featured:["date","duration"],required:[],caption:["date"],properties:{duration:{label:"Duration"},type:{label:"Type"}},color:"#00695C"},Image:{name:"Image",label:"Photo",plural:"Photos",description:"An image or photo file for investigation.",extends:["Document"],matchable:!1,generated:!1,featured:["title","filePath","location","dateTaken"],required:["title"],caption:["title","fileName"],properties:{filePath:{label:"File Path",description:"Path to the image file in the vault"},location:{label:"Location",description:"Location where the photo was taken"},dateTaken:{label:"Date Taken",type:"date"},source:{label:"Source"},width:{label:"Width",type:"number"},height:{label:"Height",type:"number"}},color:"#2196F3"},Video:{name:"Video",label:"Video",plural:"Videos",description:"A video file for investigation.",extends:["Document"],matchable:!1,generated:!1,featured:["title","filePath","duration","dateCaptured"],required:["title"],caption:["title","fileName"],properties:{filePath:{label:"File Path",description:"Path to the video file in the vault"},duration:{label:"Duration",type:"number"},location:{label:"Location",description:"Location where the video was captured"},dateCaptured:{label:"Date Captured",type:"date"},source:{label:"Source"}},color:"#9C27B0"},Audio:{name:"Audio",label:"Audio",plural:"Audio Files",description:"An audio file for investigation.",extends:["Document"],matchable:!1,generated:!1,featured:["title","filePath","duration","dateRecorded"],required:["title"],caption:["title","fileName"],properties:{filePath:{label:"File Path",description:"Path to the audio file in the vault"},duration:{label:"Duration",type:"number"},dateRecorded:{label:"Date Recorded",type:"date"},source:{label:"Source"},samplingRate:{label:"Sampling Rate",type:"number"}},color:"#009688"},Article:{name:"Article",label:"Article",plural:"Articles",description:"A news article or publication.",extends:["Document"],matchable:!1,featured:["title","date","author"],required:[],caption:["title"],properties:{author:{label:"Author"},publisher:{label:"Publisher"},publishedAt:{label:"Published at",type:"date"}},color:"#5E35B1"},Note:{name:"Note",label:"Note",plural:"Notes",description:"A note or annotation.",extends:["PlainText"],matchable:!1,featured:["title","date"],required:[],caption:["title"],properties:{},color:"#FDD835"},Post:{name:"Post",label:"Post",plural:"Posts",description:"A social media post or message.",extends:["Document"],matchable:!1,featured:["title","date"],required:[],caption:["title"],properties:{platform:{label:"Platform"},url:{label:"URL",type:"url"}},color:"#1E88E5"},Mention:{name:"Mention",label:"Mention",plural:"Mentions",description:"A mention of an entity in a document.",extends:["Interval"],matchable:!1,featured:["name"],required:[],caption:["name"],properties:{name:{label:"Name"},detectedLanguage:{label:"Detected language"}},color:"#43A047"},Assessment:{name:"Assessment",label:"Assessment",plural:"Assessments",description:"An assessment or evaluation.",extends:["Interval","Thing"],matchable:!1,featured:["name","date"],required:[],caption:["name"],properties:{type:{label:"Type"},status:{label:"Status"},result:{label:"Result"}},color:"#FB8C00"},TaxRoll:{name:"TaxRoll",label:"Tax Roll",plural:"Tax Rolls",description:"A tax roll or tax record.",extends:["Interval","Value"],matchable:!1,featured:["amount","date"],required:[],caption:["amount"],properties:{type:{label:"Type"},status:{label:"Status"}},color:"#7CB342"},Succession:{name:"Succession",label:"Succession",plural:"Successions",description:"A succession or inheritance relationship.",extends:["Interval"],matchable:!1,featured:["date"],required:[],caption:["date"],properties:{type:{label:"Type"}},color:"#8D6E63"},Similar:{name:"Similar",label:"Similar",plural:"Similarities",description:"A similarity relationship between entities.",extends:["Interval"],matchable:!1,featured:["score"],required:[],caption:["score"],properties:{score:{label:"Score",type:"number"}},color:"#78909C"},UnknownLink:{name:"UnknownLink",label:"Unknown Link",plural:"Unknown Links",description:"An unknown or unclassified relationship.",extends:["Interval"],matchable:!1,featured:["description"],required:[],caption:["description"],properties:{description:{label:"Description"}},color:"#90A4AE"},Table:{name:"Table",label:"Table",plural:"Tables",description:"A data table.",extends:["Document"],matchable:!1,generated:!0,featured:["title"],required:[],caption:["title","fileName"],properties:{},color:"#26A69A"},Workbook:{name:"Workbook",label:"Workbook",plural:"Workbooks",description:"A spreadsheet workbook.",extends:["Document"],matchable:!1,generated:!0,featured:["title"],required:[],caption:["title","fileName"],properties:{},color:"#66BB6A"},Package:{name:"Package",label:"Package",plural:"Packages",description:"A package or archive file.",extends:["Document"],matchable:!1,generated:!0,featured:["title"],required:[],caption:["title","fileName"],properties:{},color:"#8D6E63"},Page:{name:"Page",label:"Page",plural:"Pages",description:"A page in a document.",extends:["Document"],matchable:!1,generated:!0,featured:["title","index"],required:[],caption:["title","index"],properties:{index:{label:"Page number",type:"number"}},color:"#BDBDBD"},Pages:{name:"Pages",label:"Pages",plural:"Pages",description:"A collection of pages.",extends:["Document"],matchable:!1,generated:!0,featured:["title"],required:[],caption:["title","fileName"],properties:{},color:"#9E9E9E"},EconomicActivity:{name:"EconomicActivity",label:"Economic Activity",plural:"Economic Activities",description:"An economic activity or business sector.",extends:["Thing"],matchable:!1,featured:["name","code"],required:[],caption:["name","code"],properties:{code:{label:"Code",type:"identifier"},classification:{label:"Classification"}},color:"#558B2F"},CallForTenders:{name:"CallForTenders",label:"Call for Tenders",plural:"Calls for Tenders",description:"A call for tenders or procurement notice.",extends:["Asset"],matchable:!1,featured:["title","amount","date"],required:[],caption:["title"],properties:{title:{label:"Title"},deadline:{label:"Deadline",type:"date"},status:{label:"Status"}},color:"#0277BD"},ContractAward:{name:"ContractAward",label:"Contract Award",plural:"Contract Awards",description:"An award of a contract to a supplier.",extends:["Interval","Value"],matchable:!1,featured:["amount","date"],required:[],caption:["amount"],properties:{lotNumber:{label:"Lot number"}},color:"#00897B"},CourtCaseParty:{name:"CourtCaseParty",label:"Court Case Party",plural:"Court Case Parties",description:"A party to a court case.",extends:["Interval"],matchable:!1,featured:["role"],required:[],caption:["role"],properties:{role:{label:"Role"}},color:"#5D4037"},ProjectParticipant:{name:"ProjectParticipant",label:"Project Participant",plural:"Project Participants",description:"A participant in a project.",extends:["Interval"],matchable:!1,featured:["role"],required:[],caption:["role"],properties:{role:{label:"Role"}},color:"#0288D1"},Credentials:{name:"Credentials",label:"Credentials",plural:"Credentials",description:"Login credentials for a user account on a platform or service.",extends:["Thing"],matchable:!0,featured:["username","platform","dateFound"],required:["username"],caption:["username","platform"],properties:{username:{label:"Username",description:"The username or login identifier"},password:{label:"Password",description:"The password (stored securely)"},platform:{label:"Platform",description:"The platform or service (e.g., Gmail, Facebook)"},dateFound:{label:"Date Found",type:"date"},source:{label:"Source",description:"Where these credentials were found"},isValid:{label:"Is Valid",type:"boolean"}},color:"#FF9800"},PhoneNumber:{name:"PhoneNumber",label:"Phone Number",plural:"Phone Numbers",description:"A phone number associated with a person or organization.",extends:["Thing"],matchable:!0,featured:["number","carrier","country"],required:["number"],caption:["number","carrier"],properties:{number:{label:"Phone Number",type:"phone"},carrier:{label:"Carrier",description:"The phone carrier or provider"},country:{label:"Country",type:"country"},phoneType:{label:"Phone Type",description:"Type of phone (mobile, landline, VoIP)"},associatedPerson:{label:"Associated Person"},verificationStatus:{label:"Verification Status"}},color:"#4CAF50"},Evidence:{name:"Evidence",label:"Evidence",plural:"Evidence",description:"Evidence collected during an OSINT investigation.",extends:["Thing"],matchable:!1,featured:["title","source","dateCollected","relevance"],required:["title"],caption:["title","source"],properties:{title:{label:"Title"},source:{label:"Source",description:"Where this evidence was collected from"},dateCollected:{label:"Date Collected",type:"date"},relevance:{label:"Relevance",description:"How relevant this evidence is to the investigation"},attachmentPath:{label:"Attachment",description:"Path to an attached file in the vault"},tampered:{label:"Tampered",type:"boolean"},verifiedBy:{label:"Verified By"}},color:"#9E9E9E"}},Be={...Xe,...et},Ae=class{constructor(){this.resolvedSchemas=new Map;this.customSchemas=new Map;this.initialized=!1}initialize(){if(!this.initialized){for(let r of Object.keys(Be))this.resolveSchema(r);for(let r of this.customSchemas.keys())this.resolveSchema(r);this.initialized=!0}}registerSchema(r){let e=r.name;e&&(this.customSchemas.set(e,r),this.resolvedSchemas.delete(e),this.initialized&&this.resolveSchema(e))}resolveSchema(r){if(this.resolvedSchemas.has(r))return this.resolvedSchemas.get(r);let e=Be[r];if(!e){let l=this.customSchemas.get(r);l&&(e=l)}if(!e)return console.warn(`[FTMSchemaService] Schema not found: ${r}`),null;let t={};if(e.extends&&e.extends.length>0)for(let l of e.extends){let c=this.resolveSchema(l);c&&(t={...t,...c.allProperties})}e.properties&&(t={...t,...e.properties});let n=e.required||[],i=e.featured||[],o=[...new Set([...n,...i])],a=Object.keys(t).filter(l=>!o.includes(l)&&!t[l].hidden),s={name:r,label:e.label||r,plural:e.plural||r+"s",description:e.description||"",extends:e.extends||[],abstract:e.abstract,matchable:e.matchable,generated:e.generated,featured:i,required:n,caption:e.caption||[],properties:e.properties||{},allProperties:t,defaultProperties:o,optionalProperties:a,color:e.color};return this.resolvedSchemas.set(r,s),s}getSchema(r){return this.initialize(),this.resolvedSchemas.get(r)||null}getEntitySchemas(){return this.initialize(),Array.from(this.resolvedSchemas.values()).filter(r=>!r.abstract)}getIntervalSchemas(){return this.initialize(),Array.from(this.resolvedSchemas.values()).filter(r=>!r.abstract&&this.extendsInterval(r))}extendsInterval(r){if(r.name==="Interval")return!1;if(r.extends.includes("Interval"))return!0;for(let e of r.extends){let t=this.getSchema(e);if(t&&this.extendsInterval(t))return!0}return!1}getSchemaNames(){return this.initialize(),Array.from(this.resolvedSchemas.keys())}getEntitySchemaNames(){return this.getEntitySchemas().map(r=>r.name)}hasSchema(r){return this.initialize(),this.resolvedSchemas.has(r)}getLabelField(r){let e=this.getSchema(r);if(!e)return"name";for(let t of e.caption)if(e.allProperties[t])return t;return"name"}getColor(r){return this.getSchema(r)?.color||"#607D8B"}getProperty(r,e){let t=this.getSchema(r);return t&&t.allProperties[e]||null}getEntityLabel(r,e){let t=this.getLabelField(r);if(e[t])return String(e[t]);let n=["full_name","name","title","address","label"];for(let i of n)if(e[i]&&typeof e[i]=="string"&&e[i].trim())return String(e[i]);return r}},H=new Ae;var V=(p=>(p.Person="Person",p.Event="Event",p.Location="Location",p.Company="Company",p.Email="Email",p.Phone="Phone",p.Username="Username",p.Vehicle="Vehicle",p.Website="Website",p.Evidence="Evidence",p.Image="Image",p.Text="Text",p))(V||{});function U(k){let r=H.getSchema(k);return r?{color:r.color||"#607D8B",label:r.label,plural:r.plural,description:r.description,labelField:H.getLabelField(k),requiredProperties:r.required,featuredProperties:r.featured,optionalProperties:r.optionalProperties,propertyDefinitions:r.allProperties}:null}function De(){return H.getEntitySchemas().map(r=>({name:r.name,label:r.label,description:r.description,color:r.color||"#607D8B"})).sort((r,e)=>r.name==="LegalEntity"?-1:e.name==="LegalEntity"?1:r.label.localeCompare(e.label))}function $e(){return H.getIntervalSchemas().filter(r=>!["Associate","UnknownLink","Membership"].includes(r.name)).map(r=>({name:r.name,label:r.label,description:r.description,color:r.color||"#607D8B"})).sort((r,e)=>r.name==="UnknownLink"?-1:e.name==="UnknownLink"?1:r.label.localeCompare(e.label))}var _={Person:{color:"#4CAF50",properties:["full_name","age","height","nationality","occupation"],labelField:"full_name",description:"A person representing an individual"},Event:{color:"#F22416",properties:["name","description","start_date","end_date","add_to_timeline"],labelField:"name",description:"An event with date and time"},Location:{color:"#FF5722",properties:["name","address","city","state","country","postal_code","latitude","longitude","location_type"],labelField:"name",description:"A physical location or address"},Company:{color:"#037d9e",properties:["name","description"],labelField:"name",description:"A company or organization"},Email:{color:"#2196F3",properties:["address","domain"],labelField:"address",description:"An email address"},Phone:{color:"#b82549",properties:["number","phone_type","country_code"],labelField:"number",description:"A phone number"},Username:{color:"#21B57D",properties:["username","platform","link"],labelField:"username",description:"A username on a platform"},Vehicle:{color:"#6c5952",properties:["model","color","year","vin"],labelField:"model",description:"A vehicle"},Website:{color:"#9C27B0",properties:["url","domain","title","description","ip_address","status","technologies"],labelField:"title",description:"A website or web domain"},Evidence:{color:"#02bfd4",properties:["name","description","tampered"],labelField:"name",description:"Evidence in an investigation"},Image:{color:"#E9B96E",properties:["title","url","description"],labelField:"title",description:"An image"},Text:{color:"#D0BD1D",properties:["text"],labelField:"text",description:"A text note"}},Ve={Person:"\u{1F464}",Event:"\u{1F4C5}",Location:"\u{1F4CD}",Company:"\u{1F3E2}",Email:"\u{1F4E7}",Phone:"\u{1F4DE}",Username:"\u{1F465}",Vehicle:"\u{1F697}",Website:"\u{1F310}",Evidence:"\u{1F4CB}",Image:"\u{1F5BC}\uFE0F",Text:"\u{1F4DD}",LegalEntity:"\u2696\uFE0F",Organization:"\u{1F3DB}\uFE0F",BankAccount:"\u{1F3E6}",CryptoWallet:"\u20BF",UserAccount:"\u{1F465}",Document:"\u{1F4C4}",RealEstate:"\u{1F3E0}",Sanction:"\u26D4",Passport:"\u{1F6C2}",Ownership:"\u{1F517}",Employment:"\u{1F4BC}",Directorship:"\u{1F454}",Credentials:"\u{1F511}",PhoneNumber:"\u{1F4F1}",Photo:"\u{1F4F7}",IP:"\u{1F310}",Malware:"\u{1F9A0}",Group:"\u{1F465}",Domain:"\u{1F517}",Airplane:"\u2708\uFE0F",Asset:"\u{1F48E}",Audio:"\u{1F3B5}",Call:"\u{1F4DE}",Contract:"\u{1F4DC}",CourtCase:"\u2696\uFE0F",Family:"\u{1F468}\u200D\u{1F469}\u200D\u{1F467}\u200D\u{1F466}",Folder:"\u{1F4C1}",Identification:"\u{1FAAA}",Land:"\u{1F5FA}\uFE0F",License:"\u{1F4DC}",Meeting:"\u{1F91D}",Message:"\u{1F4AC}",Page:"\u{1F4C3}",Payment:"\u{1F4B3}",PlainText:"\u{1F4DD}",PublicBody:"\u{1F3DB}\uFE0F",Representation:"\u{1F3AD}",Succession:"\u{1F451}",TaxRoll:"\u{1F4B0}",Vessel:"\u{1F6A2}",Video:"\u{1F3AC}",Workbook:"\u{1F4CA}"},de=["notes","source","image"];function te(k,r){if(H.hasSchema(k))return H.getEntityLabel(k,r);let e=_[k];if(e&&r[e.labelField])return String(r[e.labelField]);let t=["full_name","name","address","title","label","username","number"];for(let n of t)if(r[n]&&typeof r[n]=="string"&&r[n].trim())return String(r[n]);return k}function J(k){if(Ve[k])return Ve[k];if(H.hasSchema(k)){let r=H.getSchema(k)}return"\u{1F4E6}"}var Ue=new Set(["Person","Event","Location","Company","Email","Phone","Username","Vehicle","Website","Evidence","Image","Text","LegalEntity","Organization","BankAccount","CryptoWallet","UserAccount","Document","RealEstate","Sanction","Passport","Ownership","Employment","Directorship","IP","Malware","Group","Domain","Airplane","Asset","Audio","Call","Contract","CourtCase","Family","Folder","Identification","Land","License","Meeting","Message","Page","Payment","PlainText","PublicBody","Representation","Succession","TaxRoll","Vessel","Video","Workbook","person","people","event","events","location","locations","company","companies","organization","organizations","email","emails","phone","phones","vehicle","vehicles","website","websites","document","documents","Entity","entity","Item","item","Object","object","Thing","thing","Unknown","unknown","Unnamed","unnamed","New","new","Untitled","untitled","Default","default"]);function ne(k,r){let e=k?.trim();if(!e)return{isValid:!1,error:"Entity name cannot be empty"};if(e.length<2)return{isValid:!1,error:"Entity name must be at least 2 characters long"};if(Ue.has(e))return{isValid:!1,error:`"${e}" is a generic type name. Please provide a specific, unique identifier (e.g., "John Smith" instead of "Person", "Acme Corp" instead of "Company")`};let t=e.toLowerCase();for(let n of Ue)if(t===n.toLowerCase())return{isValid:!1,error:`"${e}" is too generic. Please provide a specific, unique identifier`};return r&&new RegExp(`^${r}\\s*\\d*$`,"i").test(e)?{isValid:!1,error:`Please provide a specific name instead of "${e}"`}:{isValid:!0}}function ae(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(k){let r=Math.random()*16|0;return(k==="x"?r:r&3|8).toString(16)})}function pe(k){return k.replace(/[\\/:*?"<>|]/g,"-").replace(/\s+/g," ").trim().substring(0,100)}var $=require("obsidian");var qe=require("obsidian");var R=class extends Error{constructor(e,t){super(t);this.type=e;this.name="GeocodingError"}},G=class G{constructor(){this.lastRequestTime=0}async geocodeAddressWithRetry(r,e,t,n,i){let o=null;for(let a=0;a<G.MAX_RETRIES;a++)try{return await this.geocodeAddressWithFallback(r,e,t,n)}catch(s){if(s instanceof R?o=s:o=new R("UNKNOWN",s instanceof Error?s.message:String(s)),o.type==="INVALID_INPUT"||o.type==="NOT_FOUND"&&a>0)throw o;if(a===G.MAX_RETRIES-1)break;let l=G.INITIAL_RETRY_DELAY*Math.pow(2,a),c=Math.round(l/1e3);console.debug(`[GeocodingService] Retry attempt ${a+1}/${G.MAX_RETRIES} after ${c}s`),i&&i(a+1,G.MAX_RETRIES,c),await new Promise(d=>setTimeout(d,l))}throw new R("NETWORK_ERROR",`Failed to geocode after ${G.MAX_RETRIES} attempts. Please check your internet connection.`)}async geocodeAddressWithFallback(r,e,t,n){let i=[];if(r&&e&&n){i.push({components:[r,e,t,n].filter(l=>!!l),description:"full address"});let a=r.replace(/,?\s*nr\.?\s*\d+[\/\d]*/gi,"").trim();a!==r&&i.push({components:[a,e,t,n].filter(l=>!!l),description:"address without building number"});let s=r.replace(/^str\.?\s*/i,"").replace(/,?\s*nr\.?\s*\d+[\/\d]*/gi,"").trim();s!==r&&i.push({components:[s,e,t,n].filter(l=>!!l),description:"street name and city"})}e&&n&&i.push({components:[e,t,n].filter(a=>!!a),description:"city and country"}),e&&i.push({components:[e],description:"city only"}),i.length===0&&i.push({components:[r,e,t,n].filter(a=>!!a),description:"original query"});let o=null;for(let a of i)try{console.debug(`[GeocodingService] Trying ${a.description}: ${a.components.join(", ")}`);let s=await this.geocodeAddress(a.components[0],a.components[1],a.components[2],a.components[3]);return a.description!=="full address"&&a.description!=="original query"&&console.debug(`[GeocodingService] \u2713 Geocoded using ${a.description} fallback`),s}catch(s){if(s instanceof R){if(o=s,s.type==="NETWORK_ERROR"||s.type==="RATE_LIMITED")throw s;console.debug(`[GeocodingService] ${a.description} not found, trying next fallback...`)}else throw s}throw o||new R("NOT_FOUND","Address not found. Please check the address or enter coordinates manually.")}async geocodeAddress(r,e,t,n){let i=[r,e,t,n].filter(Boolean);if(i.length===0)throw new R("INVALID_INPUT","Please provide at least an address, city, or country");await this.enforceRateLimit();let o=i.join(", ");console.debug("[GeocodingService] Geocoding address:",o);try{let a=`${G.NOMINATIM_URL}?`+new URLSearchParams({q:o,format:"json",limit:"1",addressdetails:"1"}).toString(),s=await(0,qe.requestUrl)({url:a,method:"GET",headers:{"User-Agent":G.USER_AGENT,Accept:"application/json"},throw:!1});if(this.lastRequestTime=Date.now(),s.status===429)throw new R("RATE_LIMITED","Too many requests. Please wait a moment and try again.");if(s.status!==200)throw new R("NETWORK_ERROR",`Geocoding request failed with status ${s.status}`);let l=s.json;if(!l||l.length===0)throw new R("NOT_FOUND","Address not found. Please check the address or enter coordinates manually.");let c=l[0];console.debug("[GeocodingService] Geocoding result:",c);let d="medium";c.importance>.7?d="high":c.importance<.3&&(d="low");let p=c.address?.city||c.address?.town||c.address?.village||c.address?.municipality;return{latitude:parseFloat(c.lat),longitude:parseFloat(c.lon),displayName:c.display_name,city:p,state:c.address?.state,country:c.address?.country,postalCode:c.address?.postcode,confidence:d}}catch(a){throw a instanceof R?a:(console.error("[GeocodingService] Geocoding error:",a),new R("NETWORK_ERROR","Failed to connect to geocoding service. Please check your internet connection."))}}async enforceRateLimit(){let e=Date.now()-this.lastRequestTime;if(e<G.MIN_REQUEST_INTERVAL){let t=G.MIN_REQUEST_INTERVAL-e;console.debug(`[GeocodingService] Rate limiting: waiting ${t}ms`),await new Promise(n=>setTimeout(n,t))}}static validateCoordinates(r,e){return r>=-90&&r<=90&&e>=-180&&e<=180}static formatCoordinates(r,e,t=6){return`${r.toFixed(t)}, ${e.toFixed(t)}`}};G.NOMINATIM_URL="https://nominatim.openstreetmap.org/search",G.USER_AGENT="OSINTCopilot-Obsidian-Plugin/1.0 (https://github.com/Probe-Point-Analytics-LLC/OSINT-Copilot-plugin)",G.REQUEST_TIMEOUT=1e4,G.MIN_REQUEST_INTERVAL=1100,G.MAX_RETRIES=5,G.INITIAL_RETRY_DELAY=1e3;var q=G,Le=new q;var ge=class{constructor(r,e="OSINTCopilot"){this.entities=new Map;this.connections=new Map;this.app=r,this.basePath=e}setBasePath(r){this.basePath=r}async initialize(){await this.ensureFolderExists(this.basePath);for(let r of Object.values(V))await this.ensureFolderExists(`${this.basePath}/${r}`);await this.ensureFolderExists(`${this.basePath}/Connections`),await this.loadEntitiesFromNotes()}async ensureFolderExists(r){let e=(0,$.normalizePath)(r);if(!this.app.vault.getAbstractFileByPath(e))try{await this.app.vault.createFolder(e)}catch(n){if(n instanceof Error&&!n.message.includes("Folder already exists"))throw console.error(`Failed to create folder ${e}:`,n),n}}async loadEntitiesFromNotes(){this.entities.clear(),this.connections.clear();for(let r of Object.values(V)){let e=(0,$.normalizePath)(`${this.basePath}/${r}`),t=this.app.vault.getAbstractFileByPath(e);if(t instanceof $.TFolder){for(let n of t.children)if(n instanceof $.TFile&&n.extension==="md"){let i=await this.parseEntityFromNote(n);i&&this.entities.set(i.id,i)}}}await this.loadConnectionsFromNotes(),await this.parseConnectionsFromNotes()}async parseEntityFromNote(r){try{let e=await this.app.vault.read(r),t=this.parseFrontmatter(e);if(!t||!t.type||!t.id)return null;let n=t.type;if(!Object.values(V).includes(n))return null;let i={},a=[..._[n].properties,...de];for(let s of a)t[s]!==void 0&&(i[s]=t[s]);return{id:t.id,type:n,label:t.label||te(n,i),properties:i,filePath:r.path}}catch(e){return console.error(`Error parsing entity from ${r.path}:`,e),null}}parseFrontmatter(r){let e=r.match(/^---\n([\s\S]*?)\n---/);if(!e)return null;let t=e[1],n={},i=t.split(`
`);for(let o of i){let a=o.indexOf(":");if(a>0){let s=o.substring(0,a).trim(),l=o.substring(a+1).trim();(l.startsWith('"')&&l.endsWith('"')||l.startsWith("'")&&l.endsWith("'"))&&(l=l.slice(1,-1)),l==="true"?n[s]=!0:l==="false"?n[s]=!1:!isNaN(Number(l))&&l!==""?n[s]=Number(l):n[s]=l}}return n}async loadConnectionsFromNotes(){let r=(0,$.normalizePath)(`${this.basePath}/Connections`),e=this.app.vault.getAbstractFileByPath(r);if(e instanceof $.TFolder){for(let t of e.children)if(t instanceof $.TFile&&t.extension==="md"){let n=await this.parseConnectionFromNote(t);n&&this.connections.set(n.id,n)}}}async parseConnectionFromNote(r){try{let e=await this.app.vault.read(r),t=this.parseFrontmatter(e);if(!t||t.type!=="connection"||!t.id)return null;let n={},i=["id","type","relationship","fromEntityId","toEntityId","fromEntity","toEntity","ftmSchema","label"];for(let[o,a]of Object.entries(t))!i.includes(o)&&a!==void 0&&a!==null&&(n[o]=a);return{id:t.id,fromEntityId:t.fromEntityId,toEntityId:t.toEntityId,relationship:t.relationship,label:t.label,properties:Object.keys(n).length>0?n:void 0,ftmSchema:t.ftmSchema,filePath:r.path}}catch(e){return console.error(`Error parsing connection from ${r.path}:`,e),null}}async parseConnectionsFromNotes(){for(let r of this.entities.values()){if(!r.filePath)continue;let e=this.app.vault.getAbstractFileByPath(r.filePath);if(!(e instanceof $.TFile))continue;let t=await this.app.vault.read(e),n=this.parseRelationshipsFromContent(t,r.id);for(let i of n)this.connections.set(i.id,i)}}parseRelationshipsFromContent(r,e){let t=[],n=/\[\[([^\]]+)\]\]\s+([A-Z_]+)\s+\[\[([^\]]+)\]\]/g,i=/-\s+\[\[([^\]]+)\]\]\s+([A-Z_]+)/g,o;for(;(o=n.exec(r))!==null;){let a=o[3],s=o[2],l=this.findEntityByLabel(a);l&&t.push({id:ae(),fromEntityId:e,toEntityId:l.id,relationship:s})}for(;(o=i.exec(r))!==null;){let a=o[1],s=o[2],l=this.findEntityByLabel(a);l&&l.id!==e&&t.push({id:ae(),fromEntityId:e,toEntityId:l.id,relationship:s})}return t}findEntityByLabel(r){if(!r||typeof r!="string")return;let e=r.toLowerCase();for(let t of this.entities.values())if((t.label!=null?String(t.label):"").toLowerCase()===e)return t}async createEntity(r,e,t){let n=ae();r==="Location"&&!t?.skipAutoGeocode&&(e=await this.geocodeLocationIfNeeded(e));let i=te(r,e),o={id:n,type:r,label:i,properties:e},a=await this.saveEntityAsNote(o);return o.filePath=a,this.entities.set(n,o),o}async createFTMEntity(r,e,t){let n=ae();if(!U(r))throw new Error(`Unknown FTM schema: ${r}`);r==="Address"&&!t?.skipAutoGeocode&&(e=await this.geocodeAddressIfNeeded(e));let o=H.getEntityLabel(r,e),a={id:n,type:r,label:o,properties:e,ftmSchema:r},s=await this.saveFTMEntityAsNote(a,r);return a.filePath=s,this.entities.set(n,a),a}async geocodeAddressIfNeeded(r){let e=r.latitude!==void 0&&r.latitude!==null&&r.latitude!=="",t=r.longitude!==void 0&&r.longitude!==null&&r.longitude!=="";if(e&&t)return r;let n=r.full||r.street,i=r.city,o=r.state||r.region,a=r.country;if(!n&&!i&&!o&&!a)return r;try{let s=await Le.geocodeAddressWithRetry(n,i,o,a);return{...r,latitude:s.latitude,longitude:s.longitude,city:r.city||s.city,state:r.state||s.state,country:r.country||s.country,postalCode:r.postalCode||s.postalCode}}catch(s){return console.warn("[EntityManager] FTM Address geocoding failed:",s),r}}async saveFTMEntityAsNote(r,e){let t=pe(r.label),n=(0,$.normalizePath)(`${this.basePath}/${e}`);await this.ensureFolderExists(n);let i=(0,$.normalizePath)(`${n}/${t}.md`),a=`---
${this.buildFTMFrontmatter(r,e)}
---

# ${r.label}

## Properties

${this.buildFTMPropertiesSection(r,e)}

## Relationships

<!-- Add relationships using wikilinks: [[Entity Name]] RELATIONSHIP_TYPE [[Target Entity]] -->

## Notes

${r.properties.notes||""}
`,s=this.app.vault.getAbstractFileByPath(i);return s instanceof $.TFile?await this.app.vault.modify(s,a):await this.app.vault.create(i,a),i}buildFTMFrontmatter(r,e){let t=[`id: "${r.id}"`,`type: ${r.type}`,`ftmSchema: ${e}`,`label: "${r.label}"`];if(!U(e))return t.join(`
`);for(let[i,o]of Object.entries(r.properties))o!=null&&o!==""&&(typeof o=="string"?t.push(`${i}: "${o.replace(/"/g,'\\"')}"`):typeof o=="boolean"?t.push(`${i}: ${o}`):t.push(`${i}: ${String(o)}`));return t.join(`
`)}buildFTMPropertiesSection(r,e){let t=[],n=U(e);if(!n)return"_No properties set_";let i=[...n.requiredProperties,...n.featuredProperties],o=new Set;for(let a of i){if(o.has(a))continue;o.add(a);let s=r.properties[a],c=n.propertyDefinitions[a]?.label||a;s!=null&&s!==""&&t.push(`- **${c}**: ${String(s)}`)}for(let[a,s]of Object.entries(r.properties)){if(o.has(a)||s==null||s===""||a==="notes")continue;let c=n.propertyDefinitions[a]?.label||a;t.push(`- **${c}**: ${String(s)}`)}return t.length>0?t.join(`
`):"_No properties set_"}async geocodeLocationIfNeeded(r){let e=r.latitude!==void 0&&r.latitude!==null&&r.latitude!=="",t=r.longitude!==void 0&&r.longitude!==null&&r.longitude!=="";if(e&&t)return console.debug("[EntityManager] Location already has coordinates:",r.latitude,r.longitude),r;let n=r.address,i=r.city,o=r.state,a=r.country;if(!n&&!i&&!o&&!a)return console.debug("[EntityManager] No address fields available for geocoding"),r;try{console.debug("[EntityManager] Attempting to geocode location:",{address:n,city:i,state:o,country:a});let s=await Le.geocodeAddressWithRetry(n,i,o,a),l={...r,latitude:s.latitude,longitude:s.longitude};return!i&&s.city&&(l.city=s.city),!o&&s.state&&(l.state=s.state),!a&&s.country&&(l.country=s.country),!r.postal_code&&s.postalCode&&(l.postal_code=s.postalCode),console.debug("[EntityManager] Geocoding successful:",s.latitude,s.longitude,`(${s.confidence} confidence)`),new $.Notice(`\u{1F4CD} Location geocoded: ${s.displayName.substring(0,50)}...`),l}catch(s){return s instanceof R?(console.warn("[EntityManager] Geocoding failed:",s.type,s.message),s.type==="NOT_FOUND"?new $.Notice("\u26A0\uFE0F could not find coordinates for location. You can add them manually."):s.type==="RATE_LIMITED"?new $.Notice("\u26A0\uFE0F geocoding rate limited. Coordinates can be added manually."):new $.Notice(`\u26A0\uFE0F Geocoding failed: ${s.message}`)):(console.error("[EntityManager] Unexpected geocoding error:",s),new $.Notice("\u26A0\uFE0F could not geocode location. You can add coordinates manually.")),r}}async retryGeocoding(r){let e=this.entities.get(r);if(!e)return console.warn("[EntityManager] Entity not found for geocoding retry:",r),!1;if(e.type!=="Location")return console.warn("[EntityManager] Cannot geocode non-Location entity:",e.type),!1;if(e.properties.latitude&&e.properties.longitude)return console.debug("[EntityManager] Entity already has coordinates"),new $.Notice("\u{1F4CD} location already has coordinates."),!0;try{let n=await this.geocodeLocationIfNeeded(e.properties);return n.latitude&&n.longitude?(e.properties=n,await this.saveEntityAsNote(e),console.debug("[EntityManager] Geocoding retry successful for:",e.label),!0):(console.debug("[EntityManager] Geocoding retry did not find coordinates"),!1)}catch(n){return console.error("[EntityManager] Geocoding retry failed:",n),!1}}getUnlocatedEntities(){return Array.from(this.entities.values()).filter(r=>{if(r.type!=="Location")return!1;let e=r.properties.latitude!==void 0&&r.properties.latitude!==null&&r.properties.latitude!=="",t=r.properties.longitude!==void 0&&r.properties.longitude!==null&&r.properties.longitude!=="";return!e||!t})}async geocodeAllUnlocated(){let r=this.getUnlocatedEntities(),e=0,t=0;new $.Notice(`\u{1F30D} Geocoding ${r.length} locations...`);for(let n of r)await this.retryGeocoding(n.id)?e++:t++;return new $.Notice(`\u{1F4CD} Geocoding complete: ${e} succeeded, ${t} failed`),{success:e,failed:t}}async saveEntityAsNote(r){let e=pe(`${r.label}_${r.id.substring(0,8)}`),t=(0,$.normalizePath)(`${this.basePath}/${r.type}`);await this.ensureFolderExists(t);let n=(0,$.normalizePath)(`${t}/${e}.md`),o=`---
${this.buildFrontmatter(r)}
---

# ${r.label}

## Properties

${this.buildPropertiesSection(r)}

## Relationships

<!-- Add relationships using wikilinks: [[Entity Name]] RELATIONSHIP_TYPE [[Target Entity]] -->

## Notes

${r.properties.notes||""}
`,a=this.app.vault.getAbstractFileByPath(n);return a instanceof $.TFile?await this.app.vault.modify(a,o):await this.app.vault.create(n,o),n}buildFrontmatter(r){let e=[`id: "${r.id}"`,`type: ${r.type}`,`label: "${r.label}"`],t=_[r.type];if(t){let n=[...t.properties,...de];for(let i of n){let o=r.properties[i];o!=null&&o!==""&&(typeof o=="string"?e.push(`${i}: "${o.replace(/"/g,'\\"')}"`):typeof o=="boolean"?e.push(`${i}: ${o}`):e.push(`${i}: ${String(o)}`))}}else for(let[n,i]of Object.entries(r.properties))i!=null&&i!==""&&(typeof i=="string"?e.push(`${n}: "${i.replace(/"/g,'\\"')}"`):typeof i=="boolean"?e.push(`${n}: ${i}`):e.push(`${n}: ${String(i)}`));return e.join(`
`)}buildPropertiesSection(r){let e=[],t=_[r.type];if(t)for(let n of t.properties){let i=r.properties[n];i!=null&&i!==""&&e.push(`- **${n}**: ${i}`)}else for(let[n,i]of Object.entries(r.properties))i!=null&&i!==""&&e.push(`- **${n}**: ${i}`);return e.length>0?e.join(`
`):"_No properties set_"}async updateEntity(r,e){let t=this.entities.get(r);return t?(t.properties={...t.properties,...e},t.ftmSchema?t.label=H.getEntityLabel(t.ftmSchema,t.properties):t.label=te(t.type,t.properties),t.ftmSchema?await this.saveFTMEntityAsNote(t,t.ftmSchema):await this.saveEntityAsNote(t),t):null}async deleteEntity(r){let e=this.entities.get(r);if(!e)return!1;if(e.filePath){let t=this.app.vault.getAbstractFileByPath(e.filePath);t instanceof $.TFile&&await this.app.fileManager.trashFile(t)}this.entities.delete(r);for(let[t,n]of this.connections)(n.fromEntityId===r||n.toEntityId===r)&&this.connections.delete(t);return!0}deleteEntityInMemory(r){if(!this.entities.get(r))return!1;this.entities.delete(r);for(let[t,n]of this.connections)(n.fromEntityId===r||n.toEntityId===r)&&this.connections.delete(t);return!0}async restoreEntity(r){try{let e=`${this.basePath}/${r.type}`;await this.ensureFolderExists(e);let t=this.generateNoteContent(r),n=r.filePath||`${e}/${pe(r.label)}.md`,i=this.app.vault.getAbstractFileByPath(n);i?i instanceof $.TFile&&await this.app.vault.modify(i,t):await this.app.vault.create(n,t);let o={...r,filePath:n};return this.entities.set(r.id,o),!0}catch(e){return console.error("[EntityManager] Failed to restore entity:",e),!1}}async updateEntityForHistory(r){try{if(this.entities.set(r.id,r),r.filePath){let e=this.app.vault.getAbstractFileByPath(r.filePath);if(e instanceof $.TFile){let t=this.generateNoteContent(r);await this.app.vault.modify(e,t)}}return!0}catch(e){return console.error("[EntityManager] Failed to update entity:",e),!1}}generateNoteContent(r){let e=[],t=new Date().toISOString();e.push("---"),e.push(`id: ${r.id}`),e.push(`type: ${r.type}`),e.push(`label: "${r.label.replace(/"/g,'\\"')}"`),e.push(`created: ${t}`),e.push(`modified: ${t}`);for(let[n,i]of Object.entries(r.properties))if(i!=null&&i!==""){let o=typeof i=="string"?`"${i.replace(/"/g,'\\"')}"`:i;e.push(`${n}: ${o}`)}if(e.push("---"),e.push(""),e.push(`# ${r.label}`),e.push(""),e.push(`**Type:** ${r.type}`),e.push(""),Object.keys(r.properties).length>0){e.push("## Properties"),e.push("");for(let[n,i]of Object.entries(r.properties))i!=null&&i!==""&&e.push(`- **${n}:** ${i}`);e.push("")}return e.push("## Relationships"),e.push(""),e.join(`
`)}async deleteEntities(r){let e=0,t=[],n=new Set;for(let i of r)try{let o=this.entities.get(i);if(!o){t.push(i);continue}if(o.filePath){let a=this.app.vault.getAbstractFileByPath(o.filePath);a instanceof $.TFile&&await this.app.fileManager.trashFile(a)}this.entities.delete(i);for(let[a,s]of this.connections)(s.fromEntityId===i||s.toEntityId===i)&&n.add(a);e++}catch(o){console.error(`[EntityManager] Failed to delete entity ${i}:`,o),t.push(i)}for(let i of n)this.connections.delete(i);return{deleted:e,failed:t}}async createConnection(r,e,t,n){let i=this.entities.get(r),o=this.entities.get(e);if(!i||!o)return null;let a=ae(),s=`${i.label} \u2192 ${t} \u2192 ${o.label}`,l={id:a,fromEntityId:r,toEntityId:e,relationship:t,label:s,properties:n||{},ftmSchema:t},c=await this.saveConnectionAsNote(l,i,o);return l.filePath=c,this.connections.set(l.id,l),await this.addRelationshipToNote(i,o,t),l}async updateConnection(r,e){let t=this.connections.get(r);if(!t)return null;let n=this.entities.get(t.fromEntityId),i=this.entities.get(t.toEntityId);if(!n||!i)return null;if(t.properties={...t.properties,...e},t.filePath){let o=this.app.vault.getAbstractFileByPath(t.filePath);if(o instanceof $.TFile){let a=this.generateConnectionNoteContent(t,n,i);await this.app.vault.modify(o,a)}}else{let o=await this.saveConnectionAsNote(t,n,i);t.filePath=o}return t}async updateConnectionForHistory(r){try{this.connections.set(r.id,r);let e=this.entities.get(r.fromEntityId),t=this.entities.get(r.toEntityId);if(!e||!t)return console.error("[EntityManager] Cannot update connection: entities not found"),!1;if(r.filePath){let n=this.app.vault.getAbstractFileByPath(r.filePath);if(n instanceof $.TFile){let i=this.generateConnectionNoteContent(r,e,t);await this.app.vault.modify(n,i)}}return!0}catch(e){return console.error("[EntityManager] Failed to update connection:",e),!1}}generateConnectionNoteContent(r,e,t){return`---
${this.buildConnectionFrontmatter(r,e,t)}
---

# ${r.label||r.relationship}

## Connection Details

- **From**: [[${e.label}]]
- **To**: [[${t.label}]]
- **Type**: ${r.relationship}

## Properties

${this.buildConnectionPropertiesSection(r)}

## Notes

<!-- Add additional notes about this connection here -->
`}async addRelationshipToNote(r,e,t){if(!r.filePath)return;let n=this.app.vault.getAbstractFileByPath(r.filePath);if(!(n instanceof $.TFile))return;let i=await this.app.vault.read(n),o=`- [[${r.label}]] ${t.toUpperCase()} [[${e.label}]]`,a=i.match(/(## Relationships\n)([\s\S]*?)((?=\n## )|$)/);if(a){let s=i.substring(0,a.index+a[1].length),l=a[2],c=i.substring(a.index+a[0].length);if(!l.includes(o)){let d=s+l.trimEnd()+`
`+o+`
`+c;await this.app.vault.modify(n,d)}}}async addIncomingRelationshipToNote(r,e,t){if(!r.filePath)return;let n=this.app.vault.getAbstractFileByPath(r.filePath);if(!(n instanceof $.TFile))return;let i=await this.app.vault.read(n),o=`- [[${e.label}]] ${t.toUpperCase()} [[${r.label}]]`,a=i.match(/(## Relationships\n)([\s\S]*?)((?=\n## )|$)/);if(a){let s=i.substring(0,a.index+a[1].length),l=a[2],c=i.substring(a.index+a[0].length);if(!l.includes(o)){let d=s+l.trimEnd()+`
`+o+`
`+c;await this.app.vault.modify(n,d)}}}async saveConnectionAsNote(r,e,t){let n=pe(`${e.label} - ${r.relationship} - ${t.label}`),i=(0,$.normalizePath)(`${this.basePath}/Connections`),o=(0,$.normalizePath)(`${i}/${n}.md`);await this.ensureFolderExists(i);let s=`---
${this.buildConnectionFrontmatter(r,e,t)}
---

# ${r.label||r.relationship}

## Connection Details

- **From**: [[${e.label}]]
- **To**: [[${t.label}]]
- **Type**: ${r.relationship}

## Properties

${this.buildConnectionPropertiesSection(r)}

## Notes

<!-- Add additional notes about this connection here -->
`,l=this.app.vault.getAbstractFileByPath(o);return l instanceof $.TFile?await this.app.vault.modify(l,s):await this.app.vault.create(o,s),o}buildConnectionFrontmatter(r,e,t){let n=[`id: "${r.id}"`,"type: connection",`relationship: "${r.relationship}"`,`fromEntityId: "${r.fromEntityId}"`,`toEntityId: "${r.toEntityId}"`,`fromEntity: "[[${e.label}]]"`,`toEntity: "[[${t.label}]]"`];if(r.ftmSchema&&n.push(`ftmSchema: "${r.ftmSchema}"`),r.label&&n.push(`label: "${r.label.replace(/"/g,'\\"')}"`),r.properties)for(let[i,o]of Object.entries(r.properties))o!=null&&o!==""&&(typeof o=="string"?n.push(`${i}: "${o.replace(/"/g,'\\"')}"`):typeof o=="boolean"?n.push(`${i}: ${o}`):n.push(`${i}: ${o}`));return n.join(`
`)}buildConnectionPropertiesSection(r){if(!r.properties||Object.keys(r.properties).length===0)return"_No additional properties_";let e=[];for(let[t,n]of Object.entries(r.properties))if(n!=null&&n!==""){let i=t.replace(/([A-Z])/g," $1").replace(/^./,o=>o.toUpperCase());e.push(`- **${i}**: ${n}`)}return e.length>0?e.join(`
`):"_No additional properties_"}getConnection(r){return this.connections.get(r)}async deleteConnectionWithNote(r){let e=this.connections.get(r);if(!e)return!1;let t=this.entities.get(e.fromEntityId);if(t&&t.filePath){let n=this.app.vault.getAbstractFileByPath(t.filePath);if(n instanceof $.TFile)try{let i=await this.app.vault.read(n),o=this.entities.get(e.toEntityId);if(o){let a=`- [[${o.label}]] (${e.relationship})`,s=`- [[${o.filePath?.replace(".md","")}]] (${e.relationship})`;i=i.replace(new RegExp(`^${this.escapeRegex(a)}\\n?`,"gm"),""),i=i.replace(new RegExp(`^${this.escapeRegex(s)}\\n?`,"gm"),""),await this.app.vault.modify(n,i)}}catch(i){console.error("[EntityManager] Failed to update note for connection deletion:",i)}}return this.connections.delete(r)}escapeRegex(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}deleteConnection(r){return this.connections.delete(r)}async restoreConnection(r){this.connections.set(r.id,r);let e=this.entities.get(r.fromEntityId),t=this.entities.get(r.toEntityId);return e&&t&&await this.addRelationshipToNote(e,t,r.relationship),!0}getAllEntities(){return Array.from(this.entities.values())}getEntitiesByType(r){let e=Array.from(this.entities.values()).filter(t=>t.type===r);return console.debug(`[EntityManager] getEntitiesByType(${r}): found ${e.length} entities`),r==="Location"&&e.forEach(t=>{console.debug(`[EntityManager] Location entity: ${t.label}, lat: ${t.properties.latitude}, lng: ${t.properties.longitude}`)}),e}getEntity(r){return this.entities.get(r)}getAllConnections(){return Array.from(this.connections.values())}getConnectionsForEntity(r){return Array.from(this.connections.values()).filter(e=>e.fromEntityId===r||e.toEntityId===r)}getGraphData(){return{entities:this.getAllEntities(),connections:this.getAllConnections()}}async openEntityNote(r){let e=this.entities.get(r);if(!e||!e.filePath)return;let t=this.app.vault.getAbstractFileByPath(e.filePath);t instanceof $.TFile&&await this.app.workspace.getLeaf().openFile(t)}};var Q=require("obsidian");var nt={maxRetries:3,baseDelayMs:1e3,maxDelayMs:1e4,baseTimeoutMs:9e4,maxTimeoutMs:9e4,timeoutMultiplierOnTimeout:1},me=class{constructor(r="https://api.osint-copilot.com",e=""){this.isOnline=!1;this.settings=null;this.baseUrl=r,this.apiKey=e,this.retryConfig={...nt}}setSettings(r){this.settings=r}setRetryConfig(r){this.retryConfig={...this.retryConfig,...r}}getRetryConfig(){return{...this.retryConfig}}setBaseUrl(r){this.baseUrl=r}setApiKey(r){this.apiKey=r}getHeaders(){let r={"Content-Type":"application/json"};return this.apiKey&&(r.Authorization=`Bearer ${this.apiKey}`),r}async checkHealth(){if(this.settings?.apiProvider==="openai")try{let r=await(0,Q.requestUrl)({url:this.settings.customApiUrl.replace(/\/v1\/?$/,"")+"/v1/models",method:"GET",headers:this.settings.customApiKey?{Authorization:`Bearer ${this.settings.customApiKey}`}:{},throw:!1});return r.status>=200&&r.status<300?(this.isOnline=!0,{status:"ok",openai_configured:!0,version:"custom"}):(this.isOnline=!0,{status:"ok",openai_configured:!0})}catch(r){return console.debug("[GraphApiService] Custom API unavailable:",r),this.isOnline=!1,null}try{let r=await(0,Q.requestUrl)({url:`${this.baseUrl}/health`,method:"GET",headers:this.getHeaders(),throw:!1});if(r.status>=200&&r.status<300)return this.isOnline=!0,r.json;let e=await(0,Q.requestUrl)({url:`${this.baseUrl}/`,method:"GET",headers:this.getHeaders(),throw:!1});return e.status>=200&&e.status<300?(this.isOnline=!0,e.json):(this.isOnline=!1,null)}catch{return this.isOnline=!1,console.debug("[GraphApiService] AI API unavailable - graph generation from text will not work"),null}}getOnlineStatus(){return this.isOnline}createResponseWrapper(r){return{ok:r.status>=200&&r.status<300,status:r.status,text:async()=>r.text,json:async()=>r.json}}async fetchWithTimeout(r,e,t=3e4,n){if(n?.aborted)throw new DOMException("Aborted","AbortError");let i=new Promise((s,l)=>{let c=setTimeout(()=>{let d=new DOMException("Request timed out","AbortError");l(d)},t);n&&n.addEventListener("abort",()=>{clearTimeout(c),l(new DOMException("Aborted","AbortError"))})}),o=(0,Q.requestUrl)({url:r,method:e.method||"GET",headers:e.headers,body:e.body,throw:!1}),a=await Promise.race([o,i]);return this.createResponseWrapper(a)}isTimeoutError(r){if(r instanceof DOMException&&r.name==="AbortError")return!0;if(r instanceof Error){let e=r.message.toLowerCase();return e.includes("timeout")||e.includes("timed out")}return!1}isNetworkError(r){if(r instanceof Error){let e=r.message.toLowerCase();return e.includes("failed to fetch")||e.includes("network")||e.includes("connection")||e.includes("net::")||e.includes("econnrefused")||e.includes("enotfound")}return!1}isRetryableError(r,e){return!!(this.isTimeoutError(r)||this.isNetworkError(r)||r instanceof TypeError||e&&e>=500&&e<600||e===429||e===503||e===504)}getErrorReason(r,e){return this.isTimeoutError(r)?"timeout":this.isNetworkError(r)?"network":e===429?"rate-limited":e&&e>=500?`server-error-${e}`:"unknown"}getErrorMessage(r,e){return this.isTimeoutError(r)?"The request is taking longer than expected. Please wait a moment while we retry...":this.isNetworkError(r)?"Network connection failed. Please check your internet connection.":r instanceof TypeError?"Network error occurred. Please check your connection and try again.":e&&e>=500?e===503?"Service temporarily unavailable. The server is overloaded or under maintenance.":e===504?"The server is processing your request. Please wait a moment...":`Server error (${e}). The service is temporarily unavailable.`:e===429?"Too many requests. Please wait a moment before trying again.":r instanceof Error?r.message:String(r)}calculateBackoffDelay(r){let e=this.retryConfig.baseDelayMs*Math.pow(2,r-1),t=e*.25*(Math.random()*2-1);return Math.min(e+t,this.retryConfig.maxDelayMs)}calculateTimeout(r,e){if(e){let t=r*this.retryConfig.timeoutMultiplierOnTimeout;return Math.min(t,this.retryConfig.maxTimeoutMs)}return r}async extractTextFromUrl(r){console.debug("[GraphApiService] extractTextFromUrl called with:",r);try{console.debug("[GraphApiService] Making request to:",`${this.baseUrl}/api/extract-text`);let e=await(0,Q.requestUrl)({url:`${this.baseUrl}/api/extract-text`,method:"POST",headers:this.getHeaders(),body:JSON.stringify({url:r}),throw:!1});if(console.debug("[GraphApiService] Response status:",e.status),e.status<200||e.status>=300){console.error("[GraphApiService] extractTextFromUrl error:",e.status,e.text);try{let n=JSON.parse(e.text);throw new Error(n.error||`Server error (${e.status})`)}catch{throw new Error(`Server error (${e.status})`)}}let t=e.json;if(console.debug("[GraphApiService] Response json success:",t.success),t.success&&t.text)return console.debug("[GraphApiService] Extracted text length:",t.text.length),t.text;throw new Error(t.error||"Failed to extract text from URL")}catch(e){throw console.error("[GraphApiService] extractTextFromUrl exception:",e),e}}async extractTextFromFile(r){if(r.size>10485760)throw new Error(`File too large (${(r.size/1024/1024).toFixed(1)}MB). Limit is 10MB.`);return new Promise((t,n)=>{let i=new FileReader;i.onload=async()=>{try{let o=i.result,a=3,s=12e4,l=null;for(let c=1;c<=a;c++)try{console.debug(`[GraphApiService] File extraction attempt ${c}/${a}: ${r.name}`);let d=await this.fetchWithTimeout(`${this.baseUrl}/api/extract-text`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({filename:r.name,content_base64:o})},s);if(!d.ok){let h=await d.text();if(d.status===429&&c<a){let u=this.calculateBackoffDelay(c);console.debug(`[GraphApiService] Rate limited, retrying in ${u}ms...`),await new Promise(y=>setTimeout(y,u));continue}if(d.status>=500&&c<a){let u=this.calculateBackoffDelay(c);console.debug(`[GraphApiService] Server error, retrying in ${u}ms...`),await new Promise(y=>setTimeout(y,u));continue}try{let u=JSON.parse(h);throw new Error(u.error||h)}catch{throw new Error(`Server error (${d.status}): ${h}`)}}let p=await d.json();if(p.success){t(p.text);return}else throw new Error(p.error||"Failed to extract text")}catch(d){if(l=d,this.isTimeoutError(d)&&c<a){let p=this.calculateBackoffDelay(c);console.debug(`[GraphApiService] Timeout, retrying in ${p}ms...`),await new Promise(h=>setTimeout(h,p));continue}if(this.isNetworkError(d)&&c<a){let p=this.calculateBackoffDelay(c);console.debug(`[GraphApiService] Network error, retrying in ${p}ms...`),await new Promise(h=>setTimeout(h,p));continue}throw d}throw l||new Error("Failed to extract text after retries")}catch(o){n(o)}},i.onerror=()=>n(new Error("Failed to read file")),i.readAsDataURL(r)})}async chatWithCustomProvider(r,e,t,n){if(!t)throw new Error("Custom chat settings not provided");let{customApiUrl:i,customApiKey:o,customModel:a,type:s}=t;if(s==="mindsdb"){let u=i.trim().replace(/\/+$/,"");u.endsWith("/api/sql/query")||(u=`${u}/api/sql/query`);let y=r.replace(/'/g,"''"),m=`SELECT answer FROM ${a} WHERE question='${y}'`,v=(0,Q.requestUrl)({url:u,method:"POST",headers:{"Content-Type":"application/json",...o?{Authorization:`Bearer ${o}`}:{}},body:JSON.stringify({query:m}),throw:!1});if(n?.aborted)throw new DOMException("Aborted","AbortError");let f=await(n?Promise.race([v,new Promise((x,g)=>{n.addEventListener("abort",()=>g(new DOMException("Aborted","AbortError")))})]):v);if(f.status>=200&&f.status<300)try{let x=await f.json;return x.data&&Array.isArray(x.data)&&x.data.length>0?String(x.data[0][0]):"No response from MindsDB agent."}catch(x){throw console.error("MindsDB parsing error:",x),new Error("Failed to parse MindsDB response")}else throw console.error("MindsDB API Error:",f.status,f.text),new Error(`MindsDB API Error: ${f.status}`)}let c=e||"You are a helpful OSINT assistant. Answer the user's questions to the best of your ability.",d=i.trim();if(d.endsWith("/chat/completions")||(d=`${d.replace(/\/+$/,"")}/chat/completions`),n?.aborted)throw new DOMException("Aborted","AbortError");let p=(0,Q.requestUrl)({url:d,method:"POST",headers:{"Content-Type":"application/json",...o?{Authorization:`Bearer ${o}`}:{}},body:JSON.stringify({model:a,messages:[{role:"system",content:c},{role:"user",content:r}]}),throw:!1}),h=await(n?Promise.race([p,new Promise((u,y)=>{n.addEventListener("abort",()=>y(new DOMException("Aborted","AbortError")))})]):p);if(h.status>=200&&h.status<300)try{return(await h.json).choices[0].message.content}catch(u){throw console.error("[GraphApiService] Failed to parse custom API response:",u),new Error("Failed to parse AI response.")}throw new Error(`Custom API Error: ${h.status} ${await h.text}`)}splitTextIntoChunks(r,e=8e3){let t=[],n=r;for(;n.length>0;){if(n.length<=e){t.push(n);break}let i=n.lastIndexOf(`

`,e);(i===-1||i<e*.5)&&(i=n.lastIndexOf(`
`,e)),(i===-1||i<e*.5)&&(i=n.lastIndexOf(". ",e),i>0&&(i+=1)),(i===-1||i<e*.5)&&(i=e),t.push(n.substring(0,i).trim()),n=n.substring(i).trim()}return t}async processTextInChunks(r,e,t,n,i,o,a,s,l){if(r.length<=1e4)return this.processText(r,e,t,i,o,a,s,l);console.debug(`[GraphApiService] Large text detected (${r.length} chars), processing in chunks`);let p=this.splitTextIntoChunks(r,8e3);console.debug(`[GraphApiService] Split into ${p.length} chunks`);let h=[],u=new Set,y=e||[];for(let m=0;m<p.length;m++){if(o?.aborted)throw new DOMException("Aborted","AbortError");let v=p[m],f=m+1;n&&n(f,p.length,`Processing chunk ${f}/${p.length}...`),console.debug(`[GraphApiService] Processing chunk ${f}/${p.length} (${v.length} chars)`);try{let x=await this.processText(v,y,t,i,o,a,s,l);if(!x.success){console.warn(`[GraphApiService] Chunk ${f} failed:`,x.error);continue}if(x.operations)for(let g of x.operations)if(g.action==="create"&&g.entities){let T=g.entities.filter(C=>{let D=te(C.type,C.properties),S=`${C.type}::${D.toLowerCase()}`;return u.has(S)?(console.debug(`[GraphApiService] Skipping duplicate entity: ${S}`),!1):(u.add(S),!0)});T.length>0&&(h.push({...g,entities:T}),y=[...y,...T.map(C=>({id:`temp-${Date.now()}-${Math.random()}`,type:C.type,label:te(C.type,C.properties),properties:C.properties||{}}))])}else g.connections&&h.push(g)}catch(x){console.error(`[GraphApiService] Chunk ${f} error:`,x)}}return h.length===0?{success:!1,error:"Failed to extract entities from any chunks"}:(console.debug(`[GraphApiService] Chunking complete. Total operations: ${h.length}`),{success:!0,operations:h})}async processText(r,e,t,n,i,o,a,s){console.debug("[GraphApiService] Processing text with AI:",r.substring(0,100)+"...");let{maxRetries:l,baseTimeoutMs:c}=this.retryConfig,d=c,p=null,h,u=!1;for(let v=1;v<=l;v++){if(i?.aborted)throw new DOMException("Aborted","AbortError");try{u&&(d=this.calculateTimeout(d,!0),console.debug(`[GraphApiService] Increased timeout to ${d}ms after timeout error`)),console.debug(`[GraphApiService] Attempt ${v}/${l} with ${d}ms timeout`);let f=await this.fetchWithTimeout(`${this.baseUrl}/api/process-text`,{method:"POST",headers:this.getHeaders(),mode:"cors",credentials:"omit",body:JSON.stringify({text:r,existing_entities:e?.map(x=>({id:x.id,type:x.type,label:x.label,properties:x.properties})),existing_connections:a,reference_time:t,modify_only:o,graph_query:s})},d,i);if(f.ok){let x=await f.json();return console.debug("[GraphApiService] AI processing successful:",x),x}else{let x=await f.text();if(console.error(`[GraphApiService] API error (attempt ${v}/${l}):`,f.status,x),h=f.status,f.status>=400&&f.status<500&&f.status!==429)return f.status===401||f.status===403?{success:!1,error:"Authentication required. Please configure your API key in Settings \u2192 OSINT Copilot \u2192 API Key"}:f.status===404?{success:!1,error:"API endpoint not found. Please check that the API server is running and the URL is correct."}:{success:!1,error:`API error (${f.status}): ${x}`};if(p=new Error(`HTTP ${f.status}: ${x}`),v<l){let g=this.calculateBackoffDelay(v),T=this.getErrorReason(p,f.status);console.debug(`[GraphApiService] Retrying in ${Math.round(g)}ms (reason: ${T})...`),n&&n(v,l,T,g),await new Promise(C=>setTimeout(C,g));continue}}}catch(f){if(console.error(`[GraphApiService] Process text failed (attempt ${v}/${l}):`,f),p=f,this.isTimeoutError(f)&&(u=!0),this.isRetryableError(f)&&v<l){let x=this.calculateBackoffDelay(v),g=this.getErrorReason(f,h);console.debug(`[GraphApiService] ${g} error, retrying in ${Math.round(x)}ms...`),n&&n(v,l,g,x),await new Promise(T=>setTimeout(T,x));continue}this.isRetryableError(f)||(this.isOnline=!1)}}let y=this.getErrorMessage(p,h);console.error("[GraphApiService] All retries exhausted:",y);let m="\u{1F4A1} Please wait a moment and try again. This is usually temporary.";return this.isTimeoutError(p)?m="\u{1F4A1} The server is busy processing requests. Please wait a moment and try again.":this.isNetworkError(p)?m="\u{1F4A1} Network connection failed. Please check your internet connection and try again.":h&&h>=500&&(m="\u{1F4A1} The server is experiencing issues. Please try again later."),{success:!1,error:`Entity extraction failed after ${l} attempts: ${y}

${m}`,originalText:r}}async aiSearch(r,e,t){if(this.isOnline||await this.checkHealth(),!this.apiKey)throw new Error("License key required for Digital Footprint. Configure in Settings \u2192 OSINT Copilot \u2192 API Key.");console.debug("[GraphApiService] AI Search request:",r.query.substring(0,100));let{maxRetries:n}=this.retryConfig,i=18e4,o=null,a;for(let l=1;l<=n;l++)try{console.debug(`[GraphApiService] AI Search attempt ${l}/${n}`);let c=await this.fetchWithTimeout(`${this.baseUrl}/api/bot-aggregator/ai-search`,{method:"POST",headers:this.getHeaders(),mode:"cors",credentials:"omit",body:JSON.stringify(r)},i,t);if(c.ok){let d=await c.json();return console.debug("[GraphApiService] AI Search successful:",d.total_results,"results"),d}else{let d=await c.text();if(console.error(`[GraphApiService] AI Search error (attempt ${l}/${n}):`,c.status,d),a=c.status,c.status>=400&&c.status<500&&c.status!==429)throw c.status===401||c.status===403?new Error("Authentication failed. Please check your API key in Settings."):c.status===404?new Error("Digital Footprint endpoint not found. Please check your API configuration."):new Error(`API error (${c.status}): ${d}`);if(o=new Error(`HTTP ${c.status}: ${d}`),l<n){let p=this.calculateBackoffDelay(l),h=this.getErrorReason(o,c.status);console.debug(`[GraphApiService] AI Search retrying in ${Math.round(p)}ms (reason: ${h})...`),e&&e(l,n,h,p),await new Promise(u=>setTimeout(u,p));continue}}}catch(c){if(console.error(`[GraphApiService] AI Search failed (attempt ${l}/${n}):`,c),o=c,c instanceof Error&&(c.message.includes("Authentication")||c.message.includes("API key")||c.message.includes("endpoint not found")))throw c;if(this.isRetryableError(c)&&l<n){let d=this.calculateBackoffDelay(l),p=this.getErrorReason(c,a);console.debug(`[GraphApiService] AI Search ${p} error, retrying in ${Math.round(d)}ms...`),e&&e(l,n,p,d),await new Promise(h=>setTimeout(h,d));continue}}let s=this.getErrorMessage(o,a);throw console.error("[GraphApiService] AI Search all retries exhausted:",s),this.isTimeoutError(o)?new Error("Search timed out. Try reducing the number of providers or simplifying your query."):a===503?new Error("Digital Footprint service is temporarily unavailable. Please try again later."):a===504?new Error("Search timed out. Try reducing the number of providers."):new Error(`Digital Footprint failed after ${n} attempts: ${s}`)}async determineTaskPlan(r){try{let e=await this.fetchWithTimeout(`${this.baseUrl}/api/chat/route`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({text:r})},5e3);if(e.ok){let t=await e.json();if(t.success&&t.plan&&Array.isArray(t.plan))return t.plan;if(t.error&&(t.error.includes("unauthorized")||t.error.includes("API key")))throw new Error(t.error)}return[{action:"local_chat",target:r}]}catch(e){return console.error("[GraphApiService] Error determining task plan:",e),[{action:"local_chat",target:r}]}}};var le=require("obsidian"),ye=class{constructor(r,e){this.conversationList=[];this.currentConversationId=null;this.saveInProgress=!1;this.pendingSave=!1;this.app=r,this.basePath=e}setBasePath(r){this.basePath=r}setCurrentConversationId(r){this.currentConversationId=r}async initialize(){await this.ensureFolderExists(this.basePath),await this.loadConversationList()}async ensureFolderExists(r){let e=(0,le.normalizePath)(r);if(this.app.vault.getAbstractFileByPath(e))return;let n=e.split("/"),i="";for(let o of n)if(i=i?`${i}/${o}`:o,!this.app.vault.getAbstractFileByPath(i))try{await this.app.vault.createFolder(i)}catch(s){if(!(s instanceof Error?s.message:String(s)).includes("Folder already exists"))throw s}}async loadConversationList(){this.conversationList=[];let r=(0,le.normalizePath)(this.basePath);if(!await this.app.vault.adapter.exists(r))return[];try{let t=await this.app.vault.adapter.list(r);for(let n of t.files)if(n.endsWith(".md")){let i=await this.parseConversationMetadataFromPath(n);i&&this.conversationList.push(i)}}catch(t){return console.error("Failed to list conversation files:",t),[]}return this.conversationList.sort((t,n)=>n.updatedAt-t.updatedAt),this.conversationList}getConversationList(){return this.conversationList}async parseConversationMetadataFromPath(r){try{let e=await this.app.vault.adapter.read(r);return this.parseMetadataFromContent(e,r)}catch(e){return console.error("Failed to parse conversation metadata from path:",r,e),null}}async parseConversationMetadata(r){try{let e=await this.app.vault.read(r);return this.parseMetadataFromContent(e,r.path)}catch(e){return console.error("Failed to parse conversation metadata:",e),null}}parseMetadataFromContent(r,e){let t=r.match(/^---\n([\s\S]*?)\n---/);if(!t)return null;let n=t[1],i=e.split("/").pop()?.replace(".md","")||"unknown",o=this.extractYamlValue(n,"id")||i,a=this.extractYamlValue(n,"title")||"Untitled",s=parseInt(this.extractYamlValue(n,"createdAt")||"0"),l=parseInt(this.extractYamlValue(n,"updatedAt")||"0"),c=parseInt(this.extractYamlValue(n,"messageCount")||"0"),d=this.extractYamlValue(n,"darkWebMode")==="true",p=this.extractYamlValue(n,"graphGenerationMode")==="true"||this.extractYamlValue(n,"entityGenerationMode")==="true",h=this.extractYamlValue(n,"reportGenerationMode")==="true",u=this.extractYamlValue(n,"localSearchMode");u===null&&(u=this.extractYamlValue(n,"lookupMode"));let y=u===null?!d&&!h:u==="true",m=this.extractYamlValue(n,"reportConversationId");return{id:o,title:a,createdAt:s,updatedAt:l,messageCount:c,localSearchMode:y,darkWebMode:d,graphGenerationMode:p,reportGenerationMode:h,reportConversationId:m||void 0}}extractYamlValue(r,e){let t=r.match(new RegExp(`^${e}:\\s*(.*)$`,"m"));return t?t[1].trim():null}async loadConversation(r){let e=(0,le.normalizePath)(`${this.basePath}/${r}.md`);if(!await this.app.vault.adapter.exists(e))return null;try{let n=await this.app.vault.adapter.read(e),i=this.parseMetadataFromContent(n,e);if(!i)return null;let o=n.match(/```json:messages\n([\s\S]*?)\n```/),a=[];if(o)try{a=JSON.parse(o[1])}catch(s){console.error("Failed to parse messages JSON:",s)}return{...i,messages:a}}catch(n){return console.error("Failed to load conversation:",n),null}}generateId(){return`conv-${Date.now()}-${Math.random().toString(36).substring(2,11)}`}generateTitle(r){if(!r)return"New Conversation";let e=r.substring(0,50);return e.length<r.length?e+"...":e}async createConversation(r,e=!1,t=!1,n=!1){let i=this.generateId(),o=Date.now(),a=!e&&!n,s={id:i,title:this.generateTitle(r),createdAt:o,updatedAt:o,messageCount:0,localSearchMode:a,darkWebMode:e,graphGenerationMode:t,reportGenerationMode:n,messages:[]};return await this.saveConversation(s),this.currentConversationId=i,s}async saveConversation(r){if(this.saveInProgress){this.pendingSave=!0;return}this.saveInProgress=!0;try{for(await this.doSaveConversation(r);this.pendingSave;)this.pendingSave=!1,await this.doSaveConversation(r)}finally{this.saveInProgress=!1}}async doSaveConversation(r){await this.ensureFolderExists(this.basePath);let e=(0,le.normalizePath)(`${this.basePath}/${r.id}.md`);r.updatedAt=Date.now(),r.messageCount=r.messages.length;let t=this.serializeConversation(r);if(await this.app.vault.adapter.exists(e))await this.app.vault.adapter.write(e,t);else try{await this.app.vault.create(e,t)}catch(i){let o=String(i instanceof Error?i.message:i||"").toLowerCase();if(o.includes("already exists")||o.includes("file exists"))await this.app.vault.adapter.write(e,t);else throw i}await this.loadConversationList()}serializeConversation(r){let e=["---",`id: ${r.id}`,`title: ${r.title}`,`createdAt: ${r.createdAt}`,`updatedAt: ${r.updatedAt}`,`messageCount: ${r.messageCount}`,`localSearchMode: ${r.localSearchMode}`,`darkWebMode: ${r.darkWebMode}`,`graphGenerationMode: ${r.graphGenerationMode||!1}`,`reportGenerationMode: ${r.reportGenerationMode||!1}`];r.reportConversationId&&e.push(`reportConversationId: ${r.reportConversationId}`),e.push("---","");let t=e.join(`
`),n=["```json:messages",JSON.stringify(r.messages,null,2),"```"].join(`
`);return t+n}async deleteConversation(r){let e=(0,le.normalizePath)(`${this.basePath}/${r}.md`);try{return await this.app.vault.adapter.exists(e)?(await this.app.vault.adapter.remove(e),this.currentConversationId===r&&(this.currentConversationId=null),this.conversationList=this.conversationList.filter(n=>n.id!==r),!0):(console.warn(`ConversationService: File not found for deletion: ${e}`),this.conversationList=this.conversationList.filter(n=>n.id!==r),!1)}catch(t){return console.error(`ConversationService: Failed to delete conversation ${r}:`,t),!1}}async renameConversation(r,e){let t=await this.loadConversation(r);return t?(t.title=e,await this.saveConversation(t),!0):!1}async getMostRecentConversation(){return await this.loadConversationList(),this.conversationList.length===0?null:this.loadConversation(this.conversationList[0].id)}};var A=require("obsidian");var P=require("obsidian");var F=require("obsidian"),ie=class extends F.Modal{constructor(e,t,n,i,o="Thing"){super(e);this.isEditing=!1;this.baseType="Thing";this.schema={name:"",label:"",plural:"",description:"",extends:["Thing"],properties:{},featured:[],required:[],caption:[],color:"#607D8B"};this.propertyRows=[];this.onSaveCallback=null;this.PROPERTY_TYPES=["string","text","date","number","boolean","url","email","phone","country"];this.customTypesService=t,this.baseType=o,n?(this.schema=JSON.parse(JSON.stringify(n)),this.isEditing=!0,this.schema.extends&&this.schema.extends.includes("Interval")&&(this.baseType="Interval")):this.schema.extends=[o],this.onSaveCallback=i||null}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("graph_copilot-custom-type-modal"),this.addStyles(e);let t=this.baseType==="Interval"?"Create custom connection type":"Create custom entity type";e.createEl("h2",{text:t});let n=e.createDiv({cls:"graph_copilot-custom-type-container"});this.renderGeneralSettings(n),this.renderPropertyBuilder(n),this.renderFooter(e)}addStyles(e){}renderGeneralSettings(e){let t=e.createDiv({cls:"graph_copilot-section"});t.createEl("h3",{text:"1. General information"}),new F.Setting(t).setName("Type name").setDesc('Internal name (CamelCase, e.g. "MyCustomType")').addText(n=>n.setPlaceholder("MyCustomType").setValue(this.schema.name||"").setDisabled(this.isEditing).onChange(i=>{if(this.isEditing)return;let o=i.replace(/[^a-zA-Z0-9]/g,"");this.schema.name=o,this.schema.label||(this.schema.label=i),this.schema.plural||(this.schema.plural=i+"s")})),new F.Setting(t).setName("Display label").setDesc("Human readable label").addText(n=>n.setPlaceholder("My custom type").onChange(i=>this.schema.label=i)),new F.Setting(t).setName("Plural label").setDesc("Plural formatted label").addText(n=>n.setPlaceholder("My custom types").onChange(i=>this.schema.plural=i)),new F.Setting(t).setName("Description").setDesc("Short description of what this entity represents").addTextArea(n=>n.setPlaceholder("Description...").onChange(i=>this.schema.description=i)),new F.Setting(t).setName("Color").setDesc("Color for the entity nodes").addColorPicker(n=>n.setValue(this.schema.color||"#607D8B").onChange(i=>this.schema.color=i))}renderPropertyBuilder(e){let t=e.createDiv({cls:"graph_copilot-section"});t.addClass("graph_copilot-section--properties"),t.createEl("h3",{text:"2. Properties"}),t.createEl("p",{text:"Define custom properties for this entity type.",cls:"setting-item-description"});let n=t.createDiv({cls:"graph_copilot-properties-list"}),i=()=>{if(n.empty(),this.propertyRows.length===0){n.createDiv({text:"No custom properties defined.",cls:"text-muted"});return}let g=n.createEl("table",{cls:"graph_copilot-properties-table"}),C=g.createEl("thead").createEl("tr",{cls:"graph_copilot-properties-header"});["Label","Key","Type","Flags","Actions"].forEach(S=>{C.createEl("th",{text:S,cls:"graph_copilot-properties-th"})});let D=g.createEl("tbody");this.propertyRows.forEach((S,E)=>{let w=D.createEl("tr",{cls:"graph_copilot-properties-row"});w.createEl("td",{text:S.label,cls:"graph_copilot-properties-td"}),w.createEl("td",{text:S.key,cls:"graph_copilot-properties-td"}),w.createEl("td",{text:S.type,cls:"graph_copilot-properties-td"});let M=w.createEl("td",{cls:"graph_copilot-properties-td"});S.required&&M.createSpan({text:"Req",cls:"graph_copilot-tag graph_copilot-tag--mr"}),S.featured&&M.createSpan({text:"Feat",cls:"graph_copilot-tag"});let N=w.createEl("td",{cls:"graph_copilot-properties-td"}).createEl("button",{text:"\u{1F5D1}"});N.onclick=()=>{this.propertyRows.splice(E,1),i()}})};i();let o=t.createDiv({cls:"graph_copilot-add-property-form"});o.createEl("h4",{text:"Add property"});let a={id:"",key:"",label:"",type:"string",description:"",required:!1,featured:!1},s=o.createDiv({cls:"graph_copilot-form-grid"}),l=s.createDiv();l.createDiv({text:"Label *",cls:"setting-item-name"});let c=new F.TextComponent(l);c.setPlaceholder("E.g. birth date"),c.inputEl.addClass("graph_copilot-input-full"),c.onChange(g=>{if(a.label=g,!p.getValue()){let T=g.toLowerCase().replace(/[^a-z0-9]/g,"");a.key=T,p.setValue(T)}});let d=s.createDiv();d.createDiv({text:"Property key *",cls:"setting-item-name"});let p=new F.TextComponent(d);p.setPlaceholder("E.g. birthDate"),p.inputEl.addClass("graph_copilot-input-full"),p.onChange(g=>a.key=g);let h=s.createDiv();h.createDiv({text:"Type",cls:"setting-item-name"});let u=new F.DropdownComponent(h);this.PROPERTY_TYPES.forEach(g=>u.addOption(g,g)),u.setValue("string"),u.onChange(g=>a.type=g);let y=s.createDiv();y.createDiv({text:"Description",cls:"setting-item-name"});let m=new F.TextComponent(y);m.setPlaceholder("Optional description"),m.inputEl.addClass("graph_copilot-input-full"),m.onChange(g=>a.description=g);let v=o.createDiv({cls:"graph_copilot-flags-container"});new F.Setting(v).setName("Required").addToggle(g=>g.onChange(T=>a.required=T)),new F.Setting(v).setName("Key property (featured)").addToggle(g=>g.onChange(T=>a.featured=T));let f=o.createDiv({cls:"graph_copilot-btn-container"}),x=new F.ButtonComponent(f).setButtonText("Add property").setCta().onClick(()=>{if(!a.label||!a.key){new F.Notice("Label and key are required");return}this.propertyRows.push({...a,id:Date.now().toString()}),i(),a.label="",a.key="",a.description="",a.required=!1,a.featured=!1,c.setValue(""),p.setValue(""),m.setValue("")})}renderFooter(e){let t=e.createDiv({cls:"graph_copilot-entity-modal-buttons"});new F.ButtonComponent(t).setButtonText("Cancel").onClick(()=>this.close()),new F.ButtonComponent(t).setButtonText(this.isEditing?"Update type":"Create type").setCta().onClick(()=>this.handleSave())}populateRowsFromSchema(){this.schema.properties&&(this.propertyRows=[],Object.keys(this.schema.properties).forEach(e=>{let t=this.schema.properties[e];this.propertyRows.push({id:e,key:e,label:t.label,type:t.type||"string",description:t.description||"",required:(this.schema.required||[]).includes(e),featured:(this.schema.featured||[]).includes(e)})}))}async handleSave(){if(!this.schema.name){new F.Notice("Internal type name is required");return}if(!this.schema.label){new F.Notice("Display label is required");return}let e={},t=[],n=[],i=["name"];this.propertyRows.forEach(o=>{e[o.key]={label:o.label,type:o.type,description:o.description},o.required&&t.push(o.key),o.featured&&n.push(o.key)}),this.schema.properties=e,this.schema.required=t,this.schema.featured=n,n.length>0&&i.push(...n),this.schema.caption=[...new Set(i)];try{await this.customTypesService.addCustomType(this.schema),this.onSaveCallback&&this.schema.name&&this.onSaveCallback(this.schema.name),this.close()}catch(o){new F.Notice(`Failed to create type: ${o}`),console.error(o)}}onClose(){let{contentEl:e}=this;e.empty()}};var it=["WORKS_AT","ATTENDED","LOCATED_AT","KNOWS","OWNS","MEMBER_OF","RELATED_TO","CONTACTED","VISITED","EMPLOYED_BY","LIVES_AT","ASSOCIATED_WITH","PARENT_OF","CHILD_OF","SIBLING_OF","SPOUSE_OF","FRIEND_OF","COLLEAGUE_OF"],K=class extends P.Modal{constructor(e,t,n,i,o={},a){super(e);this.entityId=a;this.properties={};this.geocodeStatusEl=null;this.geocodeBtn=null;this.entityManager=t,this.entityType=n,this.onEntityCreated=i||null,this.geocodingService=new q,this.properties={...o}}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("graph_copilot-entity-modal");let t=_[this.entityType],n=this.entityId?"Edit":"Create";e.createEl("h2",{text:`${n} ${this.entityType}`}),e.createEl("p",{text:t.description,cls:"graph_copilot-entity-modal-description"});let i=e.createDiv({cls:"graph_copilot-entity-form"}),o=["address","city","state","country","postal_code"],a=["latitude","longitude"];for(let p of t.properties)this.entityType==="Location"&&a.includes(p)||this.createPropertyField(i,p,p===t.labelField);if(this.entityType==="Location"){this.createGeocodeSection(i);for(let p of a)this.createPropertyField(i,p,!1)}e.createEl("h4",{text:"Additional properties"});let s=e.createDiv({cls:"graph_copilot-entity-form"});for(let p of de)p!=="image"&&this.createPropertyField(s,p,!1);let l=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),c=l.createEl("button",{text:this.entityId?"Update entity":"Create entity",cls:"mod-cta"});c.onclick=()=>this.handleCreate();let d=l.createEl("button",{text:"Cancel"});d.onclick=()=>this.close()}createGeocodeSection(e){let t=e.createDiv({cls:"graph_copilot-geocode-section"});this.geocodeBtn=t.createEl("button",{text:"Put on map",cls:"graph_copilot-geocode-btn"}),this.geocodeStatusEl=t.createEl("span",{cls:"graph_copilot-geocode-status"}),t.createEl("small",{text:"Convert address to coordinates using OpenStreetMap",cls:"graph_copilot-geocode-help"}),this.geocodeBtn.onclick=async()=>{await this.handleGeocode()}}async handleGeocode(){if(!this.geocodeBtn||!this.geocodeStatusEl)return;let e=this.properties.address||"",t=this.properties.city||"",n=this.properties.state||"",i=this.properties.country||"";if(!e&&!t&&!i){this.setGeocodeStatus("error","Please enter an address, city, or country first");return}this.geocodeBtn.disabled=!0,this.geocodeBtn.textContent="\u23F3 geocoding...",this.setGeocodeStatus("loading","Looking up coordinates...");try{let o=await this.geocodingService.geocodeAddressWithRetry(e,t,n,i,(d,p,h)=>{this.setGeocodeStatus("loading",`Network error, retrying in ${h}s... (attempt ${d}/${p})`)});this.properties.latitude=o.latitude,this.properties.longitude=o.longitude;let a=document.getElementById("entity-latitude"),s=document.getElementById("entity-longitude");a&&(a.value=o.latitude.toString()),s&&(s.value=o.longitude.toString());let c=`\u2713 Found: ${q.formatCoordinates(o.latitude,o.longitude)}`;if(o.confidence==="low"&&(c+=" (low confidence - please verify)"),this.setGeocodeStatus("success",c),!this.properties.city&&o.city){this.properties.city=o.city;let d=document.getElementById("entity-city");d&&(d.value=o.city)}if(!this.properties.state&&o.state){this.properties.state=o.state;let d=document.getElementById("entity-state");d&&(d.value=o.state)}if(!this.properties.country&&o.country){this.properties.country=o.country;let d=document.getElementById("entity-country");d&&(d.value=o.country)}if(!this.properties.postal_code&&o.postalCode){this.properties.postal_code=o.postalCode;let d=document.getElementById("entity-postal_code");d&&(d.value=o.postalCode)}}catch(o){if(console.error("[EntityModal] Geocoding error:",o),o instanceof R)switch(o.type){case"NOT_FOUND":this.setGeocodeStatus("error","\u2717 Address not found. Please check the address or enter coordinates manually.");break;case"RATE_LIMITED":this.setGeocodeStatus("error","\u2717 Too many requests. Please wait a moment and try again.");break;case"NETWORK_ERROR":this.setGeocodeStatus("error","\u2717 Network error. Please check your internet connection.");break;case"INVALID_INPUT":this.setGeocodeStatus("error","\u2717 "+o.message);break;default:this.setGeocodeStatus("error","\u2717 Geocoding failed. Please enter coordinates manually.")}else this.setGeocodeStatus("error","\u2717 Geocoding failed. Please enter coordinates manually.")}finally{this.geocodeBtn&&(this.geocodeBtn.disabled=!1,this.geocodeBtn.textContent="Put on map")}}setGeocodeStatus(e,t){this.geocodeStatusEl&&(this.geocodeStatusEl.textContent=t,this.geocodeStatusEl.removeClass("graph_copilot-geocode-status-success"),this.geocodeStatusEl.removeClass("graph_copilot-geocode-status-error"),this.geocodeStatusEl.removeClass("graph_copilot-geocode-status-loading"),this.geocodeStatusEl.addClass(`graph_copilot-geocode-status-${e}`))}createPropertyField(e,t,n){let i=e.createDiv({cls:"graph_copilot-entity-field"});i.createEl("label",{text:this.formatPropertyName(t)+(n?" *":"")}).setAttribute("for",`entity-${t}`);let a;if(t==="notes"||t==="description"||t==="text")a=i.createEl("textarea",{placeholder:`Enter ${this.formatPropertyName(t).toLowerCase()}...`}),a.rows=3;else if(t==="start_date"||t==="end_date")a=i.createEl("input",{type:"datetime-local"});else if(t==="latitude"||t==="longitude")a=i.createEl("input",{type:"number",placeholder:t==="latitude"?"-90 to 90":"-180 to 180"}),a.step="any";else if(t==="add_to_timeline"||t==="tampered"){let s=i.createDiv({cls:"graph_copilot-toggle-container"});s.setCssProps({display:"flex",alignItems:"center",gap:"12px",marginTop:"4px"}),a=s.createEl("input",{type:"checkbox"}),a.id=`entity-${t}`,a.style.display="none";let l=s.createEl("button",{cls:"graph_copilot-toggle-btn"});l.type="button",l.setCssProps({display:"flex",alignItems:"center",gap:"8px",padding:"10px 20px",fontSize:"14px",fontWeight:"500",borderRadius:"6px",cursor:"pointer",transition:"all 0.2s ease",border:"2px solid var(--background-modifier-border)",background:"var(--background-secondary)",color:"var(--text-muted)"});let c=l.createSpan({cls:"toggle-icon"});c.textContent="\u{1F4C5}",c.setCssProps({fontSize:"16px"});let d=l.createSpan({cls:"toggle-text"});d.textContent="Add to timeline";let p=u=>{u?(l.setCssProps({background:"var(--interactive-accent)",borderColor:"var(--interactive-accent)",color:"white"}),d.textContent="On timeline \u2713"):(l.setCssProps({background:"var(--background-secondary)",borderColor:"var(--background-modifier-border)",color:"var(--text-muted)"}),d.textContent="Add to timeline")},h=this.properties[t]!==void 0?!!this.properties[t]:!this.entityId&&t==="add_to_timeline";a.checked=h,this.properties[t]=h,p(h),l.addEventListener("click",()=>{let u=!a.checked;a.checked=u,this.properties[t]=u,p(u)}),l.addEventListener("mouseenter",()=>{a.checked||l.setCssProps({borderColor:"var(--interactive-accent)",color:"var(--text-normal)"})}),l.addEventListener("mouseleave",()=>{p(a.checked)});return}else a=i.createEl("input",{type:"text",placeholder:`Enter ${this.formatPropertyName(t).toLowerCase()}...`});this.properties[t]!==void 0&&(a.value=String(this.properties[t])),a.id=`entity-${t}`,a.addClass("graph_copilot-entity-input"),a.addEventListener("input",()=>{if(a.type==="datetime-local"){let s=a.value;s&&(this.properties[t]=s.replace("T"," "))}else if(a.type==="number"){let s=parseFloat(a.value);isNaN(s)||(this.properties[t]=s)}else this.properties[t]=a.value}),a.addEventListener("change",()=>{if(a.type==="datetime-local"){let s=a.value;s&&(this.properties[t]=s.replace("T"," "))}})}formatPropertyName(e){return e.split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}async handleCreate(){let t=_[this.entityType].labelField;if(this.properties[t]&&this.properties[t].trim()!==""){let n=ne(this.properties[t],this.entityType);if(!n.isValid){new P.Notice(n.error||"Invalid entity name");return}}try{let n;this.entityId?(n=await this.entityManager.updateEntity(this.entityId,this.properties),new P.Notice(`Updated ${this.entityType}: ${n?.label}`)):(n=await this.entityManager.createEntity(this.entityType,this.properties,{skipAutoGeocode:!0}),new P.Notice(`Created ${this.entityType}: ${n.label}`)),this.onEntityCreated&&n&&this.onEntityCreated(n.id),this.close()}catch(n){new P.Notice(`Failed to create entity: ${n}`),console.error("Entity creation error:",n)}}async autoGeocodeIfNeeded(){let e=this.properties.latitude&&this.properties.longitude,t=this.properties.address||this.properties.city||this.properties.country;if(!(e||!t)){console.debug("[EntityCreationModal] Auto-geocoding location..."),this.setGeocodeStatus("loading","Auto-geocoding address...");try{let n=await this.geocodingService.geocodeAddressWithRetry(this.properties.address,this.properties.city,this.properties.state,this.properties.country,(s,l,c)=>{this.setGeocodeStatus("loading",`Network error, retrying in ${c}s... (attempt ${s}/${l})`)});this.properties.latitude=n.latitude,this.properties.longitude=n.longitude;let i=document.getElementById("entity-latitude"),o=document.getElementById("entity-longitude");if(i&&(i.value=n.latitude.toString()),o&&(o.value=n.longitude.toString()),!this.properties.city&&n.city){this.properties.city=n.city;let s=document.getElementById("entity-city");s&&(s.value=n.city)}if(!this.properties.state&&n.state){this.properties.state=n.state;let s=document.getElementById("entity-state");s&&(s.value=n.state)}if(!this.properties.country&&n.country){this.properties.country=n.country;let s=document.getElementById("entity-country");s&&(s.value=n.country)}let a=q.formatCoordinates(n.latitude,n.longitude);this.setGeocodeStatus("success",`\u2713 Auto-geocoded: ${a}`),console.debug("[EntityCreationModal] Auto-geocoded successfully:",a)}catch(n){console.warn("[EntityCreationModal] Auto-geocoding failed:",n),this.setGeocodeStatus("error","\u26A0 Auto-geocoding failed - entity will be created without coordinates")}}}onClose(){let{contentEl:e}=this;e.empty()}};var fe=class extends P.Modal{constructor(e,t,n,i,o){super(e);this.sourceEntityId=null;this.targetEntityId=null;this.relationship="";this.entities=[];this.entityManager=t,this.onConnectionCreated=n||null,this.sourceEntityId=i||null,this.targetEntityId=o||null}onOpen(){let{contentEl:e}=this;if(e.empty(),e.addClass("graph_copilot-connection-modal"),this.entities=this.entityManager.getAllEntities(),e.createEl("h2",{text:"Create connection"}),e.createEl("p",{text:"Create a relationship between two entities",cls:"graph_copilot-entity-modal-description"}),this.entities.length<2){e.createEl("p",{text:"You need at least 2 entities to create a connection.",cls:"graph_copilot-connection-warning"});let s=e.createEl("button",{text:"Close"});s.onclick=()=>this.close();return}let t=e.createDiv({cls:"graph_copilot-entity-form"});this.createEntityDropdown(t,"Source Entity","source");let n=t.createDiv({cls:"graph_copilot-connection-arrow"});n.textContent="\u2193",this.createEntityDropdown(t,"Target Entity","target"),this.createRelationshipInput(t);let i=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),o=i.createEl("button",{text:"Create connection",cls:"mod-cta"});o.onclick=()=>this.handleCreate();let a=i.createEl("button",{text:"Cancel"});a.onclick=()=>this.close()}createEntityDropdown(e,t,n){let i=e.createDiv({cls:"graph_copilot-entity-field"});i.createEl("label",{text:t+" *"});let o=i.createEl("select",{cls:"graph_copilot-entity-input"}),a=o.createEl("option",{text:`Select ${t.toLowerCase()}...`,value:""});a.disabled=!0;let s=n==="source"?this.sourceEntityId:this.targetEntityId;a.selected=!s;for(let l of this.entities){let c=o.createEl("option",{text:`${l.label} (${l.type})`,value:l.id});s&&l.id===s&&(c.selected=!0)}o.onchange=()=>{n==="source"?this.sourceEntityId=o.value||null:this.targetEntityId=o.value||null}}createRelationshipInput(e){let t=e.createDiv({cls:"graph_copilot-entity-field"});t.createEl("label",{text:"Relationship type *"});let n=t.createEl("input",{type:"text",placeholder:"e.g., WORKS_AT, KNOWS, LOCATED_AT...",cls:"graph_copilot-entity-input"});n.oninput=()=>{this.relationship=n.value.toUpperCase().replace(/\s+/g,"_"),n.value=this.relationship};let i=t.createDiv({cls:"graph_copilot-relationship-suggestions"});i.createEl("small",{text:"Suggestions: "});let o=i.createSpan();it.slice(0,6).forEach(a=>{let s=o.createEl("span",{text:a,cls:"graph_copilot-relationship-chip"});s.onclick=()=>{this.relationship=a,n.value=a}})}async handleCreate(){if(!this.sourceEntityId){new P.Notice("Please select a source entity");return}if(!this.targetEntityId){new P.Notice("Please select a target entity");return}if(this.sourceEntityId===this.targetEntityId){new P.Notice("Source and target entities must be different");return}if(!this.relationship.trim()){new P.Notice("Please enter a relationship type");return}try{let e=await this.entityManager.createConnection(this.sourceEntityId,this.targetEntityId,this.relationship);if(e){let t=this.entityManager.getEntity(this.sourceEntityId),n=this.entityManager.getEntity(this.targetEntityId);new P.Notice(`Created: ${t?.label} \u2192 ${this.relationship} \u2192 ${n?.label}`),this.onConnectionCreated&&this.onConnectionCreated(e.id),this.close()}else new P.Notice("Failed to create connection")}catch(e){new P.Notice(`Failed to create connection: ${e}`),console.error("Connection creation error:",e)}}onClose(){let{contentEl:e}=this;e.empty()}};var Ne=class extends P.Modal{constructor(e,t,n,i){super(e);this.properties={};this.optionalSectionExpanded=!1;this.entityManager=t,this.schemaName=n,this.onEntityCreated=i||null}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("graph_copilot-entity-modal"),e.addClass("graph_copilot-ftm-modal");let t=U(this.schemaName);if(!t){e.createEl("p",{text:`Unknown schema: ${this.schemaName}`});return}e.createEl("h2",{text:`Create ${t.label}`}),e.createEl("p",{text:t.description,cls:"graph_copilot-entity-modal-description"});let n=e.createDiv({cls:"graph_copilot-entity-form"});if(t.requiredProperties.length>0){n.createEl("h4",{text:"Required properties",cls:"graph_copilot-section-header"});for(let l of t.requiredProperties){let c=t.propertyDefinitions[l];c&&this.createFTMPropertyField(n,l,c,!0)}}let i=t.featuredProperties.filter(l=>!t.requiredProperties.includes(l));if(i.length>0){n.createEl("h4",{text:"Key properties",cls:"graph_copilot-section-header"});for(let l of i){let c=t.propertyDefinitions[l];c&&this.createFTMPropertyField(n,l,c,!1)}}if(t.optionalProperties.length>0){let l=e.createDiv({cls:"graph_copilot-optional-section"}),c=l.createDiv({cls:"graph_copilot-optional-header"}),d=c.createSpan({cls:"graph_copilot-toggle-icon",text:"\u25B6"});c.createSpan({text:` Additional Properties (${t.optionalProperties.length})`});let p=l.createDiv({cls:"graph_copilot-optional-content"});p.style.display="none",c.onclick=()=>{this.optionalSectionExpanded=!this.optionalSectionExpanded,d.textContent=this.optionalSectionExpanded?"\u25BC":"\u25B6",p.style.display=this.optionalSectionExpanded?"block":"none"};for(let h of t.optionalProperties){let u=t.propertyDefinitions[h];u&&!u.hidden&&this.createFTMPropertyField(p,h,u,!1)}}let o=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),a=o.createEl("button",{text:"Create entity",cls:"mod-cta"});a.onclick=()=>this.handleCreate();let s=o.createEl("button",{text:"Cancel"});s.onclick=()=>this.close()}createFTMPropertyField(e,t,n,i){let o=e.createDiv({cls:"graph_copilot-entity-field"});o.createEl("label",{text:n.label+(i?" *":"")}).setAttribute("for",`entity-${t}`);let s,l=n.type||"string";if(l==="text"||t==="description"||t==="notes"||t==="summary")s=o.createEl("textarea",{placeholder:`Enter ${n.label.toLowerCase()}...`}),s.rows=3;else if(l==="date")s=o.createEl("input",{type:"date"});else if(l==="number")s=o.createEl("input",{type:"number",placeholder:`Enter ${n.label.toLowerCase()}...`}),s.step="any";else if(l==="url")s=o.createEl("input",{type:"url",placeholder:"https://..."});else if(l==="email")s=o.createEl("input",{type:"email",placeholder:"email@example.com"});else if(l==="phone")s=o.createEl("input",{type:"tel",placeholder:"+1 234 567 8900"});else if(l==="country")s=o.createEl("input",{type:"text",placeholder:"Country code (e.g., US, GB, DE)"});else if(t==="filePath"&&(this.schemaName==="Image"||this.schemaName==="Video"||this.schemaName==="Audio"||this.schemaName==="Photo"||this.schemaName==="Evidence")){this.createFileUploadField(o,t,this.schemaName);return}else s=o.createEl("input",{type:"text",placeholder:`Enter ${n.label.toLowerCase()}...`});s.id=`entity-${t}`,s.addClass("graph_copilot-entity-input"),s.addEventListener("input",()=>{if(s.type==="number"){let c=parseFloat(s.value);isNaN(c)||(this.properties[t]=c)}else this.properties[t]=s.value})}async handleCreate(){let e=U(this.schemaName);if(!e)return;let t=e.labelField;if(this.properties[t]&&String(this.properties[t]).trim()!==""){let n=ne(this.properties[t],this.schemaName);if(!n.isValid){new P.Notice(n.error||"Invalid entity name");return}}try{let n=await this.entityManager.createFTMEntity(this.schemaName,this.properties,{skipAutoGeocode:!0});new P.Notice(`Created ${e.label}: ${n.label}`),this.onEntityCreated&&this.onEntityCreated(n.id),this.close()}catch(n){new P.Notice(`Failed to create entity: ${n}`),console.error("FTM Entity creation error:",n)}}createFileUploadField(e,t,n){let i=e.createDiv({cls:"graph_copilot-file-upload-wrapper"});i.style.cssText=`
            border: 2px dashed var(--background-modifier-border);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            background: var(--background-secondary);
            transition: all 0.2s ease;
        `;let o=i.createEl("button",{text:`\u{1F4C1} Upload ${n} File`,cls:"graph_copilot-upload-btn"});o.style.marginBottom="8px",o.onclick=c=>{c.preventDefault(),s.click()};let a=i.createEl("span",{text:"or drag and drop here",cls:"graph_copilot-upload-hint"});a.style.cssText="display: block; font-size: 12px; color: var(--text-muted);";let s=i.createEl("input",{type:"file",cls:"graph_copilot-file-input"});s.style.display="none",n==="Image"||n==="Photo"?s.accept="image/*":n==="Video"?s.accept="video/*":n==="Audio"&&(s.accept="audio/*");let l=async c=>{try{a.textContent=`Uploading ${c.name}...`;let d="/Assets/OSINT-Media/";n==="Image"||n==="Photo"?d="/Assets/OSINT-Photos/":n==="Video"?d="/Assets/OSINT-Videos/":n==="Audio"&&(d="/Assets/OSINT-Audio/");let p=await c.arrayBuffer(),h=c.name.replace(/[^a-zA-Z0-9.-]/g,"_"),u=`${d}${Date.now()}_${h}`,y=d.split("/").filter(v=>v),m="";for(let v of y)m+=(m?"/":"")+v,await this.app.vault.adapter.exists(m)||await this.app.vault.createFolder(m);if(await this.app.vault.createBinary(u.replace(/^\//,""),p),this.properties[t]=u.replace(/^\//,""),a.textContent=`\u2705 Uploaded: ${c.name}`,o.textContent="Change file",i.style.borderColor="var(--interactive-accent)",!this.properties.title&&document.getElementById("entity-title")){let v=document.getElementById("entity-title");v.value=c.name,this.properties.title=c.name}(n==="Image"||n==="Photo"||n==="Video"||n==="Audio")&&(this.properties.fileName||(this.properties.fileName=c.name)),new P.Notice(`File uploaded: ${u}`)}catch(d){console.error("File upload error:",d),a.textContent="\u274C Upload failed",new P.Notice(`Upload failed: ${d}`)}};s.addEventListener("change",c=>{let d=c.target.files;d&&d.length>0&&l(d[0])}),i.addEventListener("dragover",c=>{c.preventDefault(),i.style.borderColor="var(--interactive-accent)",i.style.background="var(--background-primary-alt)"}),i.addEventListener("dragleave",c=>{c.preventDefault(),this.properties[t]||(i.style.borderColor="var(--background-modifier-border)",i.style.background="var(--background-secondary)")}),i.addEventListener("drop",c=>{c.preventDefault(),i.style.borderColor="var(--background-modifier-border)",i.style.background="var(--background-secondary)",c.dataTransfer&&c.dataTransfer.files.length>0&&l(c.dataTransfer.files[0])})}onClose(){let{contentEl:e}=this;e.empty()}},be=class k extends P.Modal{constructor(e,t,n){super(e);this.searchInput=null;this.gridContainer=null;this.entityTypes=[];this.PRIORITY_ORDER=["Person","Company","Event","Group","BankAccount","Credentials","UserAccount","Location","Address","Evidence","Document","Video","Image","Photo","Malware","CryptoWallet","Domain","Website","IP"];this.entityManager=t,this.onEntityCreated=n||null}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("graph_copilot-entity-selector-modal");let t=e.createDiv({cls:"graph_copilot-entity-selector-header"});t.style.cssText="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;";let n=t.createEl("h2",{text:"Create new entity"});n.style.margin="0";let i=t.createEl("button",{text:"+ new custom type"});i.style.cssText="font-size: 13px; padding: 4px 10px; cursor: pointer;",i.onclick=()=>{this.close();let l=this.app.plugins.plugins["osint-copilot"];l&&l.customTypesService?new ie(this.app,l.customTypesService,void 0,c=>{new k(this.app,this.entityManager,this.onEntityCreated||void 0).open()}).open():new P.Notice("Error: OSINT copilot plugin instance not found.")},e.createEl("p",{text:"Select the type of entity to create:"});let o=e.createDiv({cls:"graph_copilot-entity-search-container"});o.style.cssText="margin-bottom: 12px;",this.searchInput=o.createEl("input",{type:"text",placeholder:"Search entity types...",cls:"graph_copilot-entity-search-input"}),this.searchInput.style.cssText=`
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--background-modifier-border);
            border-radius: 6px;
            background: var(--background-primary);
            color: var(--text-normal);
            font-size: 14px;
        `,this.searchInput.addEventListener("input",()=>this.filterEntityTypes());let a=e.createDiv({cls:"graph_copilot-entity-scroll-container"});a.style.cssText=`
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        `,this.gridContainer=a.createDiv({cls:"graph_copilot-entity-type-grid"}),this.entityTypes=De(),this.renderEntityTypes(this.entityTypes);let s=e.createEl("button",{text:"Cancel",cls:"graph_copilot-entity-cancel-btn"});s.onclick=()=>this.close(),setTimeout(()=>this.searchInput?.focus(),50)}filterEntityTypes(){let e=this.searchInput?.value.toLowerCase()||"",t=this.entityTypes.filter(n=>n.label.toLowerCase().includes(e)||n.description.toLowerCase().includes(e)||n.name.toLowerCase().includes(e));this.renderEntityTypes(t)}renderEntityTypes(e){if(!this.gridContainer)return;if(this.gridContainer.empty(),e.length===0){let s=this.gridContainer.createDiv({cls:"graph_copilot-no-results"});s.style.cssText=`
                text-align: center;
                padding: 20px;
                color: var(--text-muted);
            `,s.textContent="No entity types match your search.";return}let t=[...e].sort((s,l)=>{let c=this.PRIORITY_ORDER.indexOf(s.name),d=this.PRIORITY_ORDER.indexOf(l.name);return c!==-1&&d!==-1?c-d:c!==-1?-1:d!==-1?1:s.label.localeCompare(l.label)}),n=this.searchInput&&this.searchInput.value.trim().length>0,i=t,o=[];n||(i=t.filter(s=>this.PRIORITY_ORDER.includes(s.name)),o=t.filter(s=>!this.PRIORITY_ORDER.includes(s.name)));let a=(s,l)=>{let c=l.createDiv({cls:"graph_copilot-entity-type-btn"});c.style.borderLeftColor=s.color,c.style.position="relative";let d=c.createDiv({cls:"graph_copilot-entity-type-icon"});d.style.backgroundColor=s.color,d.style.fontSize="20px",d.style.display="flex",d.style.alignItems="center",d.style.justifyContent="center",d.textContent=J(s.name);let p=c.createDiv({cls:"graph_copilot-entity-type-info"});p.createEl("strong",{text:s.label}),p.createEl("small",{text:s.description});let h=this.app.plugins.plugins["osint-copilot"];if(h&&h.customTypesService&&h.customTypesService.getCustomSchema(s.name)){let y=c.createDiv({cls:"graph_copilot-type-actions"});y.style.cssText="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: none; gap: 6px; z-index: 10;",c.onmouseenter=()=>y.style.display="flex",c.onmouseleave=()=>y.style.display="none";let m=y.createEl("button",{text:"\u270E"});m.title="Edit type",m.style.cssText="padding: 4px 8px; background: var(--interactive-accent); color: white; border: none; border-radius: 4px; cursor: pointer;",m.onclick=f=>{f.stopPropagation(),this.close(),new ie(this.app,h.customTypesService,h.customTypesService.getCustomSchema(s.name),x=>{new k(this.app,this.entityManager,this.onEntityCreated||void 0).open()}).open()};let v=y.createEl("button",{text:"\u{1F5D1}"});v.title="Delete type",v.style.cssText="padding: 4px 8px; background: var(--background-modifier-error); color: white; border: none; border-radius: 4px; cursor: pointer;",v.onclick=async f=>{f.stopPropagation(),confirm(`Delete custom type "${s.label}"?`)&&(await h.customTypesService.deleteCustomType(s.name),this.entityTypes=De(),this.filterEntityTypes())}}c.onclick=()=>{this.close(),new Ne(this.app,this.entityManager,s.name,this.onEntityCreated||void 0).open()}};for(let s of i)a(s,this.gridContainer);if(o.length>0){let s=this.gridContainer.createDiv({cls:"graph_copilot-entity-divider"});s.style.cssText=`
                grid-column: 1 / -1;
                margin: 15px 0;
                border-top: 1px solid var(--background-modifier-border);
                position: relative;
                text-align: center;
            `;let l=s.createEl("button",{text:"Show more"});l.style.cssText=`
                position: relative;
                top: -12px;
                background: var(--background-primary);
                padding: 0 10px;
                color: var(--text-muted);
                border: 1px solid var(--background-modifier-border);
                border-radius: 12px;
                font-size: 12px;
                cursor: pointer;
            `;let c=this.gridContainer.createDiv({cls:"graph_copilot-entity-hidden-container"});c.style.cssText=`
                grid-column: 1 / -1;
                display: none;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 10px;
            `,c.addClass("graph_copilot-entity-type-grid"),c.style.marginTop="0";for(let d of o)a(d,c);l.onclick=()=>{let d=c.style.display==="none";c.style.display=d?"grid":"none",l.textContent=d?"Show Less":"Show More"}}}onClose(){let{contentEl:e}=this;e.empty()}},ve=class extends P.Modal{constructor(e,t,n,i){super(e);this.properties={};this.optionalSectionExpanded=!1;this.geocodeStatusEl=null;this.entityManager=t,this.entity=n,this.schemaName=n.ftmSchema||String(n.type),this.properties={...n.properties},this.onEntityUpdated=i||null,this.geocodingService=new q}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("graph_copilot-entity-modal"),e.addClass("graph_copilot-ftm-modal");let t=U(this.schemaName);if(!t){this.renderNonFTMEntityEditor(e);return}e.createEl("h2",{text:`Edit ${t.label}`}),e.createEl("p",{text:`Editing: ${this.entity.label}`,cls:"graph_copilot-entity-modal-description"});let n=e.createDiv({cls:"graph_copilot-entity-form"});if(t.requiredProperties.length>0){n.createEl("h4",{text:"Required properties",cls:"graph_copilot-section-header"});for(let l of t.requiredProperties){let c=t.propertyDefinitions[l];c&&this.createFTMPropertyField(n,l,c,!0)}}let i=t.featuredProperties.filter(l=>!t.requiredProperties.includes(l));if(i.length>0){n.createEl("h4",{text:"Key properties",cls:"graph_copilot-section-header"});for(let l of i){let c=t.propertyDefinitions[l];c&&this.createFTMPropertyField(n,l,c,!1)}}if(t.optionalProperties.length>0){let l=e.createDiv({cls:"graph_copilot-optional-section"}),c=l.createDiv({cls:"graph_copilot-optional-header"}),d=c.createSpan({cls:"graph_copilot-toggle-icon",text:"\u25B6"});c.createSpan({text:` Additional Properties (${t.optionalProperties.length})`});let p=l.createDiv({cls:"graph_copilot-optional-content"});p.style.display="none",c.onclick=()=>{this.optionalSectionExpanded=!this.optionalSectionExpanded,d.textContent=this.optionalSectionExpanded?"\u25BC":"\u25B6",p.style.display=this.optionalSectionExpanded?"block":"none"};for(let h of t.optionalProperties){let u=t.propertyDefinitions[h];u&&!u.hidden&&this.createFTMPropertyField(p,h,u,!1)}}(this.schemaName==="Location"||this.schemaName==="Address")&&(!this.properties.latitude||!this.properties.longitude)&&this.createGeocodingSection(e);let o=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),a=o.createEl("button",{text:"Save changes",cls:"mod-cta"});a.onclick=()=>this.handleSave();let s=o.createEl("button",{text:"Cancel"});s.onclick=()=>this.close()}createFTMPropertyField(e,t,n,i){let o=e.createDiv({cls:"graph_copilot-entity-field"});o.createEl("label",{text:n.label+(i?" *":"")}).setAttribute("for",`entity-${t}`);let s,l=this.properties[t],c=n.type||"string";if(c==="boolean"){let d=o.createDiv({cls:"graph_copilot-toggle-container"});d.style.cssText="display: flex; align-items: center; gap: 12px; margin-top: 4px;",s=d.createEl("input",{type:"checkbox"}),s.id=`entity-${t}`,s.style.display="none",l&&(s.checked=!0);let p=d.createEl("button",{cls:"graph_copilot-toggle-btn"});p.type="button",p.style.cssText=`
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 10px 20px;
                font-size: 14px;
                font-weight: 500;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s ease;
                border: 2px solid var(--background-modifier-border);
                background: var(--background-secondary);
                color: var(--text-muted);
            `;let h=p.createSpan({cls:"toggle-icon"});h.textContent="\u{1F4C5}",h.style.fontSize="16px";let u=p.createSpan({cls:"toggle-text"}),y=m=>{m?(p.style.background="var(--interactive-accent)",p.style.borderColor="var(--interactive-accent)",p.style.color="white",u.textContent="On timeline \u2713"):(p.style.background="var(--background-secondary)",p.style.borderColor="var(--background-modifier-border)",p.style.color="var(--text-muted)",u.textContent="Add to timeline")};y(!!l),p.addEventListener("click",()=>{let m=!s.checked;s.checked=m,this.properties[t]=m,y(m)}),p.addEventListener("mouseenter",()=>{s.checked||(p.style.borderColor="var(--interactive-accent)",p.style.color="var(--text-normal)")}),p.addEventListener("mouseleave",()=>{y(s.checked)});return}else if(c==="text"||t==="description"||t==="notes"||t==="summary")s=o.createEl("textarea",{placeholder:`Enter ${n.label.toLowerCase()}...`}),s.rows=3,l&&(s.value=l);else if(c==="date")s=o.createEl("input",{type:"date"}),l&&(s.value=l);else if(c==="number")s=o.createEl("input",{type:"number",placeholder:`Enter ${n.label.toLowerCase()}...`}),s.step="any",l!=null&&(s.value=l.toString());else if(c==="url")s=o.createEl("input",{type:"url",placeholder:"https://..."}),l&&(s.value=l);else if(c==="email")s=o.createEl("input",{type:"email",placeholder:"email@example.com"}),l&&(s.value=l);else if(c==="phone")s=o.createEl("input",{type:"tel",placeholder:"+1 234 567 8900"}),l&&(s.value=l);else if(c==="country")s=o.createEl("input",{type:"text",placeholder:"Country code (e.g., US, GB, DE)"}),l&&(s.value=l);else if(c==="country")s=o.createEl("input",{type:"text",placeholder:"Country code (e.g., US, GB, DE)"}),l&&(s.value=l);else if(t==="filePath"&&(this.schemaName==="Image"||this.schemaName==="Video"||this.schemaName==="Audio"||this.schemaName==="Photo"||this.schemaName==="Evidence")){this.createFileUploadField(o,t,this.schemaName,l);return}else s=o.createEl("input",{type:"text",placeholder:`Enter ${n.label.toLowerCase()}...`}),l&&(s.value=l);s.id=`entity-${t}`,s.addClass("graph_copilot-entity-input"),s.addEventListener("input",()=>{if(s.type==="number"){let d=parseFloat(s.value);isNaN(d)||(this.properties[t]=d)}else this.properties[t]=s.value})}createGeocodingSection(e){let t=e.createDiv({cls:"graph_copilot-geocoding-section"});t.style.cssText=`
            margin-top: 20px;
            padding: 15px;
            background: var(--background-secondary);
            border-radius: 6px;
            border-left: 3px solid var(--interactive-accent);
        `;let n=t.createEl("h4",{text:"\u{1F4CD} geocoding"});n.style.cssText="margin-top: 0; margin-bottom: 10px;";let i=t.createEl("p",{text:"This entity is missing coordinates. Click the button below to automatically geocode the address.",cls:"text-muted"});i.style.cssText="font-size: 12px; margin-bottom: 12px;",this.geocodeStatusEl=t.createDiv({cls:"graph_copilot-geocode-status"}),this.geocodeStatusEl.style.cssText="margin-bottom: 10px; font-size: 12px;";let o=t.createEl("button",{text:"\u{1F4CD} geolocate address"});o.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid var(--interactive-accent);
            background: var(--interactive-accent);
            color: white;
            font-weight: 500;
        `,o.onclick=async()=>{await this.handleGeocode(o)}}createFileUploadField(e,t,n,i){let o=e.createDiv({cls:"graph_copilot-file-upload-wrapper"});if(o.style.cssText=`
            border: 2px dashed var(--background-modifier-border);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            background: var(--background-secondary);
            transition: all 0.2s ease;
        `,i){o.style.borderColor="var(--interactive-accent)";let d=o.createDiv({cls:"graph_copilot-current-file"});d.style.marginBottom="10px",d.innerHTML=`
                <div style="font-weight: bold; margin-bottom: 4px;">Current File:</div>
                <div style="font-size: 12px; color: var(--text-accent); word-break: break-all;">${i}</div>
            `}let a=o.createEl("button",{text:i?`Replace ${n} File`:`\u{1F4C1} Upload ${n} File`,cls:"graph_copilot-upload-btn"});a.style.marginBottom="8px",a.onclick=d=>{d.preventDefault(),l.click()};let s=o.createEl("span",{text:"or drag and drop to replace",cls:"graph_copilot-upload-hint"});s.style.cssText="display: block; font-size: 12px; color: var(--text-muted);";let l=o.createEl("input",{type:"file",cls:"graph_copilot-file-input"});l.style.display="none",n==="Image"||n==="Photo"?l.accept="image/*":n==="Video"?l.accept="video/*":n==="Audio"?l.accept="audio/*":(n==="Document"||n==="Evidence")&&(l.accept=".pdf,.docx,.doc,.md,.png,.jpeg,.jpg");let c=async d=>{try{s.textContent=`Uploading ${d.name}...`;let p="/Assets/OSINT-Media/";n==="Image"||n==="Photo"?p="/Assets/OSINT-Photos/":n==="Video"?p="/Assets/OSINT-Videos/":n==="Audio"?p="/Assets/OSINT-Audio/":(n==="Document"||n==="Evidence")&&(p="/Assets/OSINT-Documents/");let h=await d.arrayBuffer(),u=d.name.replace(/[^a-zA-Z0-9.-]/g,"_"),y=`${p}${Date.now()}_${u}`,m=p.split("/").filter(x=>x),v="";for(let x of m)v+=(v?"/":"")+x,await this.app.vault.adapter.exists(v)||await this.app.vault.createFolder(v);await this.app.vault.createBinary(y.replace(/^\//,""),h),this.properties[t]=y.replace(/^\//,""),s.textContent=`\u2705 Uploaded: ${d.name}`,a.textContent="Change file",o.style.borderColor="var(--interactive-accent)";let f=o.querySelector(".graph_copilot-current-file");f&&(f.innerHTML=`
                        <div style="font-weight: bold; margin-bottom: 4px;">New File:</div>
                        <div style="font-size: 12px; color: var(--text-accent); word-break: break-all;">${y.replace(/^\//,"")}</div>
                    `),new P.Notice(`File uploaded: ${y}`)}catch(p){console.error("File upload error:",p),s.textContent="\u274C Upload failed",new P.Notice(`Upload failed: ${p}`)}};l.addEventListener("change",d=>{let p=d.target.files;p&&p.length>0&&c(p[0])}),o.addEventListener("dragover",d=>{d.preventDefault(),o.style.borderColor="var(--interactive-accent)",o.style.background="var(--background-primary-alt)"}),o.addEventListener("dragleave",d=>{d.preventDefault(),o.style.borderColor=i?"var(--interactive-accent)":"var(--background-modifier-border)",o.style.background="var(--background-secondary)"}),o.addEventListener("drop",d=>{d.preventDefault(),o.style.borderColor="var(--background-modifier-border)",o.style.background="var(--background-secondary)",d.dataTransfer&&d.dataTransfer.files.length>0&&c(d.dataTransfer.files[0])})}async handleGeocode(e){let t,n,i,o;if(this.schemaName==="Location"?(t=this.properties.address,n=this.properties.city,o=this.properties.country):this.schemaName==="Address"&&(t=this.properties.street||this.properties.full,n=this.properties.city,i=this.properties.state,o=this.properties.country),!t&&!n&&!o){this.updateGeocodeStatus("\u26A0\uFE0F No address information found. Please fill in address fields first.","error");return}try{e.disabled=!0,e.textContent="Geocoding...",this.updateGeocodeStatus("\u{1F504} Geocoding address...","info");let a=await this.geocodingService.geocodeAddressWithRetry(t,n,i,o,(s,l,c)=>{this.updateGeocodeStatus(`\u26A0\uFE0F Network error, retrying in ${c}s... (attempt ${s}/${l})`,"warning")});this.properties.latitude=a.latitude,this.properties.longitude=a.longitude,a.city&&!n&&(this.properties.city=a.city),a.state&&!i&&this.schemaName==="Address"&&(this.properties.state=a.state),a.country&&!o&&(this.properties.country=a.country),a.postalCode&&this.schemaName==="Address"&&!this.properties.postalCode&&(this.properties.postalCode=a.postalCode),this.updateGeocodeStatus(`\u2713 Geocoded: ${a.displayName} 
Lat: ${a.latitude.toFixed(6)}, Lng: ${a.longitude.toFixed(6)} 
Confidence: ${a.confidence} `,"success"),e.disabled=!1,e.textContent="\u2713 geocoded successfully",e.style.background="var(--text-success)",new P.Notice("Geocoding successful! Don't forget to save your changes.")}catch(a){e.disabled=!1,e.textContent="\u{1F4CD} geolocate address",a instanceof R?(this.updateGeocodeStatus(`\u2717 ${a.message} `,"error"),new P.Notice(`Geocoding failed: ${a.message} `)):(console.error("[FTMEntityEditModal] Geocoding error:",a),this.updateGeocodeStatus("\u2717 Failed to geocode address. Please try again.","error"),new P.Notice("Failed to geocode address. Please try again."))}}updateGeocodeStatus(e,t){if(!this.geocodeStatusEl)return;this.geocodeStatusEl.textContent=e;let n="var(--text-muted)";t==="success"?n="var(--text-success)":t==="warning"?n="var(--text-warning)":t==="error"&&(n="var(--text-error)"),this.geocodeStatusEl.style.color=n,this.geocodeStatusEl.style.whiteSpace="pre-line"}async handleSave(){let e=U(this.schemaName);if(!e)return;let t=e.labelField;if(this.properties[t]&&String(this.properties[t]).trim()!==""){let n=ne(this.properties[t],this.schemaName);if(!n.isValid){new P.Notice(n.error||"Invalid entity name");return}}try{let n=await this.entityManager.updateEntity(this.entity.id,this.properties);n?(new P.Notice(`Updated ${e.label}: ${n.label} `),this.onEntityUpdated&&this.onEntityUpdated(this.entity.id),this.close()):new P.Notice("Failed to update entity: entity not found")}catch(n){new P.Notice(`Failed to update entity: ${n} `),console.error("FTM Entity update error:",n)}}renderNonFTMEntityEditor(e){e.createEl("h2",{text:`Edit ${this.schemaName} `}),e.createEl("p",{text:`Editing: ${this.entity.label} `,cls:"graph_copilot-entity-modal-description"});let t=e.createDiv({cls:"graph_copilot-info-message"});t.style.cssText=`
padding: 12px;
margin - bottom: 20px;
background: var(--background - secondary);
border - left: 3px solid var(--interactive - accent);
border - radius: 4px;
`,t.createEl("p",{text:"This is a non - standard entity type.You can edit its properties below.",cls:"text-muted"});let n=e.createDiv({cls:"graph_copilot-entity-form"}),i=Object.keys(this.properties);if(i.length>0){n.createEl("h4",{text:"Properties",cls:"graph_copilot-section-header"});for(let m of i)this.createGenericPropertyField(n,m)}let o=e.createDiv({cls:"graph_copilot-add-property-section"});o.style.cssText="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--background-modifier-border);",o.createEl("h4",{text:"Add new property",cls:"graph_copilot-section-header"});let a=o.createDiv({cls:"graph_copilot-add-property-container"});a.style.cssText="display: flex; gap: 10px; align-items: flex-end;";let s=a.createDiv({cls:"graph_copilot-entity-field"});s.style.flex="1",s.createEl("label",{text:"Property name"});let l=s.createEl("input",{type:"text",placeholder:"e.g., address, phone, email"});l.addClass("graph_copilot-entity-input");let c=a.createDiv({cls:"graph_copilot-entity-field"});c.style.flex="2",c.createEl("label",{text:"Property value"});let d=c.createEl("input",{type:"text",placeholder:"Enter value..."});d.addClass("graph_copilot-entity-input");let p=a.createEl("button",{text:"+ add"});p.style.cssText="padding: 8px 16px; margin-bottom: 2px;",p.onclick=()=>{let m=l.value.trim(),v=d.value.trim();if(!m){new P.Notice("Please enter a property name");return}if(!v){new P.Notice("Please enter a property value");return}this.properties[m]=v,e.empty(),this.renderNonFTMEntityEditor(e),new P.Notice(`Added property: ${m} `)},this.schemaName==="Location"&&(!this.properties.latitude||!this.properties.longitude)&&this.createGeocodingSection(e);let h=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),u=h.createEl("button",{text:"Save changes",cls:"mod-cta"});u.onclick=()=>this.handleNonFTMSave();let y=h.createEl("button",{text:"Cancel"});y.onclick=()=>this.close()}createGenericPropertyField(e,t){let n=e.createDiv({cls:"graph_copilot-entity-field"});n.style.cssText="display: flex; gap: 10px; align-items: flex-start;";let i=n.createDiv();i.style.flex="1",i.createEl("label",{text:t}).setAttribute("for",`entity - ${t} `);let a=this.properties[t],s=i.createEl("input",{type:"text",value:String(a||"")});s.id=`entity - ${t} `,s.addClass("graph_copilot-entity-input"),s.addEventListener("input",()=>{this.properties[t]=s.value});let l=n.createEl("button",{text:"\u{1F5D1}"});l.style.cssText="padding: 8px 12px; margin-top: 24px;",l.title="Delete property",l.onclick=()=>{delete this.properties[t],n.remove(),new P.Notice(`Deleted property: ${t} `)}}async handleNonFTMSave(){try{let e=await this.entityManager.updateEntity(this.entity.id,this.properties);e?(new P.Notice(`Updated ${this.schemaName}: ${e.label} `),this.onEntityUpdated&&this.onEntityUpdated(this.entity.id),this.close()):new P.Notice("Failed to update entity: entity not found")}catch(e){new P.Notice(`Failed to update entity: ${e} `),console.error("Non-FTM Entity update error:",e)}}onClose(){let{contentEl:e}=this;e.empty()}},Ee=class k extends P.Modal{constructor(e,t,n,i,o){super(e);this.sourceEntityId=null;this.targetEntityId=null;this.searchInput=null;this.gridContainer=null;this.intervalTypes=[];this.entityManager=t,this.onConnectionCreated=n||null,this.sourceEntityId=i||null,this.targetEntityId=o||null}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("graph_copilot-entity-selector-modal");let t=e.createDiv({cls:"graph_copilot-header-container"});t.style.cssText="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;";let n=t.createEl("h2",{text:"Create new connection"});n.style.margin="0";let i=t.createEl("button",{text:"+ new custom connection"});i.style.cssText="font-size: 13px; padding: 4px 10px; cursor: pointer;",i.onclick=()=>{this.close();let l=this.app.plugins.plugins["osint-copilot"];l&&l.customTypesService?new ie(this.app,l.customTypesService,void 0,c=>{new k(this.app,this.entityManager,this.onConnectionCreated||void 0,this.sourceEntityId||void 0,this.targetEntityId||void 0).open()},"Interval").open():new P.Notice("Error: OSINT copilot plugin instance not found.")},e.createEl("p",{text:"Select the type of relationship/interval to create:"});let o=e.createDiv({cls:"graph_copilot-entity-search-container"});o.style.cssText="margin-bottom: 12px;",this.searchInput=o.createEl("input",{type:"text",placeholder:"Search relationship types...",cls:"graph_copilot-entity-search-input"}),this.searchInput.style.cssText=`
width: 100 %;
padding: 8px 12px;
border: 1px solid var(--background - modifier - border);
border - radius: 6px;
background: var(--background - primary);
color: var(--text - normal);
font - size: 14px;
`,this.searchInput.addEventListener("input",()=>this.filterIntervalTypes());let a=e.createDiv({cls:"graph_copilot-entity-scroll-container"});a.style.cssText=`
max - height: 400px;
overflow - y: auto;
padding - right: 8px;
`,this.gridContainer=a.createDiv({cls:"graph_copilot-entity-type-grid"}),this.intervalTypes=$e(),this.renderIntervalTypes(this.intervalTypes);let s=e.createEl("button",{text:"Cancel",cls:"graph_copilot-entity-cancel-btn"});s.onclick=()=>this.close(),setTimeout(()=>this.searchInput?.focus(),50)}filterIntervalTypes(){let e=this.searchInput?.value.toLowerCase()||"",t=this.intervalTypes.filter(n=>n.label.toLowerCase().includes(e)||n.description.toLowerCase().includes(e)||n.name.toLowerCase().includes(e));this.renderIntervalTypes(t)}renderIntervalTypes(e){if(this.gridContainer){if(this.gridContainer.empty(),e.length===0){let t=this.gridContainer.createDiv({cls:"graph_copilot-no-results"});t.style.cssText=`
text - align: center;
padding: 20px;
color: var(--text - muted);
`,t.textContent="No relationship types match your search.";return}for(let t of e){let n=this.gridContainer.createDiv({cls:"graph_copilot-entity-type-btn"});n.style.borderLeftColor=t.color,n.style.position="relative";let i=n.createDiv({cls:"graph_copilot-entity-type-icon"});i.style.backgroundColor=t.color,i.textContent="\u{1F517}";let o=n.createDiv({cls:"graph_copilot-entity-type-info"});o.createEl("strong",{text:t.label}),o.createEl("small",{text:t.description});let a=this.app.plugins.plugins["osint-copilot"];if(a&&a.customTypesService&&a.customTypesService.getCustomSchema(t.name)){let l=n.createDiv({cls:"graph_copilot-type-actions"});l.style.cssText="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: none; gap: 6px; z-index: 10;",n.onmouseenter=()=>l.style.display="flex",n.onmouseleave=()=>l.style.display="none";let c=l.createEl("button",{text:"\u270E"});c.title="Edit type",c.style.cssText="padding: 4px 8px; margin-right: 5px; background: var(--interactive-accent); color: white; border: none; border-radius: 4px; cursor: pointer;",c.onclick=p=>{p.stopPropagation(),this.close(),new ie(this.app,a.customTypesService,a.customTypesService.getCustomSchema(t.name),h=>{new k(this.app,this.entityManager,this.onConnectionCreated||void 0,this.sourceEntityId||void 0,this.targetEntityId||void 0).open()},"Interval").open()};let d=l.createEl("button",{text:"\u{1F5D1}"});d.title="Delete type",d.style.cssText="padding: 4px 8px; background: var(--background-modifier-error); color: white; border: none; border-radius: 4px; cursor: pointer;",d.onclick=async p=>{p.stopPropagation(),confirm(`Delete custom relationship type "${t.label}"?`)&&(await a.customTypesService.deleteCustomType(t.name),this.intervalTypes=$e(),this.filterIntervalTypes())}}n.onclick=()=>{this.close(),new Fe(this.app,this.entityManager,t.name,this.onConnectionCreated||void 0,this.sourceEntityId||void 0,this.targetEntityId||void 0).open()}}}}onClose(){let{contentEl:e}=this;e.empty()}},Fe=class extends P.Modal{constructor(e,t,n,i,o,a){super(e);this.properties={};this.sourceEntityId=null;this.targetEntityId=null;this.entities=[];this.entityManager=t,this.intervalType=n,this.onConnectionCreated=i||null,this.sourceEntityId=o||null,this.targetEntityId=a||null}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("graph_copilot-entity-modal"),this.entities=this.entityManager.getAllEntities();let t=U(this.intervalType);if(!t){new P.Notice(`Unknown interval type: ${this.intervalType} `),this.close();return}if(e.createEl("h2",{text:`Create ${t.label} `}),e.createEl("p",{text:t.description,cls:"graph_copilot-entity-modal-description"}),this.entities.length<2){e.createEl("p",{text:"You need at least 2 entities to create a connection.",cls:"graph_copilot-connection-warning"});let c=e.createEl("button",{text:"Close"});c.onclick=()=>this.close();return}let n=e.createDiv({cls:"graph_copilot-entity-form"}),i=Object.entries(t.propertyDefinitions).filter(([c,d])=>d.type==="entity").map(([c,d])=>c);for(let c of i)this.createEntityDropdown(n,c,t.propertyDefinitions[c]);let o=[...t.requiredProperties,...t.featuredProperties].filter(c=>!i.includes(c));for(let c of o){let d=t.propertyDefinitions[c];d&&this.createPropertyField(n,c,d,t.requiredProperties.includes(c))}if(t.optionalProperties.length>0){e.createEl("h4",{text:"Additional properties"});let c=e.createDiv({cls:"graph_copilot-entity-form"});for(let d of t.optionalProperties){let p=t.propertyDefinitions[d];p&&!p.hidden&&!i.includes(d)&&this.createPropertyField(c,d,p,!1)}}let a=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),s=a.createEl("button",{text:`Create ${t.label} `,cls:"mod-cta"});s.onclick=()=>this.handleCreate();let l=a.createEl("button",{text:"Cancel"});l.onclick=()=>this.close()}createEntityDropdown(e,t,n){let i=e.createDiv({cls:"graph_copilot-entity-field"});i.createEl("label",{text:n.label+" *"});let o=i.createEl("select",{cls:"graph_copilot-entity-input"}),a=o.createEl("option",{text:`Select ${n.label.toLowerCase()}...`,value:""});a.disabled=!0;let s=t==="person"||t==="owner"||t==="employee"||t==="director"?this.sourceEntityId:t==="associate"||t==="asset"||t==="employer"||t==="organization"?this.targetEntityId:null;a.selected=!s;let l=n.range,c=l?this.entities.filter(d=>d.type===l||d.ftmSchema===l):this.entities;for(let d of c){let p=o.createEl("option",{text:`${d.label} (${d.type})`,value:d.id});s&&d.id===s&&(p.selected=!0,this.properties[t]=d.id)}o.onchange=()=>{this.properties[t]=o.value||null}}createPropertyField(e,t,n,i){let o=e.createDiv({cls:"graph_copilot-entity-field"});o.createEl("label",{text:n.label+(i?" *":"")}).setAttribute("for",`interval - ${t} `);let s;n.type==="text"||t==="description"||t==="summary"?(s=o.createEl("textarea",{placeholder:`Enter ${n.label.toLowerCase()}...`}),s.rows=3):n.type==="date"||t.includes("Date")?s=o.createEl("input",{type:"date"}):n.type==="number"||t.includes("percentage")||t.includes("Count")||t.includes("Value")?(s=o.createEl("input",{type:"number",placeholder:`Enter ${n.label.toLowerCase()}...`}),s.step="any"):s=o.createEl("input",{type:"text",placeholder:`Enter ${n.label.toLowerCase()}...`}),s.id=`interval - ${t} `,s.addClass("graph_copilot-entity-input"),s.addEventListener("input",()=>{if(s.type==="number"){let l=parseFloat(s.value);isNaN(l)||(this.properties[t]=l)}else this.properties[t]=s.value})}async handleCreate(){let e=U(this.intervalType);if(e)try{let t=Object.entries(e.propertyDefinitions).filter(([n,i])=>i.type==="entity").map(([n,i])=>n);if(t.length>=2){let n=this.properties[t[0]],i=this.properties[t[1]];if(!n||!i){new P.Notice("Please select both entities for the connection");return}if(n===i){new P.Notice("Source and target entities must be different");return}let o=await this.entityManager.createConnection(n,i,this.intervalType);if(o){let a=this.entityManager.getEntity(n),s=this.entityManager.getEntity(i);new P.Notice(`Created: ${a?.label} \u2192 ${this.intervalType} \u2192 ${s?.label} `),this.onConnectionCreated&&this.onConnectionCreated(o.id),this.close()}else new P.Notice("Failed to create connection")}else new P.Notice("This interval type requires at least two entity references")}catch(t){new P.Notice(`Failed to create ${e.label}: ${t} `),console.error("Interval creation error:",t)}}onClose(){let{contentEl:e}=this;e.empty()}},xe=class extends P.Modal{constructor(e,t,n,i){super(e);this.properties={};this.entityManager=t,this.connection=n,this.properties=n.properties?{...n.properties}:{},this.onConnectionUpdated=i||null}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("graph_copilot-entity-modal"),e.addClass("graph_copilot-ftm-modal");let t=this.connection.ftmSchema||this.connection.relationship,n=U(t);if(!n){this.renderNonFTMConnectionEditor(e,t);return}let i=this.entityManager.getEntity(this.connection.fromEntityId),o=this.entityManager.getEntity(this.connection.toEntityId);if(!i||!o){e.createEl("p",{text:"Error: source or target entity not found"});let h=e.createEl("button",{text:"Close"});h.onclick=()=>this.close();return}e.createEl("h2",{text:`Edit ${n.label} `}),e.createEl("p",{text:`${i.label} \u2192 ${this.connection.relationship} \u2192 ${o.label} `,cls:"graph_copilot-entity-modal-description"});let a=e.createDiv({cls:"graph_copilot-connection-details"});a.style.cssText=`
background: var(--background - secondary);
padding: 12px;
border - radius: 6px;
margin - bottom: 16px;
`,a.createEl("div",{text:`From: ${i.label} `}),a.createEl("div",{text:`To: ${o.label} `}),a.createEl("div",{text:`Type: ${this.connection.relationship} `});let s=e.createDiv({cls:"graph_copilot-entity-form"}),l=[...n.featuredProperties,...n.optionalProperties].filter(h=>{let u=n.propertyDefinitions[h];return u&&u.type!=="entity"&&!u.hidden});if(l.length===0)s.createEl("p",{text:"This connection type has no editable properties.",cls:"graph_copilot-entity-modal-description"});else{s.createEl("h4",{text:"Connection properties",cls:"graph_copilot-section-header"});for(let h of l){let u=n.propertyDefinitions[h];if(!u)continue;let y=n.requiredProperties.includes(h);this.createPropertyField(s,h,u,y)}}let c=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),d=c.createEl("button",{text:"Save changes",cls:"mod-cta"});d.onclick=()=>this.handleSave();let p=c.createEl("button",{text:"Cancel"});p.onclick=()=>this.close()}createPropertyField(e,t,n,i){let o=e.createDiv({cls:"graph_copilot-entity-field"});o.createEl("label",{text:n.label+(i?" *":"")}).setAttribute("for",`conn - edit - ${t} `);let s,l=this.properties[t]||"";n.type==="text"||t==="description"||t==="summary"?(s=o.createEl("textarea",{placeholder:`Enter ${n.label.toLowerCase()}...`}),s.rows=3,s.value=l):n.type==="date"||t.includes("Date")?(s=o.createEl("input",{type:"date"}),s.value=l):n.type==="number"||t.includes("percentage")||t.includes("Count")||t.includes("Value")||t.includes("amount")?(s=o.createEl("input",{type:"number",placeholder:`Enter ${n.label.toLowerCase()}...`}),s.step="any",s.value=l):(s=o.createEl("input",{type:"text",placeholder:`Enter ${n.label.toLowerCase()}...`}),s.value=l),s.id=`conn - edit - ${t} `,s.addClass("graph_copilot-entity-input"),s.addEventListener("input",()=>{if(s.type==="number"){let c=parseFloat(s.value);isNaN(c)?delete this.properties[t]:this.properties[t]=c}else{let c=s.value.trim();c?this.properties[t]=c:delete this.properties[t]}})}async handleSave(){let e=this.connection.ftmSchema||this.connection.relationship,t=U(e);try{await this.entityManager.updateConnection(this.connection.id,this.properties),new P.Notice("Connection updated successfully"),this.onConnectionUpdated&&this.onConnectionUpdated(this.connection.id),this.close()}catch(n){new P.Notice(`Failed to update connection: ${n} `),console.error("Connection update error:",n)}}renderNonFTMConnectionEditor(e,t){let n=this.entityManager.getEntity(this.connection.fromEntityId),i=this.entityManager.getEntity(this.connection.toEntityId);if(!n||!i){e.createEl("p",{text:"Error: source or target entity not found"});let x=e.createEl("button",{text:"Close"});x.onclick=()=>this.close();return}e.createEl("h2",{text:"Edit connection"}),e.createEl("p",{text:`${n.label} \u2192 ${this.connection.relationship} \u2192 ${i.label} `,cls:"graph_copilot-entity-modal-description"});let o=e.createDiv({cls:"graph_copilot-info-message"});o.style.cssText=`
padding: 12px;
margin - bottom: 20px;
background: var(--background - secondary);
border - left: 3px solid var(--interactive - accent);
border - radius: 4px;
`,o.createEl("p",{text:"This is a non - standard relationship type.You can edit its properties below.",cls:"text-muted"});let a=e.createDiv({cls:"graph_copilot-entity-form"}),s=Object.keys(this.properties);if(s.length>0){a.createEl("h4",{text:"Properties",cls:"graph_copilot-section-header"});for(let x of s)this.createGenericConnectionPropertyField(a,x)}let l=e.createDiv({cls:"graph_copilot-add-property-section"});l.style.cssText="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--background-modifier-border);",l.createEl("h4",{text:"Add new property",cls:"graph_copilot-section-header"});let c=l.createDiv({cls:"graph_copilot-add-property-container"});c.style.cssText="display: flex; gap: 10px; align-items: flex-end;";let d=c.createDiv({cls:"graph_copilot-entity-field"});d.style.flex="1",d.createEl("label",{text:"Property name"});let p=d.createEl("input",{type:"text",placeholder:"e.g., date, location, notes"});p.addClass("graph_copilot-entity-input");let h=c.createDiv({cls:"graph_copilot-entity-field"});h.style.flex="2",h.createEl("label",{text:"Property value"});let u=h.createEl("input",{type:"text",placeholder:"Enter value..."});u.addClass("graph_copilot-entity-input");let y=c.createEl("button",{text:"+ add"});y.style.cssText="padding: 8px 16px; margin-bottom: 2px;",y.onclick=()=>{let x=p.value.trim(),g=u.value.trim();if(!x){new P.Notice("Please enter a property name");return}if(!g){new P.Notice("Please enter a property value");return}this.properties[x]=g,e.empty(),this.renderNonFTMConnectionEditor(e,t),new P.Notice(`Added property: ${x} `)};let m=e.createDiv({cls:"graph_copilot-entity-modal-buttons"}),v=m.createEl("button",{text:"Save changes",cls:"mod-cta"});v.onclick=()=>this.handleNonFTMConnectionSave();let f=m.createEl("button",{text:"Cancel"});f.onclick=()=>this.close()}createGenericConnectionPropertyField(e,t){let n=e.createDiv({cls:"graph_copilot-entity-field"});n.style.cssText="display: flex; gap: 10px; align-items: flex-start;";let i=n.createDiv();i.style.flex="1",i.createEl("label",{text:t}).setAttribute("for",`connection - ${t} `);let a=this.properties[t],s=i.createEl("input",{type:"text",value:String(a||"")});s.id=`connection - ${t} `,s.addClass("graph_copilot-entity-input"),s.addEventListener("input",()=>{this.properties[t]=s.value});let l=n.createEl("button",{text:"\u{1F5D1}"});l.style.cssText="padding: 8px 12px; margin-top: 24px;",l.title="Delete property",l.onclick=()=>{delete this.properties[t],n.remove(),new P.Notice(`Deleted property: ${t} `)}}async handleNonFTMConnectionSave(){try{await this.entityManager.updateConnection(this.connection.id,this.properties),new P.Notice("Connection updated successfully"),this.onConnectionUpdated&&this.onConnectionUpdated(this.connection.id),this.close()}catch(e){new P.Notice(`Failed to update connection: ${e} `),console.error("Non-FTM Connection update error:",e)}}onClose(){let{contentEl:e}=this;e.empty()}};var ze=require("obsidian"),oe=class extends ze.Modal{constructor(r,e,t,n,i,o=!1){super(r),this.title=e,this.message=t,this.onConfirm=n,this.onCancel=i,this.destructive=o}onOpen(){let{contentEl:r}=this;r.addClass("vault-ai-confirm-modal"),r.createEl("h2",{text:this.title}),r.createDiv({text:this.message,cls:"vault-ai-confirm-message"});let e=r.createDiv({cls:"graph_copilot-confirm-buttons"});e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.onCancel&&this.onCancel(),this.close()});let n=e.createEl("button",{text:"Confirm",cls:this.destructive?"mod-warning graph_copilot-confirm-btn--danger":"mod-cta"});n.addEventListener("click",()=>{this.onConfirm(),this.close()}),setTimeout(()=>n.focus(),50)}onClose(){let{contentEl:r}=this;r.empty()}};var we=class{constructor(r=100){this.undoStack=[];this.redoStack=[];this.maxHistorySize=100;this.callbacks=null;this.listeners=new Set;this.maxHistorySize=r}setCallbacks(r){this.callbacks=r}addListener(r){this.listeners.add(r)}removeListener(r){this.listeners.delete(r)}notifyListeners(){this.listeners.forEach(r=>r())}generateId(){return`hist_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}recordEntityCreate(r){let e={id:this.generateId(),type:"entity_create",timestamp:new Date,description:`Created entity: ${r.label}`,entityData:{...r}};this.pushToUndoStack(e)}recordEntityDelete(r){let e={id:this.generateId(),type:"entity_delete",timestamp:new Date,description:`Deleted entity: ${r.label}`,entityData:{...r}};this.pushToUndoStack(e)}recordEntityEdit(r,e){let t={id:this.generateId(),type:"entity_edit",timestamp:new Date,description:`Edited entity: ${e.label}`,entityData:{...e},previousEntityData:{...r}};this.pushToUndoStack(t)}recordRelationshipEdit(r,e){let t={id:this.generateId(),type:"relationship_edit",timestamp:new Date,description:`Edited relationship: ${e.relationship}`,connectionData:{...e},previousConnectionData:{...r}};this.pushToUndoStack(t)}recordRelationshipCreate(r){let e={id:this.generateId(),type:"relationship_create",timestamp:new Date,description:`Created relationship: ${r.relationship}`,connectionData:{...r}};this.pushToUndoStack(e)}recordRelationshipDelete(r){let e={id:this.generateId(),type:"relationship_delete",timestamp:new Date,description:`Deleted relationship: ${r.relationship}`,connectionData:{...r}};this.pushToUndoStack(e)}recordNodePositionChange(r,e){let t={id:this.generateId(),type:"node_position_change",timestamp:new Date,description:`Moved ${e.size} node(s)`,nodePositions:new Map(e),previousNodePositions:new Map(r)};this.pushToUndoStack(t)}pushToUndoStack(r){for(this.undoStack.push(r),this.redoStack=[];this.undoStack.length>this.maxHistorySize;)this.undoStack.shift();this.notifyListeners()}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}getUndoStack(){return[...this.undoStack]}getRedoStack(){return[...this.redoStack]}getCurrentPosition(){return this.undoStack.length}getTotalHistorySize(){return this.undoStack.length+this.redoStack.length}async undo(){if(!this.canUndo()||!this.callbacks)return!1;let r=this.undoStack.pop();try{return await this.executeUndo(r),this.redoStack.push(r),this.notifyListeners(),!0}catch(e){return console.error("[GraphHistoryManager] Undo failed:",e),this.undoStack.push(r),!1}}async redo(){if(!this.canRedo()||!this.callbacks)return!1;let r=this.redoStack.pop();try{return await this.executeRedo(r),this.undoStack.push(r),this.notifyListeners(),!0}catch(e){return console.error("[GraphHistoryManager] Redo failed:",e),this.redoStack.push(r),!1}}async undoToEntry(r){let e=this.undoStack.findIndex(n=>n.id===r);if(e===-1)return!1;let t=this.undoStack.length-e;for(let n=0;n<t;n++)if(!await this.undo())return!1;return!0}async redoToEntry(r){let e=this.redoStack.findIndex(n=>n.id===r);if(e===-1)return!1;let t=this.redoStack.length-e;for(let n=0;n<t;n++)if(!await this.redo())return!1;return!0}async executeUndo(r){if(this.callbacks)switch(r.type){case"entity_create":r.entityData&&await this.callbacks.onEntityDelete(r.entityData.id);break;case"entity_delete":r.entityData&&await this.callbacks.onEntityRestore(r.entityData);break;case"entity_edit":r.previousEntityData&&await this.callbacks.onEntityUpdate(r.previousEntityData);break;case"relationship_create":r.connectionData&&await this.callbacks.onConnectionDelete(r.connectionData.id);break;case"relationship_delete":r.connectionData&&await this.callbacks.onConnectionRestore(r.connectionData);break;case"relationship_edit":r.previousConnectionData&&await this.callbacks.onConnectionUpdate(r.previousConnectionData);break;case"node_position_change":r.previousNodePositions&&this.callbacks.onNodePositionChange(r.previousNodePositions);break;case"batch_operation":if(r.subOperations)for(let e=r.subOperations.length-1;e>=0;e--)await this.executeUndo(r.subOperations[e]);break}}async executeRedo(r){if(this.callbacks)switch(r.type){case"entity_create":r.entityData&&await this.callbacks.onEntityRestore(r.entityData);break;case"entity_delete":r.entityData&&await this.callbacks.onEntityDelete(r.entityData.id);break;case"entity_edit":r.entityData&&await this.callbacks.onEntityUpdate(r.entityData);break;case"relationship_create":r.connectionData&&await this.callbacks.onConnectionRestore(r.connectionData);break;case"relationship_delete":r.connectionData&&await this.callbacks.onConnectionDelete(r.connectionData.id);break;case"relationship_edit":r.connectionData&&await this.callbacks.onConnectionUpdate(r.connectionData);break;case"node_position_change":r.nodePositions&&this.callbacks.onNodePositionChange(r.nodePositions);break;case"batch_operation":if(r.subOperations)for(let e of r.subOperations)await this.executeRedo(e);break}}clear(){this.undoStack=[],this.redoStack=[],this.notifyListeners()}getLastUndoDescription(){return this.undoStack.length===0?null:this.undoStack[this.undoStack.length-1].description}getLastRedoDescription(){return this.redoStack.length===0?null:this.redoStack[this.redoStack.length-1].description}};var Y="graph_copilot-graph-view",Z=".osint-copilot/graph-positions.json",Ce=class extends A.ItemView{constructor(e,t,n,i){super(e);this.cy=null;this.container=null;this.onEntityClick=null;this.onShowOnMap=null;this._keyHandler=null;this.connectionMode=!1;this.sourceNodeId=null;this.sourceNodeLabel=null;this.connectBtn=null;this.statusIndicator=null;this.selectedNodes=new Set;this.selectedEdges=new Set;this.selectionCountEl=null;this.deleteSelectedBtn=null;this.clearSelectionBtn=null;this.boxSelectMode=!1;this.boxSelectBtn=null;this.historyPanel=null;this.historyPanelVisible=!1;this.undoBtn=null;this.redoBtn=null;this.nodePositionsCache=new Map;this.savePositionsDebounced=this.debounce(()=>this.savePositions(),1e3);this.entityManager=t,this.onEntityClick=n||null,this.onShowOnMap=i||null,this.geocodingService=new q,this.historyManager=new we,this.setupHistoryCallbacks()}setupHistoryCallbacks(){this.historyManager.setCallbacks({onEntityCreate:e=>Promise.resolve(),onEntityDelete:e=>(this.cy&&this.cy.getElementById(e).remove(),this.entityManager.deleteEntityInMemory(e),Promise.resolve()),onEntityRestore:async e=>{await this.entityManager.restoreEntity(e),this.addEntityToGraphPreserveLayout(e)},onEntityUpdate:async e=>{await this.entityManager.updateEntityForHistory(e),this.updateEntityInGraph(e)},onConnectionCreate:e=>Promise.resolve(),onConnectionDelete:e=>(this.cy&&this.cy.getElementById(e).remove(),this.entityManager.deleteConnection(e),Promise.resolve()),onConnectionRestore:async e=>{await this.entityManager.restoreConnection(e),this.addConnectionToGraph(e)},onConnectionUpdate:async e=>{await this.entityManager.updateConnectionForHistory(e),this.updateConnectionInGraph(e)},onNodePositionChange:e=>{let t=this.cy;t&&e.forEach((n,i)=>{let o=t.getElementById(i);o.length>0&&o.position(n)})}}),this.historyManager.addListener(()=>this.updateHistoryUI())}getViewType(){return Y}getDisplayText(){return"OSINTCopilot graph"}getIcon(){return"git-fork"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("graph_copilot-graph-container"),this.container=e.createDiv({cls:"graph_copilot-graph-canvas"}),this.container.setCssProps({width:"100%",height:"100%",position:"absolute",top:"0",left:"0"});let t=e.createDiv({cls:"graph_copilot-graph-toolbar"});this.createToolbar(t);try{if(console.debug("[GraphView] Loading Cytoscape.js..."),await this.loadCytoscape(),console.debug("[GraphView] Cytoscape.js loaded successfully"),typeof cytoscape>"u")throw new Error("Cytoscape failed to load - typeof cytoscape is undefined");this.initializeGraph(),console.debug("[GraphView] Graph initialized"),await this.loadSavedPositions(),await this.refreshWithSavedPositions(),console.debug("[GraphView] Graph refreshed with entities")}catch(n){console.error("[GraphView] Failed to initialize graph:",n);let i=e.createDiv({cls:"graph_copilot-error"});i.setCssProps({padding:"20px","text-align":"center",color:"var(--text-error)"}),i.createEl("h3",{text:"Failed to load graph"}).setCssProps({color:"var(--text-error)","margin-bottom":"10px"}),i.createEl("p",{text:n instanceof Error?n.message:String(n)}).setCssProps({"margin-bottom":"15px"});let s=i.createDiv();s.setCssProps({"text-align":"left","max-width":"600px",margin:"0 auto"}),s.createEl("p").createEl("strong",{text:"Possible causes:"});let l=s.createEl("ul"),c=l.createEl("li");c.createEl("strong",{text:"CDN blocked:"}),c.appendText(" Cytoscape.js cannot be loaded from unpkg.com CDN. Check:");let d=c.createEl("ul");d.createEl("li",{text:"Browser extensions (ad blockers, privacy tools)"}),d.createEl("li",{text:"Corporate firewall or network restrictions"}),d.createEl("li",{text:"Content security policy settings"});let p=l.createEl("li");p.createEl("strong",{text:"Network issues"}),p.appendText(" Check your internet connection");let h=l.createEl("li");h.createEl("strong",{text:"Entity manager"}),h.appendText(" Check console for EntityManager initialization errors"),s.createEl("p").createEl("strong",{text:"To debug:"});let u=s.createEl("ol");u.createEl("li",{text:"Open Developer Tools (Ctrl+Shift+I)"}),u.createEl("li",{text:"Check console tab for errors"}),u.createEl("li",{text:"Check network tab for failed requests to unpkg.com"}),u.createEl("li",{text:"Verify plugin settings: enableGraphFeatures should be enabled"}),new A.Notice("Graph failed to load. Check console for details.",1e4)}}async onClose(){this._keyHandler&&document.removeEventListener("keydown",this._keyHandler),this.cy&&(this.cy.destroy(),this.cy=null)}async loadCytoscape(){if(typeof cytoscape<"u"){console.debug("[GraphView] Cytoscape.js already loaded");return}return new Promise((e,t)=>{let n=document.createElement("script");n.src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js";let i=setTimeout(()=>{t(new Error("Cytoscape.js load timeout - CDN request took too long. Check network connection or firewall settings."))},3e4);n.onload=()=>{clearTimeout(i),typeof cytoscape>"u"?t(new Error("Cytoscape script loaded but cytoscape object is undefined. Possible CSP or script execution issue.")):(console.debug("[GraphView] Cytoscape.js loaded from CDN"),e())},n.onerror=o=>{clearTimeout(i),console.error("[GraphView] Failed to load Cytoscape.js from CDN:",o),t(new Error("Failed to load Cytoscape.js from CDN. Possible causes: network issue, firewall blocking unpkg.com, or Content Security Policy restrictions."))},document.head.appendChild(n)})}createToolbar(e){e.setCssProps({position:"absolute",top:"10px",right:"10px","z-index":"100",display:"flex",gap:"5px",background:"var(--background-secondary)",padding:"5px","border-radius":"5px","flex-wrap":"wrap","align-items":"center"});let t=e.createEl("button",{text:"+ add entity"});t.addClass("graph_copilot-add-entity-btn"),t.onclick=()=>this.openEntityCreator(),this.connectBtn=e.createEl("button",{text:"\u{1F517} connect"}),this.connectBtn.addClass("graph_copilot-connect-btn"),this.connectBtn.onclick=()=>this.toggleConnectionMode(),e.createDiv({cls:"graph_copilot-toolbar-separator"}),this.boxSelectBtn=e.createEl("button",{text:"\u2B1A box select"}),this.boxSelectBtn.title="Enter box selection mode to select multiple items by dragging",this.boxSelectBtn.onclick=()=>this.toggleBoxSelectMode(),this.clearSelectionBtn=e.createEl("button",{text:"\u2715 clear selection"}),this.clearSelectionBtn.addClass("graph_copilot-clear-selection-btn"),this.clearSelectionBtn.setCssProps({display:"none"}),this.clearSelectionBtn.onclick=()=>this.clearSelection(),this.deleteSelectedBtn=e.createEl("button",{text:"\u{1F5D1} delete selected"}),this.deleteSelectedBtn.addClass("graph_copilot-delete-selected-btn"),this.deleteSelectedBtn.setCssProps({display:"none"}),this.deleteSelectedBtn.onclick=()=>this.showDeleteConfirmation(),this.selectionCountEl=e.createDiv({cls:"graph_copilot-selection-count"}),this.selectionCountEl.setCssProps({padding:"4px 8px","font-size":"12px",color:"var(--text-muted)",display:"none"}),e.createDiv({cls:"graph_copilot-toolbar-separator"}),this.undoBtn=e.createEl("button",{text:"\u21B6 undo"}),this.undoBtn.addClass("graph_copilot-undo-btn"),this.undoBtn.disabled=!0,this.undoBtn.onclick=()=>this.performUndo(),this.redoBtn=e.createEl("button",{text:"\u21B7 redo"}),this.redoBtn.addClass("graph_copilot-redo-btn"),this.redoBtn.disabled=!0,this.redoBtn.onclick=()=>this.performRedo();let n=e.createEl("button",{text:"\u{1F4DC} history"});n.addClass("graph_copilot-history-btn"),n.onclick=()=>this.toggleHistoryPanel(),e.createDiv({cls:"graph_copilot-toolbar-separator"});let i=e.createEl("button",{text:"\u{1F504} rearrange"});i.title="Rearrange all entities using automatic layout (resets current positions)",i.onclick=()=>{(async()=>await this.showRearrangeConfirmation()&&(i.disabled=!0,i.textContent="\u{1F504} rearranging...",await this.rearrangeGraph(),i.disabled=!1,i.textContent="\u{1F504} rearrange"))()};let o=e.createEl("button",{text:"\u21BB refresh"});o.title="Refresh graph (reload entities while preserving zoom and positions)",o.addClass("graph_copilot-refresh-btn"),o.onclick=()=>{(async()=>{o.disabled=!0;let s=o.textContent;o.textContent="\u21BB refreshing...";try{await this.refreshWithSavedPositions(),new A.Notice("Graph refreshed successfully"),o.setCssProps({"background-color":"var(--interactive-success)"}),setTimeout(()=>{o.setCssProps({"background-color":""})},300)}catch(l){console.error("[GraphView] Manual refresh failed:",l),new A.Notice("Failed to refresh graph. Check console for details."),o.setCssProps({"background-color":"var(--interactive-error)"}),setTimeout(()=>{o.setCssProps({"background-color":""})},300)}finally{o.disabled=!1,o.textContent=s}})()};let a=e.createEl("button",{text:"\u22A1 fit"});a.title="Fit all entities in view",a.onclick=()=>this.cy?.fit(),this.statusIndicator=e.createDiv({cls:"graph_copilot-connection-status"}),this.statusIndicator.setCssProps({display:"none"})}toggleConnectionMode(){this.connectionMode?this.exitConnectionMode():this.enterConnectionMode()}enterConnectionMode(){this.connectionMode=!0,this.sourceNodeId=null,this.sourceNodeLabel=null,this.connectBtn&&(this.connectBtn.addClass("graph_copilot-connect-btn-active"),this.connectBtn.textContent="\u2715 cancel"),this.statusIndicator&&(this.statusIndicator.setCssProps({display:"block"}),this.statusIndicator.textContent="Click source node...",this.statusIndicator.addClass("graph_copilot-connection-status-active")),this.container&&this.container.addClass("graph_copilot-connection-mode"),new A.Notice("Connection mode: click the source node")}exitConnectionMode(){this.connectionMode=!1,this.sourceNodeId=null,this.sourceNodeLabel=null,this.connectBtn&&(this.connectBtn.removeClass("graph_copilot-connect-btn-active"),this.connectBtn.textContent="\u{1F517} connect"),this.statusIndicator&&(this.statusIndicator.setCssProps({display:"none"}),this.statusIndicator.removeClass("graph_copilot-connection-status-active")),this.container&&this.container.removeClass("graph_copilot-connection-mode"),this.cy&&this.cy.nodes().removeClass("connection-source")}toggleBoxSelectMode(){this.boxSelectMode?this.exitBoxSelectMode():this.enterBoxSelectMode()}enterBoxSelectMode(){this.connectionMode&&this.exitConnectionMode(),this.boxSelectMode=!0,this.boxSelectBtn&&(this.boxSelectBtn.addClass("graph_copilot-box-select-active"),this.boxSelectBtn.textContent="\u2B1A exit box select"),this.cy&&(this.cy.boxSelectionEnabled(!0),this.cy.userPanningEnabled(!1)),this.container&&this.container.addClass("graph_copilot-box-select-mode"),new A.Notice("Box select mode: drag to select multiple items")}exitBoxSelectMode(){this.boxSelectMode=!1,this.boxSelectBtn&&(this.boxSelectBtn.removeClass("graph_copilot-box-select-active"),this.boxSelectBtn.textContent="\u2B1A box select"),this.cy&&(this.cy.boxSelectionEnabled(!1),this.cy.userPanningEnabled(!0)),this.container&&this.container.removeClass("graph_copilot-box-select-mode")}async handleEdgeDoubleClick(e){let t=this.entityManager.getConnection(e);if(t){if(t.filePath){let n=this.app.vault.getAbstractFileByPath(t.filePath);if(n instanceof A.TFile){await this.app.workspace.getLeaf().openFile(n);return}}new A.Notice("No note file found for this relationship")}}handleConnectionModeClick(e,t){if(!this.sourceNodeId)this.sourceNodeId=e,this.sourceNodeLabel=t,this.cy&&this.cy.getElementById(e).addClass("connection-source"),this.statusIndicator&&(this.statusIndicator.textContent=`Source: ${t} \u2192 Click target...`),new A.Notice(`Source selected: ${t}. Now click the target node.`);else{if(e===this.sourceNodeId){new A.Notice("Cannot connect a node to itself. Click a different node.");return}new Ee(this.app,this.entityManager,i=>{if(i){let o=this.entityManager.getConnection(i);o&&(this.historyManager.recordRelationshipCreate(o),this.addConnectionToGraph(o))}},this.sourceNodeId,e).open(),this.exitConnectionMode()}}openConnectionModal(){new fe(this.app,this.entityManager,t=>{if(t){let n=this.entityManager.getConnection(t);n&&(this.historyManager.recordRelationshipCreate(n),this.addConnectionToGraph(n))}}).open()}openEntityCreator(){new be(this.app,this.entityManager,t=>{let n=this.entityManager.getEntity(t);n&&(this.historyManager.recordEntityCreate(n),this.addEntityToGraphPreserveLayout(n))}).open()}initializeGraph(){if(!this.container){console.error("[GraphView] Cannot initialize: container is null");return}if(typeof cytoscape>"u")throw console.error("[GraphView] Cannot initialize: cytoscape is undefined"),new Error("Cytoscape is not available. Graph cannot be initialized.");this.cy=cytoscape({container:this.container,style:this.getGraphStyle(),layout:{name:"preset"},minZoom:.1,maxZoom:3,boxSelectionEnabled:!0,selectionType:"additive"}),this.cy.on("tap","node",e=>{let t=e.target,n=t.id(),i=t.data("fullLabel")||t.data("label"),o=e.originalEvent;if(this.connectionMode){this.handleConnectionModeClick(n,i);return}if(o&&(o.ctrlKey||o.metaKey)){this.toggleNodeSelection(n);return}this.clearSelection(),this.selectedNodes.add(n),t.addClass("multi-selected"),this.updateSelectionUI()}),this.cy.on("dbltap","node",e=>{let n=e.target.id();this.connectionMode||(this.onEntityClick?this.onEntityClick(n):this.entityManager.openEntityNote(n))}),this.cy.on("tap","edge",e=>{let t=e.target,n=t.id(),i=e.originalEvent;if(i&&(i.ctrlKey||i.metaKey)){this.toggleEdgeSelection(n);return}this.clearSelection(),this.selectedEdges.add(n),t.addClass("multi-selected"),this.updateSelectionUI()}),this.cy.on("dbltap","edge",e=>{let n=e.target.id();this.handleEdgeDoubleClick(n)}),this.cy.on("cxttap","node",e=>{let t=e.target,n=t.id(),i=t.data("type"),o=t.data("fullLabel")||t.data("label");this.showNodeContextMenu(e.originalEvent,n,i,o)}),this.cy.on("cxttap","edge",e=>{let t=e.target,n=t.id(),i=t.data("label"),o=t.data("source"),a=t.data("target");this.showEdgeContextMenu(e.originalEvent,n,i,o,a)}),this.cy.on("mouseover","node, edge",e=>{let t=e.target,n=t.isNode();this.showGraphTooltip(t,n,e.renderedPosition)}),this.cy.on("mouseout","node, edge",()=>{this.hideGraphTooltip()}),this.cy.on("dragfree","node",e=>{let t=e.target,n=t.id(),i=t.position(),o=this.nodePositionsCache.get(n);if(o&&(o.x!==i.x||o.y!==i.y)){let a=new Map;a.set(n,{...o});let s=new Map;s.set(n,{x:i.x,y:i.y}),this.historyManager.recordNodePositionChange(a,s)}this.nodePositionsCache.set(n,{x:i.x,y:i.y}),this.savePositionsDebounced()}),this.cy.on("mouseover","node",e=>{let t=e.target,n=t.data("type");t.style("border-width",4),n==="Location"&&this.showLocationTooltip(t)}),this.cy.on("mouseout","node",e=>{e.target.style("border-width",2),this.hideLocationTooltip()}),this.cy.on("tap",e=>{e.target===this.cy&&(this.connectionMode?(this.exitConnectionMode(),new A.Notice("Connection mode cancelled")):!this.boxSelectMode&&(this.selectedNodes.size>0||this.selectedEdges.size>0)&&this.clearSelection())}),this.cy.on("boxselect","node",e=>{if(!this.boxSelectMode)return;let t=e.target,n=t.id();this.selectedNodes.has(n)||(this.selectedNodes.add(n),t.addClass("multi-selected"))}),this.cy.on("boxselect","edge",e=>{if(!this.boxSelectMode)return;let t=e.target,n=t.id();this.selectedEdges.has(n)||(this.selectedEdges.add(n),t.addClass("multi-selected"))}),this.cy.on("boxend",()=>{this.boxSelectMode&&(this.cy?.elements().unselect(),setTimeout(()=>{this.updateSelectionUI()},0))}),this.registerKeyboardShortcuts()}registerKeyboardShortcuts(){let e=t=>{if(!this.container?.isConnected)return;let n=document.activeElement,i=n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement||n?.hasAttribute("contenteditable"),o=document.querySelector(".modal-container")!==null;if(i||o){t.key==="Escape"&&!o&&(this.boxSelectMode?this.exitBoxSelectMode():this.connectionMode&&this.exitConnectionMode());return}t.key==="Delete"||t.key==="Backspace"?(this.selectedNodes.size>0||this.selectedEdges.size>0)&&(t.preventDefault(),this.showDeleteConfirmation()):t.key==="Escape"?this.boxSelectMode?(t.preventDefault(),this.exitBoxSelectMode()):this.connectionMode?(t.preventDefault(),this.exitConnectionMode()):(this.selectedNodes.size>0||this.selectedEdges.size>0)&&(t.preventDefault(),this.clearSelection()):t.key==="a"&&(t.ctrlKey||t.metaKey)?(t.preventDefault(),this.selectAll()):t.key==="z"&&(t.ctrlKey||t.metaKey)?(t.preventDefault(),t.shiftKey?this.performRedo():this.performUndo()):t.key==="y"&&(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.performRedo())};document.addEventListener("keydown",e),this._keyHandler=e}toggleNodeSelection(e){if(!this.cy)return;let t=this.cy.getElementById(e);t.length!==0&&(this.selectedNodes.has(e)?(this.selectedNodes.delete(e),t.removeClass("multi-selected")):(this.selectedNodes.add(e),t.addClass("multi-selected")),this.updateSelectionUI())}toggleEdgeSelection(e){if(!this.cy)return;let t=this.cy.getElementById(e);t.length!==0&&(this.selectedEdges.has(e)?(this.selectedEdges.delete(e),t.removeClass("multi-selected")):(this.selectedEdges.add(e),t.addClass("multi-selected")),this.updateSelectionUI())}selectAll(){if(!this.cy)return;this.cy.nodes().forEach(t=>{let n=t.id();this.selectedNodes.add(n),t.addClass("multi-selected")}),this.cy.edges().forEach(t=>{let n=t.id();this.selectedEdges.add(n),t.addClass("multi-selected")}),this.updateSelectionUI();let e=this.selectedNodes.size+this.selectedEdges.size;new A.Notice(`Selected ${this.selectedNodes.size} entities and ${this.selectedEdges.size} relationships`)}clearSelection(){this.cy?.nodes().removeClass("multi-selected"),this.cy?.edges().removeClass("multi-selected"),this.selectedNodes.clear(),this.selectedEdges.clear(),this.updateSelectionUI()}updateSelectionUI(){let e=this.selectedNodes.size,t=this.selectedEdges.size,n=e+t;if(this.selectionCountEl)if(n>0){let i=[];e>0&&i.push(`${e} ${e===1?"entity":"entities"}`),t>0&&i.push(`${t} ${t===1?"relationship":"relationships"}`),this.selectionCountEl.textContent=i.join(", "),this.selectionCountEl.setCssProps({display:"block"})}else this.selectionCountEl.setCssProps({display:"none"});this.deleteSelectedBtn&&(n>0?(this.deleteSelectedBtn.textContent=`\u{1F5D1} Delete Selected (${n})`,this.deleteSelectedBtn.setCssProps({display:"block"}),this.deleteSelectedBtn.ariaLabel=`Delete ${n} selected items`):(this.deleteSelectedBtn.textContent="\u{1F5D1} delete selected",this.deleteSelectedBtn.setCssProps({display:"none"}))),this.clearSelectionBtn&&this.clearSelectionBtn.setCssProps({display:n>0?"block":"none"})}showDeleteConfirmation(){let e=this.selectedNodes.size,t=this.selectedEdges.size;if(e===0&&t===0)return;let n=[];this.selectedNodes.forEach(y=>{let m=this.entityManager.getEntity(y);if(m){let v=m.label!=null?String(m.label):y;n.push(`\u{1F4E6} ${v}`)}});let i=[];this.selectedEdges.forEach(y=>{let m=this.entityManager.getConnection(y);if(m){let v=this.entityManager.getEntity(m.fromEntityId),f=this.entityManager.getEntity(m.toEntityId),x=v?.label!=null?String(v.label):m.fromEntityId,g=f?.label!=null?String(f.label):m.toEntityId;i.push(`\u{1F517} ${x} \u2192 ${m.relationship} \u2192 ${g}`)}});let o=document.createElement("div");o.className="graph_copilot-delete-modal",o.setCssProps({position:"fixed",top:"0",left:"0",right:"0",bottom:"0",background:"rgba(0, 0, 0, 0.5)",display:"flex","align-items":"center","justify-content":"center","z-index":"10000"});let a=document.createElement("div");a.setCssProps({background:"var(--background-primary)",border:"1px solid var(--background-modifier-border)","border-radius":"8px",padding:"20px","max-width":"500px","max-height":"80vh","overflow-y":"auto","box-shadow":"0 4px 20px rgba(0, 0, 0, 0.3)"});let s=[];e>0&&s.push(`${e} ${e===1?"Entity":"Entities"}`),t>0&&s.push(`${t} ${t===1?"Relationship":"Relationships"}`);let l=document.createElement("h3");l.textContent=`Delete ${s.join(" and ")}?`,l.setCssProps({margin:"0 0 15px 0",color:"var(--text-normal)"}),a.appendChild(l);let c=document.createElement("p");e>0?c.textContent="\u26A0\uFE0F entity deletions cannot be undone. Entity Markdown files will be permanently deleted.":c.textContent="\u26A0\uFE0F the following items will be deleted:",c.setCssProps({margin:"0 0 15px 0",color:"var(--text-warning)"}),a.appendChild(c);let d=document.createElement("ul");d.setCssProps({margin:"0 0 20px 0","padding-left":"20px","max-height":"200px","overflow-y":"auto",color:"var(--text-muted)"}),n.forEach(y=>{let m=document.createElement("li");m.textContent=y,d.appendChild(m)}),i.forEach(y=>{let m=document.createElement("li");m.textContent=y,m.setCssProps({"font-size":"0.9em"}),d.appendChild(m)}),a.appendChild(d);let p=document.createElement("div");p.setCssProps({display:"flex",gap:"10px","justify-content":"flex-end"});let h=document.createElement("button");h.textContent="Cancel",h.setCssProps({padding:"8px 16px"}),h.onclick=()=>o.remove(),p.appendChild(h);let u=document.createElement("button");u.textContent=`Delete ${s.join(" and ")}`,u.setCssProps({padding:"8px 16px",background:"var(--text-error)",color:"white",border:"none","border-radius":"4px",cursor:"pointer"}),u.onclick=async()=>{o.remove(),await this.deleteSelectedItems()},p.appendChild(u),a.appendChild(p),o.appendChild(a),o.onclick=y=>{y.target===o&&o.remove()},document.body.appendChild(o)}async deleteSelectedItems(){let e=0,t=0,n=0,i=0,o=Array.from(this.selectedEdges);for(let p of o){let h=this.entityManager.getConnection(p);if(h)try{await this.entityManager.deleteConnectionWithNote(p),this.historyManager.recordRelationshipDelete(h),this.cy&&this.cy.getElementById(p).remove(),t++}catch(u){console.error(`Failed to delete relationship ${p}:`,u),i++}}let a=Array.from(this.selectedNodes),s=[];for(let p of a){let h=this.entityManager.getEntity(p);h&&s.push({...h})}let l=await this.entityManager.deleteEntities(a);for(let p of s)l.failed.includes(p.id)?n++:(this.historyManager.recordEntityDelete(p),e++);if(this.cy)for(let p of a)l.failed.includes(p)||this.cy.getElementById(p).remove();this.selectedNodes.clear(),this.selectedEdges.clear(),this.updateSelectionUI();let c=[],d=[];e>0&&c.push(`${e} ${e===1?"entity":"entities"}`),t>0&&c.push(`${t} ${t===1?"relationship":"relationships"}`),n>0&&d.push(`${n} ${n===1?"entity":"entities"}`),i>0&&d.push(`${i} ${i===1?"relationship":"relationships"}`),d.length===0?new A.Notice(`Successfully deleted ${c.join(" and ")}`):new A.Notice(`Deleted ${c.join(" and ")}. Failed: ${d.join(" and ")}`)}showSingleDeleteConfirmation(e,t){let n=document.createElement("div");n.className="graph_copilot-delete-modal",n.setCssProps({position:"fixed",top:"0",left:"0",right:"0",bottom:"0",background:"rgba(0, 0, 0, 0.5)",display:"flex","align-items":"center","justify-content":"center","z-index":"10000"});let i=document.createElement("div");i.setCssProps({background:"var(--background-primary)",border:"1px solid var(--background-modifier-border)","border-radius":"8px",padding:"20px","max-width":"400px","box-shadow":"0 4px 20px rgba(0, 0, 0, 0.3)"});let o=document.createElement("h3");o.textContent="Delete entity?",o.setCssProps({margin:"0 0 15px 0",color:"var(--text-normal)"}),i.appendChild(o);let a=document.createElement("p");a.createSpan({text:"\u26A0\uFE0F This action cannot be undone. The entity "}),a.createEl("strong",{text:`"${t}"`}),a.createSpan({text:" and its markdown file will be permanently deleted."}),a.setCssProps({margin:"0 0 20px 0",color:"var(--text-warning)"}),i.appendChild(a);let s=document.createElement("div");s.setCssProps({display:"flex",gap:"10px","justify-content":"flex-end"});let l=document.createElement("button");l.textContent="Cancel",l.setCssProps({padding:"8px 16px"}),l.onclick=()=>n.remove(),s.appendChild(l);let c=document.createElement("button");c.textContent="Delete",c.setCssProps({padding:"8px 16px",background:"var(--text-error)",color:"white",border:"none","border-radius":"4px",cursor:"pointer"}),c.onclick=async()=>{n.remove();try{let d=this.entityManager.getEntity(e);await this.entityManager.deleteEntity(e)?(d&&this.historyManager.recordEntityDelete(d),this.cy&&this.cy.getElementById(e).remove(),this.selectedNodes.delete(e),this.updateSelectionUI(),new A.Notice(`Deleted entity: ${t}`)):new A.Notice(`Failed to delete entity: ${t}`)}catch(d){console.error(`Failed to delete entity ${e}:`,d),new A.Notice(`Error deleting entity: ${t}`)}},s.appendChild(c),i.appendChild(s),n.appendChild(i),n.onclick=d=>{d.target===n&&n.remove()},document.body.appendChild(n)}showNodeContextMenu(e,t,n,i){let o=document.querySelector(".graph_copilot-context-menu");o&&o.remove();let a=document.createElement("div");a.className="graph_copilot-context-menu",a.setCssProps({position:"fixed",left:`${e.clientX}px`,top:`${e.clientY}px`,background:"var(--background-primary)",border:"1px solid var(--background-modifier-border)","border-radius":"6px",padding:"4px 0","min-width":"150px","box-shadow":"0 2px 10px rgba(0,0,0,0.2)","z-index":"1000"});let s=this.createMenuItem("\u{1F4C4} Open Note",()=>{this.entityManager.openEntityNote(t),a.remove()});a.appendChild(s);let l=this.createMenuItem("\u270F\uFE0F Edit Entity",()=>{let m=this.entityManager.getEntity(t);if(m){let v={...m,properties:{...m.properties}};new ve(this.app,this.entityManager,m,()=>{let x=this.entityManager.getEntity(t);x&&(this.historyManager.recordEntityEdit(v,x),this.updateEntityInGraph(x))}).open()}else new A.Notice("Entity not found");a.remove()});if(a.appendChild(l),n==="Location"){let m=this.entityManager.getEntity(t);if(m&&m.properties.latitude&&m.properties.longitude){let v=this.createMenuItem("\u{1F5FA}\uFE0F Show on Map",()=>{this.onShowOnMap?this.onShowOnMap(t):new A.Notice("Map view not available"),a.remove()});a.appendChild(v)}}if(n==="Location"||n==="Address"){let m=this.entityManager.getEntity(t);if(m&&!m.properties.latitude&&!m.properties.longitude){let v=this.createMenuItem("\u{1F4CD} Geolocate Address",()=>{a.remove(),this.geolocateEntity(t)});a.appendChild(v)}}if(n==="Event"){let m=this.entityManager.getEntity(t);if(m&&m.properties.start_date){let v=m.properties.add_to_timeline===!0,f=v?"\u{1F4C5} Remove from Timeline":"\u{1F4C5} Add to Timeline",x=this.createMenuItem(f,()=>{(async()=>{try{await this.entityManager.updateEntity(t,{add_to_timeline:!v}),new A.Notice(v?"Removed from Timeline":"Added to Timeline");let g=this.entityManager.getEntity(t);g&&this.updateEntityInGraph(g)}catch(g){console.error("[GraphView] Failed to toggle timeline status:",g),new A.Notice("Failed to update timeline status")}a.remove()})()});a.appendChild(x)}}let c=document.createElement("div");c.setCssProps({height:"1px",background:"var(--background-modifier-border)",margin:"4px 0"}),a.appendChild(c);let d=this.createMenuItem("\u{1F517} Connect to...",()=>{this.enterConnectionMode(),this.handleConnectionModeClick(t,i),a.remove()});a.appendChild(d);let p=document.createElement("div");p.setCssProps({height:"1px",background:"var(--background-modifier-border)",margin:"4px 0"}),a.appendChild(p);let h=this.selectedNodes.size+this.selectedEdges.size;if(h>1&&this.selectedNodes.has(t)){let m=this.createMenuItem(`\u{1F5D1} Delete Selected (${h})`,()=>{a.remove(),this.showDeleteConfirmation()});m.setCssProps({color:"var(--text-error)"}),a.appendChild(m)}let u=this.createMenuItem("\u{1F5D1} Delete Entity",()=>{a.remove(),this.showSingleDeleteConfirmation(t,i)});u.setCssProps({color:"var(--text-error)"}),a.appendChild(u),document.body.appendChild(a);let y=m=>{a.contains(m.target)||(a.remove(),document.removeEventListener("click",y))};setTimeout(()=>document.addEventListener("click",y),0)}createMenuItem(e,t){let n=document.createElement("div");return n.textContent=e,n.setCssProps({padding:"6px 12px",cursor:"pointer","font-size":"13px"}),n.onmouseenter=()=>n.setCssProps({background:"var(--background-modifier-hover)"}),n.onmouseleave=()=>n.setCssProps({background:"transparent"}),n.onclick=t,n}showEdgeContextMenu(e,t,n,i,o){let a=document.querySelector(".graph_copilot-context-menu");a&&a.remove();let s=this.entityManager.getEntity(i),l=this.entityManager.getEntity(o),c=s?.label||i,d=l?.label||o,p=document.createElement("div");p.className="graph_copilot-context-menu",p.setCssProps({position:"fixed",left:`${e.clientX}px`,top:`${e.clientY}px`,background:"var(--background-primary)",border:"1px solid var(--background-modifier-border)","border-radius":"6px",padding:"4px 0","min-width":"180px","box-shadow":"0 2px 10px rgba(0,0,0,0.2)","z-index":"1000"});let h=document.createElement("div");h.setCssProps({padding:"6px 12px","font-size":"11px",color:"var(--text-muted)","border-bottom":"1px solid var(--background-modifier-border)","margin-bottom":"4px"}),h.createEl("strong",{text:c}),h.createSpan({text:" \u2192 "}),h.createEl("strong",{text:d}),h.createEl("br"),h.createEl("em",{text:n}),p.appendChild(h);let u=this.createMenuItem("\u270F\uFE0F Edit Connection",()=>{let f=this.entityManager.getConnection(t);if(f){let x={...f,properties:{...f.properties}};new xe(this.app,this.entityManager,f,()=>{let T=this.entityManager.getConnection(t);T&&(this.historyManager.recordRelationshipEdit(x,T),this.updateConnectionInGraph(T))}).open()}else new A.Notice("Connection not found");p.remove()});p.appendChild(u);let y=this.selectedNodes.size+this.selectedEdges.size;if(y>1&&this.selectedEdges.has(t)){let f=this.createMenuItem(`\u{1F5D1} Delete Selected (${y})`,()=>{p.remove(),this.showDeleteConfirmation()});f.setCssProps({color:"var(--text-error)"}),p.appendChild(f)}let m=this.createMenuItem("\u{1F5D1} Delete Relationship",()=>{p.remove(),this.deleteRelationship(t,n,c,d)});m.setCssProps({color:"var(--text-error)"}),p.appendChild(m),document.body.appendChild(p);let v=f=>{p.contains(f.target)||(p.remove(),document.removeEventListener("click",v))};setTimeout(()=>document.addEventListener("click",v),0)}async deleteRelationship(e,t,n,i){let o=this.entityManager.getConnection(e);if(!o){new A.Notice("Relationship not found");return}new oe(this.app,"Delete Relationship",`Are you sure you want to delete the relationship "${t}" between "${n}" and "${i}"?`,()=>{(async()=>(this.historyManager.recordRelationshipDelete(o),await this.entityManager.deleteConnectionWithNote(e),this.cy&&this.cy.getElementById(e).remove(),new A.Notice(`Deleted relationship: ${t}`)))()},void 0,!0).open()}showGraphTooltip(e,t,n){this.hideGraphTooltip();let i=document.createElement("div");i.id="graph_copilot-tooltip",i.style.cssText=`
            position: fixed; 
            background: var(--background-primary); 
            border: 1px solid var(--background-modifier-border); 
            border-radius: 6px; 
            padding: 8px 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
            z-index: 2000; 
            max-width: 250px; 
            pointer-events: none; 
            font-size: 12px;
        `;let o=i.createDiv();o.setCssProps({"font-weight":"bold","margin-bottom":"4px"});let a=i.createDiv();a.setCssProps({"font-size":"10px",color:"var(--text-muted)","text-transform":"uppercase","letter-spacing":"0.5px"});let s=i.createDiv();if(s.setCssProps({"margin-top":"6px","font-size":"10px",color:"var(--text-accent)"}),s.innerText="Click to select \u2022 double-click to open",t){let c=e.data("fullLabel")||e.data("label"),d=e.data("type");o.innerText=c,a.innerText=d}else{let c=e.data("label");o.innerText=c,a.innerText="RELATIONSHIP"}let l=this.container?.getBoundingClientRect();l&&(i.style.left=`${l.left+n.x+15}px`,i.style.top=`${l.top+n.y+15}px`),document.body.appendChild(i)}hideGraphTooltip(){let e=document.getElementById("graph_copilot-tooltip");e&&e.remove(),this.hideLocationTooltip()}showLocationTooltip(e){let t=e.id(),n=this.entityManager.getEntity(t);if(!n||!n.properties.latitude||!n.properties.longitude)return;this.hideLocationTooltip();let i=document.createElement("div");i.id="graph_copilot-location-tooltip",i.className="graph_copilot-location-tooltip";let o=parseFloat(n.properties.latitude),a=parseFloat(n.properties.longitude),s=i.createDiv();s.setCssProps({"font-weight":"bold","margin-bottom":"4px"}),s.setText(`\u{1F4CD} ${n.label}`);let l=i.createDiv();l.setCssProps({"font-size":"11px",color:"var(--text-muted)"}),l.setText(n.properties.address||""),l.createEl("br"),l.createSpan({text:`Lat: ${o.toFixed(4)}, Lng: ${a.toFixed(4)}`});let c=i.createDiv();c.setCssProps({"font-size":"10px",color:"var(--text-accent)","margin-top":"4px"}),c.setText("Right-click \u2192 show on map"),i.setCssProps({position:"fixed",background:"var(--background-primary)",border:"1px solid var(--background-modifier-border)","border-radius":"6px",padding:"8px 12px","box-shadow":"0 2px 8px rgba(0,0,0,0.15)","z-index":"1000","max-width":"250px","pointer-events":"none"});let d=e.renderedPosition(),p=this.container?.getBoundingClientRect();p&&i.setCssProps({left:`${p.left+d.x+30}px`,top:`${p.top+d.y-20}px`}),document.body.appendChild(i)}hideLocationTooltip(){let e=document.getElementById("graph_copilot-location-tooltip");e&&e.remove()}getGraphStyle(){return[{selector:"node",style:{"background-color":"data(color)",label:e=>{let t=e.data("icon")||"\u{1F4E6}",n=e.data("label")||"",i=e.data("type")||"";return`${t}
${n}
(${i})`},"text-valign":"center","text-halign":"center","font-size":"16px",color:"#ffffff","text-outline-color":"#000000","text-outline-width":1.5,"text-wrap":"wrap","text-max-width":"100px",width:65,height:65,"border-width":2,"border-color":"#ffffff"}},{selector:'node[type = "Location"], node[type = "Address"]',style:{shape:"diamond",width:70,height:80,"border-width":3,"border-color":"#ffffff"}},{selector:'node[type = "Location"].has-coordinates, node[type = "Address"].has-coordinates',style:{"border-style":"double","border-width":4}},{selector:"node:selected",style:{"border-width":4,"border-color":"#ffff00"}},{selector:"node.connection-source",style:{"border-width":5,"border-color":"#00ff00","border-style":"dashed"}},{selector:"node.multi-selected",style:{"border-width":4,"border-color":"#ff6b6b","border-style":"solid","overlay-color":"#ff6b6b","overlay-padding":6,"overlay-opacity":.2}},{selector:"edge",style:{width:2,"line-color":"#888888","target-arrow-color":"#888888","target-arrow-shape":"triangle","curve-style":"bezier",label:"data(label)","font-size":"10px",color:"#cccccc","text-rotation":"autorotate","text-margin-y":-10}},{selector:"edge:selected",style:{width:4,"line-color":"#ffff00"}},{selector:"edge.multi-selected",style:{width:4,"line-color":"#ff6b6b","target-arrow-color":"#ff6b6b","line-style":"solid"}}]}async refresh(){if(!this.cy)return;try{await this.entityManager.loadEntitiesFromNotes()}catch(s){console.error("[GraphView] Failed to reload entities from notes:",s)}let{entities:e,connections:t}=this.entityManager.getGraphData();this.cy.elements().remove();let n=e.map((s,l)=>{let c=s.type==="Location"&&s.properties.latitude&&s.properties.longitude,d=s.label!=null?String(s.label):"";return{data:{id:s.id,label:this.truncateLabel(d),fullLabel:d,type:s.type,color:_[s.type]?.color||"#607D8B",icon:J(s.type),hasCoordinates:c},position:this.getNodePosition(l,e.length),classes:c?"has-coordinates":""}}),i=new Set(e.map(s=>s.id)),a=t.filter(s=>{let l=i.has(s.fromEntityId),c=i.has(s.toEntityId);return!l||!c?(console.warn(`[GraphView] Skipping connection ${s.id}: missing ${l?"target":"source"} entity`),!1):!0}).map(s=>({data:{id:s.id,source:s.fromEntityId,target:s.toEntityId,label:s.relationship}}));this.cy.add([...n,...a]),this.runLayout()}async refreshWithSavedPositions(){if(!this.cy)return;console.debug(`[GraphView] refreshWithSavedPositions called, cache has ${this.nodePositionsCache.size} positions`);try{await this.entityManager.loadEntitiesFromNotes()}catch(c){console.error("[GraphView] Failed to reload entities from notes:",c)}let{entities:e,connections:t}=this.entityManager.getGraphData();console.debug(`[GraphView] Found ${e.length} entities and ${t.length} connections`),this.cy.elements().remove();let n=[],i=[],o=e.map((c,d)=>{let p=c.type==="Location"&&c.properties.latitude&&c.properties.longitude,h=c.label!=null?String(c.label):"",u=this.nodePositionsCache.get(c.id),y;return u?(y=u,i.push(c.id)):(y=this.getNodePosition(d,e.length),n.push(c.id)),{data:{id:c.id,label:this.truncateLabel(h),fullLabel:h,type:c.type,color:_[c.type]?.color||"#607D8B",icon:J(c.type),hasCoordinates:p},position:y,classes:p?"has-coordinates":""}});console.debug(`[GraphView] Nodes with saved positions: ${i.length}, nodes needing layout: ${n.length}`),n.length>0&&n.length<=5&&console.debug("[GraphView] Nodes needing layout:",n),i.length>0&&i.length<=5&&console.debug("[GraphView] Nodes with saved positions:",i);let a=new Set(e.map(c=>c.id)),l=t.filter(c=>{let d=a.has(c.fromEntityId),p=a.has(c.toEntityId);return!d||!p?(console.warn(`[GraphView] Skipping connection ${c.id}: missing ${d?"target":"source"} entity`),!1):!0}).map(c=>({data:{id:c.id,source:c.fromEntityId,target:c.toEntityId,label:c.relationship}}));if(this.cy.add([...o,...l]),this.cy.nodes().forEach(c=>{let d=c.position();this.nodePositionsCache.set(c.id(),{x:d.x,y:d.y})}),n.length>0&&n.length<e.length){let c=this.cy.nodes().filter(d=>n.includes(d.id()));c.length>0&&(c.layout({name:"cose",animate:!0,animationDuration:300,fit:!1,nodeRepulsion:()=>8e3,idealEdgeLength:()=>100}).run(),setTimeout(()=>{c.forEach(d=>{let p=d.position();this.nodePositionsCache.set(d.id(),{x:p.x,y:p.y})}),this.savePositionsDebounced()},400))}else n.length===e.length&&e.length>0&&(this.runLayout(),setTimeout(()=>{this.cy&&(this.cy.nodes().forEach(c=>{let d=c.position();this.nodePositionsCache.set(c.id(),{x:d.x,y:d.y})}),this.savePositionsDebounced())},600));this.cy.fit()}rearrangeGraph(){return new Promise(e=>{if(!this.cy){e();return}this.nodePositionsCache.clear(),this.runLayout(),setTimeout(()=>{this.cy&&(this.cy.nodes().forEach(t=>{let n=t.position();this.nodePositionsCache.set(t.id(),{x:n.x,y:n.y})}),this.savePositions(),new A.Notice("Graph rearranged")),e()},600)})}showRearrangeConfirmation(){return new Promise(e=>{let t=document.createElement("div");t.className="modal-container",t.setCssProps({position:"fixed",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(0, 0, 0, 0.5)",display:"flex","align-items":"center","justify-content":"center","z-index":"1000"});let n=document.createElement("div");n.className="modal",n.setCssProps({background:"var(--background-primary)","border-radius":"8px",padding:"20px","max-width":"400px","box-shadow":"0 4px 20px rgba(0, 0, 0, 0.3)"});let i=document.createElement("h3");i.textContent="Rearrange graph?",i.setCssProps({"margin-top":"0"}),n.appendChild(i);let o=document.createElement("p");o.textContent="Are you sure you want to rearrange all entities? This will reset their current positions.",n.appendChild(o);let a=document.createElement("div");a.setCssProps({display:"flex","justify-content":"flex-end",gap:"10px","margin-top":"20px"});let s=document.createElement("button");s.textContent="Cancel",s.onclick=()=>{t.remove(),e(!1)},a.appendChild(s);let l=document.createElement("button");l.textContent="Rearrange",l.className="mod-cta",l.setCssProps({background:"var(--interactive-accent)",color:"var(--text-on-accent)"}),l.onclick=()=>{t.remove(),e(!0)},a.appendChild(l),n.appendChild(a),t.appendChild(n),document.body.appendChild(t),t.addEventListener("click",c=>{c.target===t&&(t.remove(),e(!1))})})}truncateLabel(e,t=20){let n=e!=null?String(e):"";return n.length<=t?n:n.substring(0,t-3)+"..."}getNodePosition(e,t){let n=Math.max(200,t*30),i=2*Math.PI*e/t;return{x:n*Math.cos(i)+400,y:n*Math.sin(i)+300}}async loadSavedPositions(){try{console.debug(`[GraphView] Looking for positions file at: ${Z} `);let e=this.app.vault.getAbstractFileByPath(Z);if(e instanceof A.TFile){let t=await this.app.vault.read(e),n=JSON.parse(t);this.nodePositionsCache.clear();for(let[i,o]of Object.entries(n))this.nodePositionsCache.set(i,o);console.debug(`[GraphView] Loaded ${this.nodePositionsCache.size} saved node positions: `,Array.from(this.nodePositionsCache.entries()).slice(0,3))}else console.debug("[GraphView] Positions file not found")}catch(e){console.debug("[GraphView] No saved positions found, starting fresh:",e)}}async savePositions(){try{let e={};for(let[o,a]of this.nodePositionsCache.entries())e[o]=a;let t=JSON.stringify(e,null,2);console.debug(`[GraphView] Saving ${Object.keys(e).length} positions to ${Z} `);let n=Z.substring(0,Z.lastIndexOf("/"));try{this.app.vault.getAbstractFileByPath(n)||await this.app.vault.createFolder(n)}catch{}let i=this.app.vault.getAbstractFileByPath(Z);if(i instanceof A.TFile)await this.app.vault.modify(i,t),console.debug("[GraphView] Positions saved successfully (modified existing file)");else try{await this.app.vault.create(Z,t),console.debug("[GraphView] Positions saved successfully (created new file)")}catch(o){if(o.message?.includes("already exists")){let s=this.app.vault.getAbstractFileByPath(Z);s instanceof A.TFile&&(await this.app.vault.modify(s,t),console.debug("[GraphView] Positions saved successfully (modified after race condition)"))}else throw o}}catch(e){console.error("[GraphView] Failed to save positions:",e)}}debounce(e,t){let n=null;return(...i)=>{n&&clearTimeout(n),n=setTimeout(()=>e(...i),t)}}runLayout(){this.cy&&this.cy.layout({name:"cose",animate:!0,animationDuration:500,nodeRepulsion:()=>8e3,idealEdgeLength:()=>100,edgeElasticity:()=>100,nestingFactor:1.2,gravity:.25,numIter:1e3,initialTemp:200,coolingFactor:.95,minTemp:1}).run()}addEntity(e){if(!this.cy||this.cy.getElementById(e.id).length>0)return;let n=e.label!=null?String(e.label):"";this.cy.add({data:{id:e.id,label:this.truncateLabel(n),fullLabel:n,type:e.type,color:_[e.type]?.color||"#607D8B",icon:J(e.type)},position:{x:400,y:300}}),this.runLayout()}addConnection(e){!this.cy||this.cy.getElementById(e.id).length>0||this.cy.add({data:{id:e.id,source:e.fromEntityId,target:e.toEntityId,label:e.relationship}})}removeEntity(e){this.cy&&this.cy.getElementById(e).remove()}highlightEntity(e){if(!this.cy)return;this.cy.elements().unselect();let t=this.cy.getElementById(e);t.length>0&&(t.select(),this.cy.animate({center:{eles:t},zoom:1.5},{duration:300}))}async performUndo(){if(!this.historyManager.canUndo()){new A.Notice("Nothing to undo");return}let e=this.historyManager.getLastUndoDescription();await this.historyManager.undo()?new A.Notice(`Undo: ${e} `):new A.Notice("Undo failed")}async performRedo(){if(!this.historyManager.canRedo()){new A.Notice("Nothing to redo");return}let e=this.historyManager.getLastRedoDescription();await this.historyManager.redo()?new A.Notice(`Redo: ${e} `):new A.Notice("Redo failed")}updateHistoryUI(){if(this.undoBtn){this.undoBtn.disabled=!this.historyManager.canUndo();let e=this.historyManager.getLastUndoDescription();this.undoBtn.title=e?`Undo: ${e} `:"Nothing to undo"}if(this.redoBtn){this.redoBtn.disabled=!this.historyManager.canRedo();let e=this.historyManager.getLastRedoDescription();this.redoBtn.title=e?`Redo: ${e} `:"Nothing to redo"}this.historyPanelVisible&&this.historyPanel&&this.renderHistoryPanelContent()}toggleHistoryPanel(){this.historyPanelVisible?this.hideHistoryPanel():this.showHistoryPanel()}showHistoryPanel(){this.historyPanel&&this.historyPanel.remove(),this.historyPanel=document.createElement("div"),this.historyPanel.className="graph_copilot-history-panel",this.historyPanel.setCssProps({position:"absolute",top:"60px",right:"10px",width:"280px","max-height":"400px",background:"var(--background-primary)",border:"1px solid var(--background-modifier-border)","border-radius":"8px","box-shadow":"0 4px 12px rgba(0,0,0,0.15)","z-index":"99",overflow:"hidden",display:"flex","flex-direction":"column"});let e=document.createElement("div");e.setCssProps({padding:"10px 12px","font-weight":"bold","border-bottom":"1px solid var(--background-modifier-border)",display:"flex","justify-content":"space-between","align-items":"center"}),e.createEl("span",{text:"Edit history"}).setCssProps({"font-weight":"bold"});let n=document.createElement("button");n.textContent="\u2715",n.setCssProps({background:"none",border:"none",cursor:"pointer","font-size":"14px",color:"var(--text-muted)"}),n.onclick=()=>this.hideHistoryPanel(),e.appendChild(n),this.historyPanel.appendChild(e);let i=document.createElement("div");i.className="graph_copilot-history-content",i.setCssProps({flex:"1","overflow-y":"auto",padding:"8px"}),this.historyPanel.appendChild(i),this.container?.parentElement?.appendChild(this.historyPanel),this.historyPanelVisible=!0,this.renderHistoryPanelContent()}hideHistoryPanel(){this.historyPanel&&(this.historyPanel.remove(),this.historyPanel=null),this.historyPanelVisible=!1}renderHistoryPanelContent(){if(!this.historyPanel)return;let e=this.historyPanel.querySelector(".graph_copilot-history-content");if(!e)return;e.innerHTML="";let t=this.historyManager.getUndoStack(),n=this.historyManager.getRedoStack();if(t.length===0&&n.length===0){let o=document.createElement("div");o.setCssProps({"text-align":"center",color:"var(--text-muted)",padding:"20px","font-size":"13px"}),o.textContent="No history yet",e.appendChild(o);return}if(n.length>0){let o=document.createElement("div");o.setCssProps({"font-size":"11px",color:"var(--text-muted)",padding:"4px 8px","text-transform":"uppercase"}),o.textContent="Redo stack",e.appendChild(o),[...n].reverse().forEach((a,s)=>{let l=this.createHistoryItem(a,"redo",s);e.appendChild(l)})}let i=document.createElement("div");if(i.setCssProps({padding:"6px 8px",background:"var(--interactive-accent)",color:"var(--text-on-accent)","border-radius":"4px","font-size":"12px","text-align":"center",margin:"4px 0"}),i.textContent="\u25B6 current state",e.appendChild(i),t.length>0){let o=document.createElement("div");o.setCssProps({"font-size":"11px",color:"var(--text-muted)",padding:"4px 8px","text-transform":"uppercase"}),o.textContent="Undo stack",e.appendChild(o),[...t].reverse().forEach((a,s)=>{let l=this.createHistoryItem(a,"undo",s);e.appendChild(l)})}}createHistoryItem(e,t,n){let i=document.createElement("div");i.setCssProps({padding:"8px",margin:"2px 0",background:"var(--background-secondary)","border-radius":"4px",cursor:"pointer","font-size":"12px",opacity:t==="redo"?"0.6":"1"});let o=this.getHistoryIcon(e.type),a=this.formatTime(e.timestamp),s=i.createDiv();s.setCssProps({display:"flex","justify-content":"space-between","align-items":"center"}),s.createSpan().setText(`${o} ${e.description}`);let c=s.createSpan();return c.setCssProps({"font-size":"10px",color:"var(--text-muted)"}),c.setText(a),i.onmouseenter=()=>i.setCssProps({background:"var(--background-modifier-hover)"}),i.onmouseleave=()=>i.setCssProps({background:"var(--background-secondary)"}),i.onclick=async()=>{t==="undo"?await this.historyManager.undoToEntry(e.id):await this.historyManager.redoToEntry(e.id)},i}getHistoryIcon(e){switch(e){case"entity_create":return"\u2795";case"entity_delete":return"\u{1F5D1}";case"entity_edit":return"\u270F\uFE0F";case"relationship_create":return"\u{1F517}";case"relationship_delete":return"\u2702\uFE0F";case"node_position_change":return"\u2194\uFE0F";case"batch_operation":return"\u{1F4E6}";default:return"\u2022"}}formatTime(e){let n=new Date().getTime()-e.getTime();return n<6e4?"just now":n<36e5?`${Math.floor(n/6e4)}m ago`:n<864e5?`${Math.floor(n/36e5)}h ago`:e.toLocaleDateString()}addEntityToGraphPreserveLayout(e){if(!this.cy||this.cy.getElementById(e.id).length>0)return;let n=_[e.type]||_.Person,i=e.label!=null?String(e.label):"",o=this.truncateLabel(i,15),s=this.nodePositionsCache.get(e.id)||{x:Math.random()*400+100,y:Math.random()*400+100};this.cy.add({data:{id:e.id,label:o,fullLabel:i,type:e.type,color:n.color,icon:J(e.type)},position:s}),this.nodePositionsCache.set(e.id,s)}updateEntityInGraph(e){if(!this.cy)return;let t=this.cy.getElementById(e.id);if(t.length===0)return;let n=_[e.type]||_.Person,i=e.label!=null?String(e.label):"",o=this.truncateLabel(i,15);t.data("label",o),t.data("fullLabel",i),t.data("type",e.type),t.data("color",n.color),t.data("icon",J(e.type))}updateConnectionInGraph(e){if(!this.cy)return;let t=this.cy.getElementById(e.id);t.length!==0&&t.data("label",e.relationship)}addConnectionToGraph(e){!this.cy||this.cy.getElementById(e.id).length>0||this.cy.add({data:{id:e.id,source:e.fromEntityId,target:e.toEntityId,label:e.relationship}})}async geolocateEntity(e){let t=this.entityManager.getEntity(e);if(!t){new A.Notice("Entity not found");return}let n,i,o,a;if(t.type==="Location"?(n=t.properties.address,i=t.properties.city,a=t.properties.country):t.type==="Address"&&(n=t.properties.street||t.properties.full,i=t.properties.city,o=t.properties.state,a=t.properties.country),!n&&!i&&!a){new A.Notice("No address information found. Please add address details to the entity first.");return}try{new A.Notice("Geocoding address...");let s=await this.geocodingService.geocodeAddressWithRetry(n,i,o,a,(d,p,h)=>{new A.Notice(`Network error, retrying in ${h}s... (attempt ${d} / ${p})`)}),l={latitude:s.latitude,longitude:s.longitude};s.city&&!i&&(l.city=s.city),s.state&&!o&&t.type==="Address"&&(l.state=s.state),s.country&&!a&&(l.country=s.country),s.postalCode&&t.type==="Address"&&!t.properties.postalCode&&(l.postalCode=s.postalCode),await this.entityManager.updateEntity(e,l);let c=this.entityManager.getEntity(e);c&&this.updateEntityInGraph(c),new A.Notice(`\u2713 Geocoded: ${s.displayName} 
Lat: ${s.latitude.toFixed(4)}, Lng: ${s.longitude.toFixed(4)} 
Confidence: ${s.confidence} `)}catch(s){s instanceof R?new A.Notice(`Geocoding failed: ${s.message} `):(console.error("[GraphView] Geocoding error:",s),new A.Notice("Failed to geocode address. Please try again."))}}};var ce=require("obsidian");var re="graph_copilot-timeline-view",Te=class extends ce.ItemView{constructor(e,t,n){super(e);this.container=null;this.timelineContainer=null;this.events=[];this.onEventClick=null;this.entityManager=t,this.onEventClick=n||null}getViewType(){return re}getDisplayText(){return"OSINTCopilot timeline"}getIcon(){return"calendar-clock"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("graph_copilot-timeline-container");let t=e.createDiv({cls:"graph_copilot-timeline-toolbar"});this.createToolbar(t),this.timelineContainer=e.createDiv({cls:"graph_copilot-timeline-canvas"}),this.applyStyles(),await this.refresh()}async onClose(){this.events=[]}applyStyles(){this.timelineContainer&&this.timelineContainer.setCssProps({width:"100%",height:"calc(100% - 50px)","overflow-x":"auto","overflow-y":"auto",padding:"20px","box-sizing":"border-box"})}createToolbar(e){e.setCssProps({display:"flex",gap:"10px",padding:"10px",background:"var(--background-secondary)","border-bottom":"1px solid var(--background-modifier-border)"});let t=e.createEl("button",{text:"+ add event"});t.addClass("graph_copilot-add-entity-btn"),t.onclick=()=>this.openEventCreator(),e.createDiv({cls:"graph_copilot-toolbar-separator"});let n=e.createEl("button",{text:"\u21BB refresh"});n.onclick=()=>{(async()=>(n.disabled=!0,n.textContent="\u21BB loading...",await this.refresh(),n.disabled=!1,n.textContent="\u21BB refresh"))()},e.createEl("span",{text:'Shows events with "add to timeline" enabled',cls:"graph_copilot-timeline-info"}).setCssProps({"margin-left":"auto",color:"var(--text-muted)","font-size":"12px"})}openEventCreator(){new K(this.app,this.entityManager,"Event",t=>{this.refresh()}).open()}async refresh(){if(!this.timelineContainer)return;try{await this.entityManager.loadEntitiesFromNotes()}catch(t){console.error("[TimelineView] Failed to reload entities from notes:",t)}let e=this.entityManager.getEntitiesByType("Event");this.events=this.parseEvents(e),this.renderTimeline()}parseEvents(e){let t=[];for(let n of e){if(!n.properties.add_to_timeline)continue;let i=this.parseDate(n.properties.start_date);if(!i)continue;let o=this.parseDate(n.properties.end_date);t.push({id:n.id,label:n.label,start:i,end:o||void 0,color:_.Event.color})}return t.sort((n,i)=>n.start.getTime()-i.start.getTime()),t}parseDate(e){if(!e)return null;try{let t=e.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})/);if(t)return new Date(parseInt(t[1]),parseInt(t[2])-1,parseInt(t[3]),parseInt(t[4]),parseInt(t[5]));let n=new Date(e);if(!isNaN(n.getTime()))return n}catch{console.error("Failed to parse date:",e)}return null}renderTimeline(){if(!this.timelineContainer)return;if(this.timelineContainer.empty(),this.events.length===0){let n=this.timelineContainer.createDiv({cls:"graph_copilot-timeline-empty"});n.setCssProps({"text-align":"center",padding:"40px",color:"var(--text-muted)"}),n.createEl("p",{text:"No events added to the timeline yet."}).setCssProps({"margin-bottom":"10px"}),n.createEl("p",{text:'To add events: create an event entity with a start date, then check the "add to timeline" checkbox.'}).setCssProps({"font-size":"12px"});return}let e=this.timelineContainer.createDiv({cls:"graph_copilot-timeline-wrapper"});e.setCssProps({position:"relative","min-height":"100%","padding-left":"200px"}),e.createDiv({cls:"graph_copilot-timeline-line"}).setCssProps({position:"absolute",left:"180px",top:"0",bottom:"0",width:"4px",background:"var(--interactive-accent)","border-radius":"2px"}),this.events.forEach((n,i)=>{this.renderEvent(e,n,i)})}renderEvent(e,t,n){let i=e.createDiv({cls:"graph_copilot-timeline-event"});i.setCssProps({position:"relative","margin-bottom":"30px","padding-left":"40px"}),i.createDiv({cls:"graph_copilot-timeline-dot"}).setCssProps({position:"absolute",left:"-12px",top:"5px",width:"20px",height:"20px",background:t.color,"border-radius":"50%",border:"3px solid var(--background-primary)","box-shadow":`0 0 0 2px ${t.color}`});let a=i.createDiv({cls:"graph_copilot-timeline-date"});a.setCssProps({position:"absolute",left:"-180px",top:"0",width:"150px","text-align":"right","font-size":"12px",color:"var(--text-muted)"}),a.textContent=this.formatDate(t.start);let s=i.createDiv({cls:"graph_copilot-timeline-card"});s.setCssProps({background:"var(--background-secondary)","border-left":`4px solid ${t.color}`,padding:"15px","border-radius":"0 8px 8px 0",transition:"transform 0.2s, box-shadow 0.2s",cursor:"pointer"});let l=s.createDiv({cls:"graph_copilot-timeline-card-header"});l.setCssProps({display:"flex","justify-content":"space-between","align-items":"flex-start",gap:"10px"}),l.createEl("h4",{text:t.label}).setCssProps({margin:"0",color:"var(--text-normal)",flex:"1"});let d=l.createEl("button",{text:"\u2715 remove",cls:"graph_copilot-timeline-remove-btn"});d.setCssProps({background:"transparent",border:"1px solid var(--text-muted)",color:"var(--text-muted)",padding:"2px 8px","border-radius":"4px","font-size":"11px",cursor:"pointer",transition:"all 0.2s","white-space":"nowrap"}),d.title="Remove from timeline",d.onmouseenter=()=>{d.setCssProps({background:"var(--background-modifier-error)","border-color":"var(--background-modifier-error)",color:"white"})},d.onmouseleave=()=>{d.setCssProps({background:"transparent","border-color":"var(--text-muted)",color:"var(--text-muted)"})},d.onclick=async u=>{u.stopPropagation(),await this.toggleEventTimeline(t.id,!1)};let p=s.createDiv({cls:"graph_copilot-timeline-time"});p.setCssProps({"font-size":"12px",color:"var(--text-muted)","margin-top":"5px"});let h=this.formatTime(t.start);t.end&&(h+=` \u2192 ${this.formatTime(t.end)}`),p.textContent=h,s.onmouseenter=()=>{s.setCssProps({transform:"translateX(5px)","box-shadow":"0 4px 12px rgba(0,0,0,0.2)"})},s.onmouseleave=()=>{s.setCssProps({transform:"translateX(0)","box-shadow":"none"})},s.onclick=u=>{u.target.closest(".graph_copilot-timeline-remove-btn")||(this.onEventClick?this.onEventClick(t.id):this.entityManager.openEntityNote(t.id))},s.addEventListener("contextmenu",u=>{let y=new ce.Menu;y.addItem(m=>{m.setTitle("Edit").setIcon("pencil").onClick(()=>{let v=this.entityManager.getEntity(t.id);v?new K(this.app,this.entityManager,v.type,()=>{this.refresh()},v.properties,v.id).open():new ce.Notice("Entity not found")})}),y.showAtPosition({x:u.clientX,y:u.clientY})})}async toggleEventTimeline(e,t){try{await this.entityManager.updateEntity(e,{add_to_timeline:t}),await this.refresh()}catch(n){console.error("[TimelineView] Failed to toggle event timeline status:",n)}}formatDate(e){let t={year:"numeric",month:"short",day:"numeric"};return e.toLocaleDateString(void 0,t)}formatTime(e){let t={hour:"2-digit",minute:"2-digit"};return e.toLocaleTimeString(void 0,t)}addEvent(e){e.type==="Event"&&this.refresh()}removeEvent(e){this.events=this.events.filter(t=>t.id!==e),this.renderTimeline()}};var B=require("obsidian");var X="graph_copilot-map-view",Me=class extends B.ItemView{constructor(e,t,n){super(e);this.map=null;this.markers=new Map;this.container=null;this.onLocationClick=null;this.entityManager=t,this.onLocationClick=n||null,this.geocodingService=new q}getViewType(){return X}getDisplayText(){return"OSINTCopilot map"}getIcon(){return"map-pin"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("graph_copilot-map-container");let t=e.createDiv({cls:"graph_copilot-map-toolbar"});this.createToolbar(t),this.container=e.createDiv({cls:"graph_copilot-map-canvas"}),this.container.id="graph_copilot-map-"+Date.now(),this.container.id="graph_copilot-map-"+Date.now(),this.container.setCssProps({width:"100%",height:"calc(100% - 50px)"}),await this.loadLeaflet(),this.initializeMap(),setTimeout(()=>{this.refresh()},200)}async onClose(){this.map&&this.map._handlers&&this.map._handlers.forEach(e=>{e.enable()}),this.map&&(this.map.remove(),this.map=null),this.markers.clear()}async loadLeaflet(){if(!(typeof L<"u"))return new Promise((e,t)=>{let n=document.createElement("script");n.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",n.onload=()=>e(),n.onerror=()=>t(new Error("Failed to load Leaflet")),document.head.appendChild(n)})}createToolbar(e){e.setCssProps({display:"flex",gap:"10px",padding:"10px",background:"var(--background-secondary)","border-bottom":"1px solid var(--background-modifier-border)"});let t=e.createEl("button",{text:"+ add location"});t.addClass("graph_copilot-add-entity-btn"),t.onclick=()=>this.openLocationCreator(),e.createDiv({cls:"graph_copilot-toolbar-separator"});let n=e.createEl("button",{text:"\u21BB refresh"});n.onclick=()=>{this.refresh()};let i=e.createEl("button",{text:"\u22A1 fit all"});i.onclick=()=>this.fitAllMarkers();let o=e.createEl("button",{text:"\u{1F4CD} geolocate missing"});o.onclick=()=>this.showGeolocateMissingDialog(),e.createEl("span",{text:"Map shows all location entities with coordinates",cls:"graph_copilot-map-info"}).setCssProps({"margin-left":"auto",color:"var(--text-muted)","font-size":"12px"})}openLocationCreator(){new K(this.app,this.entityManager,"Location",t=>{this.refresh()}).open()}initializeMap(){if(!this.container||typeof L>"u")return;this.map=L.map(this.container.id,{center:[20,0],zoom:2,zoomControl:!0});let e=L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'\xA9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19,crossOrigin:"anonymous"}),t=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community",maxZoom:19}),n=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:'\xA9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors \xA9 <a href="https://carto.com/attributions">CARTO</a>',subdomains:"abcd",maxZoom:20,crossOrigin:"anonymous"});e.on("tileerror",()=>{console.debug("OSM tiles failed, trying fallback..."),this.map.hasLayer(n)||(e.remove(),n.addTo(this.map))}),e.addTo(this.map);let i={OpenStreetMap:e,Satellite:t,"Carto Light":n};L.control.layers(i).addTo(this.map);let o=a=>{let s=this.container?.querySelector(".leaflet-control-layers-toggle");s&&(a==="Satellite"?s.setCssProps({"background-image":'url("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/4/5/8")'}):a==="Carto Light"?s.setCssProps({"background-image":'url("https://a.basemaps.cartocdn.com/light_all/5/15/12.png")'}):s.setCssProps({"background-image":'url("https://tile.openstreetmap.org/5/16/10.png")'}))};this.map.on("baselayerchange",a=>{o(a.name)}),setTimeout(()=>o("OpenStreetMap"),100),setTimeout(()=>{this.map?.invalidateSize()},100),this.map.on("contextmenu",a=>{let s=new B.Menu;s.addItem(l=>{l.setTitle("Create location here").setIcon("map-pin").onClick(()=>{new K(this.app,this.entityManager,"Location",d=>{this.refresh()},{latitude:a.latlng.lat,longitude:a.latlng.lng}).open()})}),s.showAtPosition({x:a.originalEvent.clientX,y:a.originalEvent.clientY})})}async refresh(){if(console.debug("[MapView] refresh() called, map exists:",!!this.map),!this.map)return;try{await this.entityManager.loadEntitiesFromNotes(),console.debug("[MapView] Entities reloaded from notes")}catch(o){console.error("[MapView] Failed to reload entities:",o)}this.markers.forEach(o=>o.remove()),this.markers.clear();let e=this.entityManager.getEntitiesByType("Location"),t=this.entityManager.getAllEntities().filter(o=>o.type==="Address"),n=[...e,...t];console.debug("[MapView] Found Location and Address entities:",n.length,n);let i=this.parseLocations(n);console.debug("[MapView] Parsed locations with coordinates:",i.length,i),i.forEach(o=>{console.debug("[MapView] Adding marker for:",o.label,"at",o.lat,o.lng),this.addMarker(o)}),console.debug("[MapView] Total markers added:",this.markers.size),i.length>0&&this.fitAllMarkers()}parseLocations(e){let t=[];for(let n of e){console.debug("[MapView] Parsing entity:",n.label,"properties:",n.properties);let i=this.parseCoordinate(n.properties.latitude),o=this.parseCoordinate(n.properties.longitude);if(console.debug("[MapView] Parsed coordinates - lat:",i,"lng:",o),i!==null&&o!==null){let a=n.type==="Address"?n.properties.street||n.properties.full:n.properties.address;t.push({id:n.id,label:n.label,lat:i,lng:o,address:a,city:n.properties.city,country:n.properties.country})}else console.debug("[MapView] Skipping entity - missing coordinates")}return t}parseCoordinate(e){if(e==null||e==="")return console.debug("[MapView] parseCoordinate: value is empty/undefined:",e),null;let t=typeof e=="number"?e:parseFloat(e);return isNaN(t)?(console.debug("[MapView] parseCoordinate: value is NaN:",e),null):t}addMarker(e){if(!this.map||typeof L>"u")return;let t=_.Location.color,n=L.divIcon({className:"graph_copilot-map-marker",html:`<div style="
                background: ${t};
                width: 24px;
                height: 24px;
                border-radius: 50% 50% 50% 0;
                transform: rotate(-45deg);
                border: 2px solid white;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            "></div>`,iconSize:[24,24],iconAnchor:[12,24],popupAnchor:[0,-24]}),i=L.marker([e.lat,e.lng],{icon:n}).addTo(this.map),o=this.createPopupContent(e);i.bindPopup(o),i.on("click",()=>{this.onLocationClick&&this.onLocationClick(e.id)}),i.on("contextmenu",a=>{let s=new B.Menu;s.addItem(l=>{l.setTitle("Open note").setIcon("file-text").onClick(()=>{this.entityManager.openEntityNote(e.id)})}),s.addItem(l=>{l.setTitle("Edit").setIcon("pencil").onClick(()=>{let c=this.entityManager.getEntity(e.id);c?new K(this.app,this.entityManager,c.type,()=>{this.refresh()},c.properties,c.id).open():new B.Notice("Entity not found")})}),s.addItem(l=>{l.setTitle("Focus").setIcon("crosshair").onClick(()=>{this.map.setView(i.getLatLng(),16)})}),s.showAtPosition({x:a.originalEvent.clientX,y:a.originalEvent.clientY}),L.DomEvent.stopPropagation(a)}),i.on("dblclick",()=>{this.entityManager.openEntityNote(e.id)}),this.markers.set(e.id,i)}createPopupContent(e){let t='<div style="min-width: 150px;">';if(t+=`<strong>${e.label}</strong>`,e.address&&(t+=`<br><small>${e.address}</small>`),e.city||e.country){let n=[e.city,e.country].filter(Boolean);t+=`<br><small>${n.join(", ")}</small>`}return t+=`<br><small style="color: #888;">
            ${e.lat.toFixed(6)}, ${e.lng.toFixed(6)}
        </small>`,t+=`<br><a href="#" onclick="return false;" style="font-size: 11px;">
            Double-click to open note
        </a>`,t+="</div>",t}fitAllMarkers(){if(!this.map||this.markers.size===0)return;let e=L.latLngBounds([]);this.markers.forEach(t=>{e.extend(t.getLatLng())}),this.map.fitBounds(e,{padding:[50,50]})}addLocation(e){if(e.type!=="Location")return;let t=this.parseCoordinate(e.properties.latitude),n=this.parseCoordinate(e.properties.longitude);t!==null&&n!==null&&this.addMarker({id:e.id,label:e.label,lat:t,lng:n,address:e.properties.address,city:e.properties.city,country:e.properties.country})}removeLocation(e){let t=this.markers.get(e);t&&(t.remove(),this.markers.delete(e))}highlightLocation(e){let t=this.entityManager.getEntity(e);if(!t||!this.map)return;let n=this.markers.get(t.id);n&&(n.openPopup(),this.map.setView(n.getLatLng(),15))}focusLocation(e){console.debug("[MapView] focusLocation called for:",e),console.debug("[MapView] Available markers:",Array.from(this.markers.keys()));let t=this.markers.get(e);t&&this.map?(console.debug("[MapView] Found marker, focusing..."),this.map.setView(t.getLatLng(),15),t.openPopup()):console.debug("[MapView] Marker not found for entity:",e)}showGeolocateMissingDialog(){let t=this.entityManager.getAllEntities().filter(i=>{let o=i.type==="Location"||i.type==="Address",a=!i.properties.latitude||!i.properties.longitude,s=i.properties.address||i.properties.street||i.properties.full||i.properties.city||i.properties.country;return o&&a&&s});if(t.length===0){new B.Notice("No locations found that need geocoding");return}new _e(this.app,t,this.geocodingService,this.entityManager,async()=>{await this.refresh()}).open()}},_e=class extends B.Modal{constructor(r,e,t,n,i){super(r),this.locations=e,this.geocodingService=t,this.entityManager=n,this.onComplete=i}onOpen(){let{contentEl:r}=this;r.empty(),r.createEl("h2",{text:"Geolocate locations"}),r.createEl("p",{text:`Found ${this.locations.length} location(s) without coordinates that can be geocoded.`});let e=r.createDiv({cls:"geolocate-list"});e.setCssProps({"max-height":"400px","overflow-y":"auto",margin:"20px 0"}),this.locations.forEach(o=>{let a=e.createDiv({cls:"geolocate-item"});a.setCssProps({padding:"10px",margin:"5px 0",border:"1px solid var(--background-modifier-border)","border-radius":"4px",display:"flex","justify-content":"space-between","align-items":"center"});let s=a.createDiv();s.createEl("strong",{text:o.label}),s.createEl("br");let l=o.properties.address||o.properties.street||o.properties.full||o.properties.city||o.properties.country;s.createEl("small",{text:String(l),cls:"text-muted"});let c=a.createEl("button",{text:"\u{1F4CD} geolocate"});c.onclick=async()=>{c.disabled=!0,c.textContent="Geocoding...",await this.geolocateEntity(o,c,a)}});let t=r.createDiv({cls:"modal-button-container"});t.setCssProps({display:"flex","justify-content":"flex-end",gap:"10px","margin-top":"20px"});let n=t.createEl("button",{text:"Geolocate all"});n.onclick=async()=>{n.disabled=!0,await this.geolocateAll(),n.disabled=!1};let i=t.createEl("button",{text:"Close"});i.onclick=()=>this.close()}async geolocateEntity(r,e,t){try{let n,i,o,a;r.type==="Location"?(n=r.properties.address,i=r.properties.city,a=r.properties.country):r.type==="Address"&&(n=r.properties.street||r.properties.full,i=r.properties.city,o=r.properties.state,a=r.properties.country);let s=await this.geocodingService.geocodeAddressWithRetry(n,i,o,a,(c,d,p)=>{new B.Notice(`Network error, retrying in ${p}s... (attempt ${c}/${d})`)}),l={latitude:s.latitude,longitude:s.longitude};s.city&&!i&&(l.city=s.city),s.state&&!o&&r.type==="Address"&&(l.state=s.state),s.country&&!a&&(l.country=s.country),s.postalCode&&r.type==="Address"&&!r.properties.postalCode&&(l.postalCode=s.postalCode),await this.entityManager.updateEntity(r.id,l),e.textContent="\u2713 done",e.setCssProps({color:"var(--text-success)"}),t.setCssProps({"border-color":"var(--text-success)"})}catch(n){e.textContent="\u2717 failed",e.setCssProps({color:"var(--text-error)"}),n instanceof R?new B.Notice(`Failed to geocode ${r.label}: ${n.message}`):new B.Notice(`Failed to geocode ${r.label}`),e.disabled=!1}}async geolocateAll(){let r=0,e=0;for(let t of this.locations)try{let n,i,o,a;t.type==="Location"?(n=t.properties.address,i=t.properties.city,a=t.properties.country):t.type==="Address"&&(n=t.properties.street||t.properties.full,i=t.properties.city,o=t.properties.state,a=t.properties.country);let s=await this.geocodingService.geocodeAddressWithRetry(n,i,o,a,(c,d,p)=>{new B.Notice(`Network error, retrying in ${p}s... (attempt ${c}/${d})`)}),l={latitude:s.latitude,longitude:s.longitude};s.city&&!i&&(l.city=s.city),s.state&&!o&&t.type==="Address"&&(l.state=s.state),s.country&&!a&&(l.country=s.country),s.postalCode&&t.type==="Address"&&!t.properties.postalCode&&(l.postalCode=s.postalCode),await this.entityManager.updateEntity(t.id,l),r++}catch(n){console.error(`Failed to geocode ${t.label}:`,n),e++}new B.Notice(`Geocoded ${r} location(s). ${e} failed.`),await this.onComplete(),this.close()}onClose(){let{contentEl:r}=this;r.empty()}};var ue=require("obsidian");var Se=".osint-copilot",We="custom-types.json",Pe=class{constructor(r){this.customSchemas=new Map;this.app=r,this.vault=r.vault}async initialize(){await this.ensureConfigDir(),await this.loadCustomTypes()}async ensureConfigDir(){try{await this.vault.adapter.exists(Se)||await this.vault.createFolder(Se)}catch(r){console.error("[CustomTypesService] Failed to create config folder:",r)}}async loadCustomTypes(){let r=`${Se}/${We}`;if(await this.vault.adapter.exists(r))try{let e=await this.vault.adapter.read(r),t=JSON.parse(e);if(this.customSchemas.clear(),t.schemas&&Array.isArray(t.schemas))for(let n of t.schemas)n.name&&(this.customSchemas.set(n.name,n),H.registerSchema(n));console.debug(`[CustomTypesService] Loaded ${this.customSchemas.size} custom entity types.`)}catch(e){console.error("[CustomTypesService] Failed to load custom types:",e),new ue.Notice("Failed to load custom entity types config.")}}async saveCustomTypes(){await this.ensureConfigDir();let r=`${Se}/${We}`,e={schemas:Array.from(this.customSchemas.values())};try{await this.vault.adapter.write(r,JSON.stringify(e,null,2))}catch(t){console.error("[CustomTypesService] Failed to save custom types:",t),new ue.Notice("Failed to save custom entity types config.")}}async addCustomType(r){if(!r.name)throw new Error("Schema name is required");this.customSchemas.set(r.name,r),H.registerSchema(r),await this.saveCustomTypes(),new ue.Notice(`Custom entity type '${r.label}' added.`)}async updateCustomType(r){if(!r.name||!this.customSchemas.has(r.name))throw new Error(`Custom type ${r.name} does not exist`);await this.addCustomType(r)}async deleteCustomType(r){this.customSchemas.delete(r)&&(await this.saveCustomTypes(),new ue.Notice(`Custom entity type '${r}' removed. Please reload plugin to fully remove from memory.`))}getCustomSchemas(){return Array.from(this.customSchemas.values())}getCustomSchema(r){return this.customSchemas.get(r)}};var ot="gpt-4o-mini",rt="gpt-4o-mini",st="gpt-5-mini",at={systemPrompt:"You are a vault assistant. Answer questions clearly and concisely based on the provided notes. Cite note paths in-line where useful.",maxNotes:15,reportApiKey:"",reportOutputDir:"Reports",graphApiUrl:"https://api.osint-copilot.com",entityBasePath:"OSINTCopilot",enableGraphFeatures:!0,autoRefreshGraph:!0,autoOpenGraphOnEntityCreation:!1,conversationFolder:".osint-copilot/conversations",apiProvider:"default",customCheckpoints:[]},se="https://api.osint-copilot.com",ee="vault-ai-chat-view",ke=class extends b.Plugin{constructor(){super(...arguments);this.index=new Map}async onload(){await this.loadSettings(),this.settings.reportApiKey?this.verifyPermissions():new b.Notice("Osint copilot: license key required for AI features. Visualization features (graph, timeline, map) are free. Configure in settings."),this.customTypesService=new Pe(this.app),await this.customTypesService.initialize(),this.entityManager=new ge(this.app,this.settings.entityBasePath),this.graphApiService=new me(this.settings.graphApiUrl,this.settings.reportApiKey),this.graphApiService.setSettings({apiProvider:"default",customApiUrl:"",customApiKey:"",customModel:""}),this.conversationService=new ye(this.app,this.settings.conversationFolder);try{await this.conversationService.initialize(),console.debug("OSINTCopilot: Conversation service initialized")}catch(t){console.warn("OSINTCopilot: Conversation service initialization had issues:",t)}if(this.settings.enableGraphFeatures){try{await this.entityManager.initialize(),console.debug("OSINTCopilot: Local entity storage initialized")}catch(t){console.warn("OSINTCopilot: Entity storage initialization had issues:",t)}this.graphApiService.checkHealth().then(t=>{t?console.debug("OSINTCopilot: Graph API connected",t):console.debug("OSINTCopilot: Graph API unavailable - running in local-only mode")}).catch(t=>{console.debug("OSINTCopilot: Graph API unavailable - running in local-only mode")})}this.registerView(ee,t=>new he(t,this)),this.registerView(Y,t=>(console.debug("[VaultAIPlugin] Creating GraphView instance"),this.settings.enableGraphFeatures||console.warn("[VaultAIPlugin] Graph features are disabled in settings"),new Ce(t,this.entityManager,n=>this.onEntityClick(n),n=>{this.showEntityOnMap(n)}))),this.registerView(re,t=>new Te(t,this.entityManager,n=>this.onEntityClick(n))),this.registerView(X,t=>new Me(t,this.entityManager,n=>this.onEntityClick(n)));let e=this.addRibbonIcon("message-square","OSINT Copilot chat (Ctrl+click for new pane)",t=>{let n=t.ctrlKey||t.metaKey;this.openChatView(n)});if(this.settings.enableGraphFeatures){let t=this.addRibbonIcon("git-fork","Entity graph (Ctrl+click for new pane)",o=>{let a=o.ctrlKey||o.metaKey;this.openGraphView(a)}),n=this.addRibbonIcon("calendar","Timeline (Ctrl+click for new pane)",o=>{let a=o.ctrlKey||o.metaKey;this.openTimelineView(a)}),i=this.addRibbonIcon("map-pin","Location map (Ctrl+click for new pane)",o=>{let a=o.ctrlKey||o.metaKey;this.openMapView(a)})}await this.buildIndex(),this.registerEvent(this.app.vault.on("modify",t=>{t instanceof b.TFile&&this.indexFile(t)})),this.registerEvent(this.app.vault.on("create",t=>{t instanceof b.TFile&&this.indexFile(t)})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof b.TFile&&this.index.delete(t.path)})),this.addCommand({id:"open-chat-view",name:"Open chat",callback:()=>{this.openChatView()}}),this.addCommand({id:"open-chat-view-new-pane",name:"Open chat in new pane",callback:()=>{this.openChatView(!0)}}),this.addCommand({id:"open-graph-view",name:"Open entity graph",callback:()=>{this.openGraphView()}}),this.addCommand({id:"open-graph-view-new-pane",name:"Open entity graph in new pane",callback:()=>{this.openGraphView(!0)}}),this.addCommand({id:"open-timeline-view",name:"Open timeline",callback:()=>{this.openTimelineView()}}),this.addCommand({id:"open-timeline-view-new-pane",name:"Open timeline in new pane",callback:()=>{this.openTimelineView(!0)}}),this.addCommand({id:"open-map-view",name:"Open location map",callback:()=>{this.openMapView()}}),this.addCommand({id:"open-map-view-new-pane",name:"Open location map in new pane",callback:()=>{this.openMapView(!0)}}),this.addCommand({id:"ask-vault",name:"Ask (remote)",callback:()=>{if(this.settings.permissions&&this.settings.permissions.allow_plugin_access===!1){new b.Notice("Your plan does not include plugin access.");return}this.openAskModal()}}),this.addCommand({id:"reindex-vault",name:"Reindex vault",callback:()=>{if(this.settings.permissions&&this.settings.permissions.allow_plugin_access===!1){new b.Notice("Your plan does not include plugin access.");return}this.buildIndex().then(()=>{new b.Notice("Vault reindexed successfully.")})}}),this.addCommand({id:"reload-entities",name:"Reload entities from notes",callback:()=>{if(this.settings.permissions&&this.settings.permissions.allow_plugin_access===!1){new b.Notice("Your plan does not include plugin access.");return}this.entityManager.loadEntitiesFromNotes().then(()=>{new b.Notice("Entities reloaded from notes.")})}}),this.addSettingTab(new Oe(this.app,this))}onunload(){}async loadSettings(){this.settings=Object.assign({},at,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.graphApiService&&(this.graphApiService.setBaseUrl(this.settings.graphApiUrl),this.graphApiService.setApiKey(this.settings.reportApiKey),this.graphApiService.setSettings({apiProvider:"default",customApiUrl:"",customApiKey:"",customModel:""})),this.entityManager&&this.entityManager.setBasePath(this.settings.entityBasePath),this.app.workspace.getLeavesOfType(ee).forEach(e=>{e.view instanceof he&&e.view.refresh()})}isAuthenticated(){return!!this.settings.reportApiKey}async verifyPermissions(){if(this.settings.reportApiKey)try{let e=await(0,b.requestUrl)({url:`${se}/api/key/info`,method:"GET",headers:{Authorization:`Bearer ${this.settings.reportApiKey}`,"Content-Type":"application/json"}});if(e.status===200){let t=e.json;t.permissions&&(this.settings.permissions=t.permissions,await this.saveData(this.settings),console.debug("OSINTCopilot: Permissions updated",this.settings.permissions))}}catch(e){console.warn("OSINTCopilot: Failed to verify permissions",e)}}getMainEditorLeaf(e,t){let n=[Y,re,X,ee],i=[];this.app.workspace.iterateAllLeaves(s=>{s.getRoot()===this.app.workspace.rootSplit&&i.push(s)});let o=i.filter(s=>n.includes(s.view?.getViewType()||"")),a=i.filter(s=>s.view?.getViewType()==="markdown"||s.view?.getViewType()==="empty");return t&&o.length>0?this.app.workspace.createLeafBySplit(o[0],"vertical"):a.length>0?a[0]:o.length>0?this.app.workspace.createLeafBySplit(o[0],"vertical"):this.app.workspace.getLeaf("tab")}async openGraphView(e=!1){if(this.settings.permissions&&this.settings.permissions.allow_graph_automation===!1){new b.Notice("Your plan does not include access to graph automation features. Please upgrade.");return}if(!this.settings.enableGraphFeatures){new b.Notice("Graph features are disabled. Enable them in settings \u2192 osint copilot \u2192 enable graph features",5e3),console.warn("[VaultAIPlugin] Attempted to open graph view but graph features are disabled");return}console.debug("[VaultAIPlugin] Opening graph view, forceNew:",e);let t=this.app.workspace.getLeavesOfType(Y);if(!e&&t.length>0)return this.app.workspace.revealLeaf(t[0]),t[0];let n=this.getMainEditorLeaf(Y,e);return n?(await n.setViewState({type:Y,active:!0}),this.app.workspace.revealLeaf(n),n):null}async openGraphViewWithEntity(e){let t=await this.openGraphView();t&&setTimeout(()=>{let n=t.view;n&&typeof n.highlightEntity=="function"&&n.highlightEntity(e)},300)}async refreshGraphView(){let e=this.app.workspace.getLeavesOfType(Y);if(e.length>0){let t=e[0].view;t&&typeof t.refreshWithSavedPositions=="function"&&(console.debug("[OSINT Copilot] Refreshing graph view with new entities..."),await t.refreshWithSavedPositions(),new b.Notice("Graph view updated with new entities"))}}async refreshOrOpenGraphView(){if(!this.settings.enableGraphFeatures)return;this.app.workspace.getLeavesOfType(Y).length>0?this.settings.autoRefreshGraph&&await this.refreshGraphView():this.settings.autoOpenGraphOnEntityCreation&&(console.debug("[OSINT Copilot] Auto-opening graph view with new entities..."),await this.openGraphView(),new b.Notice("Graph view opened with new entities"))}async openTimelineView(e=!1){let t=this.app.workspace.getLeavesOfType(re);if(!e&&t.length>0){this.app.workspace.revealLeaf(t[0]);return}let n=this.getMainEditorLeaf(re,e);n&&(await n.setViewState({type:re,active:!0}),this.app.workspace.revealLeaf(n))}async openMapView(e=!1){let t=this.app.workspace.getLeavesOfType(X);if(!e&&t.length>0){this.app.workspace.revealLeaf(t[0]);return}let n=this.getMainEditorLeaf(X,e);n&&(await n.setViewState({type:X,active:!0}),this.app.workspace.revealLeaf(n))}onEntityClick(e){this.entityManager.openEntityNote(e)}async showEntityOnMap(e){let t=this.entityManager.getEntity(e);if(!t){new b.Notice("Entity not found");return}if(t.type!=="Location"){new b.Notice("Only location entities can be shown on the map");return}if(!t.properties.latitude||!t.properties.longitude){new b.Notice("Location has no coordinates. Please add latitude and longitude.");return}await this.openMapView(),setTimeout(()=>{let n=this.app.workspace.getLeavesOfType(X);if(n.length>0){let i=n[0].view;i&&typeof i.focusLocation=="function"&&(i.refresh(),setTimeout(()=>{i.focusLocation(e)},200))}},300)}async buildIndex(){this.index.clear();let e=this.app.vault.getMarkdownFiles();for(let t of e)await this.indexFile(t)}async indexFile(e){try{let t=await this.app.vault.read(e),n=this.app.metadataCache.getFileCache(e),i=this.extractTags(n),o=this.extractLinks(n),a=n?.frontmatter||void 0;this.index.set(e.path,{path:e.path,content:t,tags:i,links:o,frontmatter:a,updated:e.stat.mtime})}catch(t){console.error(`Failed to index file ${e.path}:`,t)}}extractTags(e){if(!e)return[];let t=[];if(e.tags&&e.tags.forEach(n=>t.push(n.tag)),e.frontmatter?.tags){let n=e.frontmatter.tags;Array.isArray(n)?t.push(...n.map(i=>i.startsWith("#")?i:`#${i}`)):typeof n=="string"&&t.push(n.startsWith("#")?n:`#${n}`)}return t}extractLinks(e){return!e||!e.links?[]:e.links.map(t=>t.link)}retrieveNotes(e){let t=e.toLowerCase(),n=this.tokenizeEnglish(t),i=[];for(let o of this.index.values()){let a=0,s=o.content.toLowerCase();(s.includes(t)||this.fuzzyMatchText(s,n))&&(a+=2),o.tags.some(c=>{let d=c.toLowerCase();return d.includes(t)||this.fuzzyMatchText(d,n)})&&(a+=1);let l=o.path.toLowerCase();(l.includes(t)||this.fuzzyMatchText(l,n))&&(a+=1),a>0&&i.push({note:o,score:a})}return i.sort((o,a)=>a.score-o.score),i.slice(0,this.settings.maxNotes).map(o=>o.note)}tokenizeEnglish(e){return(e.match(/\b[a-z0-9]{3,}\b/gi)||[]).map(t=>t.toLowerCase())}fuzzyMatchText(e,t){if(t.length===0||t.length>3)return!1;let n=this.tokenizeEnglish(e);if(n.length===0)return!1;let o=n.slice(0,800);for(let a of t)if(!(a.length<3)){for(let s of o)if(!(Math.abs(s.length-a.length)>2)&&this.levenshteinDistance(a,s)<=1)return!0}return!1}levenshteinDistance(e,t){let n=e.length,i=t.length;if(n===0)return i;if(i===0)return n;let o=new Array(i+1);for(let a=0;a<=i;a++)o[a]=a;for(let a=1;a<=n;a++){let s=o[0];o[0]=a;for(let l=1;l<=i;l++){let c=o[l];e[a-1]===t[l-1]?o[l]=s:o[l]=Math.min(s+1,o[l]+1,o[l-1]+1),s=c}}return o[i]}async callRemoteModel(e,t=!1,n,i){if(!this.settings.reportApiKey)throw new Error("License key is required. Please configure it in settings.");let o=`${se}/api/chat/completion`;try{let s={model:n||ot,messages:e,stream:t},l=(0,b.requestUrl)({url:o,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.settings.reportApiKey}`},body:JSON.stringify(s),throw:!1});if(i?.aborted)throw new DOMException("Aborted","AbortError");let c=await(i?Promise.race([l,new Promise((h,u)=>{i.addEventListener("abort",()=>u(new DOMException("Aborted","AbortError")))})]):l);if(c.status<200||c.status>=300){let h=c.text||"";throw console.error("[callRemoteModel] API error:",c.status,h),new Error(`API request failed (${c.status}): ${h.substring(0,200)}`)}let d=c.json;return d.choices?.[0]?.message?.content||d.choices?.[0]?.text||d.content||""||"No answer received."}catch(a){throw a instanceof Error?new Error(`Model call failed: ${a.message}`):a}}isTransientNetworkError(e){let t=e.message.toLowerCase();return["network","fetch","failed to fetch","net::err_","err_network_changed","network_changed","connection","timeout","timed out","econnreset","econnrefused","enotfound","socket","dns","abort","aborted","502","503","504","service unavailable","temporarily unavailable"].some(i=>t.includes(i))}sleep(e){return new Promise(t=>setTimeout(t,e))}async executeStreamingFetch(e,t,n,i){let o=await this.callRemoteModel(t,!1,void 0,i);return n&&n(o),o}async callRemoteModelStream(e,t,n,i){if(!this.settings.reportApiKey)throw new Error("License key is required. Please configure it in settings.");let o=`${se}/api/chat`,a=3,s=c=>[500,1e3,2e3][c-1]||2e3,l=null;for(let c=1;c<=a;c++)try{if(i?.aborted)throw new Error("Request was cancelled.");return await this.executeStreamingFetch(o,e,t,i)}catch(d){if(l=d instanceof Error?d:new Error(String(d)),!this.isTransientNetworkError(l))break;if(c<a){let p=s(c);console.debug(`[OSINT Copilot] Network error, retrying in ${p}ms (attempt ${c}/${a})`),n&&n(c,a),await this.sleep(p)}}if(l){let c=l.message.toLowerCase();throw this.isTransientNetworkError(l)?new Error("Network connection error. Please check your internet connection and try again."):c.includes("abort")?new Error("Request was cancelled."):new Error(`API request failed: ${l.message}`)}throw new Error("An unexpected error occurred. Please try again.")}async askVault(e){if(!this.isAuthenticated())throw new Error("License key required for AI features. Please configure your license key in settings.");let t=this.retrieveNotes(e);if(t.length===0)return{answer:"No relevant notes found for your query.",notes:[]};let n=`User query: "${e}"

Here are relevant notes:

`;for(let a of t){n+=`--- Note: ${a.path} ---
`,a.tags.length>0&&(n+=`Tags: ${a.tags.join(", ")}
`),a.frontmatter&&(n+=`Frontmatter: ${JSON.stringify(a.frontmatter)}
`);let s=a.content.length>1500?a.content.substring(0,1500)+"...":a.content;n+=`Content:
${s}

`}let i=[{role:"system",content:this.settings.systemPrompt},{role:"user",content:n}];return{answer:await this.callRemoteModel(i),notes:t}}async askVaultStream(e,t,n,i,o,a){if(!this.isAuthenticated())throw new Error("License key required for AI features. Please configure your license key in settings.");let s=n??this.retrieveNotes(e);if(s.length===0&&!o){let p="No relevant notes found for your query.";return t?.(p),{fullAnswer:p,notes:[]}}let l=`User query: "${e}"

Here are relevant notes:

`;for(let p of s){l+=`--- Note: ${p.path} ---
`,p.tags.length>0&&(l+=`Tags: ${p.tags.join(", ")}
`),p.frontmatter&&(l+=`Frontmatter: ${JSON.stringify(p.frontmatter)}
`);let h=p.content.length>1500?p.content.substring(0,1500)+"...":p.content;l+=`Content:
${h}

`}o&&(l+=`

${o}

`);let c=[{role:"system",content:this.settings.systemPrompt},{role:"user",content:l}];return{fullAnswer:await this.callRemoteModelStream(c,t,i,a),notes:s}}async generateReport(e,t,n,i){let o=this.settings.reportApiKey;if(!o)throw new Error("License key required. Please configure it in settings.");let a=se;try{n?.("Requesting report generation...");let s="",l=3,c=t?.reportConversationId||null;for(let S=1;S<=l;S++)try{let E={description:e,vault_context:"",force_new_report:!0};c?(E.conversation_id=c,console.debug("[OSINT Copilot] Sending request with existing conversation_id:",c)):console.debug("[OSINT Copilot] Sending first request (no conversation_id)");let w=await(0,b.requestUrl)({url:`${a}/api/generate-report`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(E),throw:!1});if(w.status<200||w.status>=300){let I=w.text||"";if(w.status===403){let N=I.toLowerCase();if(N.includes("quota")||N.includes("exhausted"))throw new Error("Companies&People quota exhausted. Please upgrade your plan or wait for quota renewal. Visit https://osint-copilot.com/dashboard/ to manage your subscription.");if(N.includes("expired"))throw new Error("Your license key or trial has expired. Please renew your subscription at https://osint-copilot.com/dashboard/");if(N.includes("inactive"))throw new Error("Your license key is inactive. Please check your account status at https://osint-copilot.com/dashboard/")}throw new Error(`Companies&People generation request failed (${w.status}): ${I.substring(0,200)}`)}let M=w.json;if(s=M.job_id,!s)throw new Error("No job_id received from server");M.conversation_id&&t&&(t.reportConversationId=M.conversation_id,console.debug("[OSINT Copilot] Updated conversation with reportConversationId:",M.conversation_id));break}catch(E){if(E instanceof Error&&this.isTransientNetworkError(E)&&S<l)console.debug(`[OSINT Copilot] Companies&People init network error, retrying (${S}/${l}):`,E),n?.(`Network interrupted, retrying... (attempt ${S}/${l})`),await this.sleep(1e3*S);else throw E}n?.(`Companies&People generation started (Job ID: ${s}). Processing... This might take up to 5 minutes, don't close the tab.`);let d=0,p=20*60*1e3,h=0,u="processing",y="",m=0,v=5,f=S=>S<15e3?2e3:S<45e3?3e3:5e3;for(;h<p&&u==="processing";){if(i?.aborted)throw new Error("Cancelled by user");let S=f(h);await new Promise(w=>setTimeout(w,S)),h+=S,d++;let E=Math.round(h/1e3);n?.(`Checking report status... (${E}s elapsed)`);try{let w=await(0,b.requestUrl)({url:`${a}/api/report-status/${s}`,method:"GET",headers:{Authorization:`Bearer ${o}`},throw:!1});if(w.status<200||w.status>=300)throw new Error(`Failed to check job status: ${w.status}`);let M=w.json;if(u=M.status,m=0,console.debug(`[OSINT Copilot] Polling status for job ${s}:`,M),M.progress?n?.(M.status,{message:M.progress.message||"Processing...",percent:M.progress.percent||0},M.intermediate_results):n?.(M.status,void 0,M.intermediate_results),M.response_ready){n?.("Response ready, retrieving from conversation...");let I=t?.reportConversationId||M.conversation_id;if(!I)throw new Error("Response ready but no conversation_id available");let N=M.content||M.response_content||M.message||M.response;if(!N)try{N=await this.getConversationResponse(I,a,o)}catch{throw new Error(`Response is ready but content not found. Backend must return 'content' or 'response_content' in statusData when response_ready = true. Conversation ID: ${I}`)}if(!N)throw new Error("Response is ready but no content found. Backend must return 'content' or 'response_content' in statusData when response_ready = true.");return t&&!t.reportConversationId&&(t.reportConversationId=I),{content:this.sanitizeMarkdownContent(N),filename:`response_${s}.md`,conversationId:I}}if(u==="completed"){y=M.filename;break}else if(u==="failed"){let I=M.error||"Unknown error";throw console.error(`[OSINT Copilot] Job ${s} failed with error:`,I),I.toLowerCase().includes("ssl")||I.toLowerCase().includes("certificate")||I.toLowerCase().includes("n8n")?new Error("Backend service temporarily unavailable. Please try again in a few minutes."):new Error(`Companies&People generation failed: ${I}`)}}catch(w){if(w instanceof Error&&this.isTransientNetworkError(w)){m++;let I=w instanceof Error?w.name:"Unknown",N=w instanceof Error?w.message:String(w);if(console.debug(`[OSINT Copilot] Companies&People status poll network error (${m}/${v}):`,`Type: ${I}, Message: ${N}`),m>=v)throw new Error("Network connection lost after multiple retries. Please check your internet connection and try again.");let O=`Network interrupted (${I}), retrying... (${Math.round(h/1e3)}s elapsed, attempt ${m}/${v})`;n?.(O),console.debug(`[OSINT Copilot] ${O}`)}else throw console.error("[OSINT Copilot] Non-retryable error during status polling:",w),w}}let x=Math.round(h/1e3);if(console.info(`[OSINT Copilot] Polling loop finished for job ${s}. Final status: ${u}, Elapsed: ${x}s`),u!=="completed")throw new Error("Companies&People generation timed out. Please try again.");n?.("Downloading report...");let g="",T=3;for(let S=1;S<=T;S++)try{let E=await(0,b.requestUrl)({url:`${a}/api/download-report/${s}/md`,method:"GET",headers:{Authorization:`Bearer ${o}`},throw:!1});if(E.status<200||E.status>=300){let M=E.text||"";throw new Error(`Failed to download report: ${E.status} - ${M}`)}let w=E.text;g=this.extractMarkdownFromResponse(w);break}catch(E){if(E instanceof Error&&this.isTransientNetworkError(E)&&S<T)console.debug(`[OSINT Copilot] Companies&People download network error, retrying (${S}/${T}):`,E),n?.(`Download interrupted, retrying... (attempt ${S}/${T})`),await this.sleep(1e3*S);else throw E}let C=y||`report_${s}.md`;if(!g)throw new Error("No content received from server");return n?.("Companies&People downloaded successfully!"),{content:this.sanitizeMarkdownContent(g),filename:C}}catch(s){throw s instanceof Error?new Error(`Companies&People generation failed: ${s.message}`):s}}async getConversationResponse(e,t,n){let i=[`/api/conversation/${e}/messages`,`/api/conversations/${e}/messages`,`/api/chat/conversation/${e}`,`/api/conversation/${e}`];for(let o of i)try{let a=await(0,b.requestUrl)({url:`${t}${o}`,method:"GET",headers:{Authorization:`Bearer ${n}`},throw:!1});if(a.status>=200&&a.status<300){let s=a.json,l=[];Array.isArray(s)?l=s:s.messages&&Array.isArray(s.messages)?l=s.messages:s.conversation&&Array.isArray(s.conversation.messages)&&(l=s.conversation.messages);let c=l.filter(d=>d.role==="assistant"||d.role==="AI").pop();if(c&&c.content)return c.content}else if(a.status!==404)continue}catch{continue}throw new Error("No API endpoint found to retrieve conversation messages. Backend must return 'content' or 'response_content' in statusData when response_ready = true.")}async extractEntitiesFromQuery(e){let n=[{role:"system",content:`Extract the main entities mentioned in the user's query and classify each as one of: person | company | asset | event | location. Respond ONLY in JSON with a list of objects: [{"name":"<entity name>","type":"person|company|asset|event|location|unknown"}]. If no specific entities are found, return an empty list []. Use English only.`},{role:"user",content:e}];try{let o=(await this.callRemoteModel(n,!1,rt)).trim(),a=[];try{a=JSON.parse(o)}catch{let c=o.match(/\[[\s\S]*\]/);if(c)try{a=JSON.parse(c[0])}catch(d){console.error("[extractEntitiesFromQuery] Regex parse failed:",d)}}if(!Array.isArray(a))return[];let s=["person","company","asset","event","location","unknown"];return a.map(l=>{let c=(String(l?.type)||"unknown").toLowerCase(),d=s.includes(c)?c:"unknown";return{name:typeof l?.name=="string"&&l.name.trim().length>0?l.name.trim():null,type:d}})}catch(i){return console.error("[extractEntitiesFromQuery] Error:",i),[]}}sanitizeMarkdownContent(e){return e=e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,""),e=e.replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,""),e=e.replace(/<(object|embed)\b[^<]*(?:(?!<\/\1>)<[^<]*)*<\/\1>/gi,""),e=e.replace(/\[([^\]]+)\]\(javascript:[^\)]*\)/gi,"[$1](#)"),e=e.replace(/\[([^\]]+)\]\(data:(?!image)[^\)]*\)/gi,"[$1](#)"),e}extractMarkdownFromResponse(e){let t=e.trim();if(t.startsWith("{")||t.startsWith("["))try{let n=JSON.parse(t),i=Array.isArray(n)?n[0]:n;if(i&&typeof i=="object"){let o=["content","markdown","report","text","data","body","result","output"];for(let s of o)if(i[s]&&typeof i[s]=="string")return console.debug(`[OSINT Copilot] Extracted markdown from JSON field: ${s}`),i[s];if(i.report&&typeof i.report=="object"){for(let s of o)if(i.report[s]&&typeof i.report[s]=="string")return console.debug(`[OSINT Copilot] Extracted markdown from JSON field: report.${s}`),i.report[s]}let a=Object.entries(i).filter(([s,l])=>typeof l=="string"&&l.length>100);if(a.length===1)return console.debug(`[OSINT Copilot] Extracted markdown from single string field: ${a[0][0]}`),a[0][1];console.warn("[OSINT Copilot] Could not find markdown content in JSON response. Fields:",Object.keys(i))}}catch{console.debug("[OSINT Copilot] Response is not valid JSON, treating as plain markdown")}return e}getVaultContext(){let e=Array.from(this.index.values()),t=`Vault contains ${e.length} notes.

`,n=e.slice(0,20);t+=`Sample notes:
`;for(let i of n)t+=`- ${i.path}
`;return t}async saveReportToVault(e,t,n){let i=new Date,o=i.toISOString().split("T")[0],a=i.toISOString().split("T")[1].split(".")[0].replace(/:/g,"-"),s=t,l=[/(?:tell me about|report on|who is|what is|investigate|research|find|look up|search for)\s+(.+)/i,/(.+?)(?:\s+report|\s+investigation|\s+research)?$/i];for(let v of l){let f=t.match(v);if(f&&f[1]){s=f[1].trim();break}}let c=s.substring(0,50).replace(/[^a-zA-Z0-9\s-]/g,"").trim().replace(/\s+/g,"_"),d=c?`${c}_Report`:"Corporate_Report",p=`${this.settings.reportOutputDir}/${d}_${o}_${a}.md`;this.app.vault.getAbstractFileByPath(this.settings.reportOutputDir)||await this.app.vault.createFolder(this.settings.reportOutputDir);let u=`---
`;u+=`report_description: "${t.replace(/"/g,'\\"')}"
`,u+=`generated: ${i.toISOString()}
`,u+=`source: OpenDossier API
`,u+=`---

`,u+=e;let y=p,m=1;for(;this.app.vault.getAbstractFileByPath(y);)y=`${this.settings.reportOutputDir}/${d}_${o}_${a}-${m}.md`,m++;return await this.app.vault.create(y,u),console.debug(`[OSINT Copilot] Report saved to: ${y}`),y}async saveDarkWebReportToVault(e,t,n){let i=new Date,o=i.toISOString().split("T")[0],a=i.toISOString().split("T")[1].split(".")[0].replace(/:/g,"-"),s=t.substring(0,50).replace(/[^a-zA-Z0-9\s-]/g,"").trim().replace(/\s+/g,"_"),l=s?`DarkWeb_${s}`:"DarkWeb_Investigation",c=`${this.settings.reportOutputDir}/${l}_${o}_${a}.md`;this.app.vault.getAbstractFileByPath(this.settings.reportOutputDir)||await this.app.vault.createFolder(this.settings.reportOutputDir);let p=`---
`;p+=`investigation_query: "${t.replace(/"/g,'\\"')}"
`,p+=`job_id: "${n}"
`,p+=`generated: ${i.toISOString()}
`,p+=`source: Dark Web Investigation
`,p+=`---

`,p+=e;let h=c,u=1;for(;this.app.vault.getAbstractFileByPath(h);)h=`${this.settings.reportOutputDir}/${l}_${o}_${a}-${u}.md`,u++;return await this.app.vault.create(h,p),console.debug(`[OSINT Copilot] Dark web report saved to: ${h}`),h}openAskModal(){if(!this.isAuthenticated()){new b.Notice("License key required for AI features. Please configure your license key in settings.");return}new Re(this.app,this).open()}async openChatView(e=!1){if(this.settings.permissions&&this.settings.permissions.allow_chat_view===!1){new b.Notice("Your plan does not include access to the chat view/local agent. Please upgrade to local agent or plugin own data plan.");return}if(!this.settings.reportApiKey){new b.Notice("A valid license key is required to use the chat feature. Please purchase a license key to enable this functionality.",8e3);let i=this.app.setting;i&&(i.open(),i.openTabById(this.manifest.id));return}let t=this.app.workspace.getLeavesOfType(ee);if(!e&&t.length>0){await this.app.workspace.revealLeaf(t[0]);return}let n=this.getMainEditorLeaf(ee,e);n&&(n.setViewState({type:ee,active:!0}),await this.app.workspace.revealLeaf(n))}},Re=class extends b.Modal{constructor(r,e){super(r),this.plugin=e}onOpen(){let{contentEl:r}=this;r.addClass("vault-ai-modal"),r.createEl("h2",{text:"Ask your vault"}),r.createEl("label",{text:"Your question:"}),this.queryInput=r.createEl("textarea",{placeholder:"What would you like to know?"});let e=r.createDiv();e.createEl("button",{text:"Ask"}).addEventListener("click",()=>{this.handleAsk()}),e.createEl("button",{text:"Close"}).addEventListener("click",()=>this.close()),this.answerContainer=r.createDiv("vault-ai-answer"),this.answerContainer.setCssProps({display:"none"}),this.notesContainer=r.createDiv("vault-ai-notes-list"),this.notesContainer.setCssProps({display:"none"})}async handleAsk(){let r=this.queryInput.value.trim();if(!r){new b.Notice("Please enter a question.");return}this.answerContainer.empty(),this.answerContainer.createEl("p",{text:"Thinking..."}),this.answerContainer.setCssProps({display:"block"});try{let e=await this.plugin.askVault(r);if(this.answerContainer.innerHTML="",this.answerContainer.createEl("pre").setText(e.answer),this.answerContainer.createEl("button",{text:"Copy answer"}).addEventListener("click",()=>{navigator.clipboard.writeText(e.answer),new b.Notice("Answer copied to clipboard.")}),e.notes.length>0){this.notesContainer.innerHTML="",this.notesContainer.createEl("h3",{text:"Matching notes:"});for(let i of e.notes){let o=this.notesContainer.createDiv("vault-ai-note-item");o.textContent=i.path,o.addEventListener("click",()=>{(async()=>{let a=this.app.vault.getAbstractFileByPath(i.path);a instanceof b.TFile&&(await this.app.workspace.getLeaf().openFile(a),this.close())})()})}this.notesContainer.setCssProps({display:"block"})}}catch(e){this.answerContainer.empty(),this.answerContainer.createEl("p",{text:`Error: ${e instanceof Error?e.message:String(e)}`}).setCssProps({color:"var(--text-error)"})}}onClose(){let{contentEl:r}=this;r.empty()}},Ge=class extends b.Modal{constructor(r,e,t){super(r),this.currentTitle=e,this.onSubmit=t}onOpen(){let{contentEl:r}=this;r.addClass("vault-ai-modal"),r.createEl("h3",{text:"Rename conversation"});let e=r.createDiv({cls:"vault-ai-rename-input-container"});e.createEl("label",{text:"New title:"}),this.inputEl=e.createEl("input",{type:"text",value:this.currentTitle,cls:"vault-ai-rename-input"}),this.inputEl.setCssProps({width:"100%","margin-top":"8px",padding:"8px"}),this.inputEl.addEventListener("keydown",o=>{o.key==="Enter"?(o.preventDefault(),this.submit()):o.key==="Escape"&&this.close()});let t=r.createDiv({cls:"vault-ai-rename-buttons"});t.setCssProps({"margin-top":"16px",display:"flex","justify-content":"flex-end",gap:"8px"}),t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),t.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",()=>this.submit()),setTimeout(()=>{this.inputEl.focus(),this.inputEl.select()},10)}submit(){let r=this.inputEl.value.trim();r&&r!==this.currentTitle&&this.onSubmit(r),this.close()}onClose(){let{contentEl:r}=this;r.empty()}},he=class extends b.ItemView{constructor(e,t){super(e);this.chatHistory=[];this.localSearchMode=!1;this.autoMode=!0;this.customChatMode=!1;this.darkWebMode=!1;this.reportGenerationMode=!1;this.osintSearchMode=!1;this.osintSearchOptionsVisible=!1;this.osintSearchCountry="RU";this.osintSearchMaxProviders=3;this.osintSearchParallel=!0;this.graphGenerationMode=!0;this.graphModificationMode=!1;this.graphQueryMode=!1;this.pollingIntervals=new Map;this.currentConversation=null;this.sidebarVisible=!0;this.attachedFiles=[];this.activeAbortControllers=new Map;this.plugin=t}getViewType(){return ee}getDisplayText(){return"Osint copilot"}getIcon(){return"message-square"}async onOpen(){await this.loadMostRecentConversation(),await this.render()}async loadMostRecentConversation(){let e=await this.plugin.conversationService.getMostRecentConversation();e?(this.currentConversation=e,this.chatHistory=this.conversationMessagesToHistory(e.messages),this.darkWebMode=e.darkWebMode||!1,this.reportGenerationMode=e.reportGenerationMode||!1,this.osintSearchMode=e.osintSearchMode||!1,this.autoMode=e.autoMode??!0,e.darkWebMode||e.reportGenerationMode||e.osintSearchMode||e.localSearchMode||e.autoMode?(this.localSearchMode=e.localSearchMode||!1,this.graphGenerationMode=e.graphGenerationMode||!1,this.autoMode=e.autoMode??!1):(this.localSearchMode=!1,this.graphGenerationMode=!0,this.autoMode=!0)):(this.localSearchMode=!1,this.graphGenerationMode=!0,this.autoMode=!0)}conversationMessagesToHistory(e){return e.map(t=>({role:t.role,content:t.content,notes:t.notes,jobId:t.jobId,status:t.status,progress:t.progress,reportFilePath:t.reportFilePath,usedEntities:t.usedEntities}))}historyToConversationMessages(){return this.chatHistory.map(e=>({role:e.role,content:e.content,timestamp:Date.now(),notes:e.notes,jobId:e.jobId,status:e.status,progress:e.progress,reportFilePath:e.reportFilePath,usedEntities:e.usedEntities}))}async saveCurrentConversation(){this.currentConversation||(this.currentConversation=await this.plugin.conversationService.createConversation(this.chatHistory.length>0?this.chatHistory[0].content:void 0,this.darkWebMode,this.graphGenerationMode,this.reportGenerationMode)),this.currentConversation.messages=this.historyToConversationMessages(),this.currentConversation.localSearchMode=this.localSearchMode,this.currentConversation.autoMode=this.autoMode,this.currentConversation.darkWebMode=this.darkWebMode,this.currentConversation.graphGenerationMode=this.graphGenerationMode,this.currentConversation.reportGenerationMode=this.reportGenerationMode,this.currentConversation.osintSearchMode=this.osintSearchMode,await this.plugin.conversationService.saveConversation(this.currentConversation),this.renderConversationList()}async refresh(){await this.render()}async render(){let e=this.containerEl.children[1];e.empty(),e.addClass("vault-ai-chat-view"),e.addClass("vault-ai-chat-with-sidebar");let t=e.createDiv("vault-ai-chat-layout");this.sidebarContainer=t.createDiv("vault-ai-chat-sidebar"),this.sidebarVisible||this.sidebarContainer.addClass("hidden"),this.renderSidebar();let n=t.createDiv("vault-ai-chat-area"),i=n.createDiv("vault-ai-chat-header"),o=i.createEl("button",{cls:"vault-ai-sidebar-toggle"});o.setText("\u2630"),o.title="Toggle conversation history",o.addEventListener("click",()=>{this.sidebarVisible=!this.sidebarVisible,this.sidebarVisible?this.sidebarContainer.removeClass("hidden"):this.sidebarContainer.addClass("hidden")}),i.createEl("h3",{text:"Osint copilot"});let a=i.createDiv("vault-ai-chat-header-buttons");a.createEl("button",{text:"New chat",cls:"vault-ai-new-chat-btn"}).addEventListener("click",()=>{this.startNewConversation()});let l=a.createDiv("vault-ai-mode-select-container");l.setAttribute("title","Select a mode, or choose 'graph generation' for entity extraction without AI chat");let c=l.createEl("label",{text:"Mode:",cls:"vault-ai-mode-select-label"});c.htmlFor="vault-ai-mode-dropdown",this.modeDropdown=l.createEl("select",{cls:"vault-ai-mode-dropdown"}),this.modeDropdown.id="vault-ai-mode-dropdown";let d=[];this.plugin.settings.customCheckpoints.forEach(g=>{d.push({value:`custom-${g.id}`,label:`\u{1F4AC} ${g.name}`,mode:"customChatMode",checkpointId:g.id})}),this.activeCheckpointId&&!this.plugin.settings.customCheckpoints.find(g=>g.id===this.activeCheckpointId)&&(this.activeCheckpointId=void 0,this.customChatMode&&(this.plugin.settings.customCheckpoints.length>0?this.activeCheckpointId=this.plugin.settings.customCheckpoints[0].id:(this.customChatMode=!1,this.localSearchMode=!0))),d.push({value:"auto",label:"\u2728 Auto (All-in-One)",mode:"autoMode"},{value:"none",label:"\u{1F3F7}\uFE0F Graph Generation",mode:"none"},{value:"local",label:"\u{1F50D} Local Search",mode:"localSearchMode"},{value:"darkweb",label:"\u{1F575}\uFE0F Dark Web",mode:"darkWebMode"},{value:"report",label:"\u{1F4C4} Companies&People",mode:"reportGenerationMode"},{value:"osint",label:"\u{1F50E} Digital Footprint",mode:"osintSearchMode"});for(let g of d){let T=this.modeDropdown.createEl("option",{text:g.label,value:g.value});g.mode==="customChatMode"?this.customChatMode&&this.activeCheckpointId===g.checkpointId?T.selected=!0:this.customChatMode&&!this.activeCheckpointId&&g.checkpointId===this.plugin.settings.customCheckpoints[0]?.id&&(this.activeCheckpointId=g.checkpointId,T.selected=!0):(g.value==="none"&&this.isGraphOnlyMode()||g.value==="auto"&&this.autoMode||g.value==="local"&&this.localSearchMode||g.value==="darkweb"&&this.darkWebMode||g.value==="report"&&this.reportGenerationMode||g.value==="osint"&&this.osintSearchMode)&&(T.selected=!0)}a.createEl("button",{text:"\u2699\uFE0F",cls:"vault-ai-settings-btn",attr:{"aria-label":"Open settings"}}).addEventListener("click",()=>{this.app.setting.open(),this.app.setting.openTabById(this.plugin.manifest.id)}),this.modeDropdown.addEventListener("change",()=>{let g=this.modeDropdown.value;if(this.autoMode=!1,this.customChatMode=!1,this.localSearchMode=!1,this.darkWebMode=!1,this.reportGenerationMode=!1,this.osintSearchMode=!1,g.startsWith("custom-")){let T=g.replace("custom-","");this.customChatMode=!0,this.activeCheckpointId=T;let C=this.plugin.settings.customCheckpoints.find(D=>D.id===T)?.name||"Custom Chat";new b.Notice(`${C} enabled`)}else switch(this.activeCheckpointId=void 0,g){case"auto":this.autoMode=!0,new b.Notice("Auto (All-in-One) mode enabled");break;case"local":this.localSearchMode=!0,new b.Notice("Local search mode enabled");break;case"darkweb":this.darkWebMode=!0,new b.Notice("Dark web mode enabled");break;case"report":this.reportGenerationMode=!0,new b.Notice("Companies&people mode enabled");break;case"osint":this.osintSearchMode=!0,new b.Notice("Leak search mode enabled");break;case"none":this.graphGenerationMode?new b.Notice("Graph only mode enabled - extract entities from your text"):(this.graphGenerationMode=!0,this.graphGenerationToggle.checked=!0,this.updateGraphGenerationLabel(),new b.Notice("Graph only mode enabled - extract entities from your text"));break}this.updateAllModeLabels(),this.updateInputPlaceholder(),this.updateAllModeLabels(),this.updateInputPlaceholder(),this.updateModeDisclaimer(),this.updateUploadButtonVisibility(),this.updateUrlButtonVisibility(),this.updateGraphToggleVisibility()}),this.entityGenContainer=a.createDiv("vault-ai-entity-gen-toggle"),this.entityGenContainer.addClass("vault-ai-toggle-container"),this.entityGenContainer.setAttribute("title","Extract entities (works with any mode, or alone for graph only mode)"),this.graphGenerationToggle=this.entityGenContainer.createEl("input",{type:"checkbox",cls:"vault-ai-entity-gen-checkbox"}),this.graphGenerationToggle.id="graph-gen-mode-toggle",this.graphGenerationToggle.checked=this.graphGenerationMode,this.graphGenerationToggle.addEventListener("change",()=>{this.graphGenerationMode=this.graphGenerationToggle.checked,this.updateGraphGenerationLabel(),this.updateInputPlaceholder(),this.updateInputPlaceholder(),this.updateModeDisclaimer(),this.updateUploadButtonVisibility(),this.updateUrlButtonVisibility(),this.isGraphOnlyMode()?new b.Notice("Graph only mode enabled - extract entities from your text"):this.graphGenerationMode?new b.Notice("Graph generation enabled"):new b.Notice("Graph generation disabled")});let h=this.entityGenContainer.createEl("label",{text:this.getGraphGenLabelText(),cls:this.graphGenerationMode?"vault-ai-entity-gen-label active":"vault-ai-entity-gen-label"});h.htmlFor="graph-gen-mode-toggle",this.updateGraphToggleVisibility(),this.messagesContainer=n.createDiv("vault-ai-chat-messages"),await this.renderMessages();let u=n.createDiv("vault-ai-chat-input"),y=this.getModeDisclaimer();if(y){let g=u.createDiv("vault-ai-mode-disclaimer");g.createSpan({text:y.icon+" "}),g.createEl("strong",{text:y.title+" "}),g.createSpan({text:y.text})}this.inputEl=u.createEl("textarea",{placeholder:this.getInputPlaceholder()}),this.inputEl.rows=3;let m=u.createEl("input",{type:"file",cls:"vault-ai-file-upload",attr:{accept:".md,.txt,.pdf,.docx,.doc",style:"display: none;"}});m.addEventListener("change",g=>void this.handleFileUpload(g)),this.attachmentsContainer=u.createDiv("vault-ai-attachments"),this.attachedFiles=[];let v=u.createDiv("vault-ai-action-row");this.uploadButtonEl=v.createEl("button",{text:"\u{1F4CE}",cls:"vault-ai-upload-btn",attr:{"aria-label":"Upload file for graph generation",title:"Upload file for graph generation (.md, .txt, .pdf, .docx)"}}),this.updateUploadButtonVisibility(),this.uploadButtonEl.addEventListener("click",()=>m.click()),this.urlButtonEl=v.createEl("button",{text:"\u{1F517}",cls:"vault-ai-url-btn",attr:{"aria-label":"Extract from URL",title:"Extract content from web URL for graph generation"}}),this.urlButtonEl.addEventListener("click",()=>this.showUrlInputModal()),this.updateUrlButtonVisibility();let f=v.createDiv("vault-ai-action-spacer");f.style.flexGrow="1",v.createEl("button",{text:this.osintSearchMode?"Search":"Send",cls:"vault-ai-send-btn"}).addEventListener("click",()=>void this.handleSend()),this.dragOverlay=u.createDiv("vault-ai-drag-overlay"),this.dragOverlay.createDiv({text:"Drop file to extract text",cls:"vault-ai-drag-text"}),u.addEventListener("dragenter",g=>{this.isGraphOnlyMode()&&(g.preventDefault(),g.stopPropagation(),g.dataTransfer&&(g.dataTransfer.dropEffect="copy"),this.dragOverlay.hasClass("active")||this.dragOverlay.addClass("active"))}),u.addEventListener("dragleave",g=>{this.isGraphOnlyMode()&&(g.preventDefault(),g.stopPropagation(),u.contains(g.relatedTarget)||this.dragOverlay.removeClass("active"))}),u.addEventListener("dragover",g=>{this.isGraphOnlyMode()&&(g.preventDefault(),g.stopPropagation(),g.dataTransfer&&(g.dataTransfer.dropEffect="copy"),this.dragOverlay.hasClass("active")||this.dragOverlay.addClass("active"))}),u.addEventListener("drop",async g=>{if(g.preventDefault(),g.stopPropagation(),this.dragOverlay.removeClass("active"),!this.isGraphOnlyMode()){new b.Notice("File drop only available in graph generation mode");return}if(g.dataTransfer&&g.dataTransfer.files&&g.dataTransfer.files.length>0){this.handleDroppedFile(g.dataTransfer.files[0]);return}let T=this.app.dragManager;if(T&&T.draggable&&T.draggable.type==="file"&&T.draggable.file instanceof b.TFile){await this.handleDroppedAbstractFile(T.draggable.file);return}if(g.dataTransfer){let C=g.dataTransfer.getData("text/plain");if(C){let D=this.app.vault.getAbstractFileByPath(C);if(D instanceof b.TFile){await this.handleDroppedAbstractFile(D);return}}}}),this.inputEl.addEventListener("keydown",g=>{g.key==="Enter"&&!g.shiftKey&&(g.preventDefault(),this.handleSend())}),this.osintSearchMode&&this.renderOSINTSearchOptions(u)}getModeDisclaimer(){return this.isGraphOnlyMode()?{icon:"\u{1F3F7}\uFE0F",title:"Graph Generation Mode:",text:"Your text will be analyzed to extract and create entities in the graph (people, companies, locations, etc.) without AI chat."}:this.osintSearchMode?this.graphGenerationMode?{icon:"\u{1F50E}",title:"Digital Footprint + Graph Gen:",text:"Search leaked databases and automatically create entities from the results."}:{icon:"\u{1F50E}",title:"Digital Footprint:",text:"Search multiple leaked databases for information about people, emails, phones, and more."}:this.darkWebMode?this.graphGenerationMode?{icon:"\u{1F575}\uFE0F",title:"Dark Web + Graph Gen:",text:"Investigate dark web sources and automatically create entities from findings."}:{icon:"\u{1F575}\uFE0F",title:"Dark Web:",text:"Search dark web sources for leaked data and threat intelligence."}:this.reportGenerationMode?this.graphGenerationMode?{icon:"\u{1F4C4}",title:"Persons&Companies + Graph Gen:",text:"Generate comprehensive reports and automatically create entities from the content."}:{icon:"\u{1F4C4}",title:"Persons&Companies:",text:"Generate detailed corporate intelligence reports about people and companies. Include data about sanctions and red flags"}:this.localSearchMode&&this.graphGenerationMode?{icon:"\u{1F50D}",title:"Local Search + Graph Gen:",text:"Search your vault and automatically create entities from AI responses."}:null}updateUploadButtonVisibility(){this.uploadButtonEl&&(this.isGraphOnlyMode()?this.uploadButtonEl.style.display="block":this.uploadButtonEl.style.display="none")}updateUrlButtonVisibility(){this.urlButtonEl&&(this.isGraphOnlyMode()?this.urlButtonEl.style.display="block":this.urlButtonEl.style.display="none")}showUrlInputModal(){let e=document.createElement("div");e.className="vault-ai-modal-overlay",e.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    `;let t=document.createElement("div");t.className="vault-ai-url-modal",t.style.cssText=`
      background: var(--background-primary);
      border-radius: 8px;
      padding: 20px;
      min-width: 400px;
      max-width: 600px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    `,t.innerHTML=`
      <h3 style="margin-top: 0; margin-bottom: 15px;">\u{1F517} Extract from URL</h3>
      <p style="color: var(--text-muted); margin-bottom: 15px; font-size: 0.9em;">
        Paste a URL to extract article content and generate entities.
      </p>
      <input type="url" id="url-input" placeholder="https://medium.com/@author/article..." 
        style="width: 100%; padding: 10px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-secondary); color: var(--text-normal); margin-bottom: 15px;" />
      <div id="url-status" style="color: var(--text-muted); margin-bottom: 15px; min-height: 20px;"></div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="url-cancel" style="padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; background: var(--background-modifier-border);">Cancel</button>
        <button id="url-extract" style="padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; background: var(--interactive-accent); color: white;">Extract & Generate</button>
      </div>
    `,e.appendChild(t),document.body.appendChild(e);let n=t.querySelector("#url-input"),i=t.querySelector("#url-status"),o=t.querySelector("#url-cancel"),a=t.querySelector("#url-extract");n.focus();let s=()=>{e.remove()};o.addEventListener("click",s),e.addEventListener("click",c=>{c.target===e&&s()});let l=c=>{c.key==="Escape"&&(s(),document.removeEventListener("keydown",l))};document.addEventListener("keydown",l),a.addEventListener("click",async()=>{let c=n.value.trim();if(!c){i.textContent="\u274C Please enter a URL",i.style.color="var(--text-error)";return}if(!c.startsWith("http://")&&!c.startsWith("https://")){i.textContent="\u274C URL must start with http:// or https://",i.style.color="var(--text-error)";return}a.disabled=!0,o.disabled=!0,a.textContent="Extracting...",i.textContent="\u{1F517} Fetching content from URL...",i.style.color="var(--text-muted)";try{let d=await this.plugin.graphApiService.extractTextFromUrl(c);if(!d||d.trim().length===0)throw new Error("No content could be extracted from this URL");s();let p=c.length>60?c.substring(0,60)+"...":c;this.chatHistory.push({role:"user",content:`\u{1F517} ${p}`}),await this.renderMessages(),new b.Notice("Extracted content from URL. Processing entities..."),await this.handleGraphOnlyMode(d),await this.saveCurrentConversation()}catch(d){console.error("URL extraction error:",d);let p=d instanceof Error?d.message:String(d);p.includes("timeout")||p.includes("timed out")?i.textContent="\u274C Request timed out. Try a simpler page.":p.includes("429")?i.textContent="\u274C Server busy. Please wait and try again.":i.textContent=`\u274C ${p}`,i.style.color="var(--text-error)",a.disabled=!1,o.disabled=!1,a.textContent="Extract & generate"}}),n.addEventListener("keydown",c=>{c.key==="Enter"&&a.click()})}updateGraphToggleVisibility(){this.entityGenContainer&&(this.modeDropdown&&this.modeDropdown.value==="none"?this.entityGenContainer.style.display="none":this.entityGenContainer.style.display="flex")}async handleFileUpload(e){let t=e.target;if(!t.files||t.files.length===0)return;let n=t.files[0];t.value="";let i=[".md",".txt",".pdf",".docx",".doc"],o="."+n.name.split(".").pop()?.toLowerCase();if(!i.includes(o)){new b.Notice(`File type ${o} not supported. Use .md, .txt, .pdf, .docx`);return}this.attachedFiles.push({file:n,extracted:!1}),this.renderAttachments(),new b.Notice(`Attached: ${n.name}`)}async handleDroppedFile(e){if(!e)return;let t=[".md",".txt",".pdf",".docx",".doc"],n="."+e.name.split(".").pop()?.toLowerCase();if(!t.includes(n)){new b.Notice(`File type ${n} not supported. Use .md, .txt, .pdf, .docx`);return}try{this.inputEl.placeholder=`Extracting text from ${e.name}...`,this.inputEl.disabled=!0,new b.Notice(`Extracting text from ${e.name}...`);let i=await this.plugin.graphApiService.extractTextFromFile(e);this.appendExtractedText(i),new b.Notice(`Text extracted from ${e.name}`)}catch(i){console.error("Drop file error:",i),new b.Notice(`Error: ${i instanceof Error?i.message:String(i)}`)}finally{this.inputEl.disabled=!1,this.updateInputPlaceholder(),this.inputEl.focus()}}async handleDroppedAbstractFile(e){if(!e)return;if(!["md","txt","pdf","docx","doc"].includes(e.extension)){new b.Notice(`File type .${e.extension} not supported.`);return}this.attachedFiles.push({file:e,extracted:!1}),this.renderAttachments(),new b.Notice(`Attached: ${e.name}`)}renderAttachments(){if(this.attachmentsContainer.empty(),this.attachedFiles.length!==0)for(let e=0;e<this.attachedFiles.length;e++){let t=this.attachedFiles[e],n=this.attachmentsContainer.createDiv("vault-ai-attachment-item"),i=n.createDiv("vault-ai-attachment-info");if(i.createSpan({text:"\u{1F4C4} ",cls:"vault-ai-attachment-icon"}),i.createSpan({text:t.file.name,cls:"vault-ai-attachment-name"}),t.extracted&&t.content){let a=t.content.substring(0,100).replace(/\n/g," ").trim();a&&n.createDiv({text:a+(t.content.length>100?"...":""),cls:"vault-ai-attachment-preview"})}else n.createDiv({text:"\u{1F4CB} Ready to extract on send",cls:"vault-ai-attachment-preview"});n.createEl("button",{text:"\u2715",cls:"vault-ai-attachment-remove",attr:{"aria-label":"Remove attachment",title:"Remove attachment"}}).addEventListener("click",()=>{this.attachedFiles.splice(e,1),this.renderAttachments()})}}appendExtractedText(e){let t=this.inputEl.value;t?this.inputEl.value=t+`

`+e:this.inputEl.value=e}async handleUrlExtraction(e){try{if(!e.startsWith("http"))return!1;let t=this.inputEl.placeholder;this.inputEl.placeholder="Extracting text from URL...",this.inputEl.disabled=!0,new b.Notice(`Extracting text from URL: ${e}...`);let n=await this.plugin.graphApiService.extractTextFromUrl(e);return this.inputEl.value=n,new b.Notice("Text extracted from URL"),!0}catch(t){return console.error("URL extraction error:",t),new b.Notice(`Error extracting URL: ${t instanceof Error?t.message:String(t)}`),!1}finally{this.inputEl.disabled=!1,this.updateInputPlaceholder(),this.inputEl.focus()}}renderOSINTSearchOptions(e){let t=e.createDiv("vault-ai-osint-search-options"),n=t.createEl("button",{text:this.osintSearchOptionsVisible?"\u2699\uFE0F Hide Options":"\u2699\uFE0F Search Options",cls:"vault-ai-osint-options-toggle"});n.addEventListener("click",()=>{this.osintSearchOptionsVisible=!this.osintSearchOptionsVisible,n.textContent=this.osintSearchOptionsVisible?"\u2699\uFE0F Hide Options":"\u2699\uFE0F Search Options",i.style.display=this.osintSearchOptionsVisible?"flex":"none"});let i=t.createDiv("vault-ai-osint-options-content");i.style.display=this.osintSearchOptionsVisible?"flex":"none";let o=i.createDiv("vault-ai-osint-option-group");o.createEl("label",{text:"Country:"});let a=o.createEl("select",{cls:"vault-ai-osint-country-select"}),s=[{value:"RU",label:"\u{1F1F7}\u{1F1FA} Russia"},{value:"UA",label:"\u{1F1FA}\u{1F1E6} Ukraine"},{value:"BY",label:"\u{1F1E7}\u{1F1FE} Belarus"},{value:"KZ",label:"\u{1F1F0}\u{1F1FF} Kazakhstan"}];for(let u of s){let y=a.createEl("option",{text:u.label,value:u.value});u.value===this.osintSearchCountry&&(y.selected=!0)}a.addEventListener("change",()=>{this.osintSearchCountry=a.value});let l=i.createDiv("vault-ai-osint-option-group");l.createEl("label",{text:"Max providers:"});let c=l.createEl("input",{type:"number",cls:"vault-ai-osint-providers-input",value:String(this.osintSearchMaxProviders)});c.min="1",c.max="10",c.addEventListener("change",()=>{let u=parseInt(c.value);u>=1&&u<=10?this.osintSearchMaxProviders=u:c.value=String(this.osintSearchMaxProviders)});let p=i.createDiv("vault-ai-osint-option-group").createEl("label"),h=p.createEl("input",{type:"checkbox"});h.checked=this.osintSearchParallel,p.appendText(" Parallel Search"),h.addEventListener("change",()=>{this.osintSearchParallel=h.checked})}isGraphOnlyMode(){return this.graphGenerationMode&&!this.localSearchMode&&!this.customChatMode&&!this.darkWebMode&&!this.reportGenerationMode&&!this.osintSearchMode&&!this.autoMode}checkGraphOnlyMode(){this.isGraphOnlyMode()&&new b.Notice("Graph only mode - enter text to extract entities")}getInputPlaceholder(){return this.isGraphOnlyMode()?"Enter text to extract entities...":this.osintSearchMode?"Enter OSINT search query (e.g., 'Find info about john@example.com')...":this.darkWebMode?"Enter dark web investigation query...":this.reportGenerationMode?"Describe the report you want to generate...":"Ask a question about your vault..."}updateInputPlaceholder(){this.inputEl&&(this.inputEl.placeholder=this.getInputPlaceholder())}updateModeDisclaimer(){let e=this.containerEl.querySelector(".vault-ai-chat-input");if(!e)return;let t=e.querySelector(".vault-ai-mode-disclaimer"),n=this.getModeDisclaimer();if(n)if(t)t.empty(),t.createSpan({text:n.icon+" "}),t.createEl("strong",{text:n.title+" "}),t.createSpan({text:n.text});else{t=document.createElement("div"),t.className="vault-ai-mode-disclaimer";let o=document.createElement("span");o.textContent=n.icon+" ",t.appendChild(o);let a=document.createElement("strong");a.textContent=n.title+" ",t.appendChild(a);let s=document.createElement("span");s.textContent=n.text,t.appendChild(s),e.insertBefore(t,e.firstChild)}else t&&t.remove();let i=e.querySelector(".vault-ai-send-btn");i&&(i.textContent=this.osintSearchMode?"Search":"Send")}getGraphGenLabelText(){return this.isGraphOnlyMode()?"\u{1F3F7}\uFE0F Graph only (ON)":this.graphGenerationMode?"\u{1F3F7}\uFE0F Graph Generation (ON)":"\u{1F3F7}\uFE0F Graph Generation"}updateGraphGenerationLabel(){let e=this.containerEl.querySelector(".vault-ai-entity-gen-toggle");if(e){let t=e.querySelector("label");t&&(t.textContent=this.getGraphGenLabelText(),t.className=this.graphGenerationMode?"vault-ai-entity-gen-label active":"vault-ai-entity-gen-label",this.isGraphOnlyMode()?e.addClass("graph-only-mode"):e.removeClass("graph-only-mode"))}}updateAllModeLabels(){this.modeDropdown&&(this.customChatMode&&this.activeCheckpointId?this.modeDropdown.value=`custom-${this.activeCheckpointId}`:this.localSearchMode?this.modeDropdown.value="local":this.darkWebMode?this.modeDropdown.value="darkweb":this.reportGenerationMode?this.modeDropdown.value="report":this.osintSearchMode?this.modeDropdown.value="osint":this.autoMode?this.modeDropdown.value="auto":this.modeDropdown.value="none"),this.updateGraphGenerationLabel()}renderSidebar(){this.sidebarContainer.empty(),this.sidebarContainer.createDiv("vault-ai-sidebar-header").createEl("h4",{text:"Conversations"}),this.conversationListEl=this.sidebarContainer.createDiv("vault-ai-conversation-list"),this.renderConversationList()}renderConversationList(){this.conversationListEl.empty();let e=this.plugin.conversationService.getConversationList();if(e.length===0){this.conversationListEl.createEl("p",{text:"No conversations yet",cls:"vault-ai-no-conversations"});return}for(let t of e){let n=this.conversationListEl.createDiv("vault-ai-conversation-item");this.currentConversation&&this.currentConversation.id===t.id&&n.addClass("active");let i=n.createDiv("vault-ai-conversation-content");i.createEl("div",{text:t.title,cls:"vault-ai-conversation-title"});let o=i.createDiv("vault-ai-conversation-meta"),a=new Date(t.updatedAt);o.createEl("span",{text:this.formatDate(a),cls:"vault-ai-conversation-date"});let s=t.osintSearchMode||!1,l=t.autoMode??!0;t.graphGenerationMode&&!t.localSearchMode&&!t.darkWebMode&&!t.reportGenerationMode&&!s&&!l?o.createEl("span",{text:"\u{1F3F7}\uFE0F",cls:"vault-ai-conversation-graphonly",title:"Graph only mode"}):l?(o.createEl("span",{text:"\u2728",cls:"vault-ai-conversation-auto",title:"Auto (All-in-One) mode"}),t.graphGenerationMode&&o.createEl("span",{text:"\u{1F3F7}\uFE0F",cls:"vault-ai-conversation-graphgen",title:"Graph generation"})):s?(o.createEl("span",{text:"\u{1F50E}",cls:"vault-ai-conversation-osint-search",title:"Leak search mode"}),t.graphGenerationMode&&o.createEl("span",{text:"\u{1F3F7}\uFE0F",cls:"vault-ai-conversation-graphgen",title:"Graph generation"})):t.darkWebMode?(o.createEl("span",{text:"\u{1F575}\uFE0F",cls:"vault-ai-conversation-darkweb",title:"Dark web mode"}),t.graphGenerationMode&&o.createEl("span",{text:"\u{1F3F7}\uFE0F",cls:"vault-ai-conversation-graphgen",title:"Graph generation"})):t.reportGenerationMode?(o.createEl("span",{text:"\u{1F4C4}",cls:"vault-ai-conversation-report",title:"Companies&people generation mode"}),t.graphGenerationMode&&o.createEl("span",{text:"\u{1F3F7}\uFE0F",cls:"vault-ai-conversation-graphgen",title:"Graph generation"})):(o.createEl("span",{text:"\u{1F50D}",cls:"vault-ai-conversation-local-search",title:"Local search mode"}),t.graphGenerationMode&&o.createEl("span",{text:"\u{1F3F7}\uFE0F",cls:"vault-ai-conversation-graphgen",title:"Graph generation"})),i.addEventListener("click",()=>{this.loadConversation(t.id)});let d=n.createDiv("vault-ai-conversation-actions"),p=d.createEl("button",{cls:"vault-ai-conv-action-btn"});p.setText("\u270F\uFE0F"),p.title="Rename",p.addEventListener("click",u=>{u.stopPropagation(),this.renameConversation(t.id,t.title)});let h=d.createEl("button",{cls:"vault-ai-conv-action-btn"});h.setText("\u{1F5D1}\uFE0F"),h.title="Delete",h.addEventListener("click",u=>{u.stopPropagation(),this.deleteConversation(t.id)})}}formatDate(e){let n=new Date().getTime()-e.getTime(),i=Math.floor(n/(1e3*60*60*24));return i===0?e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):i===1?"Yesterday":i<7?e.toLocaleDateString([],{weekday:"short"}):e.toLocaleDateString([],{month:"short",day:"numeric"})}async loadConversation(e){if(this.currentConversation&&this.currentConversation.id===e)return;let t=await this.plugin.conversationService.loadConversation(e);t?(this.currentConversation=t,this.chatHistory=this.conversationMessagesToHistory(t.messages),this.darkWebMode=t.darkWebMode||!1,this.graphGenerationMode=t.graphGenerationMode||!1,this.reportGenerationMode=t.reportGenerationMode||!1,this.osintSearchMode=t.osintSearchMode||!1,this.autoMode=t.autoMode!==void 0?t.autoMode:!this.darkWebMode&&!this.reportGenerationMode&&!this.osintSearchMode&&!this.localSearchMode,this.plugin.conversationService.setCurrentConversationId(e),await this.render()):new b.Notice("Failed to load conversation")}async startNewConversation(){this.currentConversation&&this.chatHistory.length>0&&await this.saveCurrentConversation(),this.currentConversation=null,this.chatHistory=[],this.localSearchMode=!1,this.autoMode=!0,this.darkWebMode=!1,this.graphGenerationMode=!0,this.reportGenerationMode=!1,this.osintSearchMode=!1,this.plugin.conversationService.setCurrentConversationId(null),await this.render(),new b.Notice("Started new conversation")}async deleteConversation(e){new oe(this.app,"Delete Conversation","Are you sure you want to delete this conversation?",async()=>{let t=await this.plugin.conversationService.deleteConversation(e);this.currentConversation&&this.currentConversation.id===e&&(this.currentConversation=null,this.chatHistory=[]),this.renderConversationList(),await this.renderMessages(),t?new b.Notice("Conversation deleted"):new b.Notice("Failed to delete conversation")},void 0,!0).open()}renameConversation(e,t){new Ge(this.app,t,n=>{(async()=>await this.plugin.conversationService.renameConversation(e,n)&&(this.currentConversation&&this.currentConversation.id===e&&(this.currentConversation.title=n),await this.plugin.conversationService.loadConversationList(),this.renderConversationList(),new b.Notice("Conversation renamed")))()}).open()}async renderMessages(){if(this.messagesContainer.empty(),this.chatHistory.length===0){this.messagesContainer.createEl("p",{text:"Start a conversation by asking a question about your vault.",cls:"vault-ai-chat-empty"});return}for(let e=0;e<this.chatHistory.length;e++){let t=this.chatHistory[e],n=this.messagesContainer.createDiv(`vault-ai-chat-message vault-ai-chat-${t.role}`);n.setAttribute("data-message-index",e.toString()),t.jobId&&(n.addClass("vault-ai-darkweb-message"),t.status==="processing"?n.addClass("vault-ai-darkweb-processing"):t.status==="completed"?n.addClass("vault-ai-darkweb-completed"):t.status==="failed"&&n.addClass("vault-ai-darkweb-failed"));let i=n.createEl("strong",{text:t.role==="user"?"You: ":"AI: "}),o=n.createDiv("vault-ai-chat-content");if(await b.MarkdownRenderer.render(this.app,t.content,o,"",this),t.role==="assistant"&&t.progress&&typeof t.progress=="object"&&"percent"in t.progress){let a=n.createDiv("vault-ai-progress-container"),s=a.createDiv("vault-ai-progress-bar");s.style.width=`${t.progress.percent}%`;let l=a.createEl("span",{cls:"vault-ai-progress-text",text:`${t.progress.message||"Processing..."} (${t.progress.percent}%)`})}if(t.role==="assistant"&&t.intermediateResults&&t.intermediateResults.length>0){let a=n.createDiv("vault-ai-intermediate-results-container");a.createEl("strong",{text:"Intermediate results:"});let s=a.createEl("ul",{cls:"vault-ai-intermediate-results"});t.intermediateResults.forEach(l=>{s.createEl("li",{text:l})})}if(t.role==="assistant"&&t.notes&&t.notes.length>0){let a=n.createDiv("vault-ai-chat-notes");a.createEl("small",{text:"Referenced notes:"});for(let s of t.notes)a.createEl("a",{text:s.path,cls:"vault-ai-note-link"}).addEventListener("click",c=>{c.preventDefault(),(async()=>{let d=this.app.vault.getAbstractFileByPath(s.path);d instanceof b.TFile&&await this.app.workspace.getLeaf().openFile(d)})()})}if(t.role==="assistant"&&t.usedEntities&&t.usedEntities.length>0){let a=n.createDiv("vault-ai-used-entities");a.style.marginTop="8px",a.createEl("small",{text:"Graph sources:"});let s=a.createDiv("vault-ai-entity-chips-container");s.style.cssText=`
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        `;for(let l of t.usedEntities){let c=this.plugin.entityManager.getEntity(l.id);if(!c)continue;let d=s.createDiv("vault-ai-entity-chip");d.style.cssText=`
                display: inline-flex;
                align-items: center;
                padding: 2px 8px;
                border-radius: 12px;
                background: var(--background-modifier-border);
                font-size: 11px;
                cursor: pointer;
                border: 1px solid var(--background-modifier-border-hover);
                transition: background 0.2s;
            `,d.setAttribute("aria-label",`Open ${c.label}`);let p=d.createEl("span",{text:"\u{1F517}"});p.style.marginRight="4px",p.style.opacity="0.7",d.createEl("span",{text:c.label}),d.addEventListener("mouseenter",()=>{d.style.background="var(--background-modifier-hover)"}),d.addEventListener("mouseleave",()=>{d.style.background="var(--background-modifier-border)"}),d.addEventListener("click",h=>{h.preventDefault(),c.filePath&&(async()=>{let u=this.app.vault.getAbstractFileByPath(c.filePath);u instanceof b.TFile?await this.app.workspace.getLeaf().openFile(u):new b.Notice("Linked note file not found")})()})}}if(t.role==="assistant"&&t.createdEntities&&t.createdEntities.length>0){let a=n.createDiv("vault-ai-created-entities");a.style.cssText=`
          margin-top: 10px;
          padding: 10px;
          background: var(--background-secondary);
          border-radius: 6px;
          border-left: 3px solid var(--interactive-accent);
        `;for(let l of t.createdEntities){let c=a.createDiv("vault-ai-entity-row");c.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            flex-wrap: wrap;
          `;let d=c.createEl("span",{text:l.type,cls:"vault-ai-entity-type-badge"});d.style.cssText=`
            background: var(--interactive-accent);
            color: var(--text-on-accent);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
          `;let p=c.createEl("span",{text:l.label,cls:"vault-ai-entity-label"});p.style.cssText=`
            font-weight: 500;
            flex: 1;
            min-width: 100px;
          `;let h=c.createEl("button",{text:"\u{1F4C4} note",cls:"vault-ai-entity-note-btn"});h.style.cssText=`
            padding: 3px 8px;
            font-size: 11px;
            background: var(--background-modifier-border);
            border: none;
            border-radius: 4px;
            cursor: pointer;
          `,h.title="Open entity note",h.addEventListener("click",y=>{y.preventDefault(),(async()=>{let m=this.app.vault.getAbstractFileByPath(l.filePath);m instanceof b.TFile&&await this.app.workspace.getLeaf().openFile(m)})()});let u=c.createEl("button",{text:"\u{1F517} graph",cls:"vault-ai-entity-graph-btn"});u.style.cssText=`
            padding: 3px 8px;
            font-size: 11px;
            background: var(--interactive-accent);
            color: var(--text-on-accent);
            border: none;
            border-radius: 4px;
            cursor: pointer;
          `,u.title="View in graph",u.addEventListener("click",y=>{y.preventDefault(),this.plugin.openGraphViewWithEntity(l.id)})}let s=a.createEl("small",{text:"Click 'graph' to view entity in the graph, or 'note' to open its file.",cls:"vault-ai-entity-hint"});s.style.cssText=`
          display: block;
          margin-top: 8px;
          color: var(--text-muted);
          font-style: italic;
        `}if(t.role==="assistant"&&t.reportFilePath){let a=n.createDiv("vault-ai-report-button-container");a.setCssProps({"margin-top":"12px",padding:"10px",background:"var(--background-secondary)","border-radius":"6px","border-left":"3px solid var(--interactive-accent)"});let s=a.createEl("button",{text:"\u{1F4C4} open companies&people",cls:"vault-ai-open-report-btn"});s.setCssProps({padding:"8px 16px","font-size":"13px","font-weight":"500",background:"var(--interactive-accent)",color:"var(--text-on-accent)",border:"none","border-radius":"4px",cursor:"pointer",transition:"opacity 0.2s"}),s.title=`Open report: ${t.reportFilePath}`,s.addEventListener("mouseenter",()=>{s.setCssProps({opacity:"0.8"})}),s.addEventListener("mouseleave",()=>{s.setCssProps({opacity:"1"})}),s.addEventListener("click",c=>{c.preventDefault(),(async()=>{let d=this.app.vault.getAbstractFileByPath(t.reportFilePath);d instanceof b.TFile?(await this.app.workspace.getLeaf().openFile(d),new b.Notice(`Opened report: ${t.reportFilePath}`)):new b.Notice(`Companies&People file not found: ${t.reportFilePath}`)})()});let l=a.createEl("small",{text:`File: ${t.reportFilePath}`,cls:"vault-ai-report-path-label"});l.style.cssText=`
          display: block;
          margin-top: 6px;
          color: var(--text-muted);
          font-style: italic;
          font-size: 11px;
        `}}this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}updateProgressBar(e,t,n){let i=this.messagesContainer.querySelector(`.vault-ai-chat-message[data-message-index="${e}"]`);if(!i)return;let o=t||(e<this.chatHistory.length&&this.chatHistory[e].progress&&typeof this.chatHistory[e].progress=="object"&&"percent"in this.chatHistory[e].progress?this.chatHistory[e].progress:void 0),a=i.querySelector(".vault-ai-progress-container");if(o){if(a)a.empty();else{let u=i.querySelector(".vault-ai-chat-content");u?(a=document.createElement("div"),a.className="vault-ai-progress-container",u.insertAdjacentElement("afterend",a)):a=i.createDiv("vault-ai-progress-container")}let c=a.createDiv("vault-ai-progress-bar");c.style.width=`${o.percent}%`;let d=a.createDiv("vault-ai-progress-info");if(d.style.display="flex",d.style.justifyContent="space-between",d.style.alignItems="center",d.style.marginTop="4px",d.createEl("span",{cls:"vault-ai-progress-text",text:`${o.message||"Processing..."} (${o.percent}%)`}),this.activeAbortControllers.has(e)){let u=d.createEl("button",{text:"\u2715 Cancel",cls:"vault-ai-cancel-btn"});u.style.fontSize="11px",u.style.padding="2px 6px",u.style.height="auto",u.style.marginLeft="8px",u.style.color="var(--text-muted)",u.style.background="transparent",u.style.border="1px solid var(--background-modifier-border)",u.style.borderRadius="4px",u.style.cursor="pointer",u.addEventListener("mouseenter",()=>{u.style.color="var(--text-error)",u.style.borderColor="var(--text-error)"}),u.addEventListener("mouseleave",()=>{u.style.color="var(--text-muted)",u.style.borderColor="var(--background-modifier-border)"}),u.addEventListener("click",y=>{y.stopPropagation(),this.handleCancel(e)})}let p=o.message||"";if(p.includes("\u{1F4C4}")||p.includes("Report")||this.chatHistory[e]?.content&&this.chatHistory[e].content.includes("Generating report")){let u=a.createDiv("vault-ai-progress-disclaimer");u.style.marginTop="4px",u.style.fontSize="11px",u.style.color="var(--text-muted)",u.style.fontStyle="italic",u.innerText="It might take up to 5-6 minutes, don't close the tab"}}if(e<this.chatHistory.length){let c=i.querySelector(".vault-ai-chat-content");if(c){let d=this.chatHistory[e].content;c.textContent!==d&&(c.textContent=d)}}let s=n||(e<this.chatHistory.length&&this.chatHistory[e].intermediateResults&&this.chatHistory[e].intermediateResults.length>0?this.chatHistory[e].intermediateResults:void 0),l=i.querySelector(".vault-ai-intermediate-results-container");if(s&&s.length>0){l?l.empty():l=i.createDiv("vault-ai-intermediate-results-container"),l.createEl("strong",{text:"Intermediate results:"});let c=l.createEl("ul",{cls:"vault-ai-intermediate-results"});s.forEach(d=>{c.createEl("li",{text:d})})}}async handleCancel(e){let t=this.activeAbortControllers.get(e);t&&new oe(this.app,"Cancel Operation","Are you sure you want to cancel this operation?",()=>{if(t.abort(),this.activeAbortControllers.delete(e),this.chatHistory[e]){let n=this.chatHistory[e].content||"";this.chatHistory[e].content=n+`

\u274C **Cancelled by user**`,this.chatHistory[e].progress=void 0,this.renderMessages()}new b.Notice("Operation cancelled")},()=>{},!0).open()}async handleSend(){let e=this.inputEl.value.trim();if(!e&&this.attachedFiles.length===0)return;if(this.isGraphOnlyMode()&&e.startsWith("http")&&await this.handleUrlExtraction(e)){this.inputEl.value="",await this.saveCurrentConversation();return}if(this.inputEl.value="",!this.plugin.isAuthenticated()){new b.Notice("License key required for AI features. Please configure your license key in settings.");return}let t=e,n=e,i=[];if(this.attachedFiles.length>0){let a=[...this.attachedFiles];this.attachedFiles=[],this.renderAttachments();let s=a.length,l=this.chatHistory.length;this.chatHistory.push({role:"assistant",content:`\u{1F4C4} Extracting text from ${s} file${s>1?"s":""}...`}),await this.renderMessages();let c=[],d=0,p=0;for(let h of a){let u=h.file.name;this.chatHistory[l].content=`\u{1F4C4} Extracting text (${d+1}/${s}): ${u}...`,await this.renderMessages();try{let y="";if(h.extracted&&h.content)y=h.content;else if(h.file instanceof b.TFile){let m=h.file.extension;if(["md","txt"].includes(m))y=await this.app.vault.read(h.file);else{this.chatHistory[l].content=`\u{1F4C4} Processing ${u}... (this may take a moment for large files)`,await this.renderMessages();let v=await this.app.vault.readBinary(h.file),f=new Blob([v]),x=new File([f],h.file.name,{type:"application/octet-stream"});y=await this.plugin.graphApiService.extractTextFromFile(x)}}else{let m=u.split(".").pop()?.toLowerCase()||"";["md","txt"].includes(m)||(this.chatHistory[l].content=`\u{1F4C4} Processing ${u}... (this may take a moment for large files)`,await this.renderMessages()),y=await this.plugin.graphApiService.extractTextFromFile(h.file)}c.push(`

--- Content from ${u} ---
${y}`),i.push(u),d++}catch(y){p++,console.error(`Error extracting ${u}:`,y);let m=`Could not extract text from ${u}`,v=y instanceof Error?y.message:String(y);v.includes("timed out")||v.includes("timeout")||v.includes("AbortError")?m=`${u}: File too large or server busy. Try a smaller file.`:v.includes("429")||v.includes("Too Many Requests")?m=`${u}: Server busy (rate limited). Please wait and try again.`:v.includes("too large")&&(m=`${u}: ${v}`),new b.Notice(m,5e3)}}if(d>0)this.chatHistory.splice(l,1);else{this.chatHistory[l].content=`\u274C Failed to extract text from ${p} file${p>1?"s":""}. Please try again.`,await this.renderMessages();return}if(n=n+c.join(`
`),i.length>0){let h=i.map(u=>`\u{1F4CE} ${u}`).join(`
`);t=t?`${t}

${h}`:h}d>0&&p===0?new b.Notice(`Extracted text from ${d} file${d>1?"s":""}`):d>0&&p>0&&new b.Notice(`Extracted ${d} file${d>1?"s":""}, ${p} failed`)}this.chatHistory.push({role:"user",content:t}),await this.saveCurrentConversation();let o="localSearchMode";if(this.isGraphOnlyMode())o="none";else if(this.customChatMode)o="customChatMode";else if(this.autoMode){let a=this.chatHistory.length;this.chatHistory.push({role:"assistant",content:"..."}),await this.renderMessages();let s=await this.plugin.graphApiService.determineTaskPlan(n);console.log("[AutoMode] Detected task plan:",s),this.chatHistory.splice(a,1),this.graphGenerationMode=!1;let l=n;for(let c of s)c.action==="graph_generation"?(this.graphGenerationMode=!0,o==="localSearchMode"&&(o="none",l=c.target||n)):c.action==="graph_modification"?(this.graphGenerationMode=!0,this.graphModificationMode=!0,o==="localSearchMode"&&(o="none",l=c.target||n)):c.action==="graph_query"?(o="graphQueryMode",l=c.target||n):c.action==="report_generation"?(o="reportGenerationMode",l=c.target||n):c.action==="darkweb"?(o="darkWebMode",l=c.target||n):c.action==="osint_search"&&(o="osintSearchMode",l=c.target||n);n=l}else this.osintSearchMode?o="osintSearchMode":this.darkWebMode?o="darkWebMode":this.reportGenerationMode&&(o="reportGenerationMode");switch(o){case"none":await this.handleGraphOnlyMode(n);break;case"graphQueryMode":await this.handleGraphQuery(n);break;case"customChatMode":await this.handleCustomChat(n);break;case"osintSearchMode":await this.handleOSINTSearch(n);break;case"darkWebMode":await this.handleDarkWebInvestigation(n);break;case"reportGenerationMode":await this.handleReportGeneration(n);break;default:await this.handleNormalChat(n);break}await this.saveCurrentConversation()}async handleCustomChat(e){let t=this.chatHistory.length;this.chatHistory.push({role:"assistant",content:"",progress:{message:"Waiting for custom provider...",percent:10}}),await this.renderMessages(),((i,o)=>{this.activeAbortControllers.has(t)&&(this.chatHistory[t].progress={message:i,percent:o},this.updateProgressBar(t,{message:i,percent:o}))})("Sending to custom provider...",30);try{let i=new AbortController;this.activeAbortControllers.set(t,i);let o=this.plugin.settings.customCheckpoints.find(s=>s.id===this.activeCheckpointId),a=await this.plugin.graphApiService.chatWithCustomProvider(e,this.plugin.settings.systemPrompt,o?{customApiUrl:o.url,customApiKey:o.apiKey,customModel:o.model,type:o.type||"openai"}:void 0,i.signal);if(this.activeAbortControllers.delete(t),this.chatHistory[t].content=a,this.chatHistory[t].progress=void 0,await this.renderMessages(),this.graphGenerationMode)try{await this.processGraphGeneration(t,a,e,a,this.graphModificationMode)}catch(s){console.error("[OSINT Copilot] Graph generation from custom chat failed:",s),new b.Notice("Graph generation failed, but the chat response was received successfully.")}}catch(i){this.activeAbortControllers.delete(t);let o=i instanceof Error?i.message:String(i);if(o==="Cancelled by user"||o.includes("Aborted")||o.includes("Request was cancelled"))return;console.error("Custom chat error:",i),this.chatHistory[t].content=`Error calling custom provider: ${o}`,this.chatHistory[t].progress=void 0,await this.renderMessages()}}async handleGraphQuery(e){let t=this.chatHistory.length;this.chatHistory.push({role:"assistant",content:"\u{1F50D} Analyzing your graph...",progress:{message:"Gathering graph state...",percent:10}}),await this.renderMessages();let n=(i,o)=>{this.chatHistory[t].progress={message:i,percent:o},this.chatHistory[t].content=`\u{1F50D} ${i}`,this.updateProgressBar(t,{message:i,percent:o})};try{let i=this.plugin.entityManager.getAllEntities(),o=this.plugin.entityManager.getAllConnections().map(l=>({from:l.fromEntityId,to:l.toEntityId,relationship:l.relationship}));n(`Sending graph (${i.length} entities, ${o.length} connections) to AI...`,30);let a=(l,c,d,p)=>{let h=Math.round(p/1e3);n(`\u26A0\uFE0F Retrying in ${h}s... (${l+1}/${c})`,35)},s=await this.plugin.graphApiService.processText(e,i,void 0,a,void 0,!1,o,!0);this.chatHistory[t].progress=void 0,s.success&&s.message?this.chatHistory[t].content=s.message:s.success?this.chatHistory[t].content=`\u{1F50D} **No answer generated**

The AI couldn't analyze the graph. Make sure you have entities in your graph.`:this.chatHistory[t].content=`\u{1F50D} **Graph Query Failed**

**Error:** ${s.error||"Unknown error"}

Please try rephrasing your question.`,await this.renderMessages()}catch(i){console.error("[GraphQuery] Error:",i),this.chatHistory[t].progress=void 0,this.chatHistory[t].content=`\u{1F50D} **Graph Query Error**

${i instanceof Error?i.message:"An unexpected error occurred."}`,await this.renderMessages()}}async handleGraphOnlyMode(e){let t=this.chatHistory.length;this.chatHistory.push({role:"assistant",content:"\u{1F3F7}\uFE0F Extracting entities from your text...",progress:{message:"Analyzing text...",percent:10}}),await this.renderMessages();let n=(i,o)=>{this.chatHistory[t].progress={message:i,percent:o},this.chatHistory[t].content=`\u{1F3F7}\uFE0F ${i}`,this.updateProgressBar(t,{message:i,percent:o})};try{let i=this.plugin.entityManager.getAllEntities();n("Checking existing entities...",20);let o=(f,x,g,T)=>{let C=Math.round(T/1e3),D="Network interrupted";g==="timeout"?D="Request takes longer than usual, please wait":g==="network"?D="Network connection lost":g.startsWith("server-error")?D="Server temporarily unavailable":g==="rate-limited"&&(D="Rate limited"),n(`\u26A0\uFE0F ${D}. Retrying in ${C}s... (${f+1}/${x})`,25)};n("Sending text to AI for entity extraction...",30);let a=(f,x,g)=>{let T=30+Math.round(f/x*20);n(`\u{1F4E6} ${g}`,T)},s=this.graphModificationMode?this.plugin.entityManager.getAllConnections().map(f=>({from:f.fromEntityId,to:f.toEntityId,relationship:f.relationship})):void 0,l=await this.plugin.graphApiService.processTextInChunks(e,i,void 0,a,o,void 0,this.graphModificationMode,s);if(n("Processing API response...",50),!l.success){this.chatHistory[t].progress=void 0,this.chatHistory[t].content=`\u{1F3F7}\uFE0F **Graph Generation Failed**

**Input:** ${e.substring(0,100)}${e.length>100?"...":""}

**Error:** ${l.error||"Unknown error"}`,await this.renderMessages();return}if(!l.operations||l.operations.length===0){this.chatHistory[t].progress=void 0,this.chatHistory[t].content=`\u{1F3F7}\uFE0F **Graph Generation Complete**

**Input:** ${e.substring(0,200)}${e.length>200?"...":""}

No entities detected in the provided text.`,await this.renderMessages();return}let c=0;for(let f of l.operations)f.action==="create"&&f.entities&&(c+=f.entities.length);n(`Found ${c} entities to create...`,55);let d=[],p=0,h=0,u=0,y=0,m=0;console.debug("[GraphOnlyMode] Processing operations:",JSON.stringify(l.operations,null,2));for(let f of l.operations){console.debug("[GraphOnlyMode] Processing operation:",{action:f.action,hasEntities:!!f.entities,entitiesCount:f.entities?.length||0,hasConnections:!!f.connections,connectionsCount:f.connections?.length||0});let x=[];if(f.action==="create"&&f.entities){for(let g of f.entities){h++;let T=55+Math.round(h/c*35);n(`Creating entity ${h}/${c}...`,T),console.debug("[EntityOnlyMode] Processing entity:",{type:g.type,properties:g.properties});try{let C=g.type;if(!Object.values(V).includes(C)){console.warn(`[EntityOnlyMode] Unknown entity type: ${g.type}. Valid types:`,Object.values(V)),x.push(null);continue}let S=_[C]?.labelField,E=S?g.properties[S]:null;if(E){let M=ne(E,C);if(!M.isValid){console.warn(`[EntityOnlyMode] Skipping entity with generic name: "${E}" - ${M.error}`),x.push(null);continue}}console.debug("[GraphOnlyMode] Creating entity with type:",C);let w=await this.plugin.entityManager.createEntity(C,g.properties);console.debug("[GraphOnlyMode] Entity created successfully:",{id:w.id,type:w.type,label:w.label,filePath:w.filePath}),x.push(w),d.push({id:w.id,type:w.type,label:w.label,filePath:w.filePath||""})}catch(C){console.error("[GraphOnlyMode] Failed to create entity:",C),x.push(null)}}if(f.connections&&f.connections.length>0){n("Creating relationships...",92);for(let g of f.connections)try{let T=x[g.from],C=x[g.to];T&&C&&(await this.plugin.entityManager.addRelationshipToNote(T,C,g.relationship),p++)}catch(T){console.error("[GraphOnlyMode] Failed to create connection:",T)}}}else if(f.action==="delete"&&f.deletions){n("Processing deletions...",90);for(let g of f.deletions)try{this.plugin.entityManager.getEntity(g)?(await this.plugin.entityManager.deleteEntity(g),u++):this.plugin.entityManager.getConnection(g)?(await this.plugin.entityManager.deleteConnectionWithNote(g),y++):console.warn(`[GraphOnlyMode] Element to delete not found: ${g}`)}catch(T){console.error(`[GraphOnlyMode] Failed to delete element ${g}:`,T)}}else if(f.action==="update"&&f.updates){n("Applying updates...",92);for(let g of f.updates)try{g.id&&this.plugin.entityManager.getEntity(g.id)&&(await this.plugin.entityManager.updateEntity(g.id,g.new_properties||{}),m++)}catch(T){console.error(`[GraphOnlyMode] Failed to update entity ${g.id}:`,T)}}else if(f.action==="connect"&&f.new_connections){n("Connecting entities...",93);for(let g of f.new_connections)try{let T=this.plugin.entityManager.getEntity(g.from_id),C=this.plugin.entityManager.getEntity(g.to_id);T&&C?(await this.plugin.entityManager.addRelationshipToNote(T,C,g.relationship),p++):console.warn(`[GraphOnlyMode] Cannot connect: from=${g.from_id} to=${g.to_id} - entity not found`)}catch(T){console.error("[GraphOnlyMode] Failed to connect entities:",T)}}}n("Finalizing...",98);let v=`\u{1F3F7}\uFE0F **Graph Operations Complete**

`;if(v+=`**Input:** ${e.substring(0,200)}${e.length>200?"...":""}

`,d.length>0||u>0||m>0||y>0||p>0?(this.chatHistory[t].createdEntities=d,this.chatHistory[t].connectionsCreated=p,d.length>0&&(v+=`
- **Entities Created:** ${d.length}`),p>0&&(v+=`
- **Relationships Created:** ${p}`),u>0&&(v+=`
- **Entities Deleted:** ${u}`),y>0&&(v+=`
- **Relationships Deleted:** ${y}`),m>0&&(v+=`
- **Entities Updated:** ${m}`)):v+="No operations were performed.",this.chatHistory[t].progress=void 0,this.chatHistory[t].content=v,await this.renderMessages(),d.length>0||u>0||m>0||y>0){let f=[];d.length>0&&f.push(`${d.length} entities created`),p>0&&f.push(`${p} relationships`),u>0&&f.push(`${u} deleted`),m>0&&f.push(`${m} updated`),new b.Notice(`Graph updated: ${f.join(", ")}`),await this.plugin.refreshOrOpenGraphView()}}catch(i){this.activeAbortControllers.delete(t);let o=i instanceof Error?i.message:String(i);if(o==="Cancelled by user"||o.includes("Aborted")||o.includes("Request was cancelled"))return;this.chatHistory[t].progress=void 0,this.chatHistory[t].content=`\u{1F3F7}\uFE0F **Graph Generation Failed**

**Input:** ${e.substring(0,100)}${e.length>100?"...":""}

**Error:** ${o}`,await this.renderMessages(),new b.Notice(`Graph generation failed: ${o}`)}}async handleNormalChat(e){this.chatHistory.push({role:"assistant",content:"Analyzing query...",progress:{message:"Analyzing query...",percent:10}});let t=this.chatHistory.length-1;await this.renderMessages();let n=(a,s)=>{this.activeAbortControllers.has(t)&&(this.chatHistory[t].progress={message:a,percent:s},this.updateProgressBar(t,{message:a,percent:s}))},i=()=>{let a=this.messagesContainer.querySelectorAll(".vault-ai-chat-message.vault-ai-chat-assistant .vault-ai-chat-content");return a.length===0?null:a[a.length-1]},o="";try{let a=new AbortController;this.activeAbortControllers.set(t,a),n("Extracting entities from query...",15);let s=await this.plugin.extractEntitiesFromQuery(e),l="No specific entities identified. Searching vault...";s.length>0&&(l=`Entities defined (${s.filter(w=>w.name).map(w=>`${w.type}: ${w.name}`).join(", ")}). Searching vault & graph...`),this.chatHistory[t].content=l,n("Entities extracted, searching vault...",30);let c=this.plugin.retrieveNotes(e);if(c.length<3&&s.length>0){for(let E of s)if(E.name){let w=this.plugin.retrieveNotes(E.name),M=new Set(c.map(I=>I.path));for(let I of w)M.has(I.path)||(c.push(I),M.add(I.path))}}n("Checking Knowledge Graph...",40);let d="",p=new Set;if(s.length>0){let E=new Set;for(let w of s){if(!w.name)continue;let M=this.plugin.entityManager.findEntityByLabel(w.name);if(M){let I=this.plugin.entityManager.getConnectionsForEntity(M.id);for(let N of I){let O=this.plugin.entityManager.getEntity(N.fromEntityId),z=this.plugin.entityManager.getEntity(N.toEntityId);if(O&&z){let W=`[${O.label}] (ID:${O.id}) --(${N.relationship})--> [${z.label}] (ID:${z.id})`;E.has(W)||(d+="- "+W+`
`,E.add(W),p.add(O.id),p.add(z.id))}}}}}let h="";if(d.length>0&&(h=`Knowledge Graph Connections:
`+d+"\nIMPORTANT INSTRUCTION: If you use any relationship facts from the 'Knowledge Graph Connections' section above to answer the user's question, you MUST cite the Entity IDs used at the very end of your response. Use this exact format: `[[USED_ENTITY_ID: <ID>]]`. List each used entity ID. Do not output this for note citations, ONLY for graph entities found in the Knowledge Graph section.\n"),c.length===0&&d.length===0){this.chatHistory[t].progress=void 0,this.chatHistory[t].content=l+`

No relevant notes or graph connections found.`,this.chatHistory[t].notes=[],await this.renderMessages();return}n(`Found ${c.length} notes & ${p.size} related entities...`,50),o=l+`

Found ${c.length} relevant notes and ${p.size} graph connections.
Drafting the answer...

`,this.chatHistory[t].content=o,this.chatHistory[t].notes=c,await this.renderMessages(),n("Generating response...",60);let u=i(),y="",m=60,v=(E,w)=>{n(`Network interrupted. Retrying... (${E}/${w})`,m),this.chatHistory[t].content=o+`\u26A0\uFE0F Network interrupted. Retrying... (${E}/${w})`,this.renderMessages()},f=E=>{if(y+=E,m<95&&(m+=.5,n("Streaming response...",Math.min(95,m))),u){b.MarkdownRenderer.renderMarkdown(y,u,"",this.plugin);let w=this.messagesContainer.parentElement;w&&(w.scrollTop=w.scrollHeight)}},x=await this.plugin.askVaultStream(e,f,c,v,h,a.signal);this.activeAbortControllers.delete(t);let g=x.fullAnswer,T=new Set,C=/\[\[USED_ENTITY_ID:\s*([a-zA-Z0-9-]+)\]\]/g,D;for(;(D=C.exec(g))!==null;)T.add(D[1]);g=g.replace(C,"").trim();let S=[];for(let E of T){let w=this.plugin.entityManager.getEntity(E);w&&S.push({id:w.id,label:w.label,type:w.type})}if(this.chatHistory[t].content=g,this.chatHistory[t].progress=void 0,this.chatHistory[t].usedEntities=S,await this.saveCurrentConversation(),await this.renderMessages(),this.graphGenerationMode)try{await this.processGraphGeneration(t,x.fullAnswer,e,g)}catch(E){console.error("[OSINT Copilot] Graph generation from chat failed:",E),new b.Notice("Graph generation failed, but the chat response was received successfully.")}}catch(a){console.error("Chat error:",a);let s=a instanceof Error?a.message:String(a);this.chatHistory[t].progress=void 0,this.chatHistory[t].content=`Error: ${s}

\u{1F4A1} Tip: Your message was saved. You can try sending it again.`,await this.renderMessages(),this.inputEl.value=e}}async processGraphGeneration(e,t,n,i,o=!1){let a=(s,l)=>{this.chatHistory[e].progress={message:s,percent:l},this.updateProgressBar(e,{message:s,percent:l})};try{let s=this.chatHistory[e].content||i;a("Extracting entities from response...",10);let l=s+`

\u{1F3F7}\uFE0F Extracting entities...`;this.chatHistory[e].content=l,await this.renderMessages();let c=`Extract all entities (people, companies, locations, events) and their relationships from the following content. Create entities for each person, company, location, and event mentioned. Return JSON operations to create entities, do NOT provide analysis or summary.

Original Query: ${n}

Content to extract entities from:
${t}`,d=this.plugin.entityManager.getAllEntities(),p=(E,w,M,I)=>{let N=Math.round(I/1e3),O="Network interrupted";M==="timeout"?O="Request takes longer than usual, please wait":M==="network"?O="Network connection lost":M.startsWith("server-error")?O="Server temporarily unavailable":M==="rate-limited"&&(O="Rate limited");let z=`

\u26A0\uFE0F ${O}. Retrying in ${N}s... (attempt ${E+1}/${w})`,W=this.chatHistory[e].content||"";this.chatHistory[e].content=W+z,this.renderMessages()},h=(E,w,M)=>{let I=10+Math.round(E/w*30);a(`\u{1F4E6} ${M}`,I)};a("Sending to AI for entity extraction...",15);let u=new AbortController;this.activeAbortControllers.set(e,u);let y=o||this.graphModificationMode,m=y?this.plugin.entityManager.getAllConnections().map(E=>({from:E.fromEntityId,to:E.toEntityId,relationship:E.relationship})):void 0,v=await this.plugin.graphApiService.processTextInChunks(c,d,void 0,h,p,u.signal,y,m);if(this.activeAbortControllers.delete(e),a("Processing extraction results...",40),!v.success){this.chatHistory[e].progress=void 0;let E=this.chatHistory[e].content||"";this.chatHistory[e].content=E+`

\u26A0\uFE0F Entity extraction failed: ${v.error||"Unknown error"}`,await this.renderMessages();return}if(!v.operations||v.operations.length===0){this.chatHistory[e].progress=void 0;let E=this.chatHistory[e].content||"";this.chatHistory[e].content=E+`

\u{1F3F7}\uFE0F No new entities detected in the response.`,await this.renderMessages();return}a("Creating entities...",50);let f=[],x=0,g=0,T=0,C=0,D=0;for(let E of v.operations)E.action==="create"&&E.entities&&(D+=E.entities.length);let S=0;console.debug("[GraphGeneration] Processing operations:",JSON.stringify(v.operations,null,2));for(let E of v.operations){console.debug("[GraphGeneration] Processing operation:",{action:E.action,hasEntities:!!E.entities,entitiesCount:E.entities?.length||0,hasConnections:!!E.connections,connectionsCount:E.connections?.length||0});let w=[];if(E.action==="create"&&E.entities){for(let M of E.entities){S++;let I=50+Math.round(S/Math.max(D,1)*35);a(`Creating entity ${S}/${D}...`,I),console.debug("[GraphGeneration] Processing entity:",{type:M.type,properties:M.properties});try{let N=M.type;if(!Object.values(V).includes(N)){console.warn(`[GraphGeneration] Unknown entity type: ${M.type}. Valid types:`,Object.values(V)),w.push(null);continue}let z=_[N]?.labelField,W=z?M.properties[z]:null;if(W){let He=ne(W,N);if(!He.isValid){console.warn(`[GraphGeneration] Skipping entity with generic name: "${W}" - ${He.error}`),w.push(null);continue}}console.debug("[GraphGeneration] Creating entity with type:",N);let j=await this.plugin.entityManager.createEntity(N,M.properties);console.debug("[GraphGeneration] Entity created successfully:",{id:j.id,type:j.type,label:j.label,filePath:j.filePath}),w.push(j),f.push({id:j.id,type:j.type,label:j.label,filePath:j.filePath||""})}catch(N){console.error("[GraphGeneration] Failed to create entity:",N),w.push(null)}}if(E.connections&&E.connections.length>0){a("Creating relationships...",88);for(let M of E.connections)try{let I=w[M.from],N=w[M.to];I&&N&&(await this.plugin.entityManager.addRelationshipToNote(I,N,M.relationship),x++)}catch(I){console.error("[GraphGeneration] Failed to create connection:",I)}}}else if(E.action==="delete"&&E.deletions){a("Processing deletions...",90);for(let M of E.deletions)try{this.plugin.entityManager.getEntity(M)?(await this.plugin.entityManager.deleteEntity(M),g++):this.plugin.entityManager.getConnection(M)?(await this.plugin.entityManager.deleteConnectionWithNote(M),T++):console.warn(`[GraphGeneration] Element to delete not found: ${M}`)}catch(I){console.error(`[GraphGeneration] Failed to delete element ${M}:`,I)}}else if(E.action==="update"&&E.updates){a("Applying updates...",92);for(let M of E.updates)try{M.id&&this.plugin.entityManager.getEntity(M.id)&&(await this.plugin.entityManager.updateEntity(M.id,M.new_properties||{}),C++)}catch(I){console.error(`[GraphGeneration] Failed to update entity ${M.id}:`,I)}}else if(E.action==="connect"&&E.new_connections){a("Connecting entities...",93);for(let M of E.new_connections)try{let I=this.plugin.entityManager.getEntity(M.from_id),N=this.plugin.entityManager.getEntity(M.to_id);I&&N?(await this.plugin.entityManager.addRelationshipToNote(I,N,M.relationship),x++):console.warn(`[GraphGeneration] Cannot connect: from=${M.from_id} to=${M.to_id} - entity not found`)}catch(I){console.error("[GraphGeneration] Failed to connect entities:",I)}}}if(a("Finalizing...",95),f.length>0||g>0||C>0||T>0||x>0){this.chatHistory[e].createdEntities=f,this.chatHistory[e].connectionsCreated=x;let E=`

\u{1F3F7}\uFE0F **Graph Operations Complete:**`;f.length>0&&(E+=`
- **Entities Created:** ${f.length}`),x>0&&(E+=`
- **Relationships Created:** ${x}`),g>0&&(E+=`
- **Entities Deleted:** ${g}`),T>0&&(E+=`
- **Relationships Deleted:** ${T}`),C>0&&(E+=`
- **Entities Updated:** ${C}`),this.chatHistory[e].progress=void 0;let w=this.chatHistory[e].content||"";this.chatHistory[e].content=w+E,await this.plugin.refreshOrOpenGraphView()}else{this.chatHistory[e].progress=void 0;let E=this.chatHistory[e].content||"";this.chatHistory[e].content=E+`

\u{1F3F7}\uFE0F No entities were created or modified.`}await this.renderMessages()}catch(s){console.error("[GraphGeneration] Error during graph generation:",s);let l=s instanceof Error?s.message:String(s);this.chatHistory[e].progress=void 0,this.chatHistory[e].content=i+`

\u26A0\uFE0F Graph generation error: ${l}`,await this.renderMessages()}}async handleReportGeneration(e){let t=this.chatHistory.length;this.chatHistory.push({role:"assistant",content:"\u{1F4C4} Generating report, 3-6 mins, don't close the tab",progress:{message:"Initializing research...",percent:5}}),await this.renderMessages();try{let n=new AbortController;this.activeAbortControllers.set(t,n);let i=await this.plugin.generateReport(e,this.currentConversation,(l,c,d)=>{let p=l;l==="processing"&&(p="Generating report..."),l==="queued"&&(p="Queued for processing...");let h=`\u{1F4C4} ${p}`;c?(h=`\u{1F4C4} ${c.message}`,console.info(`[OSINT Copilot] Report progress update: ${c.percent}% - ${c.message}`)):console.info(`[OSINT Copilot] Report status update: ${l}`),this.chatHistory[t].content=h,c&&(this.chatHistory[t].progress=c),d&&d.length>0&&(this.chatHistory[t].intermediateResults=d),this.updateProgressBar(t,c,d)},n.signal);this.activeAbortControllers.delete(t);let o=await this.plugin.saveReportToVault(i.content,e,i.filename);this.currentConversation&&await this.saveCurrentConversation();let a=`\u{1F4C4} **Companies&People Generated Successfully!**

**Request:** ${e}

**Saved to:** \`${o}\`

---

`+i.content;if(this.chatHistory[t].content=a,this.chatHistory[t].reportFilePath=o,await this.renderMessages(),this.graphGenerationMode)try{await this.processGraphGeneration(t,i.content,e,a)}catch(l){console.error("[OSINT Copilot] Graph generation from report failed:",l),new b.Notice("Graph generation failed, but the report was saved successfully.")}let s=this.app.vault.getAbstractFileByPath(o);s instanceof b.TFile&&await this.app.workspace.getLeaf().openFile(s),new b.Notice(`Companies&People saved to ${o}`)}catch(n){this.activeAbortControllers.delete(t);let i=n instanceof Error?n.message:String(n);if(i==="Cancelled by user"||i.includes("Aborted"))return;let o=i,a="";i.toLowerCase().includes("ssl")||i.toLowerCase().includes("certificate")?(o="Backend service temporarily unavailable (SSL/certificate issue)",a=`

\u{1F4A1} **Suggestion:** This is a temporary server-side issue. Please try again in a few minutes.`):i.toLowerCase().includes("timeout")?(o="Companies&People generation timed out",a=`

\u{1F4A1} **Suggestion:** The server may be busy. Please try again with a simpler query.`):i.toLowerCase().includes("quota")?a=`

\u{1F4A1} **Suggestion:** Visit https://osint-copilot.com/dashboard/ to check your quota.`:i.toLowerCase().includes("network")||i.toLowerCase().includes("fetch")?(o="Network connection error",a=`

\u{1F4A1} **Suggestion:** Check your internet connection and try again.`):(i.toLowerCase().includes("n8n")||i.toLowerCase().includes("workflow"))&&(o="Backend workflow error",a=`

\u{1F4A1} **Suggestion:** This is a temporary server-side issue. Please try again in a few minutes.`),this.chatHistory[t].content=`\u{1F4C4} **Companies&People Generation Failed**

**Request:** ${e}

**Error:** ${o}${a}`,await this.renderMessages(),new b.Notice(`Companies&People generation failed: ${o}`)}}async handleOSINTSearch(e){let t=this.chatHistory.length;this.chatHistory.push({role:"assistant",content:"\u{1F50E} Searching OSINT databases...",progress:{message:"Analyzing query...",percent:10}}),await this.renderMessages();let n=(i,o)=>{this.activeAbortControllers.has(t)&&(this.chatHistory[t].progress={message:i,percent:o},this.chatHistory[t].content=`\u{1F50E} ${i}`,this.updateProgressBar(t,{message:i,percent:o}))};try{if(!this.plugin.settings.reportApiKey){this.chatHistory[t].progress=void 0,this.chatHistory[t].content=`\u{1F50E} **Digital Footprint Failed**

**Error:** License key required for Digital Footprint.

Please configure your API key in Settings \u2192 OSINT Copilot \u2192 API Key.`,await this.renderMessages(),new b.Notice("License key required for leak search. Configure in settings.");return}n("Detecting entities in query...",20);let i={query:e,country:this.osintSearchCountry,max_providers:this.osintSearchMaxProviders,parallel:this.osintSearchParallel},o=(c,d,p,h)=>{let u=Math.round(h/1e3),y="Network interrupted";p==="timeout"?y="Request takes longer than usual, please wait":p==="network"?y="Network connection lost":p.startsWith("server-error")?y="Server temporarily unavailable":p==="rate-limited"&&(y="Rate limited"),n(`\u26A0\uFE0F ${y}. Retrying in ${u}s... (${c+1}/${d})`,40)};n("Searching OSINT databases...",50);let a=new AbortController;this.activeAbortControllers.set(t,a);let s=await this.plugin.graphApiService.aiSearch(i,o,a.signal);this.activeAbortControllers.delete(t),n("Processing results...",80);let l=this.renderOSINTSearchResults(t,e,s);if(this.graphGenerationMode&&s.results&&s.results.length>0)try{let c=this.formatOSINTResultsForEntityExtraction(e,s);await this.processGraphGeneration(t,c,e,l)}catch(c){console.error("[ChatView] Graph generation from OSINT results failed:",c);let d=c instanceof Error?c.message:String(c);this.chatHistory[t].content=l+`

\u26A0\uFE0F Graph generation failed: ${d}`,this.chatHistory[t].progress=void 0,await this.renderMessages()}}catch(i){this.activeAbortControllers.delete(t),console.error("[ChatView] Digital Footprint error:",i),this.chatHistory[t].progress=void 0;let o=i instanceof Error?i.message:String(i);if(o==="Cancelled by user"||o.includes("Aborted"))return;let a="";o.includes("timeout")?a=`

\u{1F4A1} Try reducing the number of providers or simplifying your query.`:o.includes("unavailable")?a=`

\u{1F4A1} The service may be temporarily down. Please try again later.`:(o.includes("Authentication")||o.includes("API key"))&&(a=`

\u{1F4A1} Please check your API key in Settings \u2192 OSINT Copilot \u2192 API Key.`),this.chatHistory[t].content=`\u{1F50E} **Digital Footprint Failed**

**Query:** ${e}

**Error:** ${o}${a}`,await this.renderMessages(),new b.Notice(`Digital Footprint failed: ${o}`)}}renderOSINTSearchResults(e,t,n){this.chatHistory[e].progress=void 0;let i=`\u{1F50E} **Digital Footprint Results**

`;if(i+=`**Query:** ${t}
`,i+=`\u23F1\uFE0F ${(n.execution_time_ms/1e3).toFixed(1)}s | \u{1F4CA} ${n.total_results} result(s)

`,n.detected_entities&&n.detected_entities.length>0){i+=`---

### \u{1F4CB} Detected Entities

`;for(let o of n.detected_entities){let a=this.getEntityTypeIcon(o.type),s=Math.round(o.confidence*100);i+=`${a} **${o.type}:** \`${o.value}\` (${s}% confidence)
`}i+=`
`}else i+=`---

### \u{1F4CB} Detected Entities

`,i+=`\u26A0\uFE0F No searchable entities detected in your query.
`,i+=`Try including an email, phone, name, or other identifier.

`;if(n.results&&n.results.length>0){i+=`---

### \u{1F4CA} Results

`;for(let o=0;o<n.results.length;o++){let a=n.results[o];i+=`**Result ${o+1}:**
`,i+="```json\n",i+=JSON.stringify(a,null,2),i+="\n```\n\n"}}else n.detected_entities&&n.detected_entities.length>0&&(i+=`---

### \u{1F4CA} Results

`,i+=`No results found.

`);return n.explanation&&(i+=`---

### \u{1F4A1} Explanation

`,i+=`${n.explanation}
`),this.chatHistory[e].content=i,this.renderMessages(),i}formatOSINTResultsForEntityExtraction(e,t){let n=`Digital Footprint Results for query: "${e}"

`;if(t.detected_entities&&t.detected_entities.length>0){n+=`Detected search entities:
`;for(let i of t.detected_entities)n+=`- ${i.type}: ${i.value}
`;n+=`
`}if(t.results&&t.results.length>0){n+=`Found ${t.total_results} results:

`;for(let i=0;i<t.results.length;i++){let o=t.results[i];n+=`Result ${i+1}:
`,n+=JSON.stringify(o,null,2),n+=`

`}}return t.explanation&&(n+=`
Explanation: ${t.explanation}
`),n}getEntityTypeIcon(e){return{email:"\u{1F4E7}",phone:"\u{1F4DE}",name:"\u{1F464}",ip:"\u{1F310}",domain:"\u{1F517}",passport:"\u{1F6C2}",inn:"\u{1F4B3}",snils:"\u{1F194}",address:"\u{1F4CD}",auto:"\u{1F697}",ogrn:"\u{1F3E2}"}[e.toLowerCase()]||"\u{1F4E6}"}async handleDarkWebInvestigation(e){let t=this.chatHistory.length;this.chatHistory.push({role:"assistant",content:"\u{1F575}\uFE0F Starting dark web investigation...",status:"starting",progress:{message:"Initializing investigation...",percent:5}}),await this.renderMessages();let n=(d,p)=>{this.chatHistory[t].progress={message:d,percent:p},this.updateProgressBar(t,{message:d,percent:p})},i=3,o=1e3,a=null,s=new AbortController;this.activeAbortControllers.set(t,s);for(let d=1;d<=i;d++){if(s.signal.aborted){this.activeAbortControllers.delete(t);return}try{n("Connecting to dark web API...",10);let p=`${se}/api/darkweb/investigate`,h=await(0,b.requestUrl)({url:p,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.plugin.settings.reportApiKey}`},body:JSON.stringify({query:e,model:st,threads:8}),throw:!1});if(h.status<200||h.status>=300){let m=h.text||"";if(h.status===403){let v=m.toLowerCase();if(v.includes("quota")||v.includes("exceeded"))throw new Error("Investigation credits exhausted. Please upgrade your plan or wait for credit renewal. Visit https://osint-copilot.com/dashboard/ to manage your subscription.");if(v.includes("expired"))throw new Error("Your license key or trial has expired. Please renew your subscription at https://osint-copilot.com/dashboard/");if(v.includes("inactive"))throw new Error("Your license key is inactive. Please check your account status at https://osint-copilot.com/dashboard/")}throw new Error(`DarkWeb API request failed (${h.status}): ${m.substring(0,200)}`)}n("Processing API response...",15);let y=h.json.job_id;if(!y)throw new Error("No job ID returned from DarkWeb API");n("Investigation started, searching dark web engines...",20),console.debug(`[OSINT Copilot] Dark web investigation started with Job ID: ${y}`),this.chatHistory[t]={role:"assistant",content:`\u{1F575}\uFE0F Dark web investigation started

**Query:** ${e}
**Status:** Processing
**Estimated time:** 2-3 minutes

Searching 15+ dark web engines...`,jobId:y,status:"processing",query:e,progress:{message:"Searching dark web engines...",percent:20}},await this.renderMessages(),this.pollDarkWebStatus(y,t,e);return}catch(p){if(this.activeAbortControllers.has(t)&&this.activeAbortControllers.get(t)?.signal.aborted)return;if(a=p instanceof Error?p:new Error(String(p)),!this.plugin.isTransientNetworkError(a))break;if(d<i){let h=o*Math.pow(2,d-1);console.debug(`[OSINT Copilot] DarkWeb API network error, retrying in ${h}ms (attempt ${d}/${i})`),n(`Network error. Retrying... (${d}/${i})`,8),this.chatHistory[t]={role:"assistant",content:`\u{1F575}\uFE0F Starting dark web investigation...

\u26A0\uFE0F Network interrupted. Retrying... (${d}/${i})`,status:"starting"},await this.renderMessages(),await this.plugin.sleep(h)}}}let l=a?a.message:"Unknown error",c=a&&this.plugin.isTransientNetworkError(a);this.chatHistory[t]={role:"assistant",content:`\u274C Error starting dark web investigation: ${c?"Network connection error. Please check your internet connection and try again.":l}

\u{1F4A1} Tip: Your query was saved. You can try sending it again.`,status:"failed"},await this.renderMessages(),this.inputEl.value=e,this.activeAbortControllers.delete(t)}pollDarkWebStatus(e,t,n){let i=this.pollingIntervals.get(e);i&&window.clearTimeout(i);let o=0,a=0,s=5,l=10*60*1e3,c=u=>u<2e4?3e3:u<6e4?5e3:8e3,d=async()=>{if(!this.activeAbortControllers.has(t)){this.pollingIntervals.delete(e);return}if(o>=l){this.pollingIntervals.delete(e),console.warn(`[OSINT Copilot] Dark web investigation timed out after ${Math.round(l/1e3)}s`),this.chatHistory[t]={role:"assistant",content:`\u23F1\uFE0F Dark web investigation timed out

**Job ID:** ${e}

The investigation is taking longer than expected (${Math.round(l/6e4)} minutes).

The job may still be processing on the server. You can try checking the status later or contact support.`,jobId:e,status:"timeout",progress:void 0},await this.renderMessages();return}try{let u=`${se}/api/darkweb/status/${e}`,y=await(0,b.requestUrl)({url:u,method:"GET",headers:{Authorization:`Bearer ${this.plugin.settings.reportApiKey}`},throw:!1});if(y.status<200||y.status>=300){if(y.status===404){this.pollingIntervals.delete(e),console.warn(`[OSINT Copilot] Job ${e} not found in backend (404). Attempting to fetch results directly...`);try{await this.fetchDarkWebResults(e,t,n),this.activeAbortControllers.delete(t);return}catch(f){console.error("[OSINT Copilot] Failed to fetch results after 404:",f),this.chatHistory[t]={role:"assistant",content:`\u26A0\uFE0F Investigation status unavailable

**Job ID:** ${e}

The backend lost track of this investigation (likely due to a Redis connection issue).

The investigation may have completed, but the results are not accessible. Please try starting a new investigation.`,jobId:e,status:"failed",progress:void 0},await this.renderMessages(),this.activeAbortControllers.delete(t);return}}throw new Error(`Status check failed (${y.status})`)}let m=y.json,v=m.status;if(a=0,v==="processing"||v==="queued"){let f=m.stage||"processing",x=m.search_results_count||0,g=m.filtered_results_count||0,C={initializing:{percent:22,message:"Initializing investigation..."},refining_query:{percent:28,message:"Refining search query with AI..."},searching:{percent:40,message:"Searching dark web engines..."},filtering:{percent:55,message:`Filtering ${x} results...`},scraping:{percent:70,message:`Scraping ${g} relevant sites...`},generating_summary:{percent:85,message:"Generating intelligence summary..."}}[f]||{percent:25,message:"Processing..."},D=C.percent,S=C.message,E=`\u{1F575}\uFE0F Dark web investigation in progress

**Stage:** ${S}
`;x>0&&(E+=`**Search results:** ${x}
`),g>0&&(E+=`**Filtered results:** ${g}
`),E+=`
Please wait...`,this.chatHistory[t]={role:"assistant",content:E,jobId:e,status:"processing",progress:{message:S,percent:D},query:n},this.updateProgressBar(t,{message:S,percent:D});let w=c(o);o+=w;let M=window.setTimeout(()=>{d()},w);this.pollingIntervals.set(e,M)}else v==="completed"?(this.pollingIntervals.delete(e),this.chatHistory[t].progress={message:"Fetching results...",percent:92},this.updateProgressBar(t,{message:"Fetching results...",percent:92}),await this.fetchDarkWebResults(e,t,n),this.activeAbortControllers.delete(t)):v==="failed"&&(this.pollingIntervals.delete(e),console.error(`[OSINT Copilot] Dark web investigation failed. Job ID: ${e}, Error: ${m.error||"Unknown error"}`),this.chatHistory[t]={role:"assistant",content:`\u274C Dark web investigation failed

**Error:** ${m.error||"Unknown error"}

Please try again or contact support if the issue persists.`,jobId:e,status:"failed",progress:void 0},await this.renderMessages())}catch(u){a++;let y=u instanceof Error?u.name:"Unknown",m=u instanceof Error?u.message:String(u);if(console.error(`[OSINT Copilot] Dark web status poll error (${a}/${s}):`,`Type: ${y}, Message: ${m}`),a<s){let v=c(o);o+=v;let f=Math.round(o/1e3),x=`Network interrupted (${y}), retrying... (${f}s elapsed, attempt ${a}/${s})`;console.debug(`[OSINT Copilot] ${x}`);let g=window.setTimeout(()=>{d()},v);this.pollingIntervals.set(e,g)}else this.pollingIntervals.delete(e),console.error("[OSINT Copilot] Dark web status polling failed after max retries"),this.chatHistory[t]={role:"assistant",content:`\u274C Dark web investigation status check failed

**Error:** Network connection lost after ${s} attempts (${y}).

Please check your connection and try again.`,jobId:e,status:"failed",progress:void 0},await this.renderMessages()}},p=c(0);o=p;let h=window.setTimeout(()=>{d()},p);this.pollingIntervals.set(e,h)}async fetchDarkWebResults(e,t,n){try{let i=e.startsWith("darkweb_")?e.replace("darkweb_",""):e,o=`${se}/api/darkweb/summary/${i}`,a=await(0,b.requestUrl)({url:o,method:"GET",headers:{Authorization:`Bearer ${this.plugin.settings.reportApiKey}`},throw:!1});if(a.status<200||a.status>=300)throw new Error(`Failed to fetch results (${a.status})`);let s=a.json;console.debug(`[OSINT Copilot] Dark web investigation completed. Job ID: ${e}`);let l=`# Dark Web Investigation: ${n}

`;s.summary&&(l+=`## Summary

${s.summary}

`),s.findings&&s.findings.length>0&&(l+=`## Key Findings (${s.findings.length})

`,s.findings.forEach((p,h)=>{l+=`### ${h+1}. ${p.title||"Finding"}

`,p.url&&(l+=`**URL:** ${p.url}

`),p.snippet&&(l+=`${p.snippet}

`)}));let c="";try{c=await this.plugin.saveDarkWebReportToVault(l,n,e),new b.Notice(`Dark web report saved to ${c}`)}catch(p){console.error("Error saving dark web report to vault:",p)}let d=`\u2705 Dark web investigation completed

`;if(d+=`**Query:** ${n}
`,c&&(d+=`**Saved to:** \`${c}\`
`),d+=`
---

`,d+=l,this.chatHistory[t]={role:"assistant",content:d,jobId:e,status:"completed",query:n,progress:void 0,reportFilePath:c||void 0},await this.renderMessages(),this.graphGenerationMode)try{await this.processGraphGeneration(t,l,n,d)}catch(p){console.error("[OSINT Copilot] Graph generation from dark web results failed:",p),new b.Notice("Graph generation failed, but the report was saved successfully.")}if(c){let p=this.app.vault.getAbstractFileByPath(c);p instanceof b.TFile&&await this.app.workspace.getLeaf().openFile(p)}new b.Notice("Dark web investigation completed!")}catch(i){console.error(`[OSINT Copilot] Failed to fetch dark web results. Job ID: ${e}, Error:`,i),this.chatHistory[t]={role:"assistant",content:`\u26A0\uFE0F Investigation completed but failed to fetch results

**Query:** ${n}
**Error:** ${i instanceof Error?i.message:String(i)}

Please try again or contact support if the issue persists.`,jobId:e,status:"completed",query:n},await this.renderMessages()}}async onClose(){for(let e of this.pollingIntervals.values())window.clearTimeout(e);this.pollingIntervals.clear()}},Oe=class extends b.PluginSettingTab{constructor(r,e){super(r,e),this.plugin=e}display(){let{containerEl:r}=this;if(r.empty(),new b.Setting(r).setName("Max notes").setDesc("Maximum number of notes to include in context").addText(i=>i.setPlaceholder("15").setValue(String(this.plugin.settings.maxNotes)).onChange(async o=>{let a=parseInt(o);!isNaN(a)&&a>0&&(this.plugin.settings.maxNotes=a,await this.plugin.saveSettings())})),new b.Setting(r).setName("System prompt").setDesc("Default system prompt for q&a").addTextArea(i=>{i.setPlaceholder("You are a vault assistant...").setValue(this.plugin.settings.systemPrompt).onChange(async o=>{this.plugin.settings.systemPrompt=o,await this.plugin.saveSettings()}),i.inputEl.rows=4,i.inputEl.setCssProps({width:"100%"})}),this.plugin.settings.permissions&&this.plugin.settings.permissions.allow_custom_chat_config){new b.Setting(r).setName("Custom chat configuration").setHeading(),r.createEl("p",{text:"Configure LLM providers for the 'Custom chat' mode. Add multiple checkpoints (e.g., local models, different providers) and select them in the chat view.",cls:"setting-item-description"});let i=r.createDiv("vault-ai-checkpoints-container");i.style.marginBottom="20px";let o=r.createDiv("vault-ai-add-checkpoint");o.style.borderTop="1px solid var(--background-modifier-border)",o.style.paddingTop="10px";let a=o.createDiv();a.setText("Add new checkpoint"),a.addClass("setting-item-heading");let s="",l="http://localhost:11434/v1",c="",d="",p="openai",h=null,u,y,m,v,f,x,g=()=>{h=null,s="",l="http://localhost:11434/v1",c="",d="",p="openai",u&&u.setValue(""),y&&y.setValue("http://localhost:11434/v1"),m&&m.setValue(""),v&&v.setValue(""),f&&f.setValue("openai"),a.setText("Add new checkpoint"),x&&x.setButtonText("Add checkpoint")},T=()=>{i.empty(),this.plugin.settings.customCheckpoints.length===0&&i.createEl("p",{text:"No checkpoints configured.",cls:"setting-item-description"}),this.plugin.settings.customCheckpoints.forEach((C,D)=>{let S=i.createDiv("vault-ai-checkpoint-item");S.style.display="flex",S.style.alignItems="center",S.style.marginBottom="10px",S.style.padding="10px",S.style.background="var(--background-secondary)",S.style.borderRadius="5px",S.style.gap="10px";let E=S.createDiv();E.style.flex="1",E.createEl("strong",{text:C.name});let w=C.type==="mindsdb"?"MindsDB":"OpenAI";E.createEl("span",{text:` (${w}: ${C.model})`,cls:"setting-item-description"}),E.createEl("div",{text:C.url,cls:"setting-item-description"}).style.fontSize="0.8em",new b.ButtonComponent(S).setIcon("pencil").setTooltip("Edit").onClick(()=>{h=C.id,s=C.name,l=C.url,c=C.apiKey,d=C.model,p=C.type||"openai",u&&u.setValue(s),y&&y.setValue(l),m&&m.setValue(c),v&&v.setValue(d),f&&f.setValue(p),a.setText("Edit checkpoint"),x&&x.setButtonText("Update checkpoint"),x&&x.setCta()}),new b.ButtonComponent(S).setIcon("trash").setTooltip("Delete").setWarning().onClick(async()=>{confirm(`Delete checkpoint "${C.name}"?`)&&(this.plugin.settings.customCheckpoints.splice(D,1),await this.plugin.saveSettings(),T(),h===C.id&&g())})})};T(),new b.Setting(o).setName("Name").setDesc("Display name").addText(C=>{u=C,C.setPlaceholder("My custom LLM").onChange(D=>s=D)}),new b.Setting(o).setName("Provider type").setDesc("Protocol to use").addDropdown(C=>{f=C,C.addOption("openai","OpenAI compatible (default)").addOption("mindsdb","MindsDB (SQL via HTTP)").setValue(p).onChange(D=>{p=D,p==="mindsdb"&&l.includes("localhost")&&(l="http://127.0.0.1:47334",y&&y.setValue(l))})}),new b.Setting(o).setName("API URL").setDesc("Base URL. For MindsDB, use the root (e.g. http://127.0.0.1:47334). For OpenAI, the full path is constructed automatically unless specified.").addText(C=>{y=C,C.setValue(l).setPlaceholder("http://localhost:11434/v1").onChange(D=>l=D)}),new b.Setting(o).setName("API key").setDesc("Optional").addText(C=>{m=C,C.setPlaceholder("sk-...").onChange(D=>c=D)}),new b.Setting(o).setName("Model / agent name").setDesc("Model ID or agent name").addText(C=>{v=C,C.setPlaceholder("llama3 or my_agent").onChange(D=>d=D)}),new b.Setting(o).addButton(C=>{x=C,C.setButtonText("Add checkpoint").setCta().onClick(async()=>{if(!s||!l||!d){new b.Notice("Name, URL, and model are required.");return}if(h){let D=this.plugin.settings.customCheckpoints.findIndex(S=>S.id===h);D!==-1&&(this.plugin.settings.customCheckpoints[D]={...this.plugin.settings.customCheckpoints[D],name:s,url:l,apiKey:c,model:d,type:p},new b.Notice("Checkpoint updated!"))}else this.plugin.settings.customCheckpoints.push({id:Date.now().toString(),name:s,url:l,apiKey:c,model:d,type:p}),new b.Notice("Checkpoint added!");await this.plugin.saveSettings(),T(),g()})}),new b.Setting(o).addButton(C=>C.setButtonText("Clear / cancel").onClick(()=>{g()}))}else new b.Setting(r).setName("Custom chat configuration").setHeading(),r.createEl("p",{text:"This feature is available in 'Plugin own data' plan.",cls:"setting-item-description"}).style.color="var(--text-muted)";if(new b.Setting(r).setName("Backend API").setHeading(),new b.Setting(r).setName("Account dashboard").setDesc("View your API usage, quota, and manage your subscription").controlEl.createEl("a",{text:"Open dashboard \u2192",href:"https://osint-copilot.com/dashboard/",cls:"external-link"}).setCssProps({color:"var(--interactive-accent)","text-decoration":"none","font-weight":"500"}),new b.Setting(r).setName("License key").setDesc("License key for all operations (chat, reports, and investigations)").addText(i=>{i.setPlaceholder("Enter your license key").setValue(this.plugin.settings.reportApiKey).onChange(async o=>{this.plugin.settings.reportApiKey=o,await this.plugin.saveSettings(),await this.refreshApiInfo()}),i.inputEl.type="password"}),this.plugin.settings.reportApiKey){let i=r.createDiv("api-info-container");i.setCssProps({margin:"10px 0",padding:"15px",background:"var(--background-secondary)","border-radius":"5px"});let o=i.createEl("p",{text:"Loading license key information...",cls:"setting-item-description"});this.fetchApiKeyInfo().then(a=>{if(o.remove(),a){let s=i.createDiv();s.setCssProps({display:"grid","grid-template-columns":"1fr 1fr",gap:"10px","font-size":"0.9em"});let l=a.remaining_credits??a.remaining_quota??0,c=a.active??!1,d=a.is_trial??!1,p=s.createDiv();p.createEl("strong",{text:"Plan: "}),p.createSpan({text:a.plan||"No Plan"});let h=s.createDiv();h.createEl("strong",{text:"Remaining credits: "});let u=h.createSpan({text:`${l} credits`});l<=0?u.setCssProps({color:"var(--text-error)","font-weight":"bold"}):l<=5&&u.setCssProps({color:"var(--text-warning)"});let y=s.createDiv();y.createEl("strong",{text:"Status: "}),y.createSpan({text:c?"Active":"Inactive"}).setCssProps({color:c?"var(--text-success)":"var(--text-error)"});let v=s.createDiv();if(v.createEl("strong",{text:"Expires: "}),a.expires_at){let f=new Date(a.expires_at);v.createSpan({text:f.toLocaleDateString()})}else v.createSpan({text:"N/A"});if(d&&i.createEl("p",{text:"\u{1F381} trial account",cls:"setting-item-description"}).setCssProps({"margin-top":"10px",color:"var(--text-warning)","font-weight":"500"}),l<=0){let f=i.createDiv();f.setCssProps({"margin-top":"15px",padding:"12px",background:"var(--background-modifier-error)","border-radius":"5px","border-left":"4px solid var(--text-error)"}),f.createEl("p",{text:"\u26A0\uFE0F credits exhausted"}).setCssProps({margin:"0 0 8px 0","font-weight":"bold",color:"var(--text-error)"}),f.createEl("p",{text:"You have no remaining credits. Dark web investigations and report generation are unavailable until you upgrade or your quota renews."}).setCssProps({margin:"0 0 10px 0","font-size":"0.9em"}),f.createEl("a",{text:"Upgrade your plan \u2192",href:"https://osint-copilot.com/dashboard/"}).setCssProps({color:"var(--interactive-accent)","font-weight":"500","text-decoration":"none"})}else if(l<=5){let f=i.createDiv();f.setCssProps({"margin-top":"15px",padding:"10px",background:"var(--background-modifier-warning)","border-radius":"5px"}),f.createEl("p",{text:`\u26A0\uFE0F Low credits: Only ${l} credits remaining.`}).setCssProps({margin:"0","font-size":"0.9em",color:"var(--text-warning)"})}}else i.createEl("p",{text:"\u26A0\uFE0F could not load license key information. Please check your license key.",cls:"setting-item-description"}).setCssProps({color:"var(--text-error)"})}).catch(()=>{o.remove(),i.createEl("p",{text:"\u26A0\uFE0F failed to connect to API. Please check your internet connection.",cls:"setting-item-description"}).setCssProps({color:"var(--text-error)"})})}new b.Setting(r).setName("Companies&people output directory").setDesc("Directory where generated reports will be saved").addText(i=>i.setPlaceholder("Reports").setValue(this.plugin.settings.reportOutputDir).onChange(async o=>{this.plugin.settings.reportOutputDir=o,await this.plugin.saveSettings()})),new b.Setting(r).setName("Conversation history folder").setDesc("Directory where chat conversations will be saved").addText(i=>i.setPlaceholder(".osint-copilot/conversations").setValue(this.plugin.settings.conversationFolder).onChange(async o=>{this.plugin.settings.conversationFolder=o,this.plugin.conversationService.setBasePath(o),await this.plugin.saveSettings(),await this.plugin.conversationService.initialize()})),r.createEl("p",{text:"\u2139\uFE0F note: AI entity generation requires an active API connection. All other features (manual entity creation, editing, connections, map view) work locally without the API.",cls:"setting-item-description"}).setCssProps({color:"var(--text-muted)"}),new b.Setting(r).setName("Graph view").setHeading(),new b.Setting(r).setName("Auto-refresh graph view").setDesc("Automatically refresh the graph view when new entities are created through AI generation").addToggle(i=>i.setValue(this.plugin.settings.autoRefreshGraph).onChange(async o=>{this.plugin.settings.autoRefreshGraph=o,await this.plugin.saveSettings()})),new b.Setting(r).setName("Auto-open graph view").setDesc("Automatically open the graph view when entities are created (if not already open)").addToggle(i=>i.setValue(this.plugin.settings.autoOpenGraphOnEntityCreation).onChange(async o=>{this.plugin.settings.autoOpenGraphOnEntityCreation=o,await this.plugin.saveSettings()}))}async fetchApiKeyInfo(){if(!this.plugin.settings.reportApiKey)return null;try{let r=await(0,b.requestUrl)({url:"https://api.osint-copilot.com/api/key/info",method:"GET",headers:{Authorization:`Bearer ${this.plugin.settings.reportApiKey}`,"Content-Type":"application/json"},throw:!1});return r.status<200||r.status>=300?null:r.json}catch(r){return console.error("Failed to fetch license key info:",r),null}}async refreshApiInfo(){this.display()}};
